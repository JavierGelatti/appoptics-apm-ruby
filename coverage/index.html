<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Ruby-appoptics apm</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.10.2/application.js' type='text/javascript'></script>    
    <link href='./assets/0.10.2/application.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="./assets/0.10.2/favicon_red.png" />
    <link rel="icon" type="image/png" href="./assets/0.10.2/favicon.png" />
  </head>
  
  <body>
    <div id="loading">
      <img src="./assets/0.10.2/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2018-06-14T20:13:09+00:00">2018-06-14T20:13:09+00:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="red">75.09%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         356.31
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>66</b> files in total.
    <b>3561</b> relevant lines. 
    <span class="green"><b>2674</b> lines covered</span> and
    <span class="red"><b>887</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#4b76e0298081d1a5a1d3ab0fb0563d779f3e09e6" class="src_link" title="lib/appoptics_apm.rb">lib/appoptics_apm.rb</a></td>
        <td class="yellow strong">81.25 %</td>
        <td>76</td>
        <td>48</td>
        <td>39</td>
        <td>9</td>
        <td>20.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8a53ebc8626c04a02b516e1e41838781c4550391" class="src_link" title="lib/appoptics_apm/api.rb">lib/appoptics_apm/api.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>17</td>
        <td>8</td>
        <td>8</td>
        <td>0</td>
        <td>31.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#617021d85319f41fba0b7a10dd9c2ad47fb8caa8" class="src_link" title="lib/appoptics_apm/api/layerinit.rb">lib/appoptics_apm/api/layerinit.rb</a></td>
        <td class="red strong">71.43 %</td>
        <td>26</td>
        <td>7</td>
        <td>5</td>
        <td>2</td>
        <td>24.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#64fcc81987967f761e170d78585095f20e91cae5" class="src_link" title="lib/appoptics_apm/api/logging.rb">lib/appoptics_apm/api/logging.rb</a></td>
        <td class="yellow strong">83.7 %</td>
        <td>364</td>
        <td>92</td>
        <td>77</td>
        <td>15</td>
        <td>5267.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9247b5f32c513d90d1b10bce09b0ccdceb441f5e" class="src_link" title="lib/appoptics_apm/api/memcache.rb">lib/appoptics_apm/api/memcache.rb</a></td>
        <td class="red strong">56.25 %</td>
        <td>37</td>
        <td>16</td>
        <td>9</td>
        <td>7</td>
        <td>15.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b8d6fb6907d3b95844890563b636777bf40785a2" class="src_link" title="lib/appoptics_apm/api/profiling.rb">lib/appoptics_apm/api/profiling.rb</a></td>
        <td class="green strong">95.06 %</td>
        <td>203</td>
        <td>81</td>
        <td>77</td>
        <td>4</td>
        <td>33.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ed757c653b4c19d7cf2632a3c3081b0c039c2644" class="src_link" title="lib/appoptics_apm/api/tracing.rb">lib/appoptics_apm/api/tracing.rb</a></td>
        <td class="red strong">69.77 %</td>
        <td>192</td>
        <td>43</td>
        <td>30</td>
        <td>13</td>
        <td>282.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#28b282b470cb6cc7f956d0883a93ece8791df1a4" class="src_link" title="lib/appoptics_apm/api/util.rb">lib/appoptics_apm/api/util.rb</a></td>
        <td class="green strong">91.3 %</td>
        <td>128</td>
        <td>46</td>
        <td>42</td>
        <td>4</td>
        <td>1409.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#60b289b61e06064ddbe39c8b0625cd77a5a22f2b" class="src_link" title="lib/appoptics_apm/base.rb">lib/appoptics_apm/base.rb</a></td>
        <td class="red strong">73.03 %</td>
        <td>258</td>
        <td>89</td>
        <td>65</td>
        <td>24</td>
        <td>1141.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#76d8427bd7bdd29101315f367aa5ba2b40a95d92" class="src_link" title="lib/appoptics_apm/config.rb">lib/appoptics_apm/config.rb</a></td>
        <td class="red strong">70.65 %</td>
        <td>225</td>
        <td>92</td>
        <td>65</td>
        <td>27</td>
        <td>2326.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#93091a91c17a1f39864f8a0d204690d9f06f7f27" class="src_link" title="lib/appoptics_apm/frameworks/grape.rb">lib/appoptics_apm/frameworks/grape.rb</a></td>
        <td class="green strong">97.87 %</td>
        <td>94</td>
        <td>47</td>
        <td>46</td>
        <td>1</td>
        <td>16.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b194d92d30f81cf97b3783be276c104de215c5c2" class="src_link" title="lib/appoptics_apm/frameworks/padrino.rb">lib/appoptics_apm/frameworks/padrino.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>52</td>
        <td>26</td>
        <td>26</td>
        <td>0</td>
        <td>18.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b02123ebe46744f1e93b3cb58daa80fd0c76265f" class="src_link" title="lib/appoptics_apm/frameworks/padrino/templates.rb">lib/appoptics_apm/frameworks/padrino/templates.rb</a></td>
        <td class="red strong">21.43 %</td>
        <td>58</td>
        <td>28</td>
        <td>6</td>
        <td>22</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5df8234fb59c12ed13afaceac5f714277d37cd31" class="src_link" title="lib/appoptics_apm/frameworks/rails.rb">lib/appoptics_apm/frameworks/rails.rb</a></td>
        <td class="red strong">71.11 %</td>
        <td>94</td>
        <td>45</td>
        <td>32</td>
        <td>13</td>
        <td>15.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4075d214e65959814e2b1cb170e814d60e6afdba" class="src_link" title="lib/appoptics_apm/frameworks/rails/inst/action_controller.rb">lib/appoptics_apm/frameworks/rails/inst/action_controller.rb</a></td>
        <td class="red strong">78.05 %</td>
        <td>106</td>
        <td>41</td>
        <td>32</td>
        <td>9</td>
        <td>43.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fbe789f86aa1d696d83c5a26d790156980b98c68" class="src_link" title="lib/appoptics_apm/frameworks/rails/inst/action_controller4.rb">lib/appoptics_apm/frameworks/rails/inst/action_controller4.rb</a></td>
        <td class="yellow strong">86.36 %</td>
        <td>48</td>
        <td>22</td>
        <td>19</td>
        <td>3</td>
        <td>56.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0f3580075c5b12d263b7e1f09dad8a4d2c2e4319" class="src_link" title="lib/appoptics_apm/frameworks/rails/inst/action_controller5.rb">lib/appoptics_apm/frameworks/rails/inst/action_controller5.rb</a></td>
        <td class="yellow strong">85.71 %</td>
        <td>50</td>
        <td>21</td>
        <td>18</td>
        <td>3</td>
        <td>56.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bf1dbce1e200fc5bcf9f33a8cff359e347e9e3af" class="src_link" title="lib/appoptics_apm/frameworks/rails/inst/action_controller_api.rb">lib/appoptics_apm/frameworks/rails/inst/action_controller_api.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>50</td>
        <td>21</td>
        <td>21</td>
        <td>0</td>
        <td>15.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#556f13d23af3fcbfb78efdade1a1c860c870fed0" class="src_link" title="lib/appoptics_apm/frameworks/rails/inst/action_view.rb">lib/appoptics_apm/frameworks/rails/inst/action_view.rb</a></td>
        <td class="red strong">26.67 %</td>
        <td>58</td>
        <td>30</td>
        <td>8</td>
        <td>22</td>
        <td>3.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5af664e5a9d8817ca0cdf3fdd262537a0813ab0d" class="src_link" title="lib/appoptics_apm/frameworks/rails/inst/action_view_30.rb">lib/appoptics_apm/frameworks/rails/inst/action_view_30.rb</a></td>
        <td class="red strong">6.9 %</td>
        <td>50</td>
        <td>29</td>
        <td>2</td>
        <td>27</td>
        <td>0.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#af137e8df9fa78f0904309dd5bd6f06e670f5c64" class="src_link" title="lib/appoptics_apm/frameworks/rails/inst/active_record.rb">lib/appoptics_apm/frameworks/rails/inst/active_record.rb</a></td>
        <td class="yellow strong">85.71 %</td>
        <td>27</td>
        <td>14</td>
        <td>12</td>
        <td>2</td>
        <td>10.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9bd5b5fbf81547af414f7dc877686b30a0ea5cbb" class="src_link" title="lib/appoptics_apm/frameworks/rails/inst/connection_adapters/mysql.rb">lib/appoptics_apm/frameworks/rails/inst/connection_adapters/mysql.rb</a></td>
        <td class="red strong">68.75 %</td>
        <td>43</td>
        <td>16</td>
        <td>11</td>
        <td>5</td>
        <td>4.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#26be7cafaf9209e393f42f6eca7cc1574c6d0ad7" class="src_link" title="lib/appoptics_apm/frameworks/rails/inst/connection_adapters/mysql2.rb">lib/appoptics_apm/frameworks/rails/inst/connection_adapters/mysql2.rb</a></td>
        <td class="green strong">92.86 %</td>
        <td>29</td>
        <td>14</td>
        <td>13</td>
        <td>1</td>
        <td>7.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1be031bf27c4edf7c6a6f1e69c883342a94b1aa4" class="src_link" title="lib/appoptics_apm/frameworks/rails/inst/connection_adapters/postgresql.rb">lib/appoptics_apm/frameworks/rails/inst/connection_adapters/postgresql.rb</a></td>
        <td class="green strong">92.31 %</td>
        <td>31</td>
        <td>13</td>
        <td>12</td>
        <td>1</td>
        <td>7.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3cf6073c679cec410b43fffd7dbb7df42331163b" class="src_link" title="lib/appoptics_apm/frameworks/rails/inst/connection_adapters/utils.rb">lib/appoptics_apm/frameworks/rails/inst/connection_adapters/utils.rb</a></td>
        <td class="yellow strong">84.13 %</td>
        <td>132</td>
        <td>63</td>
        <td>53</td>
        <td>10</td>
        <td>37.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5a5ba5b35f01ca7825b9d8a4b3fabb5056a09a88" class="src_link" title="lib/appoptics_apm/frameworks/rails/inst/connection_adapters/utils5x.rb">lib/appoptics_apm/frameworks/rails/inst/connection_adapters/utils5x.rb</a></td>
        <td class="yellow strong">87.27 %</td>
        <td>113</td>
        <td>55</td>
        <td>48</td>
        <td>7</td>
        <td>31.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#42d1f42fe0c9fd416412dc900355f890813ba923" class="src_link" title="lib/appoptics_apm/frameworks/sinatra.rb">lib/appoptics_apm/frameworks/sinatra.rb</a></td>
        <td class="yellow strong">83.78 %</td>
        <td>71</td>
        <td>37</td>
        <td>31</td>
        <td>6</td>
        <td>18.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d3aabd712e5c24b83ec3425b925e533bc17c3668" class="src_link" title="lib/appoptics_apm/frameworks/sinatra/templates.rb">lib/appoptics_apm/frameworks/sinatra/templates.rb</a></td>
        <td class="yellow strong">88.89 %</td>
        <td>56</td>
        <td>27</td>
        <td>24</td>
        <td>3</td>
        <td>41.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2244c8a293b746e05d776637528fe5e9719a8f44" class="src_link" title="lib/appoptics_apm/inst/bunny-client.rb">lib/appoptics_apm/inst/bunny-client.rb</a></td>
        <td class="yellow strong">83.16 %</td>
        <td>148</td>
        <td>95</td>
        <td>79</td>
        <td>16</td>
        <td>811.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#687c0dbd14f83066c8bd7a5b60b4bc7fbc571b10" class="src_link" title="lib/appoptics_apm/inst/bunny-consumer.rb">lib/appoptics_apm/inst/bunny-consumer.rb</a></td>
        <td class="green strong">90.2 %</td>
        <td>92</td>
        <td>51</td>
        <td>46</td>
        <td>5</td>
        <td>12.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#dc2e6465384926dfb8288f75186b87b1c333f967" class="src_link" title="lib/appoptics_apm/inst/curb.rb">lib/appoptics_apm/inst/curb.rb</a></td>
        <td class="yellow strong">85.71 %</td>
        <td>329</td>
        <td>147</td>
        <td>126</td>
        <td>21</td>
        <td>31.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9cddf1ac04e3f42169c65199808a463061ee8b79" class="src_link" title="lib/appoptics_apm/inst/dalli.rb">lib/appoptics_apm/inst/dalli.rb</a></td>
        <td class="green strong">95.83 %</td>
        <td>86</td>
        <td>48</td>
        <td>46</td>
        <td>2</td>
        <td>16.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c074cf4df4d4b2b6602af174541e80992a770eb4" class="src_link" title="lib/appoptics_apm/inst/delayed_job.rb">lib/appoptics_apm/inst/delayed_job.rb</a></td>
        <td class="green strong">91.11 %</td>
        <td>92</td>
        <td>45</td>
        <td>41</td>
        <td>4</td>
        <td>7.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#97d36c893d3b23333dd49fc56ae17fc271c03222" class="src_link" title="lib/appoptics_apm/inst/em-http-request.rb">lib/appoptics_apm/inst/em-http-request.rb</a></td>
        <td class="red strong">14.29 %</td>
        <td>103</td>
        <td>56</td>
        <td>8</td>
        <td>48</td>
        <td>4.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3484bd1d1cc873539c958aa5422fe4274685003e" class="src_link" title="lib/appoptics_apm/inst/excon.rb">lib/appoptics_apm/inst/excon.rb</a></td>
        <td class="green strong">95.38 %</td>
        <td>122</td>
        <td>65</td>
        <td>62</td>
        <td>3</td>
        <td>39.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3e8acb3c6d7bdb2020cd5b336613515c405c1700" class="src_link" title="lib/appoptics_apm/inst/faraday.rb">lib/appoptics_apm/inst/faraday.rb</a></td>
        <td class="green strong">94.0 %</td>
        <td>84</td>
        <td>50</td>
        <td>47</td>
        <td>3</td>
        <td>19.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c545f810d384b1df8fb9c0b8e54c9ce5f4ec695b" class="src_link" title="lib/appoptics_apm/inst/http.rb">lib/appoptics_apm/inst/http.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>83</td>
        <td>40</td>
        <td>40</td>
        <td>0</td>
        <td>127.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#412386c97055243674e885f2ec18b629641dc132" class="src_link" title="lib/appoptics_apm/inst/httpclient.rb">lib/appoptics_apm/inst/httpclient.rb</a></td>
        <td class="green strong">96.08 %</td>
        <td>176</td>
        <td>102</td>
        <td>98</td>
        <td>4</td>
        <td>37.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#424bca7a55c6514f0ce909aeeac186e1adf66714" class="src_link" title="lib/appoptics_apm/inst/memcached.rb">lib/appoptics_apm/inst/memcached.rb</a></td>
        <td class="green strong">92.31 %</td>
        <td>94</td>
        <td>52</td>
        <td>48</td>
        <td>4</td>
        <td>20.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#63a9d162524b2990106525607f95655e2f14ad01" class="src_link" title="lib/appoptics_apm/inst/mongo.rb">lib/appoptics_apm/inst/mongo.rb</a></td>
        <td class="red strong">8.46 %</td>
        <td>242</td>
        <td>130</td>
        <td>11</td>
        <td>119</td>
        <td>2.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1979cde34f623146357229498f24e67afbe56473" class="src_link" title="lib/appoptics_apm/inst/mongo2.rb">lib/appoptics_apm/inst/mongo2.rb</a></td>
        <td class="yellow strong">87.38 %</td>
        <td>225</td>
        <td>103</td>
        <td>90</td>
        <td>13</td>
        <td>31.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9823ae1f08b7426581da78bf494419ead8afb947" class="src_link" title="lib/appoptics_apm/inst/moped.rb">lib/appoptics_apm/inst/moped.rb</a></td>
        <td class="yellow strong">90.0 %</td>
        <td>466</td>
        <td>240</td>
        <td>216</td>
        <td>24</td>
        <td>14.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6c55d8d4bd46293fa43f3dbe40600d99cdc1c5ce" class="src_link" title="lib/appoptics_apm/inst/rack.rb">lib/appoptics_apm/inst/rack.rb</a></td>
        <td class="green strong">96.84 %</td>
        <td>203</td>
        <td>95</td>
        <td>92</td>
        <td>3</td>
        <td>425.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8f0a2b577507604412be43fd399be55f7268bd7c" class="src_link" title="lib/appoptics_apm/inst/redis.rb">lib/appoptics_apm/inst/redis.rb</a></td>
        <td class="yellow strong">81.25 %</td>
        <td>275</td>
        <td>112</td>
        <td>91</td>
        <td>21</td>
        <td>101.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ef0b992ac72f7add994a0169bb585e59c180fc2d" class="src_link" title="lib/appoptics_apm/inst/resque.rb">lib/appoptics_apm/inst/resque.rb</a></td>
        <td class="red strong">63.75 %</td>
        <td>151</td>
        <td>80</td>
        <td>51</td>
        <td>29</td>
        <td>10.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3a7171132a5d77b2f2e34a039cc752a4aecfe04b" class="src_link" title="lib/appoptics_apm/inst/rest-client.rb">lib/appoptics_apm/inst/rest-client.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>50</td>
        <td>26</td>
        <td>26</td>
        <td>0</td>
        <td>29.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b5813e6e5fe63f5bc4021d67ad852971a93e0283" class="src_link" title="lib/appoptics_apm/inst/sequel.rb">lib/appoptics_apm/inst/sequel.rb</a></td>
        <td class="green strong">91.46 %</td>
        <td>178</td>
        <td>82</td>
        <td>75</td>
        <td>7</td>
        <td>39.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#069e2ff3df1de81c27c1a1cc8fa29f11bbfc27ff" class="src_link" title="lib/appoptics_apm/inst/sidekiq-client.rb">lib/appoptics_apm/inst/sidekiq-client.rb</a></td>
        <td class="green strong">90.32 %</td>
        <td>55</td>
        <td>31</td>
        <td>28</td>
        <td>3</td>
        <td>24.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7f8211a94b222c1b1276532c97dcbc07048aad2b" class="src_link" title="lib/appoptics_apm/inst/sidekiq-worker.rb">lib/appoptics_apm/inst/sidekiq-worker.rb</a></td>
        <td class="red strong">20.59 %</td>
        <td>67</td>
        <td>34</td>
        <td>7</td>
        <td>27</td>
        <td>5.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#603bb127c894515581ae7c6f2769b390d6c86054" class="src_link" title="lib/appoptics_apm/inst/twitter-cassandra.rb">lib/appoptics_apm/inst/twitter-cassandra.rb</a></td>
        <td class="red strong">21.77 %</td>
        <td>294</td>
        <td>147</td>
        <td>32</td>
        <td>115</td>
        <td>5.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4c5ebd7d7e73a1a73322275812bf7237d01e8336" class="src_link" title="lib/appoptics_apm/inst/typhoeus.rb">lib/appoptics_apm/inst/typhoeus.rb</a></td>
        <td class="green strong">95.16 %</td>
        <td>113</td>
        <td>62</td>
        <td>59</td>
        <td>3</td>
        <td>32.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7c3d11112dc2dc81664dd6181e8c93148bd0f948" class="src_link" title="lib/appoptics_apm/instrumentation.rb">lib/appoptics_apm/instrumentation.rb</a></td>
        <td class="red strong">77.78 %</td>
        <td>22</td>
        <td>9</td>
        <td>7</td>
        <td>2</td>
        <td>260.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#eca1cacbcc2bda178e224137fc588693a02240c5" class="src_link" title="lib/appoptics_apm/legacy_method_profiling.rb">lib/appoptics_apm/legacy_method_profiling.rb</a></td>
        <td class="yellow strong">88.46 %</td>
        <td>90</td>
        <td>26</td>
        <td>23</td>
        <td>3</td>
        <td>25.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d68b16994b46638ce99efeaa14a26ce95bded3d0" class="src_link" title="lib/appoptics_apm/loading.rb">lib/appoptics_apm/loading.rb</a></td>
        <td class="red strong">66.67 %</td>
        <td>66</td>
        <td>27</td>
        <td>18</td>
        <td>9</td>
        <td>26.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#873aa68a709782d905fbfd6a5d7fe281cf00fbd3" class="src_link" title="lib/appoptics_apm/logger.rb">lib/appoptics_apm/logger.rb</a></td>
        <td class="red strong">70.59 %</td>
        <td>42</td>
        <td>17</td>
        <td>12</td>
        <td>5</td>
        <td>21.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6aead5dc0fc99ae507e71410a1d9359c92e8f708" class="src_link" title="lib/appoptics_apm/method_profiling.rb">lib/appoptics_apm/method_profiling.rb</a></td>
        <td class="yellow strong">86.96 %</td>
        <td>33</td>
        <td>23</td>
        <td>20</td>
        <td>3</td>
        <td>42.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cb839f8b873fd741e762082dbd877503487f2e88" class="src_link" title="lib/appoptics_apm/noop/context.rb">lib/appoptics_apm/noop/context.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>19</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>3.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#41358d788ba9862014661622ed9d98720f6295b2" class="src_link" title="lib/appoptics_apm/ruby.rb">lib/appoptics_apm/ruby.rb</a></td>
        <td class="yellow strong">90.0 %</td>
        <td>35</td>
        <td>10</td>
        <td>9</td>
        <td>1</td>
        <td>20.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a9ece4d9b1494600f8bf399c0f7e187952ece8a1" class="src_link" title="lib/appoptics_apm/support.rb">lib/appoptics_apm/support.rb</a></td>
        <td class="red strong">6.58 %</td>
        <td>136</td>
        <td>76</td>
        <td>5</td>
        <td>71</td>
        <td>2.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f9a2e655fd7784d80c554e2add953317603e7c7a" class="src_link" title="lib/appoptics_apm/test.rb">lib/appoptics_apm/test.rb</a></td>
        <td class="red strong">58.06 %</td>
        <td>94</td>
        <td>31</td>
        <td>18</td>
        <td>13</td>
        <td>11.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c9619e17efe90a68ff37714fdab50626e1f1c84b" class="src_link" title="lib/appoptics_apm/thread_local.rb">lib/appoptics_apm/thread_local.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>26</td>
        <td>8</td>
        <td>8</td>
        <td>0</td>
        <td>3521.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c98ed8c31f040cfca52f327d90ca5539a175b585" class="src_link" title="lib/appoptics_apm/util.rb">lib/appoptics_apm/util.rb</a></td>
        <td class="red strong">73.85 %</td>
        <td>315</td>
        <td>130</td>
        <td>96</td>
        <td>34</td>
        <td>88.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0fbacdcc50cc60f29e65d76cd04dd1d447cd8891" class="src_link" title="lib/appoptics_apm/xtrace.rb">lib/appoptics_apm/xtrace.rb</a></td>
        <td class="red strong">70.59 %</td>
        <td>103</td>
        <td>34</td>
        <td>24</td>
        <td>10</td>
        <td>2652.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8ab8af3b9db813e143c4c344208432c8ef64009c" class="src_link" title="lib/oboe/backward_compatibility.rb">lib/oboe/backward_compatibility.rb</a></td>
        <td class="yellow strong">85.37 %</td>
        <td>80</td>
        <td>41</td>
        <td>35</td>
        <td>6</td>
        <td>21.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#af6ff44d543c3027efd5a8cdbc66f7d6f9038a56" class="src_link" title="lib/oboe_metal.rb">lib/oboe_metal.rb</a></td>
        <td class="red strong">79.49 %</td>
        <td>187</td>
        <td>78</td>
        <td>62</td>
        <td>16</td>
        <td>902.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a9e958cce9206c0643cacabcdbb39f2f16b115d3" class="src_link" title="lib/rails/generators/appoptics_apm/templates/appoptics_apm_initializer.rb">lib/rails/generators/appoptics_apm/templates/appoptics_apm_initializer.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>215</td>
        <td>83</td>
        <td>83</td>
        <td>0</td>
        <td>31.0</td>
      </tr>
      
    </tbody>
  </table>
</div>


        
      </div>
    
      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.16.1 
        and simplecov-html v0.10.2<br/>
        using 2.3.6_delayed_job.gemfile_postgresql, 2.3.6_frameworks.gemfile_postgresql, 2.3.6_instrumentation_mocked.gemfile_postgresql, 2.3.6_instrumentation_mocked_oldgems.gemfile_postgresql, 2.3.6_libraries.gemfile_postgresql, 2.3.6_noop.gemfile_postgresql, 2.3.6_rails42.gemfile_mysql, 2.3.6_rails42.gemfile_mysql2, 2.3.6_rails42.gemfile_postgresql, 2.3.6_rails51.gemfile_mysql2, 2.3.6_rails51.gemfile_postgresql, 2.4.4_delayed_job.gemfile_postgresql, 2.4.4_frameworks.gemfile_postgresql, 2.4.4_instrumentation_mocked.gemfile_postgresql, 2.4.4_instrumentation_mocked_oldgems.gemfile_postgresql, 2.4.4_libraries.gemfile_postgresql, 2.4.4_noop.gemfile_postgresql, 2.4.4_rails42.gemfile_mysql2, 2.4.4_rails42.gemfile_postgresql, 2.4.4_rails51.gemfile_mysql2, 2.4.4_rails51.gemfile_postgresql, 2.5.1_delayed_job.gemfile_postgresql, 2.5.1_frameworks.gemfile_postgresql, 2.5.1_instrumentation_mocked.gemfile_postgresql, 2.5.1_instrumentation_mocked_oldgems.gemfile_postgresql, 2.5.1_libraries.gemfile_postgresql, 2.5.1_noop.gemfile_postgresql, 2.5.1_rails42.gemfile_mysql2, 2.5.1_rails42.gemfile_postgresql, 2.5.1_rails51.gemfile_mysql2, 2.5.1_rails51.gemfile_postgresql
      </div>
    
      <div class="source_files">
      
        <div class="source_table" id="4b76e0298081d1a5a1d3ab0fb0563d779f3e09e6">
  <div class="header">
    <h3>lib/appoptics_apm.rb</h3>
    <h4><span class="yellow">81.25 %</span> covered</h4>
    <div>
      <b>48</b> relevant lines. 
      <span class="green"><b>39</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># Backward compatibility for supported environment variables</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="5">
          <span class="hits">31</span>
          
          <code class="ruby">ENV[&#39;APPOPTICS_GEM_VERBOSE&#39;] = ENV[&#39;OBOE_GEM_VERBOSE&#39;] if ENV.key?(&#39;OBOE_GEM_VERBOSE&#39;)</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="6">
          <span class="hits">31</span>
          
          <code class="ruby">ENV[&#39;APPOPTICS_GEM_TEST&#39;]    = ENV[&#39;OBOE_GEM_TEST&#39;]    if ENV.key?(&#39;OBOE_GEM_TEST&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="8">
          <span class="hits">31</span>
          
          <code class="ruby">begin</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="9">
          <span class="hits">31</span>
          
          <code class="ruby">  require &#39;openssl&#39;</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="10">
          <span class="hits">31</span>
          
          <code class="ruby">  require &#39;appoptics_apm/version&#39;</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="11">
          <span class="hits">31</span>
          
          <code class="ruby">  require &#39;appoptics_apm/thread_local&#39;</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="12">
          <span class="hits">31</span>
          
          <code class="ruby">  require &#39;appoptics_apm/logger&#39;</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="13">
          <span class="hits">31</span>
          
          <code class="ruby">  require &#39;appoptics_apm/util&#39;</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="14">
          <span class="hits">31</span>
          
          <code class="ruby">  require &#39;appoptics_apm/xtrace&#39;</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="15">
          <span class="hits">31</span>
          
          <code class="ruby">  require &#39;appoptics_apm/support&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # If OboeHeroku is already defined then we are in a PaaS environment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  # with an alternate metal (see the oboe-heroku gem)</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="19">
          <span class="hits">31</span>
          
          <code class="ruby">  unless defined?(OboeHeroku)</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="20">
          <span class="hits">31</span>
          
          <code class="ruby">    require &#39;appoptics_apm/base&#39;</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="21">
          <span class="hits">31</span>
          
          <code class="ruby">    AppOpticsAPM.loaded = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="23">
          <span class="hits">31</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="24">
          <span class="hits">31</span>
          
          <code class="ruby">      if RUBY_PLATFORM == &#39;java&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">        require &#39;/usr/local/tracelytics/tracelyticsagent.jar&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        require &#39;joboe_metal&#39;</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="27">
          <span class="hits">31</span>
          
          <code class="ruby">      elsif RUBY_PLATFORM =~ /linux/</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="28">
          <span class="hits">28</span>
          
          <code class="ruby">        require &#39;oboe_metal.so&#39;</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="29">
          <span class="hits">28</span>
          
          <code class="ruby">        require &#39;oboe_metal.rb&#39;  # sets AppOpticsAPM.loaded = true  if successful</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="31">
          <span class="hits">3</span>
          
          <code class="ruby">        $stderr.puts &#39;===================================================================&#39;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="32">
          <span class="hits">3</span>
          
          <code class="ruby">        $stderr.puts &quot;AppOptics warning: Platform #{RUBY_PLATFORM} not yet supported.&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="33">
          <span class="hits">3</span>
          
          <code class="ruby">        $stderr.puts &#39;see: https://docs.appoptics.com/kb/apm_tracing/supported_platforms/&#39;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="34">
          <span class="hits">3</span>
          
          <code class="ruby">        $stderr.puts &#39;Tracing disabled.&#39;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="35">
          <span class="hits">3</span>
          
          <code class="ruby">        $stderr.puts &#39;Contact support@appoptics.com if this is unexpected.&#39;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="36">
          <span class="hits">3</span>
          
          <code class="ruby">        $stderr.puts &#39;===================================================================&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    rescue LoadError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      unless ENV[&#39;RAILS_GROUP&#39;] == &#39;assets&#39; or ENV[&#39;IGNORE_APPOPTICS_WARNING&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        $stderr.puts &#39;==============================================================&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        $stderr.puts &#39;Missing AppOpticsAPM libraries.  Tracing disabled.&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        $stderr.puts &#39;See: https://docs.appoptics.com/kb/apm_tracing/ruby/&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        $stderr.puts &#39;==============================================================&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="48">
          <span class="hits">31</span>
          
          <code class="ruby">  require &#39;appoptics_apm/config&#39;</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="49">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config.load_config_file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="51">
          <span class="hits">31</span>
          
          <code class="ruby">  require &#39;appoptics_apm/loading&#39;</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="52">
          <span class="hits">31</span>
          
          <code class="ruby">  require &#39;appoptics_apm/legacy_method_profiling&#39;</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="53">
          <span class="hits">31</span>
          
          <code class="ruby">  require &#39;appoptics_apm/method_profiling&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="55">
          <span class="hits">31</span>
          
          <code class="ruby">  if AppOpticsAPM.loaded</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="56">
          <span class="hits">28</span>
          
          <code class="ruby">    require &#39;appoptics_apm/instrumentation&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    # Frameworks</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="59">
          <span class="hits">28</span>
          
          <code class="ruby">    require &#39;appoptics_apm/frameworks/rails&#39;</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="60">
          <span class="hits">28</span>
          
          <code class="ruby">    require &#39;appoptics_apm/frameworks/sinatra&#39;</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="61">
          <span class="hits">28</span>
          
          <code class="ruby">    require &#39;appoptics_apm/frameworks/padrino&#39;</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="62">
          <span class="hits">28</span>
          
          <code class="ruby">    require &#39;appoptics_apm/frameworks/grape&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="64">
          <span class="hits">3</span>
          
          <code class="ruby">    require &#39;appoptics_apm/noop/context&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  # Load Ruby module last.  If there is no framework detected,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  # it will load all of the Ruby instrumentation</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="69">
          <span class="hits">31</span>
          
          <code class="ruby">  require &#39;appoptics_apm/ruby&#39;</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="70">
          <span class="hits">31</span>
          
          <code class="ruby">  require &#39;oboe/backward_compatibility&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="72">
          <span class="hits">31</span>
          
          <code class="ruby">  require &#39;appoptics_apm/test&#39; if ENV[&#39;APPOPTICS_GEM_TEST&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">  $stderr.puts &quot;[appoptics_apm/error] Problem loading: #{e.inspect}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">  $stderr.puts e.backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8a53ebc8626c04a02b516e1e41838781c4550391">
  <div class="header">
    <h3>lib/appoptics_apm/api.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>8</b> relevant lines. 
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="4">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # This module implements the AppOpticsAPM tracing API.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # See: https://docs.appoptics.com/kb/apm_tracing/ruby/sdk/</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="8">
          <span class="hits">31</span>
          
          <code class="ruby">  module API</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="9">
          <span class="hits">31</span>
          
          <code class="ruby">    def self.extend_with_tracing</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="10">
          <span class="hits">31</span>
          
          <code class="ruby">      extend AppOpticsAPM::API::Logging</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="11">
          <span class="hits">31</span>
          
          <code class="ruby">      extend AppOpticsAPM::API::Tracing</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="12">
          <span class="hits">31</span>
          
          <code class="ruby">      extend AppOpticsAPM::API::Profiling</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="13">
          <span class="hits">31</span>
          
          <code class="ruby">      extend AppOpticsAPM::API::LayerInit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="15">
          <span class="hits">31</span>
          
          <code class="ruby">    extend AppOpticsAPM::API::Util</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="617021d85319f41fba0b7a10dd9c2ad47fb8caa8">
  <div class="header">
    <h3>lib/appoptics_apm/api/layerinit.rb</h3>
    <h4><span class="red">71.43 %</span> covered</h4>
    <div>
      <b>7</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">#--</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#++</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="6">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="7">
          <span class="hits">31</span>
          
          <code class="ruby">  module API</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # Provides methods related to layer initialization and reporting</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="10">
          <span class="hits">31</span>
          
          <code class="ruby">    module LayerInit #:nodoc:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      # Internal: Report that instrumentation for the given layer has been</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      # installed, as well as the version of instrumentation and version of</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      # layer.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="15">
          <span class="hits">31</span>
          
          <code class="ruby">      def report_init(layer = :rack) #:nodoc:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">        # Don&#39;t send __Init in test or if AppOpticsAPM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">        # isn&#39;t fully loaded (e.g. missing c-extension)</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="18">
          <span class="hits">44</span>
          
          <code class="ruby">        return if ENV.key?(&#39;APPOPTICS_GEM_TEST&#39;) || !AppOpticsAPM.loaded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        platform_info = AppOpticsAPM::Util.build_init_report</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">        log_init(layer, platform_info)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="64fcc81987967f761e170d78585095f20e91cae5">
  <div class="header">
    <h3>lib/appoptics_apm/api/logging.rb</h3>
    <h4><span class="yellow">83.7 %</span> covered</h4>
    <div>
      <b>92</b> relevant lines. 
      <span class="green"><b>77</b> lines covered</span> and
      <span class="red"><b>15</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">#--</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#++</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"># Make sure Set is loaded if possible.</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="7">
          <span class="hits">31</span>
          
          <code class="ruby">begin</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="8">
          <span class="hits">31</span>
          
          <code class="ruby">  require &#39;set&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">rescue LoadError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  class Set; end # :nodoc:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="14">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="15">
          <span class="hits">31</span>
          
          <code class="ruby">  module API</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    # This modules provides the X-Trace logging facilities.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # These are the lower level methods, please see AppOpticsAPM::API::Tracing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    # for the higher level methods.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # If using these directly make sure to always match a start/end and entry/exit to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    # avoid broken traces.</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="24">
          <span class="hits">31</span>
          
          <code class="ruby">    module Logging</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="25">
          <span class="hits">31</span>
          
          <code class="ruby">      @@ints_or_nil = [Integer, Float, NilClass, String]</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="26">
          <span class="hits">31</span>
          
          <code class="ruby">      @@ints_or_nil &lt;&lt; Fixnum unless RUBY_VERSION &gt;= &#39;2.4&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      # Public: Report an event in an active trace.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      # ==== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      # * +layer+ - The layer the reported event belongs to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      # * +label+ - The label for the reported event. See SDK documentation for reserved labels and usage.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      # * +opts+  - A hash containing key/value pairs that will be reported along with this event (optional).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      # * +event+ - An event to be used instead of generating a new one (see also start_trace_with_target)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      # ==== Example</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      #   AppOpticsAPM::API.log(&#39;logical_layer&#39;, &#39;entry&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      #   AppOpticsAPM::API.log(&#39;logical_layer&#39;, &#39;info&#39;, { :list_length =&gt; 20 })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      #   AppOpticsAPM::API.log(&#39;logical_layer&#39;, &#39;exit&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      # Returns nothing.</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="45">
          <span class="hits">31</span>
          
          <code class="ruby">      def log(layer, label, opts = {}, event=nil)</code>
        </li>
      
        <li class="covered" data-hits="557" data-linenumber="46">
          <span class="hits">557</span>
          
          <code class="ruby">        return AppOpticsAPM::Context.toString unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="512" data-linenumber="48">
          <span class="hits">512</span>
          
          <code class="ruby">        event ||= AppOpticsAPM::Context.createEvent</code>
        </li>
      
        <li class="covered" data-hits="512" data-linenumber="49">
          <span class="hits">512</span>
          
          <code class="ruby">        log_event(layer, label, event, opts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      # Public: Report an exception.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      # ==== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      # * +layer+ - The layer the reported event belongs to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      # * +exn+ - The exception to report</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      # * +opts+ - Custom params if you want to log extra information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      # ==== Example</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      #   begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      #     my_iffy_method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      #   rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      #     AppOpticsAPM::API.log_exception(&#39;rails&#39;, e, { user: user_id })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      #     raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      # Returns nothing.</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="71">
          <span class="hits">31</span>
          
          <code class="ruby">      def log_exception(layer, exn, opts = {})</code>
        </li>
      
        <li class="covered" data-hits="108" data-linenumber="72">
          <span class="hits">108</span>
          
          <code class="ruby">        return AppOpticsAPM::Context.toString if !AppOpticsAPM.tracing? || exn.instance_variable_get(:@oboe_logged)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="73" data-linenumber="74">
          <span class="hits">73</span>
          
          <code class="ruby">        unless exn</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &#39;[appoptics_apm/debug] log_exception called with nil exception&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">          return AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">        opts.merge!(:ErrorClass =&gt; exn.class.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">                    :ErrorMsg =&gt; exn.message,</code>
        </li>
      
        <li class="covered" data-hits="73" data-linenumber="81">
          <span class="hits">73</span>
          
          <code class="ruby">                    :Backtrace =&gt; exn.backtrace.join(&quot;\r\n&quot;)) if exn.backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="73" data-linenumber="83">
          <span class="hits">73</span>
          
          <code class="ruby">        exn.instance_variable_set(:@oboe_logged, true)</code>
        </li>
      
        <li class="covered" data-hits="73" data-linenumber="84">
          <span class="hits">73</span>
          
          <code class="ruby">        log(layer, :error, opts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      # Public: Decide whether or not to start a trace, and report an entry event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">      # appropriately.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      # ==== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      # * +layer+ - The layer the reported event belongs to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      # * +xtrace+ - An xtrace metadata string, or nil.  Used for cross-application tracing.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      # * +opts+ - A hash containing key/value pairs that will be reported along with this event (optional).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">      # ==== Example</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      #   AppOpticsAPM::API.log_start(:layer_name, nil, { :id =&gt; @user.id })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      # Returns an xtrace metadata string if we are tracing</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="102">
          <span class="hits">31</span>
          
          <code class="ruby">      def log_start(layer, xtrace = nil, opts = {})</code>
        </li>
      
        <li class="covered" data-hits="2175" data-linenumber="103">
          <span class="hits">2175</span>
          
          <code class="ruby">        return if !AppOpticsAPM.loaded || (opts.key?(:URL) &amp;&amp; ::AppOpticsAPM::Util.static_asset?(opts[:URL]))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">        #--</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">        # Is the below necessary? Only on JRuby? Could there be an existing context but not x-trace header?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        # See discussion at:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">        # https://github.com/librato/ruby-tracelytics/pull/6/files?diff=split#r131029135</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">        # Used by JRuby/Java webservers such as Tomcat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        # AppOpticsAPM::Context.fromString(xtrace) if AppOpticsAPM.pickup_context?(xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">        # if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">        #   # Pre-existing context.  Either we inherited context from an</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">        #   # incoming X-Trace request header or under JRuby, Joboe started</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">        #   # tracing before the JRuby code was called (e.g. Tomcat)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">        #   AppOpticsAPM.is_continued_trace = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">        #   if AppOpticsAPM.has_xtrace_header</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">        #     opts[:TraceOrigin] = :continued_header</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">        #   elsif AppOpticsAPM.has_incoming_context</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">        #     opts[:TraceOrigin] = :continued_context</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">        #   else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">        #     opts[:TraceOrigin] = :continued</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">        #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        # return log_entry(layer, opts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">        # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">        #++</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2175" data-linenumber="131">
          <span class="hits">2175</span>
          
          <code class="ruby">        if AppOpticsAPM.sample?(opts.merge(:layer =&gt; layer, :xtrace =&gt; xtrace))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">          # Yes, we&#39;re sampling this request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">          # Probablistic tracing of a subset of requests based off of</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">          # sample rate and sample source</code>
        </li>
      
        <li class="covered" data-hits="1963" data-linenumber="135">
          <span class="hits">1963</span>
          
          <code class="ruby">          opts[:SampleRate]        = AppOpticsAPM.sample_rate</code>
        </li>
      
        <li class="covered" data-hits="1963" data-linenumber="136">
          <span class="hits">1963</span>
          
          <code class="ruby">          opts[:SampleSource]      = AppOpticsAPM.sample_source</code>
        </li>
      
        <li class="covered" data-hits="1963" data-linenumber="137">
          <span class="hits">1963</span>
          
          <code class="ruby">          opts[:TraceOrigin]       = :always_sampled</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1963" data-linenumber="139">
          <span class="hits">1963</span>
          
          <code class="ruby">          if xtrace_v2?(xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">            # continue valid incoming xtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">            # use it for current context, ensuring sample bit is set</code>
        </li>
      
        <li class="covered" data-hits="246" data-linenumber="142">
          <span class="hits">246</span>
          
          <code class="ruby">            AppOpticsAPM::XTrace.set_sampled(xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="246" data-linenumber="144">
          <span class="hits">246</span>
          
          <code class="ruby">            md = AppOpticsAPM::Metadata.fromString(xtrace)</code>
        </li>
      
        <li class="covered" data-hits="246" data-linenumber="145">
          <span class="hits">246</span>
          
          <code class="ruby">            AppOpticsAPM::Context.fromString(xtrace)</code>
        </li>
      
        <li class="covered" data-hits="246" data-linenumber="146">
          <span class="hits">246</span>
          
          <code class="ruby">            log_event(layer, :entry, md.createEvent, opts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">            # discard invalid incoming xtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">            # create a new context, ensuring sample bit set</code>
        </li>
      
        <li class="covered" data-hits="1717" data-linenumber="150">
          <span class="hits">1717</span>
          
          <code class="ruby">            md = AppOpticsAPM::Metadata.makeRandom(true)</code>
        </li>
      
        <li class="covered" data-hits="1717" data-linenumber="151">
          <span class="hits">1717</span>
          
          <code class="ruby">            AppOpticsAPM::Context.set(md)</code>
        </li>
      
        <li class="covered" data-hits="1717" data-linenumber="152">
          <span class="hits">1717</span>
          
          <code class="ruby">            log_event(layer, :entry, AppOpticsAPM::Event.startTrace(md), opts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">          # No, we&#39;re not sampling this request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">          # set the context but don&#39;t log the event</code>
        </li>
      
        <li class="covered" data-hits="212" data-linenumber="157">
          <span class="hits">212</span>
          
          <code class="ruby">          if xtrace_v2?(xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">            # continue valid incoming xtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">            # use it for current context, ensuring sample bit is not set</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="160">
          <span class="hits">6</span>
          
          <code class="ruby">            AppOpticsAPM::XTrace.unset_sampled(xtrace)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="161">
          <span class="hits">6</span>
          
          <code class="ruby">            AppOpticsAPM::Context.fromString(xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">            # discard invalid incoming xtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">            # create a new context, ensuring sample bit not set</code>
        </li>
      
        <li class="covered" data-hits="206" data-linenumber="165">
          <span class="hits">206</span>
          
          <code class="ruby">            md = AppOpticsAPM::Metadata.makeRandom(false)</code>
        </li>
      
        <li class="covered" data-hits="206" data-linenumber="166">
          <span class="hits">206</span>
          
          <code class="ruby">            AppOpticsAPM::Context.fromString(md.toString)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="2175" data-linenumber="169">
          <span class="hits">2175</span>
          
          <code class="ruby">        AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">      # Public: Report an exit event and potentially clear the tracing context.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">      # ==== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">      # * +layer+ - The layer the reported event belongs to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">      # * +opts+ - A hash containing key/value pairs that will be reported along with this event (optional).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">      # ==== Example</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">      #   AppOpticsAPM::API.log_end(:layer_name, { :id =&gt; @user.id })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">      # Returns an xtrace metadata string if we are tracing</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="185">
          <span class="hits">31</span>
          
          <code class="ruby">      def log_end(layer, opts = {})</code>
        </li>
      
        <li class="covered" data-hits="2190" data-linenumber="186">
          <span class="hits">2190</span>
          
          <code class="ruby">        return AppOpticsAPM::Context.toString unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1954" data-linenumber="188">
          <span class="hits">1954</span>
          
          <code class="ruby">        log_event(layer, :exit, AppOpticsAPM::Context.createEvent, opts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">      ensure</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">        # FIXME has_incoming_context commented out, it has importance for JRuby only but breaks Ruby tests</code>
        </li>
      
        <li class="covered" data-hits="2190" data-linenumber="191">
          <span class="hits">2190</span>
          
          <code class="ruby">        AppOpticsAPM::Context.clear # unless AppOpticsAPM.has_incoming_context?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">      # Public: Log an entry event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">      # A helper method to create and log an entry event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">      # ==== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">      # * +layer+ - The layer the reported event belongs to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">      # * +opts+ - A hash containing key/value pairs that will be reported along with this event (optional).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">      # * +op+ - To identify the current operation being traced.  Used to avoid double tracing recursive calls.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">      # ==== Example</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">      #   AppOpticsAPM::API.log_entry(:layer_name, { :id =&gt; @user.id })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">      # Returns an xtrace metadata string if we are tracing</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="210">
          <span class="hits">31</span>
          
          <code class="ruby">      def log_entry(layer, opts = {}, op = nil)</code>
        </li>
      
        <li class="covered" data-hits="5182" data-linenumber="211">
          <span class="hits">5182</span>
          
          <code class="ruby">        return AppOpticsAPM::Context.toString unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5137" data-linenumber="213">
          <span class="hits">5137</span>
          
          <code class="ruby">        AppOpticsAPM.layer_op = op.to_sym if op</code>
        </li>
      
        <li class="covered" data-hits="5137" data-linenumber="214">
          <span class="hits">5137</span>
          
          <code class="ruby">        log_event(layer, :entry, AppOpticsAPM::Context.createEvent, opts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">      # Public: Log an info event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">      # A helper method to create and log an info event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">      # ==== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">      # * +layer+ - The layer the reported event belongs to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">      # * +opts+ - A hash containing key/value pairs that will be reported along with this event (optional).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">      # ==== Example</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">      #   AppOpticsAPM::API.log_info(:layer_name, { :id =&gt; @user.id })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">      # Returns an xtrace metadata string if we are tracing</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="232">
          <span class="hits">31</span>
          
          <code class="ruby">      def log_info(layer, opts = {})</code>
        </li>
      
        <li class="covered" data-hits="868" data-linenumber="233">
          <span class="hits">868</span>
          
          <code class="ruby">        return AppOpticsAPM::Context.toString unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="746" data-linenumber="235">
          <span class="hits">746</span>
          
          <code class="ruby">        log_event(layer, :info, AppOpticsAPM::Context.createEvent, opts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">      # Public: Log an exit event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">      # A helper method to create and log an exit event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">      # ==== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">      # * +layer+ - The layer the reported event belongs to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">      # * +opts+  - A hash containing key/value pairs that will be reported along with this event (optional).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">      # * +op+    - Used to avoid double tracing recursive calls, needs to be true in +log_exit+ that corresponds to a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">      #   +log_entry+</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">      # ==== Example</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">      #   AppOpticsAPM::API.log_exit(:layer_name, { :id =&gt; @user.id })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">      # Returns an xtrace metadata string  if we are tracing</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="255">
          <span class="hits">31</span>
          
          <code class="ruby">      def log_exit(layer, opts = {}, op = nil)</code>
        </li>
      
        <li class="covered" data-hits="5252" data-linenumber="256">
          <span class="hits">5252</span>
          
          <code class="ruby">        return AppOpticsAPM::Context.toString unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5119" data-linenumber="258">
          <span class="hits">5119</span>
          
          <code class="ruby">        AppOpticsAPM.layer_op = nil if op</code>
        </li>
      
        <li class="covered" data-hits="5119" data-linenumber="259">
          <span class="hits">5119</span>
          
          <code class="ruby">        log_event(layer, :exit, AppOpticsAPM::Context.createEvent, opts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">      # Public: Log an exit event from multiple requests</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">      # A helper method to create and log an info event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">      # If we return from a request that faned out multiple requests</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">      # we can add the collected X-Traces to the exit event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">      # ==== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">      # * +layer+ - The layer the reported event belongs to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">      # * +traces+ - An array with X-Trace strings returned from the requests</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="274">
          <span class="hits">31</span>
          
          <code class="ruby">      def log_multi_exit(layer, traces)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="275">
          <span class="hits">24</span>
          
          <code class="ruby">        return AppOpticsAPM::Context.toString unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="276">
          <span class="hits">18</span>
          
          <code class="ruby">        task_id = AppOpticsAPM::XTrace.task_id(AppOpticsAPM::Context.toString)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="277">
          <span class="hits">18</span>
          
          <code class="ruby">        event = AppOpticsAPM::Context.createEvent</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="278">
          <span class="hits">18</span>
          
          <code class="ruby">        traces.each do |trace|</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="279">
          <span class="hits">18</span>
          
          <code class="ruby">          event.addEdgeStr(trace) if AppOpticsAPM::XTrace.task_id(trace) == task_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="281">
          <span class="hits">18</span>
          
          <code class="ruby">        log_event(layer, :exit, event)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">      #:nodoc:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">      # Internal: Reports agent init to the collector</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">      # ==== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">      # * +layer+ - The layer the reported event belongs to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">      # * +opts+ - A hash containing key/value pairs that will be reported along with this event</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="292">
          <span class="hits">31</span>
          
          <code class="ruby">      def log_init(layer = :rack, opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">        context = AppOpticsAPM::Metadata.makeRandom</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">        return AppOpticsAPM::Context.toString unless context.isValid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">        event = context.createEvent</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">        event.addInfo(APPOPTICS_STR_LAYER, layer.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">        event.addInfo(APPOPTICS_STR_LABEL, &#39;single&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">        opts.each do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="300">
          
          
          <code class="ruby">          event.addInfo(k, v.to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">        AppOpticsAPM::Reporter.sendStatus(event, context)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">        AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="307">
          <span class="hits">31</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">      #:nodoc:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">      # @private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">      # Internal: Report an event.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">      # ==== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">      # * +layer+ - The layer the reported event belongs to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">      # * +label+ - The label for the reported event.  See API documentation for reserved labels and usage.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">      # * +event+ - The pre-existing AppOpticsAPM context event.  See AppOpticsAPM::Context.createEvent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">      # * +opts+ - A hash containing key/value pairs that will be reported along with this event (optional).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">      # ==== Example</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">      #   entry = AppOpticsAPM::Context.createEvent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">      #   AppOpticsAPM::API.log_event(:layer_name, &#39;entry&#39;,  entry_event, { :id =&gt; @user.id })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">      #   exit_event = AppOpticsAPM::Context.createEvent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">      #   exit_event.addEdge(entry.getMetadata)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">      #   AppOpticsAPM::API.log_event(:layer_name, &#39;exit&#39;,  exit_event, { :id =&gt; @user.id })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="330">
          <span class="hits">31</span>
          
          <code class="ruby">      def log_event(layer, label, event, opts = {})</code>
        </li>
      
        <li class="covered" data-hits="15410" data-linenumber="331">
          <span class="hits">15410</span>
          
          <code class="ruby">        event.addInfo(APPOPTICS_STR_LAYER, layer.to_s.freeze) if layer</code>
        </li>
      
        <li class="covered" data-hits="15410" data-linenumber="332">
          <span class="hits">15410</span>
          
          <code class="ruby">        event.addInfo(APPOPTICS_STR_LABEL, label.to_s.freeze)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15410" data-linenumber="334">
          <span class="hits">15410</span>
          
          <code class="ruby">        AppOpticsAPM.layer = layer.to_sym if label == :entry</code>
        </li>
      
        <li class="covered" data-hits="15410" data-linenumber="335">
          <span class="hits">15410</span>
          
          <code class="ruby">        AppOpticsAPM.layer = nil          if label == :exit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">        opts.each do |k, v|</code>
        </li>
      
        <li class="covered" data-hits="49989" data-linenumber="338">
          <span class="hits">49989</span>
          
          <code class="ruby">          value = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="49989" data-linenumber="340">
          <span class="hits">49989</span>
          
          <code class="ruby">          next unless valid_key? k</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="49989" data-linenumber="342">
          <span class="hits">49989</span>
          
          <code class="ruby">          if @@ints_or_nil.include?(v.class)</code>
        </li>
      
        <li class="covered" data-hits="35924" data-linenumber="343">
          <span class="hits">35924</span>
          
          <code class="ruby">            value = v</code>
        </li>
      
        <li class="covered" data-hits="14065" data-linenumber="344">
          <span class="hits">14065</span>
          
          <code class="ruby">          elsif v.class == Set</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">            value = v.to_a.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="14065" data-linenumber="347">
          <span class="hits">14065</span>
          
          <code class="ruby">            value = v.to_s if v.respond_to?(:to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="49989" data-linenumber="350">
          <span class="hits">49989</span>
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="covered" data-hits="49989" data-linenumber="351">
          <span class="hits">49989</span>
          
          <code class="ruby">            event.addInfo(k.to_s, value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">          rescue ArgumentError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="353">
          
          
          <code class="ruby">            AppOpticsAPM.logger.debug &quot;[AppOpticsAPM/debug] Couldn&#39;t add event KV: #{k} =&gt; #{v.class}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">            AppOpticsAPM.logger.debug &quot;[AppOpticsAPM/debug] #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="15410" data-linenumber="356">
          <span class="hits">15410</span>
          
          <code class="ruby">        end if !opts.nil? &amp;&amp; opts.any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15410" data-linenumber="358">
          <span class="hits">15410</span>
          
          <code class="ruby">        AppOpticsAPM::Reporter.sendReport(event)</code>
        </li>
      
        <li class="covered" data-hits="15410" data-linenumber="359">
          <span class="hits">15410</span>
          
          <code class="ruby">        AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9247b5f32c513d90d1b10bce09b0ccdceb441f5e">
  <div class="header">
    <h3>lib/appoptics_apm/api/memcache.rb</h3>
    <h4><span class="red">56.25 %</span> covered</h4>
    <div>
      <b>16</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">#--</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#++</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"># TODO remove Memcache from API and into some Util module to be included in Modules that need</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"># ____ these methods</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="8">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="9">
          <span class="hits">31</span>
          
          <code class="ruby">  module API</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    # Utility methods for the Memcache instrumentation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    # currently used by dalli and memcached</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="13">
          <span class="hits">31</span>
          
          <code class="ruby">    module Memcache #:nodoc:</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="14">
          <span class="hits">31</span>
          
          <code class="ruby">      MEMCACHE_OPS = %w(add append cas decr decrement delete fetch get incr increment prepend replace set)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="16">
          <span class="hits">31</span>
          
          <code class="ruby">      def memcache_hit?(result)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="17">
          <span class="hits">9</span>
          
          <code class="ruby">        result.nil? ? 0 : 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="20">
          <span class="hits">31</span>
          
          <code class="ruby">      def remote_host(key)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="21">
          <span class="hits">17</span>
          
          <code class="ruby">        return unless defined?(Lib.memcached_server_by_key) &amp;&amp;</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="22">
          <span class="hits">34</span>
          
          <code class="ruby">                      defined?(@struct) &amp;&amp; defined?(is_unix_socket?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        server_as_array = Lib.memcached_server_by_key(@struct, key.to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        return unless server_as_array.is_a?(Array)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        server = server_as_array.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        if is_unix_socket?(server)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">          &#39;localhost&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        elsif defined?(server.hostname)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">          server.hostname</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b8d6fb6907d3b95844890563b636777bf40785a2">
  <div class="header">
    <h3>lib/appoptics_apm/api/profiling.rb</h3>
    <h4><span class="green">95.06 %</span> covered</h4>
    <div>
      <b>81</b> relevant lines. 
      <span class="green"><b>77</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">#--</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#++</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="6">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="7">
          <span class="hits">31</span>
          
          <code class="ruby">  module API</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # Module to create profiling traces for blocks of code or methods</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="10">
          <span class="hits">31</span>
          
          <code class="ruby">    module Profiling</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      # Public: Profile a given block of code. Detect any exceptions thrown by</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      # the block and report errors.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      # ==== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      # * +profile_name+ - A name used to identify the block being profiled.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      # * +report_kvs+ - A hash containing key/value pairs that will be reported along</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      #   with the event of this profile (optional).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      # * +with_backtrace+ - Boolean to indicate whether a backtrace should</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      #   be collected with this trace event.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      # ==== Example</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      #   def computation(n)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      #     AppOpticsAPM::API.profile(&#39;fib&#39;, { :n =&gt; n }) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      #       fib(n)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      #     end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      # Returns the result of the block.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="34">
          <span class="hits">31</span>
          
          <code class="ruby">      def profile(profile_name, report_kvs = {}, with_backtrace = false)</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="35">
          <span class="hits">51</span>
          
          <code class="ruby">        return yield unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="38">
          <span class="hits">48</span>
          
          <code class="ruby">          report_kvs[:Language] ||= :ruby</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="39">
          <span class="hits">48</span>
          
          <code class="ruby">          report_kvs[:ProfileName] ||= profile_name</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="40">
          <span class="hits">48</span>
          
          <code class="ruby">          report_kvs[:Backtrace] = AppOpticsAPM::API.backtrace if with_backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="42">
          <span class="hits">48</span>
          
          <code class="ruby">          AppOpticsAPM::API.log(nil, :profile_entry, report_kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="44">
          <span class="hits">48</span>
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="45">
          <span class="hits">48</span>
          
          <code class="ruby">            yield</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">          rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">            log_exception(nil, e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">            raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">          ensure</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="50">
          <span class="hits">48</span>
          
          <code class="ruby">            exit_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="51">
          <span class="hits">48</span>
          
          <code class="ruby">            exit_kvs[:Language] = :ruby</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="52">
          <span class="hits">48</span>
          
          <code class="ruby">            exit_kvs[:ProfileName] = report_kvs[:ProfileName]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="54">
          <span class="hits">48</span>
          
          <code class="ruby">            AppOpticsAPM::API.log(nil, :profile_exit, exit_kvs)</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="55">
          <span class="hits">32</span>
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      # Public: Add profiling to a method on a class or module.  That method can be of any (accessible)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      # type (instance, singleton, private, protected etc.).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      # ==== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      # * +klass+  - the class or module that has the method to profile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      # * +method+ - the method to profile.  Can be singleton, instance, private etc...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      # * +opts+   - a hash specifying the one or more of the following options:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      #   * +:arguments+  - report the arguments passed to &lt;tt&gt;method&lt;/tt&gt; on each profile (default: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      #   * +:result+     - report the return value of &lt;tt&gt;method&lt;/tt&gt; on each profile (default: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      #   * +:backtrace+  - report the return value of &lt;tt&gt;method&lt;/tt&gt; on each profile (default: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      #   * +:name+       - alternate name for the profile reported in the dashboard (default: method name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      # * +extra_kvs+ - a hash containing any additional key/value pairs you would like reported with the profile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      # ==== Example</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      #   opts = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      #   opts[:backtrace] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      #   opts[:arguments] = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      #   opts[:name] = :array_sort</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      #   AppOpticsAPM::API.profile_method(Array, :sort, opts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="83">
          <span class="hits">31</span>
          
          <code class="ruby">      def profile_method(klass, method, opts = {}, extra_kvs = {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">        # If we&#39;re on an unsupported platform (ahem Mac), just act</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        # like we did something to nicely play the no-op part.</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="86">
          <span class="hits">67</span>
          
          <code class="ruby">        return true unless AppOpticsAPM.loaded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="64" data-linenumber="88">
          <span class="hits">64</span>
          
          <code class="ruby">        if !klass.is_a?(Module)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="89">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM.logger.warn &quot;[appoptics_apm/error] profile_method: Not sure what to do with #{klass}.  Send a class or module.&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="90">
          <span class="hits">3</span>
          
          <code class="ruby">          return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="92">
          <span class="hits">61</span>
          
          <code class="ruby">        elsif !method.is_a?(Symbol)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="93">
          <span class="hits">3</span>
          
          <code class="ruby">          if method.is_a?(String)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">            method = method.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="96">
          <span class="hits">3</span>
          
          <code class="ruby">            AppOpticsAPM.logger.warn &quot;[appoptics_apm/error] profile_method: Not sure what to do with #{method}.  Send a string or symbol for method.&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="97">
          <span class="hits">3</span>
          
          <code class="ruby">            return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="101">
          <span class="hits">58</span>
          
          <code class="ruby">        instance_method = klass.instance_methods.include?(method) || klass.private_instance_methods.include?(method)</code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="102">
          <span class="hits">58</span>
          
          <code class="ruby">        class_method = klass.singleton_methods.include?(method)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">        # Make sure the request klass::method exists</code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="105">
          <span class="hits">58</span>
          
          <code class="ruby">        if !instance_method &amp;&amp; !class_method</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="106">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM.logger.warn &quot;[appoptics_apm/error] profile_method: Can&#39;t instrument #{klass}.#{method} as it doesn&#39;t seem to exist.&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="107">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM.logger.warn &quot;[appoptics_apm/error] #{__FILE__}:#{__LINE__}&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="108">
          <span class="hits">3</span>
          
          <code class="ruby">          return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        # Strip &#39;!&#39; or &#39;?&#39; from method if present</code>
        </li>
      
        <li class="covered" data-hits="55" data-linenumber="112">
          <span class="hits">55</span>
          
          <code class="ruby">        safe_method_name = method.to_s.chop if method.to_s =~ /\?$|\!$/</code>
        </li>
      
        <li class="covered" data-hits="55" data-linenumber="113">
          <span class="hits">55</span>
          
          <code class="ruby">        safe_method_name ||= method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="55" data-linenumber="115">
          <span class="hits">55</span>
          
          <code class="ruby">        without_appoptics = &quot;#{safe_method_name}_without_appoptics&quot;</code>
        </li>
      
        <li class="covered" data-hits="55" data-linenumber="116">
          <span class="hits">55</span>
          
          <code class="ruby">        with_appoptics    = &quot;#{safe_method_name}_with_appoptics&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        # Check if already profiled</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="119">
          <span class="hits">18</span>
          
          <code class="ruby">        if klass.instance_methods.include?(with_appoptics.to_sym) ||</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="120">
          <span class="hits">37</span>
          
          <code class="ruby">           klass.singleton_methods.include?(with_appoptics.to_sym)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="121">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM.logger.warn &quot;[appoptics_apm/error] profile_method: #{klass}::#{method} already profiled.&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="122">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM.logger.warn &quot;[appoptics_apm/error] profile_method: #{__FILE__}:#{__LINE__}&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="123">
          <span class="hits">3</span>
          
          <code class="ruby">          return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="126">
          <span class="hits">52</span>
          
          <code class="ruby">        source_location = []</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="127">
          <span class="hits">52</span>
          
          <code class="ruby">        if instance_method</code>
        </li>
      
        <li class="covered" data-hits="40" data-linenumber="128">
          <span class="hits">40</span>
          
          <code class="ruby">          ::AppOpticsAPM::Util.send_include(klass, ::AppOpticsAPM::MethodProfiling)</code>
        </li>
      
        <li class="covered" data-hits="40" data-linenumber="129">
          <span class="hits">40</span>
          
          <code class="ruby">          source_location = klass.instance_method(method).source_location</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="130">
          <span class="hits">12</span>
          
          <code class="ruby">        elsif class_method</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="131">
          <span class="hits">12</span>
          
          <code class="ruby">          ::AppOpticsAPM::Util.send_extend(klass, ::AppOpticsAPM::MethodProfiling)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="132">
          <span class="hits">12</span>
          
          <code class="ruby">          source_location = klass.method(method).source_location</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="135">
          <span class="hits">52</span>
          
          <code class="ruby">        report_kvs = collect_profile_kvs(klass, method, opts, extra_kvs, source_location)</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="136">
          <span class="hits">52</span>
          
          <code class="ruby">        report_kvs[:MethodName] = safe_method_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="138">
          <span class="hits">52</span>
          
          <code class="ruby">        if instance_method</code>
        </li>
      
        <li class="covered" data-hits="40" data-linenumber="139">
          <span class="hits">40</span>
          
          <code class="ruby">          klass.class_eval do</code>
        </li>
      
        <li class="covered" data-hits="40" data-linenumber="140">
          <span class="hits">40</span>
          
          <code class="ruby">            define_method(with_appoptics) do |*args, &amp;block|</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="141">
          <span class="hits">50</span>
          
          <code class="ruby">              profile_wrapper(without_appoptics, report_kvs, opts, *args, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="40" data-linenumber="144">
          <span class="hits">40</span>
          
          <code class="ruby">            alias_method without_appoptics, method.to_s</code>
        </li>
      
        <li class="covered" data-hits="40" data-linenumber="145">
          <span class="hits">40</span>
          
          <code class="ruby">            alias_method method.to_s, with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="147">
          <span class="hits">12</span>
          
          <code class="ruby">        elsif class_method</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="148">
          <span class="hits">12</span>
          
          <code class="ruby">          klass.define_singleton_method(with_appoptics) do |*args, &amp;block|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="149">
          <span class="hits">12</span>
          
          <code class="ruby">            profile_wrapper(without_appoptics, report_kvs, opts, *args, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="152">
          <span class="hits">12</span>
          
          <code class="ruby">          klass.singleton_class.class_eval do</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="153">
          <span class="hits">12</span>
          
          <code class="ruby">            alias_method without_appoptics, method.to_s</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="154">
          <span class="hits">12</span>
          
          <code class="ruby">            alias_method method.to_s, with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="157">
          <span class="hits">52</span>
          
          <code class="ruby">        true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="160">
          <span class="hits">31</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      # Private: Helper method to aggregate KVs to report</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">      # klass  - the class or module that has the method to profile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">      # method - the method to profile.  Can be singleton, instance, private etc...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">      # opts   - a hash specifying the one or more of the following options:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">      #   * :arguments  - report the arguments passed to &lt;tt&gt;method&lt;/tt&gt; on each profile (default: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">      #   * :result     - report the return value of &lt;tt&gt;method&lt;/tt&gt; on each profile (default: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      #   * :backtrace  - report the return value of &lt;tt&gt;method&lt;/tt&gt; on each profile (default: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">      #   * :name       - alternate name for the profile reported in the dashboard (default: method name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">      # extra_kvs - a hash containing any additional KVs you would like reported with the profile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">      # source_location - array returned from klass.method(:name).source_location</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="175">
          <span class="hits">31</span>
          
          <code class="ruby">      def collect_profile_kvs(klass, method, opts, extra_kvs, source_location)</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="176">
          <span class="hits">52</span>
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="177">
          <span class="hits">52</span>
          
          <code class="ruby">        report_kvs[:Language] ||= :ruby</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="178">
          <span class="hits">52</span>
          
          <code class="ruby">        report_kvs[:ProfileName] ||= opts[:name] ? opts[:name] : method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="180">
          <span class="hits">52</span>
          
          <code class="ruby">        if klass.is_a?(Class)</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="181">
          <span class="hits">46</span>
          
          <code class="ruby">          report_kvs[:Class] = klass.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="183">
          <span class="hits">6</span>
          
          <code class="ruby">          report_kvs[:Module] = klass.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        # If this is a Rails Controller, report the KVs</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="187">
          <span class="hits">52</span>
          
          <code class="ruby">        if defined?(::AbstractController::Base) &amp;&amp; klass.ancestors.include?(::AbstractController::Base)</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="188">
          <span class="hits">13</span>
          
          <code class="ruby">          report_kvs[:Controller] = klass.to_s</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="189">
          <span class="hits">13</span>
          
          <code class="ruby">          report_kvs[:Action] = method.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">        # We won&#39;t have access to this info for native methods (those not defined in Ruby).</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="193">
          <span class="hits">52</span>
          
          <code class="ruby">        if source_location.is_a?(Array) &amp;&amp; source_location.length == 2</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="194">
          <span class="hits">52</span>
          
          <code class="ruby">          report_kvs[:File] = source_location[0]</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="195">
          <span class="hits">52</span>
          
          <code class="ruby">          report_kvs[:LineNumber] = source_location[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">        # Merge in any extra_kvs requested</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="199">
          <span class="hits">52</span>
          
          <code class="ruby">        report_kvs.merge!(extra_kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ed757c653b4c19d7cf2632a3c3081b0c039c2644">
  <div class="header">
    <h3>lib/appoptics_apm/api/tracing.rb</h3>
    <h4><span class="red">69.77 %</span> covered</h4>
    <div>
      <b>43</b> relevant lines. 
      <span class="green"><b>30</b> lines covered</span> and
      <span class="red"><b>13</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">#--</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#++</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="6">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="7">
          <span class="hits">31</span>
          
          <code class="ruby">  module API</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # Provides the higher-level tracing interface for the API.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    # Traces are best created with a &lt;tt&gt;AppOpticsAPM:API.start_trace&lt;/tt&gt; block and</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    # &lt;tt&gt;AppOpticsAPM:API.trace&lt;/tt&gt; blocks around calls to be traced.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    # These two methods guarantee proper nesting of tracing and handling of the tracing context.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # Some optional keys that can be used in the +opts+ hash:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # * +:TransactionName+ - this will show up in the transactions column in the traces dashboard</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    # * +:Controller+ - if present will be combined with +Action+ and show up as transaction in the traces dashboard</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    # * +:Action+ - if present will be combined with +Controller+ and show up as transaction in the traces dashboard</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # * +:HTTP-Host+ - domain portion of URL</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    # * +:URL+ - request URI</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    # * +:Method+</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    # TODO complete the above</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    # Invalid keys: +:Label+, +:Layer+, +:Edge+, +:Timestamp+, +:Timestamp_u+</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="27">
          <span class="hits">31</span>
          
          <code class="ruby">    module Tracing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      # Public: Trace a given block of code. Detect any exceptions thrown by</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      # the block and report errors.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      # This method will create a single span within a traced transaction.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      # Make sure a trace has been started, when calling trace(), see start_trace()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      # * +:layer+ - The layer the block of code belongs to.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      # * +:opts+ - A hash containing key/value pairs that will be reported along</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      #   with the first event of this layer (optional).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      # * +:protect_op+ - The operation being traced.  Used to avoid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      #   double tracing operations that call each other</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      # Example</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      #   def computation(n)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      #     fib(n)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      #     raise Exception.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      #   def computation_with_trace(n)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      #     trace(&#39;fib&#39;, { :number =&gt; n }, :fib) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      #       computation(n)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      #     end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      #   result = computation_with_oboe(1000)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      # Returns the result of the block.</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="55">
          <span class="hits">31</span>
          
          <code class="ruby">      def trace(layer, opts = {}, protect_op = nil)</code>
        </li>
      
        <li class="covered" data-hits="565" data-linenumber="56">
          <span class="hits">565</span>
          
          <code class="ruby">        return if !AppOpticsAPM.loaded || (protect_op &amp;&amp; AppOpticsAPM.layer_op == protect_op.to_sym)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="556" data-linenumber="58">
          <span class="hits">556</span>
          
          <code class="ruby">        log_entry(layer, opts, protect_op)</code>
        </li>
      
        <li class="covered" data-hits="556" data-linenumber="59">
          <span class="hits">556</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="556" data-linenumber="60">
          <span class="hits">556</span>
          
          <code class="ruby">          yield</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="61">
          <span class="hits">6</span>
          
          <code class="ruby">        rescue Exception =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="62">
          <span class="hits">6</span>
          
          <code class="ruby">          log_exception(layer, e)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="63">
          <span class="hits">6</span>
          
          <code class="ruby">          raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="556" data-linenumber="65">
          <span class="hits">556</span>
          
          <code class="ruby">          log_exit(layer, opts, protect_op)</code>
        </li>
      
        <li class="covered" data-hits="380" data-linenumber="66">
          <span class="hits">380</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      # Public: Start a trace around a given block of code (Note: Not every transaction will be traced,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      # tracing depends on client-side configuration and sampling decision returned by the collector)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      # Detect any exceptions thrown by the block and report errors.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      # When start_trace returns control to the calling context, the oboe</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      # context will be cleared.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      # ==== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      # * +layer+  - name for the layer to be used as label in the trace view</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      # * +xtrace+ - (optional) incoming X-Trace identifier to be continued</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      # * +opts+   - (optional) hash containing key/value pairs that will be reported along</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      #   with the first event of this layer (optional)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      # ==== Example</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      #   def handle_request(request, response)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      #     # ... code that modifies request and response ...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">      #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">      #   def handle_request_with_appoptics(request, response)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      #     result, xtrace = start_trace(&#39;rails&#39;, request[&#39;X-Trace&#39;]) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      #       handle_request(request, response)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      #     end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      #     result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      #   rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      #     xtrace = e.xtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">      #   ensure</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">      #     response[&#39;X-trace&#39;] = xtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      # Returns a list of length two, the first element of which is the result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      # of the block, and the second element of which is the oboe context that</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">      # was set when the block completed execution.</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="103">
          <span class="hits">31</span>
          
          <code class="ruby">      def start_trace(layer, xtrace = nil, opts = {})</code>
        </li>
      
        <li class="covered" data-hits="1403" data-linenumber="104">
          <span class="hits">1403</span>
          
          <code class="ruby">        return [yield, nil] unless AppOpticsAPM.loaded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1400" data-linenumber="106">
          <span class="hits">1400</span>
          
          <code class="ruby">        log_start(layer, xtrace, opts)</code>
        </li>
      
        <li class="covered" data-hits="1400" data-linenumber="107">
          <span class="hits">1400</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="1400" data-linenumber="108">
          <span class="hits">1400</span>
          
          <code class="ruby">          result = yield</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">        rescue Exception =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="110">
          <span class="hits">28</span>
          
          <code class="ruby">          log_exception(layer, e)</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="111">
          <span class="hits">28</span>
          
          <code class="ruby">          e.instance_variable_set(:@xtrace, log_end(layer))</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="112">
          <span class="hits">28</span>
          
          <code class="ruby">          raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1372" data-linenumber="114">
          <span class="hits">1372</span>
          
          <code class="ruby">        xtrace = log_end(layer)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1372" data-linenumber="116">
          <span class="hits">1372</span>
          
          <code class="ruby">        [result, xtrace]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      # Public: Trace a given block of code which can start a trace depending</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      # on configuration and probability. Detect any exceptions thrown by the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      # block and report errors. Assign an X-Trace to the target.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      # The motivating use case for this is HTTP streaming in rails3. We need</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">      # access to the exit event&#39;s trace id so we can set the header before any</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">      # work is done, and before any headers are sent back to the client.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">      # ===== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">      # * +layer+ - The layer the block of code belongs to.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      # * +xtrace+ - string - The X-Trace to continue by the target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">      # * +target+ - has to respond to #[]=, The target object in which to place the trace information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">      # * +opts+ - A hash containing key/value pairs that will be reported along</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      #   with the first event of this layer (optional).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">      # ==== Example</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      #   def handle_request(request, response)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">      #     # ... code that does something with request and response ...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">      #   def handle_request_with_appoptics(request, response)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">      #     start_trace_with_target(&#39;rails&#39;, request[&#39;X-Trace&#39;], response) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">      #       handle_request(request, response)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">      #     end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      # Returns the result of the block.</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="147">
          <span class="hits">31</span>
          
          <code class="ruby">      def start_trace_with_target(layer, xtrace, target, opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">        return yield unless AppOpticsAPM.loaded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">        log_start(layer, xtrace, opts)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">        exit_evt = AppOpticsAPM::Context.createEvent</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">          target[&#39;X-Trace&#39;] = AppOpticsAPM::EventUtil.metadataString(exit_evt) if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">          yield</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">        rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">          log_exception(layer, e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">          raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">          exit_evt.addEdge(AppOpticsAPM::Context.get)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">          log(layer, :exit, {}, exit_evt)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">          AppOpticsAPM::Context.clear</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">      # Public: Set a ThreadLocal custom transaction name to be used when sending a trace or metrics for the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">      # current transaction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">      # In addition to setting a transaction name here there is also a configuration</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">      # AppOpticsAPM::Config[&#39;transaction_name&#39;][&#39;prepend_domain&#39;] which allows to have the domain prepended</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      # to the transaction name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">      # ===== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">      # * +name+ - A non-empty string with the custom transaction name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="175">
          <span class="hits">31</span>
          
          <code class="ruby">      def set_transaction_name(name)</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="176">
          <span class="hits">87</span>
          
          <code class="ruby">        if name.is_a?(String) &amp;&amp; name.strip != &#39;&#39;</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="177">
          <span class="hits">63</span>
          
          <code class="ruby">          AppOpticsAPM.transaction_name = name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="179">
          <span class="hits">24</span>
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/api] Could not set transaction name, provided name is empty or not a String.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="181">
          <span class="hits">87</span>
          
          <code class="ruby">        AppOpticsAPM.transaction_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">      # this is provided for testing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">      # returns the current transaction name</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="187">
          <span class="hits">31</span>
          
          <code class="ruby">      def get_transaction_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">        AppOpticsAPM.transaction_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="28b282b470cb6cc7f956d0883a93ece8791df1a4">
  <div class="header">
    <h3>lib/appoptics_apm/api/util.rb</h3>
    <h4><span class="green">91.3 %</span> covered</h4>
    <div>
      <b>46</b> relevant lines. 
      <span class="green"><b>42</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">#--</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#++</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="6">
          <span class="hits">31</span>
          
          <code class="ruby">require &#39;pp&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="8">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="9">
          <span class="hits">31</span>
          
          <code class="ruby">  module API</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    # General utility methods for the gem</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="12">
          <span class="hits">31</span>
          
          <code class="ruby">    module Util #:nodoc:</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="13">
          <span class="hits">31</span>
          
          <code class="ruby">      BACKTRACE_CUTOFF = 200</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      # Internal: Check whether the provided key is reserved or not. Reserved</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      # keys are either keys that are handled by liboboe calls or the appoptics_apm gem.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      # key - the key to check.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      # Return a boolean indicating whether or not key is reserved.</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="21">
          <span class="hits">31</span>
          
          <code class="ruby">      def valid_key?(key)</code>
        </li>
      
        <li class="covered" data-hits="49989" data-linenumber="22">
          <span class="hits">49989</span>
          
          <code class="ruby">        ![:Label, :Layer, :Edge, :Timestamp, :Timestamp_u].include?(key.to_sym)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      # Internal: Get the current backtrace.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      # ignore - Number of frames to ignore at the top of the backtrace. Use</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      #          when you know how many layers deep in the key call is being</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      #          made.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      # Returns a string with each frame of the backtrace separated by &#39;\r\n&#39;.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="33">
          <span class="hits">31</span>
          
          <code class="ruby">      def backtrace(ignore = 0)</code>
        </li>
      
        <li class="covered" data-hits="765" data-linenumber="34">
          <span class="hits">765</span>
          
          <code class="ruby">        bt = Kernel.caller</code>
        </li>
      
        <li class="covered" data-hits="765" data-linenumber="35">
          <span class="hits">765</span>
          
          <code class="ruby">        bt.slice!(0, ignore)</code>
        </li>
      
        <li class="covered" data-hits="765" data-linenumber="36">
          <span class="hits">765</span>
          
          <code class="ruby">        trim_backtrace(bt).join(&quot;\r\n&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      # Internal: Trim a backtrace to a manageable size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      # backtrace - the backtrace (an array of stack frames/from Kernel.caller)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      # Returns a trimmed backtrace</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="44">
          <span class="hits">31</span>
          
          <code class="ruby">      def trim_backtrace(backtrace)</code>
        </li>
      
        <li class="covered" data-hits="765" data-linenumber="45">
          <span class="hits">765</span>
          
          <code class="ruby">        return backtrace unless backtrace.is_a?(Array)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="765" data-linenumber="47">
          <span class="hits">765</span>
          
          <code class="ruby">        length = backtrace.size</code>
        </li>
      
        <li class="covered" data-hits="765" data-linenumber="48">
          <span class="hits">765</span>
          
          <code class="ruby">        if length &gt; BACKTRACE_CUTOFF</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">          # Trim backtraces by getting the first 180 and last 20 lines</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">          trimmed = backtrace[0, 180] + [&#39;...[snip]...&#39;] + backtrace[length - 20, 20]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="765" data-linenumber="52">
          <span class="hits">765</span>
          
          <code class="ruby">          trimmed = backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="765" data-linenumber="54">
          <span class="hits">765</span>
          
          <code class="ruby">        trimmed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      # Internal: Check if a host is blacklisted from tracing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      # addr_port - the addr_port from Net::HTTP although this method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      # can be used from any component in reality</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      # Returns a boolean on blacklisted state</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="63">
          <span class="hits">31</span>
          
          <code class="ruby">      def blacklisted?(addr_port)</code>
        </li>
      
        <li class="covered" data-hits="1484" data-linenumber="64">
          <span class="hits">1484</span>
          
          <code class="ruby">        return false unless AppOpticsAPM::Config.blacklist</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        # Ensure that the blacklist is an array</code>
        </li>
      
        <li class="covered" data-hits="1484" data-linenumber="67">
          <span class="hits">1484</span>
          
          <code class="ruby">        unless AppOpticsAPM::Config.blacklist.is_a?(Array)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">          val = AppOpticsAPM::Config[:blacklist]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">          AppOpticsAPM::Config[:blacklist] = [val.to_s]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1484" data-linenumber="72">
          <span class="hits">1484</span>
          
          <code class="ruby">        AppOpticsAPM::Config.blacklist.each do |h|</code>
        </li>
      
        <li class="covered" data-hits="120" data-linenumber="73">
          <span class="hits">120</span>
          
          <code class="ruby">          return true if addr_port.to_s.match(h.to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1364" data-linenumber="76">
          <span class="hits">1364</span>
          
          <code class="ruby">        false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      # Internal: Pretty print a list of arguments for reporting</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      # args - the list of arguments to work on</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      # Returns a pretty string representation of arguments</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="84">
          <span class="hits">31</span>
          
          <code class="ruby">      def pps(*args)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="85">
          <span class="hits">12</span>
          
          <code class="ruby">        old_out = $stdout</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="86">
          <span class="hits">12</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="87">
          <span class="hits">12</span>
          
          <code class="ruby">          s = StringIO.new</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="88">
          <span class="hits">12</span>
          
          <code class="ruby">          $stdout = s</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="89">
          <span class="hits">12</span>
          
          <code class="ruby">          pp(*args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="91">
          <span class="hits">12</span>
          
          <code class="ruby">          $stdout = old_out</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="93">
          <span class="hits">12</span>
          
          <code class="ruby">        s.string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">      # Internal: Determine a string to report representing klass</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      # args - an instance of a Class, a Class or a Module</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      # Returns a string representation of klass</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="101">
          <span class="hits">31</span>
          
          <code class="ruby">      def get_class_name(klass)</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="102">
          <span class="hits">30</span>
          
          <code class="ruby">        kv = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="104">
          <span class="hits">30</span>
          
          <code class="ruby">        if klass.to_s =~ /::/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">          klass.class.to_s.rpartition(&#39;::&#39;).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="107">
          <span class="hits">30</span>
          
          <code class="ruby">          if klass.is_a?(Class) &amp;&amp; klass.is_a?(Module)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">            # Class</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="109">
          <span class="hits">18</span>
          
          <code class="ruby">            kv[&#39;Class&#39;] = klass.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="111">
          <span class="hits">12</span>
          
          <code class="ruby">          elsif !klass.is_a?(Class) &amp;&amp; !klass.is_a?(Module)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">            # Class instance</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="113">
          <span class="hits">6</span>
          
          <code class="ruby">            kv[&#39;Class&#39;] = klass.class.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">            # Module</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="117">
          <span class="hits">6</span>
          
          <code class="ruby">            kv[&#39;Module&#39;] = klass.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="120">
          <span class="hits">30</span>
          
          <code class="ruby">        kv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="123">
          <span class="hits">31</span>
          
          <code class="ruby">      def xtrace_v2?(xtr)</code>
        </li>
      
        <li class="covered" data-hits="2175" data-linenumber="124">
          <span class="hits">2175</span>
          
          <code class="ruby">        return xtr &amp;&amp; xtr.start_with?(&#39;2B&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="60b289b61e06064ddbe39c8b0625cd77a5a22f2b">
  <div class="header">
    <h3>lib/appoptics_apm/base.rb</h3>
    <h4><span class="red">73.03 %</span> covered</h4>
    <div>
      <b>89</b> relevant lines. 
      <span class="green"><b>65</b> lines covered</span> and
      <span class="red"><b>24</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># Constants from liboboe</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="5">
          <span class="hits">31</span>
          
          <code class="ruby">OBOE_TRACE_NEVER   = 0</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="6">
          <span class="hits">31</span>
          
          <code class="ruby">OBOE_TRACE_ALWAYS  = 1</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="7">
          <span class="hits">31</span>
          
          <code class="ruby">OBOE_TRACE_THROUGH = 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="9">
          <span class="hits">31</span>
          
          <code class="ruby">OBOE_SAMPLE_RATE_SOURCE_FILE                   = 1</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="10">
          <span class="hits">31</span>
          
          <code class="ruby">OBOE_SAMPLE_RATE_SOURCE_DEFAULT                = 2</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="11">
          <span class="hits">31</span>
          
          <code class="ruby">OBOE_SAMPLE_RATE_SOURCE_OBOE                   = 3</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="12">
          <span class="hits">31</span>
          
          <code class="ruby">OBOE_SAMPLE_RATE_SOURCE_LAST_OBOE              = 4</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="13">
          <span class="hits">31</span>
          
          <code class="ruby">OBOE_SAMPLE_RATE_SOURCE_DEFAULT_MISCONFIGURED  = 5</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="14">
          <span class="hits">31</span>
          
          <code class="ruby">OBOE_SAMPLE_RATE_SOURCE_OBOE_DEFAULT           = 6</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"># Masks for bitwise ops</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="17">
          <span class="hits">31</span>
          
          <code class="ruby">ZERO_MASK = 0b0000000000000000000000000000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="19">
          <span class="hits">31</span>
          
          <code class="ruby">SAMPLE_RATE_MASK   = 0b0000111111111111111111111111</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="20">
          <span class="hits">31</span>
          
          <code class="ruby">SAMPLE_SOURCE_MASK = 0b1111000000000000000000000000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="22">
          <span class="hits">31</span>
          
          <code class="ruby">ZERO_SAMPLE_RATE_MASK   = 0b1111000000000000000000000000</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="23">
          <span class="hits">31</span>
          
          <code class="ruby">ZERO_SAMPLE_SOURCE_MASK = 0b0000111111111111111111111111</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="25">
          <span class="hits">31</span>
          
          <code class="ruby">APPOPTICS_STR_BLANK = &#39;&#39;.freeze</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="26">
          <span class="hits">31</span>
          
          <code class="ruby">APPOPTICS_STR_LAYER = &#39;Layer&#39;.freeze</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="27">
          <span class="hits">31</span>
          
          <code class="ruby">APPOPTICS_STR_LABEL = &#39;Label&#39;.freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"># Used in tests to store local trace data</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="30">
          <span class="hits">31</span>
          
          <code class="ruby">TRACE_FILE = &#39;/tmp/appoptics_traces.bson&#39;.freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"># This module is the base module for the various implementations of AppOpticsAPM reporting.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"># Current variations as of 2014-09-10 are a c-extension, JRuby (using AppOpticsAPM Java</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"># instrumentation) and a Heroku c-extension (with embedded tracelyzer)</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="36">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPMBase</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="37">
          <span class="hits">31</span>
          
          <code class="ruby">  extend ::AppOpticsAPM::ThreadLocal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="39">
          <span class="hits">31</span>
          
          <code class="ruby">  attr_accessor :reporter</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="40">
          <span class="hits">31</span>
          
          <code class="ruby">  attr_accessor :loaded</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="41">
          <span class="hits">31</span>
          
          <code class="ruby">  thread_local :sample_source</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="42">
          <span class="hits">31</span>
          
          <code class="ruby">  thread_local :sample_rate</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="43">
          <span class="hits">31</span>
          
          <code class="ruby">  thread_local :layer</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="44">
          <span class="hits">31</span>
          
          <code class="ruby">  thread_local :layer_op</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  # transaction_name is used for custom transaction naming</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  # It needs to be globally accessible, but is only set by the request processors of the different frameworks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  # and read by rack</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="49">
          <span class="hits">31</span>
          
          <code class="ruby">  thread_local :transaction_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  # Semaphore used during the test suite to test</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  # global config options.</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="53">
          <span class="hits">31</span>
          
          <code class="ruby">  thread_local :config_lock</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  # The following accessors indicate the incoming tracing state received</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  # by the rack layer.  These are primarily used to identify state</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  # between the Ruby and JAppOpticsAPM instrumentation under JRuby.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  # This is because that even though there may be an incoming</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  # X-Trace request header, tracing may have already been started</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  # by Joboe.  Such a scenario occurs when the application is being</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  # hosted by a Java container (such as Tomcat or Glassfish) and</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  # AppOpticsAPM has already initiated tracing.  In this case, we shouldn&#39;t</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  # pickup the X-Trace context in the X-Trace header and we shouldn&#39;t</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  # set the outgoing response X-Trace header or clear context.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  # Yeah I know.  Yuck.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  # Occurs only on Jruby.  Indicates that Joboe (the java instrumentation)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  # has already started tracing before it hit the JRuby instrumentation.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  # It is used in Rack#call if there is a context when entering rack</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="71">
          <span class="hits">31</span>
          
          <code class="ruby">  thread_local :has_incoming_context</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  # Indicates the existence of a valid X-Trace request header</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="74">
          <span class="hits">31</span>
          
          <code class="ruby">  thread_local :has_xtrace_header</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  # This indicates that this trace was continued from</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  # an incoming X-Trace request header or in the case</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  # of JRuby, a trace already started by JAppOpticsAPM.</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="79">
          <span class="hits">31</span>
          
          <code class="ruby">  thread_local :is_continued_trace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  # extended</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  # Invoked when this module is extended.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">  # e.g. extend AppOpticsAPMBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="87">
          <span class="hits">31</span>
          
          <code class="ruby">  def self.extended(cls)</code>
        </li>
      
        <li class="covered" data-hits="90" data-linenumber="88">
          <span class="hits">90</span>
          
          <code class="ruby">    cls.loaded = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    # This gives us pretty accessors with questions marks at the end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    # e.g. is_continued_trace --&gt; is_continued_trace?</code>
        </li>
      
        <li class="covered" data-hits="19539" data-linenumber="92">
          <span class="hits">19539</span>
          
          <code class="ruby">    AppOpticsAPM.methods.select { |m| m =~ /^is_|^has_/ }.each do |c|</code>
        </li>
      
        <li class="covered" data-hits="807" data-linenumber="93">
          <span class="hits">807</span>
          
          <code class="ruby">      unless c =~ /\?$|=$/</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">        # AppOpticsAPM.logger.debug &quot;aliasing #{c}? to #{c}&quot;</code>
        </li>
      
        <li class="covered" data-hits="270" data-linenumber="95">
          <span class="hits">270</span>
          
          <code class="ruby">        alias_method &quot;#{c}?&quot;, c</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">  # pickup_context</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">  # for JRUBY</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  # Determines whether we should pickup context</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">  # from an incoming X-Trace request header.  The answer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  # is generally yes but there are cases in JRuby under</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  # Tomcat (or Glassfish etc.) where tracing may have</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">  # been already started by the Java instrumentation (Joboe)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">  # in which case we don&#39;t want to do this.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="111">
          <span class="hits">31</span>
          
          <code class="ruby">  def pickup_context?(xtrace)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">    return false unless AppOpticsAPM::XTrace.valid?(xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    if defined?(JRUBY_VERSION) &amp;&amp; AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">      return true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">  # tracing_layer?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">  # Queries the thread local variable about the current</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">  # layer being traced.  This is used in cases of recursive</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">  # operation tracing or one instrumented operation calling another.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="128">
          <span class="hits">31</span>
          
          <code class="ruby">  def tracing_layer?(layer)</code>
        </li>
      
        <li class="covered" data-hits="339" data-linenumber="129">
          <span class="hits">339</span>
          
          <code class="ruby">    AppOpticsAPM.layer == layer.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">  # tracing_layer_op?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  # Queries the thread local variable about the current</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">  # operation being traced.  This is used in cases of recursive</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">  # operation tracing or one instrumented operation calling another.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">  # &lt;operation&gt; can be a single symbol or an array of symbols that</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  # will be checked against.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  # In such cases, we only want to trace the outermost operation.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="144">
          <span class="hits">31</span>
          
          <code class="ruby">  def tracing_layer_op?(operation)</code>
        </li>
      
        <li class="covered" data-hits="156" data-linenumber="145">
          <span class="hits">156</span>
          
          <code class="ruby">    if operation.is_a?(Array)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="146">
          <span class="hits">9</span>
          
          <code class="ruby">      operation.include?(AppOpticsAPM.layer_op)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="147" data-linenumber="148">
          <span class="hits">147</span>
          
          <code class="ruby">      AppOpticsAPM.layer_op == operation.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">  # Returns true if the tracing_mode is set to always.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">  # False otherwise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="156">
          <span class="hits">31</span>
          
          <code class="ruby">  def always?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    AppOpticsAPM::Config[:tracing_mode] &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">      AppOpticsAPM::Config[:tracing_mode].to_sym == :always</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">  # Returns true if the tracing_mode is set to never.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">  # False otherwise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="165">
          <span class="hits">31</span>
          
          <code class="ruby">  def never?</code>
        </li>
      
        <li class="covered" data-hits="8637" data-linenumber="166">
          <span class="hits">8637</span>
          
          <code class="ruby">    AppOpticsAPM::Config[:tracing_mode] &amp;&amp;</code>
        </li>
      
        <li class="covered" data-hits="17643" data-linenumber="167">
          <span class="hits">17643</span>
          
          <code class="ruby">      AppOpticsAPM::Config[:tracing_mode].to_sym == :never</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">  # Returns true if we are currently tracing a request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">  # False otherwise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="174">
          <span class="hits">31</span>
          
          <code class="ruby">  def tracing?</code>
        </li>
      
        <li class="covered" data-hits="26286" data-linenumber="175">
          <span class="hits">26286</span>
          
          <code class="ruby">    return false if !AppOpticsAPM.loaded || AppOpticsAPM.never?</code>
        </li>
      
        <li class="covered" data-hits="26026" data-linenumber="176">
          <span class="hits">26026</span>
          
          <code class="ruby">    AppOpticsAPM::Context.isSampled</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="179">
          <span class="hits">31</span>
          
          <code class="ruby">  def heroku?</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="180">
          <span class="hits">69</span>
          
          <code class="ruby">    ENV.key?(&#39;APPOPTICS_URL&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">  # Determines if we are running under a forking webserver</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="186">
          <span class="hits">31</span>
          
          <code class="ruby">  def forking_webserver?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">    if (defined?(::Unicorn) &amp;&amp; ($PROGRAM_NAME =~ /unicorn/i)) ||</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">       (defined?(::Puma) &amp;&amp; ($PROGRAM_NAME =~ /puma/i))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">  # Debugging helper method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">  # FIXME does this belong here? Is it still needed?</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="199">
          <span class="hits">31</span>
          
          <code class="ruby">  def pry!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">    # Only valid for development or test environments</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">    env = ENV[&#39;RACK_ENV&#39;] || ENV[&#39;RAILS_ENV&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">    return unless %w(development, test).include? env</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">    require &#39;pry&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">    require &#39;pry-byebug&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">    if defined?(PryByebug)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">      Pry.commands.alias_command &#39;c&#39;, &#39;continue&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">      Pry.commands.alias_command &#39;s&#39;, &#39;step&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">      Pry.commands.alias_command &#39;n&#39;, &#39;next&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">      Pry.commands.alias_command &#39;f&#39;, &#39;finish&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">      Pry::Commands.command(/^$/, &#39;repeat last command&#39;) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">        _pry_.run_command Pry.history.to_a.last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">    byebug</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">  # Indicates whether a supported framework is in use</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">  # or not</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="225">
          <span class="hits">31</span>
          
          <code class="ruby">  def framework?</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="226">
          <span class="hits">28</span>
          
          <code class="ruby">    defined?(::Rails) || defined?(::Sinatra) || defined?(::Padrino) || defined?(::Grape)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">  # These methods should be implemented by the descendants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">  # (Oboe_metal, JOboe_metal (JRuby), Heroku_metal)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="233">
          <span class="hits">31</span>
          
          <code class="ruby">  def sample?(_opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">    fail &#39;sample? should be implemented by metal layer.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="237">
          <span class="hits">31</span>
          
          <code class="ruby">  def log(_layer, _label, _options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">    fail &#39;log should be implemented by metal layer.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="241">
          <span class="hits">31</span>
          
          <code class="ruby">  def set_tracing_mode(_mode)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">    fail &#39;set_tracing_mode should be implemented by metal layer.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="245">
          <span class="hits">31</span>
          
          <code class="ruby">  def set_sample_rate(_rate)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">    fail &#39;set_sample_rate should be implemented by metal layer.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="250">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="251">
          <span class="hits">31</span>
          
          <code class="ruby">  extend AppOpticsAPMBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby"># Setup an alias so we don&#39;t bug users</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby"># about single letter capitalization</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="256">
          <span class="hits">31</span>
          
          <code class="ruby">AppopticsAPM = AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="257">
          <span class="hits">31</span>
          
          <code class="ruby">AppOpticsApm = AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="258">
          <span class="hits">31</span>
          
          <code class="ruby">AppopticsApm = AppOpticsAPM</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="76d8427bd7bdd29101315f367aa5ba2b40a95d92">
  <div class="header">
    <h3>lib/appoptics_apm/config.rb</h3>
    <h4><span class="red">70.65 %</span> covered</h4>
    <div>
      <b>92</b> relevant lines. 
      <span class="green"><b>65</b> lines covered</span> and
      <span class="red"><b>27</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="4">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # This module exposes a nested configuration hash that can be used to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # configure and/or modify the functionality of the appoptics_apm gem.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # Use AppOpticsAPM::Config.show to view the entire nested hash.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="11">
          <span class="hits">31</span>
          
          <code class="ruby">  module Config</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="12">
          <span class="hits">31</span>
          
          <code class="ruby">    @@config = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="14">
          <span class="hits">31</span>
          
          <code class="ruby">    @@instrumentation = [:action_controller, :action_controller_api, :action_view,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">                         :active_record, :bunnyclient, :bunnyconsumer, :cassandra, :curb,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">                         :dalli, :delayed_jobclient, :delayed_jobworker,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">                         :em_http_request, :excon, :faraday, :grape,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">                         :httpclient, :nethttp, :memcached, :mongo, :moped, :rack, :redis,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">                         :resqueclient, :resqueworker, :rest_client,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">                         :sequel, :sidekiqclient, :sidekiqworker, :typhoeus]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # Subgrouping of instrumentation</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="23">
          <span class="hits">31</span>
          
          <code class="ruby">    @@http_clients = [:curb, :excon, :em_http_request, :faraday, :httpclient, :nethttp, :rest_client, :typhoeus]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    # load_config_file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    # There are 3 possible locations for the config file:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    # Rails default, ENV[&#39;APPOPTICS_APM_CONFIG_RUBY&#39;], or the gem&#39;s default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    # Hierarchie:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    # 1 - Rails default: config/initializers/appoptics_apm.rb</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    #     (also loaded  by Rails, but we can&#39;t reliably determine if Rails is running)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    # 2 - ENV[&#39;APPOPTICS_APM_CONFIG_RUBY&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    # 3 - Gem default: &lt;startup_dir&gt;/appoptics_apm_config.rb</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="37">
          <span class="hits">31</span>
          
          <code class="ruby">    def self.load_config_file</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="38">
          <span class="hits">52</span>
          
          <code class="ruby">      config_files = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      # Check for the rails config file</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="41">
          <span class="hits">52</span>
          
          <code class="ruby">      config_file = File.join(Dir.pwd, &#39;config/initializers/appoptics_apm.rb&#39;)</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="42">
          <span class="hits">52</span>
          
          <code class="ruby">      config_files &lt;&lt; config_file if File.exist?(config_file)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      # Check for file set by env variable</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="45">
          <span class="hits">52</span>
          
          <code class="ruby">      if ENV.key?(&#39;APPOPTICS_APM_CONFIG_RUBY&#39;)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="46">
          <span class="hits">12</span>
          
          <code class="ruby">        if File.exist?(ENV[&#39;APPOPTICS_APM_CONFIG_RUBY&#39;]) &amp;&amp; !File.directory?(ENV[&#39;APPOPTICS_APM_CONFIG_RUBY&#39;])</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="47">
          <span class="hits">6</span>
          
          <code class="ruby">          config_files &lt;&lt; ENV[&#39;APPOPTICS_APM_CONFIG_RUBY&#39;]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="48">
          <span class="hits">6</span>
          
          <code class="ruby">        elsif File.exist?(File.join(ENV[&#39;APPOPTICS_APM_CONFIG_RUBY&#39;], &#39;appoptics_apm_config.rb&#39;))</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="49">
          <span class="hits">3</span>
          
          <code class="ruby">          config_files &lt;&lt; File.join(ENV[&#39;APPOPTICS_APM_CONFIG_RUBY&#39;], &#39;appoptics_apm_config.rb&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="51">
          <span class="hits">3</span>
          
          <code class="ruby">          $stderr.puts &#39;Could not find the configuration file set by the APPOPTICS_APM_CONFIG_RUBY environment variable:&#39;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="52">
          <span class="hits">3</span>
          
          <code class="ruby">          $stderr.puts &quot;#{ENV[&#39;APPOPTICS_APM_CONFIG_RUBY&#39;]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      # Check for default config file</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="57">
          <span class="hits">52</span>
          
          <code class="ruby">      config_file = File.join(Dir.pwd, &#39;appoptics_apm_config.rb&#39;)</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="58">
          <span class="hits">52</span>
          
          <code class="ruby">      config_files &lt;&lt; config_file if File.exist?(config_file)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="60">
          <span class="hits">52</span>
          
          <code class="ruby">      return if config_files.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="62">
          <span class="hits">15</span>
          
          <code class="ruby">      if config_files.size &gt; 1</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="63">
          <span class="hits">3</span>
          
          <code class="ruby">        $stderr.puts &#39;Found multiple configuration files, using the first one listed:&#39;</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="64">
          <span class="hits">9</span>
          
          <code class="ruby">        config_files.each { |path| $stderr.puts &quot;  #{path}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="66">
          <span class="hits">15</span>
          
          <code class="ruby">      load(config_files[0])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    # print_config</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    # print configurations one per line</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    # to create an output similar to the content of the config file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="75">
          <span class="hits">31</span>
          
          <code class="ruby">    def self.print_config</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      AppOpticsAPM.logger.warn &quot;# General configurations&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">      non_instrumentation = @@config.keys - @@instrumentation</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      non_instrumentation.each do |config|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;AppOpticsAPM::Config[:#{config}] = #{@@config[config]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      AppOpticsAPM.logger.warn &quot;\n# Instrumentation specific configurations&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      AppOpticsAPM.logger.warn &quot;# Enabled/Disabled Instrumentation&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      @@instrumentation.each do |config|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;AppOpticsAPM::Config[:#{config}][:enabled] = #{@@config[config][:enabled]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      AppOpticsAPM.logger.warn &quot;\n# Enabled/Disabled Backtrace Collection&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">      @@instrumentation.each do |config|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;AppOpticsAPM::Config[:#{config}][:collect_backtraces] = #{@@config[config][:collect_backtraces]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">      AppOpticsAPM.logger.warn &quot;\n# Logging of outgoing HTTP query args&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">      @@instrumentation.each do |config|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;AppOpticsAPM::Config[:#{config}][:log_args] = #{@@config[config][:log_args] || false}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      AppOpticsAPM.logger.warn &quot;\n# Bunny Controller and Action&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">      AppOpticsAPM.logger.warn &quot;AppOpticsAPM::Config[:bunnyconsumer][:controller] = #{@@config[:bunnyconsumer][:controller].inspect}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">      AppOpticsAPM.logger.warn &quot;AppOpticsAPM::Config[:bunnyconsumer][:action] = #{@@config[:bunnyconsumer][:action].inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">    # initialize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    # Initializer method to set everything up with a default configuration.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    # The defaults are read from the template configuration file.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    # rubocop:disable Metrics/AbcSize</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="111">
          <span class="hits">31</span>
          
          <code class="ruby">    def self.initialize(_data = {})</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="112">
          <span class="hits">46</span>
          
          <code class="ruby">      @@instrumentation.each do |k|</code>
        </li>
      
        <li class="covered" data-hits="1334" data-linenumber="113">
          <span class="hits">1334</span>
          
          <code class="ruby">        @@config[k] = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="115">
          <span class="hits">46</span>
          
          <code class="ruby">      @@config[:transaction_name] = {}</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="116">
          <span class="hits">46</span>
          
          <code class="ruby">      load(File.join(File.dirname(File.dirname(__FILE__)),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">                    &#39;rails/generators/appoptics_apm/templates/appoptics_apm_initializer.rb&#39;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    # rubocop:enable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="121">
          <span class="hits">31</span>
          
          <code class="ruby">    def self.update!(data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">      data.each do |key, value|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">        self[key] = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="127">
          <span class="hits">31</span>
          
          <code class="ruby">    def self.merge!(data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">      update!(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="131">
          <span class="hits">31</span>
          
          <code class="ruby">    def self.[](key)</code>
        </li>
      
        <li class="covered" data-hits="80567" data-linenumber="132">
          <span class="hits">80567</span>
          
          <code class="ruby">      if key == :resque</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &#39;[appoptics_apm/warn] :resque config is deprecated.  It is now split into :resqueclient and :resqueworker.&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;[appoptics_apm/warn] Called from #{Kernel.caller[0]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="80567" data-linenumber="137">
          <span class="hits">80567</span>
          
          <code class="ruby">      @@config[key.to_sym]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">    # []=</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">    # Config variable assignment method.  Here we validate and store the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">    # assigned value(s) and trigger any secondary action needed.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">    # rubocop:disable Metrics/AbcSize, Metrics/PerceivedComplexity, Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="147">
          <span class="hits">31</span>
          
          <code class="ruby">    def self.[]=(key, value)</code>
        </li>
      
        <li class="covered" data-hits="3837" data-linenumber="148">
          <span class="hits">3837</span>
          
          <code class="ruby">      @@config[key.to_sym] = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3837" data-linenumber="150">
          <span class="hits">3837</span>
          
          <code class="ruby">      if key == :sampling_rate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &#39;[appoptics_apm/config] sampling_rate is not a supported setting for AppOpticsAPM::Config.  &#39; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">                         &#39;Please use :sample_rate.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3837" data-linenumber="154">
          <span class="hits">3837</span>
          
          <code class="ruby">      elsif key == :sample_rate</code>
        </li>
      
        <li class="covered" data-hits="1127" data-linenumber="155">
          <span class="hits">1127</span>
          
          <code class="ruby">        unless value.is_a?(Integer) || value.is_a?(Float)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="156">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM.logger.warn &quot;[appoptics_apm/config] :sample_rate must be a number between 0 and 1000000 (1m) &quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">                                   &quot;(provided: #{value}), corrected to 0&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="158">
          <span class="hits">3</span>
          
          <code class="ruby">          value = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">        # Validate :sample_rate value</code>
        </li>
      
        <li class="covered" data-hits="1127" data-linenumber="162">
          <span class="hits">1127</span>
          
          <code class="ruby">        unless value.between?(0, 1e6)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="163">
          <span class="hits">6</span>
          
          <code class="ruby">          value_1 = value</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="164">
          <span class="hits">6</span>
          
          <code class="ruby">          value = value_1 &lt; 0 ? 0 : 1_000_000</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="165">
          <span class="hits">6</span>
          
          <code class="ruby">          AppOpticsAPM.logger.warn &quot;[appoptics_apm/config] :sample_rate must be between 0 and 1000000 (1m) &quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">                                   &quot;(provided: #{value_1}), corrected to #{value}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">        # Assure value is an integer</code>
        </li>
      
        <li class="covered" data-hits="1127" data-linenumber="170">
          <span class="hits">1127</span>
          
          <code class="ruby">        @@config[key.to_sym] = value.to_i</code>
        </li>
      
        <li class="covered" data-hits="1127" data-linenumber="171">
          <span class="hits">1127</span>
          
          <code class="ruby">        AppOpticsAPM.set_sample_rate(value) if AppOpticsAPM.loaded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2710" data-linenumber="173">
          <span class="hits">2710</span>
          
          <code class="ruby">      elsif key == :action_blacklist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;[appoptics_apm/config] :action_blacklist has been deprecated and no longer functions.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2710" data-linenumber="176">
          <span class="hits">2710</span>
          
          <code class="ruby">      elsif key == :resque</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;[appoptics_apm/config] :resque config is deprecated.  It is now split into :resqueclient and :resqueworker.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;[appoptics_apm/config] Called from #{Kernel.caller[0]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2710" data-linenumber="180">
          <span class="hits">2710</span>
          
          <code class="ruby">      elsif key == :include_url_query_params # DEPRECATED</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">        # Obey the global flag and update all of the per instrumentation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">        # &lt;tt&gt;:log_args&lt;/tt&gt; values.</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="183">
          <span class="hits">6</span>
          
          <code class="ruby">        @@config[:rack][:log_args] = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2704" data-linenumber="185">
          <span class="hits">2704</span>
          
          <code class="ruby">      elsif key == :include_remote_url_params # DEPRECATED</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        # Obey the global flag and update all of the per instrumentation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">        # &lt;tt&gt;:log_args&lt;/tt&gt; values.</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="188">
          <span class="hits">6</span>
          
          <code class="ruby">        @@http_clients.each do |i|</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="189">
          <span class="hits">48</span>
          
          <code class="ruby">          @@config[i][:log_args] = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">      # Update liboboe if updating :tracing_mode</code>
        </li>
      
        <li class="covered" data-hits="2698" data-linenumber="193">
          <span class="hits">2698</span>
          
          <code class="ruby">      elsif key == :tracing_mode</code>
        </li>
      
        <li class="covered" data-hits="1276" data-linenumber="194">
          <span class="hits">1276</span>
          
          <code class="ruby">        AppOpticsAPM.set_tracing_mode(value.to_sym) if AppOpticsAPM.loaded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">        # Make sure that the mode is stored as a symbol</code>
        </li>
      
        <li class="covered" data-hits="1276" data-linenumber="197">
          <span class="hits">1276</span>
          
          <code class="ruby">        @@config[key.to_sym] = value.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">    # rubocop:enable Metrics/AbcSize, Metrics/PerceivedComplexity, Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="202">
          <span class="hits">31</span>
          
          <code class="ruby">    def self.method_missing(sym, *args)</code>
        </li>
      
        <li class="covered" data-hits="4581" data-linenumber="203">
          <span class="hits">4581</span>
          
          <code class="ruby">      class_var_name = &quot;@@#{sym}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4581" data-linenumber="205">
          <span class="hits">4581</span>
          
          <code class="ruby">      if sym.to_s =~ /(.+)=$/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">        self[$1] = args.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">        # Try part of the @@config hash first</code>
        </li>
      
        <li class="covered" data-hits="4581" data-linenumber="209">
          <span class="hits">4581</span>
          
          <code class="ruby">        if @@config.key?(sym)</code>
        </li>
      
        <li class="covered" data-hits="4575" data-linenumber="210">
          <span class="hits">4575</span>
          
          <code class="ruby">          self[sym]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">        # Then try as a class variable</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="213">
          <span class="hits">6</span>
          
          <code class="ruby">        elsif self.class_variable_defined?(class_var_name.to_sym)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="214">
          <span class="hits">6</span>
          
          <code class="ruby">          self.class_eval(class_var_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">        # Congrats - You&#39;ve won a brand new nil...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">          nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="225">
          <span class="hits">31</span>
          
          <code class="ruby">AppOpticsAPM::Config.initialize</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="93091a91c17a1f39864f8a0d204690d9f06f7f27">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/grape.rb</h3>
    <h4><span class="green">97.87 %</span> covered</h4>
    <div>
      <b>47</b> relevant lines. 
      <span class="green"><b>46</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Grape</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    module API</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.extended(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="8">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.class_method_alias(klass, :inherited, ::Grape::API)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="11">
          <span class="hits">28</span>
          
          <code class="ruby">      def inherited_with_appoptics(subclass)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="12">
          <span class="hits">12</span>
          
          <code class="ruby">        inherited_without_appoptics(subclass)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="14">
          <span class="hits">12</span>
          
          <code class="ruby">        subclass.use ::AppOpticsAPM::Rack</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="18">
          <span class="hits">28</span>
          
          <code class="ruby">    module Endpoint</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="19">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="20">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :run, ::Grape::Endpoint)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="23">
          <span class="hits">28</span>
          
          <code class="ruby">      def run_with_appoptics(*args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">        # Report Controller/Action and Transaction as best possible</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="25">
          <span class="hits">33</span>
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="27">
          <span class="hits">33</span>
          
          <code class="ruby">        report_kvs[:Controller] = options[:for].name</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="28">
          <span class="hits">33</span>
          
          <code class="ruby">        if route &amp;&amp; route.pattern</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="29">
          <span class="hits">33</span>
          
          <code class="ruby">          report_kvs[:Action] = route.pattern.origin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">          report_kvs[:Action] = args.empty? ? env[&#39;PATH_INFO&#39;] : args[0][&#39;PATH_INFO&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="34">
          <span class="hits">33</span>
          
          <code class="ruby">        env[&#39;appoptics_apm.controller&#39;] = report_kvs[:Controller]</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="35">
          <span class="hits">33</span>
          
          <code class="ruby">        env[&#39;appoptics_apm.action&#39;]     = report_kvs[:Action]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="37">
          <span class="hits">33</span>
          
          <code class="ruby">        ::AppOpticsAPM::API.log_entry(&#39;grape&#39;, report_kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="39">
          <span class="hits">33</span>
          
          <code class="ruby">        run_without_appoptics(*args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      ensure</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="41">
          <span class="hits">33</span>
          
          <code class="ruby">        ::AppOpticsAPM::API.log_exit(&#39;grape&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="45">
          <span class="hits">28</span>
          
          <code class="ruby">    module Middleware</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="46">
          <span class="hits">28</span>
          
          <code class="ruby">      module Error</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="47">
          <span class="hits">28</span>
          
          <code class="ruby">        def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="48">
          <span class="hits">3</span>
          
          <code class="ruby">          ::AppOpticsAPM::Util.method_alias(klass, :error_response, ::Grape::Middleware::Error)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="51">
          <span class="hits">28</span>
          
          <code class="ruby">        def error_response_with_appoptics(error = {})</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="52">
          <span class="hits">6</span>
          
          <code class="ruby">          status, headers, body = error_response_without_appoptics(error)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="54">
          <span class="hits">6</span>
          
          <code class="ruby">          xtrace = AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="56">
          <span class="hits">6</span>
          
          <code class="ruby">          if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">            # Since Grape uses throw/catch and not Exceptions, we manually log</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">            # the error here.</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="59">
          <span class="hits">6</span>
          
          <code class="ruby">            kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="60">
          <span class="hits">6</span>
          
          <code class="ruby">            kvs[:ErrorClass] = &#39;GrapeError&#39;</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="61">
          <span class="hits">6</span>
          
          <code class="ruby">            kvs[:ErrorMsg] = error[:message] ? error[:message] : &quot;No message given.&quot;</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="62">
          <span class="hits">6</span>
          
          <code class="ruby">            kvs[:Backtrace] = ::AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:grape][:collect_backtraces]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="63">
          <span class="hits">6</span>
          
          <code class="ruby">            ::AppOpticsAPM::API.log(&#39;rack&#39;, &#39;error&#39;, kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">            # Since calls to error() are handled similar to abort in Grape.  We</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">            # manually log the rack exit here since the original code won&#39;t</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">            # be returned to</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="68">
          <span class="hits">6</span>
          
          <code class="ruby">            xtrace = AppOpticsAPM::API.log_end(&#39;rack&#39;, :Status =&gt; status)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="71">
          <span class="hits">6</span>
          
          <code class="ruby">          if headers &amp;&amp; AppOpticsAPM::XTrace.valid?(xtrace)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="72">
          <span class="hits">6</span>
          
          <code class="ruby">            unless defined?(JRUBY_VERSION) &amp;&amp; AppOpticsAPM.is_continued_trace?</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="73">
          <span class="hits">6</span>
          
          <code class="ruby">              headers[&#39;X-Trace&#39;] = xtrace if headers.is_a?(Hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="77">
          <span class="hits">6</span>
          
          <code class="ruby">          [status, headers, body]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="84">
          <span class="hits">28</span>
          
          <code class="ruby">if AppOpticsAPM::Config[:grape][:enabled] &amp;&amp; defined?(::Grape)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="85">
          <span class="hits">3</span>
          
          <code class="ruby">  require &#39;appoptics_apm/inst/rack&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="87">
          <span class="hits">3</span>
          
          <code class="ruby">  AppOpticsAPM.logger.info &quot;[appoptics_apm/loading] Instrumenting Grape&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="89">
          <span class="hits">3</span>
          
          <code class="ruby">  AppOpticsAPM::Inst.load_instrumentation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="91">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_extend(::Grape::API,               ::AppOpticsAPM::Grape::API)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="92">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_include(::Grape::Endpoint,          ::AppOpticsAPM::Grape::Endpoint)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="93">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_include(::Grape::Middleware::Error, ::AppOpticsAPM::Grape::Middleware::Error)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b194d92d30f81cf97b3783be276c104de215c5c2">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/padrino.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>26</b> relevant lines. 
      <span class="green"><b>26</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module PadrinoInst</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    module Routing</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="8">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :dispatch!, ::Padrino::Routing)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="11">
          <span class="hits">28</span>
          
          <code class="ruby">      def dispatch_with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="13">
          <span class="hits">27</span>
          
          <code class="ruby">        ::AppOpticsAPM::API.log_entry(&#39;padrino&#39;, {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="15">
          <span class="hits">27</span>
          
          <code class="ruby">        result = dispatch_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">        # Report Controller/Action and Transaction as best possible</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="18">
          <span class="hits">27</span>
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="19">
          <span class="hits">27</span>
          
          <code class="ruby">        controller = (request.controller &amp;&amp; !request.controller.empty?) ? request.controller : nil</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="20">
          <span class="hits">27</span>
          
          <code class="ruby">        report_kvs[:Controller] = controller || self.class</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="21">
          <span class="hits">27</span>
          
          <code class="ruby">        report_kvs[:Action] = request.route_obj ? request.route_obj.path : request.action</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="22">
          <span class="hits">27</span>
          
          <code class="ruby">        env[&#39;appoptics_apm.controller&#39;] = report_kvs[:Controller]</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="23">
          <span class="hits">27</span>
          
          <code class="ruby">        env[&#39;appoptics_apm.action&#39;]     = report_kvs[:Action]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="25">
          <span class="hits">27</span>
          
          <code class="ruby">        result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      ensure</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="27">
          <span class="hits">27</span>
          
          <code class="ruby">        ::AppOpticsAPM::API.log_exit(&#39;padrino&#39;, report_kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="33">
          <span class="hits">28</span>
          
          <code class="ruby">if defined?(::Padrino)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  # This instrumentation is a superset of the Sinatra instrumentation similar</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  # to how Padrino is a superset of Sinatra itself.</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="36">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting Padrino&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="38">
          <span class="hits">3</span>
          
          <code class="ruby">  require &#39;appoptics_apm/frameworks/padrino/templates&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="40">
          <span class="hits">3</span>
          
          <code class="ruby">  Padrino.after_load do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="41">
          <span class="hits">3</span>
          
          <code class="ruby">    ::AppOpticsAPM.logger = ::Padrino.logger if ::Padrino.respond_to?(:logger)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="42">
          <span class="hits">3</span>
          
          <code class="ruby">    ::AppOpticsAPM::Inst.load_instrumentation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="44">
          <span class="hits">3</span>
          
          <code class="ruby">    ::AppOpticsAPM::Util.send_include(::Padrino::Routing::InstanceMethods, ::AppOpticsAPM::PadrinoInst::Routing)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="45">
          <span class="hits">3</span>
          
          <code class="ruby">    if defined?(::Padrino::Rendering)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="46">
          <span class="hits">3</span>
          
          <code class="ruby">      ::AppOpticsAPM::Util.send_include(::Padrino::Rendering::InstanceMethods, ::AppOpticsAPM::PadrinoInst::Rendering)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    # Report __Init after fork when in Heroku</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="50">
          <span class="hits">3</span>
          
          <code class="ruby">    AppOpticsAPM::API.report_init unless AppOpticsAPM.heroku?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b02123ebe46744f1e93b3cb58daa80fd0c76265f">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/padrino/templates.rb</h3>
    <h4><span class="red">21.43 %</span> covered</h4>
    <div>
      <b>28</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>22</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="4">
          <span class="hits">3</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="5">
          <span class="hits">3</span>
          
          <code class="ruby">  module PadrinoInst</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="6">
          <span class="hits">3</span>
          
          <code class="ruby">    module Rendering</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="7">
          <span class="hits">3</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="8">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :render, ::Padrino::Rendering)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="11">
          <span class="hits">3</span>
          
          <code class="ruby">      def render_with_appoptics(engine, data = nil, options = {}, locals = {}, &amp;block)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">        if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">          report_kvs = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">          if data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">            report_kvs[:engine] = engine</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">            report_kvs[:template] = data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">            report_kvs[:template] = engine</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">          if AppOpticsAPM.tracing_layer_op?(:render)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">            # For recursive calls to :render (for sub-partials and layouts),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">            # use method profiling.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">            begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">              report_kvs[:FunctionName] = :render</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">              report_kvs[:Class]        = :Rendering</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">              report_kvs[:Module]       = :Padrino</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">              report_kvs[:File]         = __FILE__</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">              report_kvs[:LineNumber]   = __LINE__</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">            rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">              ::AppOpticsAPM.logger.debug e.message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">              ::AppOpticsAPM.logger.debug e.backtrace.join(&#39;, &#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">            AppOpticsAPM::API.profile(report_kvs[:template], report_kvs, false) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">              render_without_appoptics(engine, data, options, locals, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">            # Fall back to the raw tracing API so we can pass KVs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">            # back on exit (a limitation of the AppOpticsAPM::API.trace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">            # block method) This removes the need for an info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">            # event to send additonal KVs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">            ::AppOpticsAPM::API.log_entry(:render, {}, :render)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">            begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">              render_without_appoptics(engine, data, options, locals, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">            ensure</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">              ::AppOpticsAPM::API.log_exit(:render, report_kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">          render_without_appoptics(engine, data, options, locals, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5df8234fb59c12ed13afaceac5f714277d37cd31">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/rails.rb</h3>
    <h4><span class="red">71.11 %</span> covered</h4>
    <div>
      <b>45</b> relevant lines. 
      <span class="green"><b>32</b> lines covered</span> and
      <span class="red"><b>13</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Rails</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    module Helpers</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">      extend ActiveSupport::Concern if defined?(::Rails) and ::Rails::VERSION::MAJOR &gt; 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      # Deprecated</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      # no usages</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="11">
          <span class="hits">28</span>
          
          <code class="ruby">      def appoptics_rum_header</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &#39;[appoptics_apm/warn] Note that appoptics_rum_header is deprecated.  It is now a no-op and should be removed from your application code.&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">        return &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="15">
          <span class="hits">28</span>
          
          <code class="ruby">      alias_method :oboe_rum_header, :appoptics_rum_header</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      # Deprecated</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="18">
          <span class="hits">28</span>
          
          <code class="ruby">      def appoptics_rum_footer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &#39;[appoptics_apm/warn] Note that appoptics_rum_footer is deprecated.  It is now a no-op and should be removed from your application code.&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        return &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="22">
          <span class="hits">28</span>
          
          <code class="ruby">      alias_method :oboe_rum_footer, :appoptics_rum_footer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end # Helpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="25">
          <span class="hits">28</span>
          
          <code class="ruby">    def self.load_initializer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      # Force load the AppOpticsAPM Rails initializer if there is one</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      # Prefer appoptics_apm.rb but give priority to the legacy tracelytics.rb if it exists</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      if ::Rails::VERSION::MAJOR &gt; 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        rails_root = ::Rails.root.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        rails_root = RAILS_ROOT.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      # We&#39;ve been through 3 initializer names.  Try each one.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      if File.exist?(&quot;#{rails_root}/config/initializers/tracelytics.rb&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        tr_initializer = &quot;#{rails_root}/config/initializers/tracelytics.rb&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      elsif File.exist?(&quot;#{rails_root}/config/initializers/oboe.rb&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        tr_initializer = &quot;#{rails_root}/config/initializers/oboe.rb&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        tr_initializer = &quot;#{rails_root}/config/initializers/appoptics_apm.rb&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      require tr_initializer if File.exist?(tr_initializer)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="47">
          <span class="hits">28</span>
          
          <code class="ruby">    def self.load_instrumentation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      # Load the Rails specific instrumentation</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="49">
          <span class="hits">19</span>
          
          <code class="ruby">      require &#39;appoptics_apm/frameworks/rails/inst/action_controller&#39;</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="50">
          <span class="hits">19</span>
          
          <code class="ruby">      require &#39;appoptics_apm/frameworks/rails/inst/action_view&#39;</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="51">
          <span class="hits">19</span>
          
          <code class="ruby">      require &#39;appoptics_apm/frameworks/rails/inst/action_view_30&#39;</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="52">
          <span class="hits">19</span>
          
          <code class="ruby">      require &#39;appoptics_apm/frameworks/rails/inst/active_record&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="54">
          <span class="hits">19</span>
          
          <code class="ruby">      AppOpticsAPM.logger.info &quot;AppOpticsAPM gem #{AppOpticsAPM::Version::STRING} successfully loaded.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="57">
          <span class="hits">28</span>
          
          <code class="ruby">    def self.include_helpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      # TBD: This would make the helpers available to controllers which is occasionally desired.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      # ActiveSupport.on_load(:action_controller) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      #   include AppOpticsAPM::Rails::Helpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      # end</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="62">
          <span class="hits">19</span>
          
          <code class="ruby">      ActiveSupport.on_load(:action_view) do</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="63">
          <span class="hits">19</span>
          
          <code class="ruby">        include AppOpticsAPM::Rails::Helpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  end # Rails</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">end # AppOpticsAPM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="69">
          <span class="hits">28</span>
          
          <code class="ruby">if defined?(::Rails)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="70">
          <span class="hits">16</span>
          
          <code class="ruby">  require &#39;appoptics_apm/inst/rack&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="72">
          <span class="hits">16</span>
          
          <code class="ruby">  module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="73">
          <span class="hits">16</span>
          
          <code class="ruby">    class Railtie &lt; ::Rails::Railtie</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="74">
          <span class="hits">16</span>
          
          <code class="ruby">      initializer &#39;appoptics_apm.helpers&#39; do</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="75">
          <span class="hits">19</span>
          
          <code class="ruby">        AppOpticsAPM::Rails.include_helpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="78">
          <span class="hits">16</span>
          
          <code class="ruby">      initializer &#39;appoptics_apm.rack&#39; do |app|</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="79">
          <span class="hits">19</span>
          
          <code class="ruby">        AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting rack&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="80">
          <span class="hits">19</span>
          
          <code class="ruby">        app.config.middleware.insert 0, AppOpticsAPM::Rack</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="83">
          <span class="hits">16</span>
          
          <code class="ruby">      config.after_initialize do</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="84">
          <span class="hits">19</span>
          
          <code class="ruby">        AppOpticsAPM.logger = ::Rails.logger if ::Rails.logger &amp;&amp; !ENV.key?(&#39;APPOPTICS_GEM_TEST&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="86">
          <span class="hits">19</span>
          
          <code class="ruby">        AppOpticsAPM::Inst.load_instrumentation</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="87">
          <span class="hits">19</span>
          
          <code class="ruby">        AppOpticsAPM::Rails.load_instrumentation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">        # Report __Init after fork when in Heroku</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="90">
          <span class="hits">19</span>
          
          <code class="ruby">        AppOpticsAPM::API.report_init unless AppOpticsAPM.heroku?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="4075d214e65959814e2b1cb170e814d60e6afdba">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/rails/inst/action_controller.rb</h3>
    <h4><span class="red">78.05 %</span> covered</h4>
    <div>
      <b>41</b> relevant lines. 
      <span class="green"><b>32</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="4">
          <span class="hits">13</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="5">
          <span class="hits">13</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    # RailsBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # This module contains the instrumentation code common to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    # many Rails versions.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="12">
          <span class="hits">13</span>
          
          <code class="ruby">    module RailsBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      # has_handler?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      # Determins if &lt;tt&gt;exception&lt;/tt&gt; has a registered</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      # handler via &lt;tt&gt;rescue_from&lt;/tt&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="20">
          <span class="hits">13</span>
          
          <code class="ruby">      def has_handler?(exception)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        # Don&#39;t log exceptions if they have a rescue handler set</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="22">
          <span class="hits">6</span>
          
          <code class="ruby">        has_handler = false</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="23">
          <span class="hits">6</span>
          
          <code class="ruby">        rescue_handlers.detect do |klass_name, _handler|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">          # Rescue handlers can be specified as strings or constant names</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">          klass = self.class.const_get(klass_name) rescue nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">          klass ||= klass_name.constantize rescue nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">          has_handler = exception.is_a?(klass) if klass</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="29">
          <span class="hits">6</span>
          
          <code class="ruby">        has_handler</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] Error searching Rails handlers: #{e.message}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      # log_rails_error?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      # Determins whether we should log a raised exception to the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      # AppOptics dashboard.  This is determined by whether the exception</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      # has a rescue handler setup and the value of</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      # AppOpticsAPM::Config[:report_rescued_errors]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="43">
          <span class="hits">13</span>
          
          <code class="ruby">      def log_rails_error?(exception)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        # As it&#39;s perculating up through the layers...  make sure that</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">        # we only report it once.</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="46">
          <span class="hits">6</span>
          
          <code class="ruby">        return false if exception.instance_variable_get(:@appoptics_logged)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="48">
          <span class="hits">6</span>
          
          <code class="ruby">        has_handler = has_handler?(exception)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="50">
          <span class="hits">6</span>
          
          <code class="ruby">        if !has_handler || (has_handler &amp;&amp; AppOpticsAPM::Config[:report_rescued_errors])</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="51">
          <span class="hits">6</span>
          
          <code class="ruby">          return true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      # This method does the logging if we are tracing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      # it `wraps` around the call to the original method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="60">
          <span class="hits">13</span>
          
          <code class="ruby">      def trace(layer)</code>
        </li>
      
        <li class="covered" data-hits="280" data-linenumber="61">
          <span class="hits">280</span>
          
          <code class="ruby">        return yield unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="207" data-linenumber="62">
          <span class="hits">207</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="207" data-linenumber="63">
          <span class="hits">207</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(layer)</code>
        </li>
      
        <li class="covered" data-hits="207" data-linenumber="64">
          <span class="hits">207</span>
          
          <code class="ruby">          yield</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">        rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(layer, e) if log_rails_error?(e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">          raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="207" data-linenumber="69">
          <span class="hits">207</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exit(layer)</code>
        </li>
      
        <li class="covered" data-hits="143" data-linenumber="70">
          <span class="hits">143</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      # render_with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      # Our render wrapper that calls &#39;add_logging&#39;, which will log if we are tracing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="79">
          <span class="hits">13</span>
          
          <code class="ruby">      def render_with_appoptics(*args, &amp;blk)</code>
        </li>
      
        <li class="covered" data-hits="151" data-linenumber="80">
          <span class="hits">151</span>
          
          <code class="ruby">        trace(&#39;actionview&#39;) do</code>
        </li>
      
        <li class="covered" data-hits="151" data-linenumber="81">
          <span class="hits">151</span>
          
          <code class="ruby">          render_without_appoptics(*args, &amp;blk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"># ActionController::Base</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="89">
          <span class="hits">13</span>
          
          <code class="ruby">if defined?(ActionController::Base) &amp;&amp; AppOpticsAPM::Config[:action_controller][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="90">
          <span class="hits">13</span>
          
          <code class="ruby">  AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting actioncontroller&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="91">
          <span class="hits">13</span>
          
          <code class="ruby">  require &quot;appoptics_apm/frameworks/rails/inst/action_controller#{Rails::VERSION::MAJOR}&quot;</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="92">
          <span class="hits">13</span>
          
          <code class="ruby">  if Rails::VERSION::MAJOR &gt;= 5</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="93">
          <span class="hits">6</span>
          
          <code class="ruby">    ::ActionController::Base.send(:prepend, ::AppOpticsAPM::Inst::ActionController)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  else</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="95">
          <span class="hits">7</span>
          
          <code class="ruby">    ::AppOpticsAPM::Util.send_include(::ActionController::Base, AppOpticsAPM::Inst::ActionController)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"># ActionController::API - Rails 5+ or via the rails-api gem</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="100">
          <span class="hits">13</span>
          
          <code class="ruby">if defined?(ActionController::API) &amp;&amp; AppOpticsAPM::Config[:action_controller_api][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="101">
          <span class="hits">6</span>
          
          <code class="ruby">  AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting actioncontroller api&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="102">
          <span class="hits">6</span>
          
          <code class="ruby">  require &quot;appoptics_apm/frameworks/rails/inst/action_controller_api&quot;</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="103">
          <span class="hits">6</span>
          
          <code class="ruby">  ::ActionController::API.send(:prepend, ::AppOpticsAPM::Inst::ActionControllerAPI)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"># vim:set expandtab:tabstop=2</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="fbe789f86aa1d696d83c5a26d790156980b98c68">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/rails/inst/action_controller4.rb</h3>
    <h4><span class="yellow">86.36 %</span> covered</h4>
    <div>
      <b>22</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="4">
          <span class="hits">7</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="5">
          <span class="hits">7</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    # ActionController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # This modules contains the instrumentation code specific</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    # to Rails v4</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="12">
          <span class="hits">7</span>
          
          <code class="ruby">    module ActionController</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="13">
          <span class="hits">7</span>
          
          <code class="ruby">      include ::AppOpticsAPM::Inst::RailsBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="15">
          <span class="hits">7</span>
          
          <code class="ruby">      def self.included(base)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="16">
          <span class="hits">7</span>
          
          <code class="ruby">        base.class_eval do</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="17">
          <span class="hits">7</span>
          
          <code class="ruby">          alias_method_chain :process_action, :appoptics</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="18">
          <span class="hits">7</span>
          
          <code class="ruby">          alias_method_chain :render, :appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="22">
          <span class="hits">7</span>
          
          <code class="ruby">      def process_action_with_appoptics(method_name, *args)</code>
        </li>
      
        <li class="covered" data-hits="151" data-linenumber="23">
          <span class="hits">151</span>
          
          <code class="ruby">        kvs = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">            :Controller   =&gt; self.class.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">            :Action       =&gt; self.action_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="151" data-linenumber="27">
          <span class="hits">151</span>
          
          <code class="ruby">        request.env[&#39;appoptics_apm.controller&#39;] = kvs[:Controller]</code>
        </li>
      
        <li class="covered" data-hits="151" data-linenumber="28">
          <span class="hits">151</span>
          
          <code class="ruby">        request.env[&#39;appoptics_apm.action&#39;] = kvs[:Action]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="151" data-linenumber="30">
          <span class="hits">151</span>
          
          <code class="ruby">        return process_action_without_appoptics(method_name, *args) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="102" data-linenumber="31">
          <span class="hits">102</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="102" data-linenumber="32">
          <span class="hits">102</span>
          
          <code class="ruby">          kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:action_controller][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="102" data-linenumber="34">
          <span class="hits">102</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(&#39;rails&#39;, kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="102" data-linenumber="36">
          <span class="hits">102</span>
          
          <code class="ruby">          process_action_without_appoptics(method_name, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(nil, e) if log_rails_error?(e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">          raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="102" data-linenumber="42">
          <span class="hits">102</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exit(&#39;rails&#39;)</code>
        </li>
      
        <li class="covered" data-hits="73" data-linenumber="43">
          <span class="hits">73</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="0f3580075c5b12d263b7e1f09dad8a4d2c2e4319">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/rails/inst/action_controller5.rb</h3>
    <h4><span class="yellow">85.71 %</span> covered</h4>
    <div>
      <b>21</b> relevant lines. 
      <span class="green"><b>18</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="4">
          <span class="hits">6</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="5">
          <span class="hits">6</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    # ActionController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # This modules contains the instrumentation code specific</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    # to Rails v5</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="12">
          <span class="hits">6</span>
          
          <code class="ruby">    module ActionController</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="13">
          <span class="hits">6</span>
          
          <code class="ruby">      include ::AppOpticsAPM::Inst::RailsBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="15">
          <span class="hits">6</span>
          
          <code class="ruby">      def process_action(method_name, *args)</code>
        </li>
      
        <li class="covered" data-hits="111" data-linenumber="16">
          <span class="hits">111</span>
          
          <code class="ruby">        kvs = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">            :Controller   =&gt; self.class.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">            :Action       =&gt; self.action_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="111" data-linenumber="20">
          <span class="hits">111</span>
          
          <code class="ruby">        request.env[&#39;appoptics_apm.controller&#39;] = kvs[:Controller]</code>
        </li>
      
        <li class="covered" data-hits="111" data-linenumber="21">
          <span class="hits">111</span>
          
          <code class="ruby">        request.env[&#39;appoptics_apm.action&#39;] = kvs[:Action]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="111" data-linenumber="23">
          <span class="hits">111</span>
          
          <code class="ruby">        return super(method_name, *args) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="24">
          <span class="hits">87</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="25">
          <span class="hits">87</span>
          
          <code class="ruby">          kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:action_controller][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="27">
          <span class="hits">87</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(&#39;rails&#39;, kvs)</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="28">
          <span class="hits">87</span>
          
          <code class="ruby">          super(method_name, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(nil, e) if log_rails_error?(e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">          raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="34">
          <span class="hits">87</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exit(&#39;rails&#39;)</code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="35">
          <span class="hits">58</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      # render</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      # Our render wrapper that calls &#39;trace&#39;, which will log if we are tracing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="43">
          <span class="hits">6</span>
          
          <code class="ruby">      def render(*args, &amp;blk)</code>
        </li>
      
        <li class="covered" data-hits="111" data-linenumber="44">
          <span class="hits">111</span>
          
          <code class="ruby">        trace(&#39;actionview&#39;) do</code>
        </li>
      
        <li class="covered" data-hits="111" data-linenumber="45">
          <span class="hits">111</span>
          
          <code class="ruby">          super(*args, &amp;blk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="bf1dbce1e200fc5bcf9f33a8cff359e347e9e3af">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/rails/inst/action_controller_api.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>21</b> relevant lines. 
      <span class="green"><b>21</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="4">
          <span class="hits">6</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="5">
          <span class="hits">6</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    # ActionController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # This modules contains the instrumentation code specific</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    # to Rails v5.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="12">
          <span class="hits">6</span>
          
          <code class="ruby">    module ActionControllerAPI</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="13">
          <span class="hits">6</span>
          
          <code class="ruby">      include ::AppOpticsAPM::Inst::RailsBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="15">
          <span class="hits">6</span>
          
          <code class="ruby">      def process_action(method_name, *args)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="16">
          <span class="hits">24</span>
          
          <code class="ruby">        kvs = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">            :Controller   =&gt; self.class.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">            :Action       =&gt; self.action_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="20">
          <span class="hits">24</span>
          
          <code class="ruby">        request.env[&#39;appoptics_apm.controller&#39;] = kvs[:Controller]</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="21">
          <span class="hits">24</span>
          
          <code class="ruby">        request.env[&#39;appoptics_apm.action&#39;] = kvs[:Action]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="23">
          <span class="hits">24</span>
          
          <code class="ruby">        return super(method_name, *args) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="24">
          <span class="hits">24</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="25">
          <span class="hits">24</span>
          
          <code class="ruby">          kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:action_controller_api][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="27">
          <span class="hits">24</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(&#39;rails-api&#39;, kvs)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="28">
          <span class="hits">24</span>
          
          <code class="ruby">          super(method_name, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="30">
          <span class="hits">6</span>
          
          <code class="ruby">        rescue Exception =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="31">
          <span class="hits">6</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(nil, e) if log_rails_error?(e)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="32">
          <span class="hits">6</span>
          
          <code class="ruby">          raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="34">
          <span class="hits">24</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exit(&#39;rails-api&#39;)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="35">
          <span class="hits">16</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      # render</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      # Our render wrapper that calls &#39;add_logging&#39;, which will log if we are tracing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="43">
          <span class="hits">6</span>
          
          <code class="ruby">      def render(*args, &amp;blk)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="44">
          <span class="hits">18</span>
          
          <code class="ruby">        trace(&#39;actionview&#39;) do</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="45">
          <span class="hits">18</span>
          
          <code class="ruby">          super(*args, &amp;blk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="556f13d23af3fcbfb78efdade1a1c860c870fed0">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/rails/inst/action_view.rb</h3>
    <h4><span class="red">26.67 %</span> covered</h4>
    <div>
      <b>30</b> relevant lines. 
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>22</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="4">
          <span class="hits">13</span>
          
          <code class="ruby">if defined?(ActionView::Base) &amp;&amp; AppOpticsAPM::Config[:action_view][:enabled]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # ActionView Instrumentation is version dependent.  ActionView 2.x is separate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # and ActionView 3.0 is a special case.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # Everything else goes here. (ActionView 3.1 - 4.0 as of this writing)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="11">
          <span class="hits">13</span>
          
          <code class="ruby">  if (Rails::VERSION::MAJOR == 3 &amp;&amp; Rails::VERSION::MINOR &gt; 0) || Rails::VERSION::MAJOR &gt;= 4</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="13">
          <span class="hits">13</span>
          
          <code class="ruby">    AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting actionview&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="15">
          <span class="hits">13</span>
          
          <code class="ruby">    ActionView::PartialRenderer.class_eval do</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="16">
          <span class="hits">13</span>
          
          <code class="ruby">      alias :render_partial_without_appoptics :render_partial</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="17">
          <span class="hits">13</span>
          
          <code class="ruby">      def render_partial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        entry_kvs = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">          name = AppOpticsAPM::Util.prettify(@options[:partial]) if @options.is_a?(Hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">          entry_kvs[:FunctionName] = :render_partial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">          entry_kvs[:Class]        = :PartialRenderer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">          entry_kvs[:Module]       = :ActionView</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">          entry_kvs[:File]         = __FILE__</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">          entry_kvs[:LineNumber]   = __LINE__</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        AppOpticsAPM::API.profile(name, entry_kvs, AppOpticsAPM::Config[:action_view][:collect_backtraces]) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">          render_partial_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="35">
          <span class="hits">13</span>
          
          <code class="ruby">      alias :render_collection_without_appoptics :render_collection</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="36">
          <span class="hits">13</span>
          
          <code class="ruby">      def render_collection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        entry_kvs = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">          name = AppOpticsAPM::Util.prettify(@path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">          entry_kvs[:FunctionName] = :render_collection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">          entry_kvs[:Class]        = :PartialRenderer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">          entry_kvs[:Module]       = :ActionView</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">          entry_kvs[:File]         = __FILE__</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">          entry_kvs[:LineNumber]   = __LINE__</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">        AppOpticsAPM::API.profile(name, entry_kvs, AppOpticsAPM::Config[:action_view][:collect_backtraces]) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">          render_collection_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"># vim:set expandtab:tabstop=2</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5af664e5a9d8817ca0cdf3fdd262537a0813ab0d">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/rails/inst/action_view_30.rb</h3>
    <h4><span class="red">6.9 %</span> covered</h4>
    <div>
      <b>29</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>27</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="4">
          <span class="hits">13</span>
          
          <code class="ruby">if defined?(ActionView::Base) &amp;&amp; AppOpticsAPM::Config[:action_view][:enabled]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="6">
          <span class="hits">13</span>
          
          <code class="ruby">  if Rails::VERSION::MAJOR == 3 &amp;&amp; Rails::VERSION::MINOR == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    ActionView::Partials::PartialRenderer.class_eval do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      alias :render_partial_without_appoptics :render_partial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      def render_partial(object = @object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">        entry_kvs = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">          name  = AppOpticsAPM::Util.prettify(@options[:partial]) if @options.is_a?(Hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">          entry_kvs[:FunctionName] = :render_partial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">          entry_kvs[:Class]        = :PartialRenderer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">          entry_kvs[:Module]       = &#39;ActionView::Partials&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">          entry_kvs[:File]         = __FILE__</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">          entry_kvs[:LineNumber]   = __LINE__</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">        AppOpticsAPM::API.profile(name, entry_kvs, AppOpticsAPM::Config[:action_view][:collect_backtraces]) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">          render_partial_without_appoptics(object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      alias :render_collection_without_appoptics :render_collection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      def render_collection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        entry_kvs = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">          name  = AppOpticsAPM::Util.prettify(@path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">          entry_kvs[:FunctionName] = :render_collection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">          entry_kvs[:Class]        = :PartialRenderer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">          entry_kvs[:Module]       = &#39;ActionView::Partials&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">          entry_kvs[:File]         = __FILE__</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">          entry_kvs[:LineNumber]   = __LINE__</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        AppOpticsAPM::API.profile(name, entry_kvs, AppOpticsAPM::Config[:action_view][:collect_backtraces]) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">          render_collection_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"># vim:set expandtab:tabstop=2</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="af137e8df9fa78f0904309dd5bd6f06e670f5c64">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/rails/inst/active_record.rb</h3>
    <h4><span class="yellow">85.71 %</span> covered</h4>
    <div>
      <b>14</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="4">
          <span class="hits">13</span>
          
          <code class="ruby">require &#39;appoptics_apm/frameworks/rails/inst/connection_adapters/mysql&#39;</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="5">
          <span class="hits">13</span>
          
          <code class="ruby">require &#39;appoptics_apm/frameworks/rails/inst/connection_adapters/mysql2&#39;</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="6">
          <span class="hits">13</span>
          
          <code class="ruby">require &#39;appoptics_apm/frameworks/rails/inst/connection_adapters/postgresql&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="8">
          <span class="hits">13</span>
          
          <code class="ruby">if AppOpticsAPM::Config[:active_record][:enabled] &amp;&amp; !defined?(JRUBY_VERSION)</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="9">
          <span class="hits">13</span>
          
          <code class="ruby">  begin</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="10">
          <span class="hits">13</span>
          
          <code class="ruby">    adapter = ActiveRecord::Base.configurations[Rails.env][&#39;adapter&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="12">
          <span class="hits">13</span>
          
          <code class="ruby">    if Rails::VERSION::MAJOR &lt; 5</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="13">
          <span class="hits">7</span>
          
          <code class="ruby">      require &#39;appoptics_apm/frameworks/rails/inst/connection_adapters/utils&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="15">
          <span class="hits">6</span>
          
          <code class="ruby">      require &#39;appoptics_apm/frameworks/rails/inst/connection_adapters/utils5x&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="18">
          <span class="hits">13</span>
          
          <code class="ruby">    AppOpticsAPM::Inst::ConnectionAdapters::FlavorInitializers.mysql      if adapter == &#39;mysql&#39;</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="19">
          <span class="hits">13</span>
          
          <code class="ruby">    AppOpticsAPM::Inst::ConnectionAdapters::FlavorInitializers.mysql2     if adapter == &#39;mysql2&#39;</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="20">
          <span class="hits">13</span>
          
          <code class="ruby">    AppOpticsAPM::Inst::ConnectionAdapters::FlavorInitializers.postgresql if adapter == &#39;postgresql&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    AppOpticsAPM.logger.error &quot;[appoptics_apm/error] AppOpticsAPM/ActiveRecord error: #{e.inspect}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    AppOpticsAPM.logger.debug e.backtrace.join(&quot;\n&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"># vim:set expandtab:tabstop=2</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9bd5b5fbf81547af414f7dc877686b30a0ea5cbb">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/rails/inst/connection_adapters/mysql.rb</h3>
    <h4><span class="red">68.75 %</span> covered</h4>
    <div>
      <b>16</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="4">
          <span class="hits">13</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="5">
          <span class="hits">13</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="6">
          <span class="hits">13</span>
          
          <code class="ruby">    module ConnectionAdapters</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="7">
          <span class="hits">13</span>
          
          <code class="ruby">      module FlavorInitializers</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="8">
          <span class="hits">13</span>
          
          <code class="ruby">        def self.mysql</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">          AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting activerecord mysqladapter&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">          # ActiveRecord 3.2 and higher</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">          if (::ActiveRecord::VERSION::MAJOR == 3 &amp;&amp; ::ActiveRecord::VERSION::MINOR &gt;= 2) ||</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">              ::ActiveRecord::VERSION::MAJOR == 4</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">            # AbstractMysqlAdapter</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">            AppOpticsAPM::Util.send_include(::ActiveRecord::ConnectionAdapters::AbstractMysqlAdapter,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">                                    ::AppOpticsAPM::Inst::ConnectionAdapters::Utils)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">            AppOpticsAPM::Util.method_alias(::ActiveRecord::ConnectionAdapters::AbstractMysqlAdapter, :execute)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">            # MysqlAdapter</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">            AppOpticsAPM::Util.send_include(::ActiveRecord::ConnectionAdapters::MysqlAdapter,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">                                    ::AppOpticsAPM::Inst::ConnectionAdapters::Utils)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">            AppOpticsAPM::Util.method_alias(::ActiveRecord::ConnectionAdapters::MysqlAdapter, :exec_query)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">            # ActiveRecord 3.1 and below</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">            # MysqlAdapter</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">            AppOpticsAPM::Util.send_include(::ActiveRecord::ConnectionAdapters::MysqlAdapter,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">                                    ::AppOpticsAPM::Inst::ConnectionAdapters::Utils)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">            AppOpticsAPM::Util.method_alias(::ActiveRecord::ConnectionAdapters::MysqlAdapter, :execute)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">            if ::ActiveRecord::VERSION::MAJOR == 3 &amp;&amp; ::ActiveRecord::VERSION::MINOR == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">              AppOpticsAPM::Util.method_alias(::ActiveRecord::ConnectionAdapters::MysqlAdapter, :begin_db_transaction)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">              AppOpticsAPM::Util.method_alias(::ActiveRecord::ConnectionAdapters::MysqlAdapter, :exec_delete)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="26be7cafaf9209e393f42f6eca7cc1574c6d0ad7">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/rails/inst/connection_adapters/mysql2.rb</h3>
    <h4><span class="green">92.86 %</span> covered</h4>
    <div>
      <b>14</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="4">
          <span class="hits">13</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="5">
          <span class="hits">13</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="6">
          <span class="hits">13</span>
          
          <code class="ruby">    module ConnectionAdapters</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="7">
          <span class="hits">13</span>
          
          <code class="ruby">      module FlavorInitializers</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="8">
          <span class="hits">13</span>
          
          <code class="ruby">        def self.mysql2</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="9">
          <span class="hits">6</span>
          
          <code class="ruby">          AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting activerecord mysql2adapter&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="11">
          <span class="hits">6</span>
          
          <code class="ruby">          AppOpticsAPM::Util.send_include(::ActiveRecord::ConnectionAdapters::Mysql2Adapter,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">                                  ::AppOpticsAPM::Inst::ConnectionAdapters::Utils)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="14">
          <span class="hits">2</span>
          
          <code class="ruby">          if (::ActiveRecord::VERSION::MAJOR == 3 &amp;&amp; ::ActiveRecord::VERSION::MINOR == 0) ||</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="15">
          <span class="hits">4</span>
          
          <code class="ruby">              ::ActiveRecord::VERSION::MAJOR == 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">            # ActiveRecord 3.0 and prior</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">            AppOpticsAPM::Util.method_alias(::ActiveRecord::ConnectionAdapters::Mysql2Adapter, :execute)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">            # ActiveRecord 3.1 and above</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="20">
          <span class="hits">6</span>
          
          <code class="ruby">            AppOpticsAPM::Util.method_alias(::ActiveRecord::ConnectionAdapters::Mysql2Adapter, :exec_insert)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="21">
          <span class="hits">6</span>
          
          <code class="ruby">            AppOpticsAPM::Util.method_alias(::ActiveRecord::ConnectionAdapters::Mysql2Adapter, :exec_query)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="22">
          <span class="hits">6</span>
          
          <code class="ruby">            AppOpticsAPM::Util.method_alias(::ActiveRecord::ConnectionAdapters::Mysql2Adapter, :exec_update)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="23">
          <span class="hits">6</span>
          
          <code class="ruby">            AppOpticsAPM::Util.method_alias(::ActiveRecord::ConnectionAdapters::Mysql2Adapter, :exec_delete)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="1be031bf27c4edf7c6a6f1e69c883342a94b1aa4">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/rails/inst/connection_adapters/postgresql.rb</h3>
    <h4><span class="green">92.31 %</span> covered</h4>
    <div>
      <b>13</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="4">
          <span class="hits">13</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="5">
          <span class="hits">13</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="6">
          <span class="hits">13</span>
          
          <code class="ruby">    module ConnectionAdapters</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="7">
          <span class="hits">13</span>
          
          <code class="ruby">      module FlavorInitializers</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="8">
          <span class="hits">13</span>
          
          <code class="ruby">        def self.postgresql</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="10">
          <span class="hits">6</span>
          
          <code class="ruby">          AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting activerecord postgresqladapter&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="12">
          <span class="hits">6</span>
          
          <code class="ruby">          AppOpticsAPM::Util.send_include(::ActiveRecord::ConnectionAdapters::PostgreSQLAdapter,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">                                  ::AppOpticsAPM::Inst::ConnectionAdapters::Utils)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="15">
          <span class="hits">2</span>
          
          <code class="ruby">          if (::ActiveRecord::VERSION::MAJOR == 3 &amp;&amp; ::ActiveRecord::VERSION::MINOR &gt; 0) ||</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="16">
          <span class="hits">4</span>
          
          <code class="ruby">                ::ActiveRecord::VERSION::MAJOR &gt;= 4</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">            # ActiveRecord 3.1 and up</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="19">
          <span class="hits">6</span>
          
          <code class="ruby">            AppOpticsAPM::Util.method_alias(::ActiveRecord::ConnectionAdapters::PostgreSQLAdapter, :exec_query)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="20">
          <span class="hits">6</span>
          
          <code class="ruby">            AppOpticsAPM::Util.method_alias(::ActiveRecord::ConnectionAdapters::PostgreSQLAdapter, :exec_update)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="21">
          <span class="hits">6</span>
          
          <code class="ruby">            AppOpticsAPM::Util.method_alias(::ActiveRecord::ConnectionAdapters::PostgreSQLAdapter, :exec_delete)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">            # ActiveRecord 3.0 and prior</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">            AppOpticsAPM::Util.method_alias(::ActiveRecord::ConnectionAdapters::PostgreSQLAdapter, :execute)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3cf6073c679cec410b43fffd7dbb7df42331163b">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/rails/inst/connection_adapters/utils.rb</h3>
    <h4><span class="yellow">84.13 %</span> covered</h4>
    <div>
      <b>63</b> relevant lines. 
      <span class="green"><b>53</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="4">
          <span class="hits">7</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="5">
          <span class="hits">7</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="6">
          <span class="hits">7</span>
          
          <code class="ruby">    module ConnectionAdapters</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="7">
          <span class="hits">7</span>
          
          <code class="ruby">      module Utils</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="9">
          <span class="hits">7</span>
          
          <code class="ruby">        def extract_trace_details(sql, name = nil, binds = [])</code>
        </li>
      
        <li class="covered" data-hits="103" data-linenumber="10">
          <span class="hits">103</span>
          
          <code class="ruby">          opts = {}</code>
        </li>
      
        <li class="covered" data-hits="103" data-linenumber="11">
          <span class="hits">103</span>
          
          <code class="ruby">          if AppOpticsAPM::Config[:sanitize_sql]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">            # Sanitize SQL and don&#39;t report binds</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="13">
          <span class="hits">23</span>
          
          <code class="ruby">            opts[:Query] = AppOpticsAPM::Util.sanitize_sql(sql)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">            # Report raw SQL and any binds if they exist</code>
        </li>
      
        <li class="covered" data-hits="80" data-linenumber="16">
          <span class="hits">80</span>
          
          <code class="ruby">            opts[:Query] = sql.to_s</code>
        </li>
      
        <li class="covered" data-hits="265" data-linenumber="17">
          <span class="hits">265</span>
          
          <code class="ruby">            opts[:QueryArgs] = binds.map { |col, val| [col.name, val.to_s] } unless binds.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="103" data-linenumber="20">
          <span class="hits">103</span>
          
          <code class="ruby">          opts[:Name] = name.to_s if name</code>
        </li>
      
        <li class="covered" data-hits="103" data-linenumber="21">
          <span class="hits">103</span>
          
          <code class="ruby">          opts[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:active_record][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="103" data-linenumber="23">
          <span class="hits">103</span>
          
          <code class="ruby">          if ::Rails::VERSION::MAJOR == 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">            config = ::Rails.configuration.database_configuration[::Rails.env]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="103" data-linenumber="26">
          <span class="hits">103</span>
          
          <code class="ruby">            config = ActiveRecord::Base.connection.instance_variable_get(:@config)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="103" data-linenumber="29">
          <span class="hits">103</span>
          
          <code class="ruby">          if config</code>
        </li>
      
        <li class="covered" data-hits="103" data-linenumber="30">
          <span class="hits">103</span>
          
          <code class="ruby">            opts[:Database]   = config[&#39;database&#39;] if config.key?(&#39;database&#39;)</code>
        </li>
      
        <li class="covered" data-hits="103" data-linenumber="31">
          <span class="hits">103</span>
          
          <code class="ruby">            opts[:RemoteHost] = config[&#39;host&#39;]     if config.key?(&#39;host&#39;)</code>
        </li>
      
        <li class="covered" data-hits="103" data-linenumber="32">
          <span class="hits">103</span>
          
          <code class="ruby">            adapter_name = config[:adapter]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="103" data-linenumber="34">
          <span class="hits">103</span>
          
          <code class="ruby">            case adapter_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">            when /mysql/i</code>
        </li>
      
        <li class="covered" data-hits="70" data-linenumber="36">
          <span class="hits">70</span>
          
          <code class="ruby">              opts[:Flavor] = &#39;mysql&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">            when /postgres/i</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="38">
          <span class="hits">33</span>
          
          <code class="ruby">              opts[:Flavor] = &#39;postgresql&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;Exception raised capturing ActiveRecord KVs: #{e.inspect}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug e.backtrace.join(&#39;\n&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="103" data-linenumber="45">
          <span class="hits">103</span>
          
          <code class="ruby">          return opts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">        # We don&#39;t want to trace framework caches.  Only instrument SQL that</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">        # directly hits the database.</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="50">
          <span class="hits">7</span>
          
          <code class="ruby">        def ignore_payload?(name)</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="51">
          <span class="hits">27</span>
          
          <code class="ruby">          %w(SCHEMA EXPLAIN CACHE).include?(name.to_s) ||</code>
        </li>
      
        <li class="covered" data-hits="111" data-linenumber="52">
          <span class="hits">111</span>
          
          <code class="ruby">            (name &amp;&amp; name.to_sym == :skip_logging) ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">            name == &#39;ActiveRecord::SchemaMigration Load&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">        # def cfg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">        #   @config</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">        # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="60">
          <span class="hits">7</span>
          
          <code class="ruby">        def execute_with_appoptics(sql, name = nil)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="61">
          <span class="hits">10</span>
          
          <code class="ruby">          if AppOpticsAPM.tracing? &amp;&amp; !ignore_payload?(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="63">
          <span class="hits">7</span>
          
          <code class="ruby">            opts = extract_trace_details(sql, name)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="64">
          <span class="hits">7</span>
          
          <code class="ruby">            AppOpticsAPM::API.trace(&#39;activerecord&#39;, opts, :ar_started) do</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="65">
          <span class="hits">7</span>
          
          <code class="ruby">              execute_without_appoptics(sql, name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="68">
          <span class="hits">3</span>
          
          <code class="ruby">            execute_without_appoptics(sql, name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="72">
          <span class="hits">7</span>
          
          <code class="ruby">        def exec_query_with_appoptics(sql, name = nil, binds = [])</code>
        </li>
      
        <li class="covered" data-hits="64" data-linenumber="73">
          <span class="hits">64</span>
          
          <code class="ruby">          if AppOpticsAPM.tracing? &amp;&amp; !ignore_payload?(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="75">
          <span class="hits">57</span>
          
          <code class="ruby">            opts = extract_trace_details(sql, name, binds)</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="76">
          <span class="hits">57</span>
          
          <code class="ruby">            AppOpticsAPM::API.trace(&#39;activerecord&#39;, opts, :ar_started) do</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="77">
          <span class="hits">57</span>
          
          <code class="ruby">              exec_query_without_appoptics(sql, name, binds)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="80">
          <span class="hits">7</span>
          
          <code class="ruby">            exec_query_without_appoptics(sql, name, binds)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="84">
          <span class="hits">7</span>
          
          <code class="ruby">        def exec_delete_with_appoptics(sql, name = nil, binds = [])</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="85">
          <span class="hits">15</span>
          
          <code class="ruby">          if AppOpticsAPM.tracing? &amp;&amp; !ignore_payload?(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="87">
          <span class="hits">15</span>
          
          <code class="ruby">            opts = extract_trace_details(sql, name, binds)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="88">
          <span class="hits">15</span>
          
          <code class="ruby">            AppOpticsAPM::API.trace(&#39;activerecord&#39;, opts, :ar_started) do</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="89">
          <span class="hits">15</span>
          
          <code class="ruby">              exec_delete_without_appoptics(sql, name, binds)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">            exec_delete_without_appoptics(sql, name, binds)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="96">
          <span class="hits">7</span>
          
          <code class="ruby">        def exec_update_with_appoptics(sql, name = nil, binds = [])</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="97">
          <span class="hits">6</span>
          
          <code class="ruby">          if AppOpticsAPM.tracing? &amp;&amp; !ignore_payload?(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="99">
          <span class="hits">6</span>
          
          <code class="ruby">            opts = extract_trace_details(sql, name, binds)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="100">
          <span class="hits">6</span>
          
          <code class="ruby">            AppOpticsAPM::API.trace(&#39;activerecord&#39;, opts, :ar_started) do</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="101">
          <span class="hits">6</span>
          
          <code class="ruby">              exec_update_without_appoptics(sql, name, binds)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">            exec_update_without_appoptics(sql, name, binds)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="108">
          <span class="hits">7</span>
          
          <code class="ruby">        def exec_insert_with_appoptics(sql, name = nil, binds = [], *args)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="109">
          <span class="hits">18</span>
          
          <code class="ruby">          if AppOpticsAPM.tracing? &amp;&amp; !ignore_payload?(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="111">
          <span class="hits">18</span>
          
          <code class="ruby">            opts = extract_trace_details(sql, name, binds)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="112">
          <span class="hits">18</span>
          
          <code class="ruby">            AppOpticsAPM::API.trace(&#39;activerecord&#39;, opts, :ar_started) do</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="113">
          <span class="hits">18</span>
          
          <code class="ruby">              exec_insert_without_appoptics(sql, name, binds, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">            exec_insert_without_appoptics(sql, name, binds, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="120">
          <span class="hits">7</span>
          
          <code class="ruby">        def begin_db_transaction_with_appoptics</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">          if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">            AppOpticsAPM::API.trace(&#39;activerecord&#39;, { :Query =&gt; &#39;BEGIN&#39;, :Flavor =&gt; :mysql }, :ar_started) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">              begin_db_transaction_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">            begin_db_transaction_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      end # Utils</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5a5ba5b35f01ca7825b9d8a4b3fabb5056a09a88">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/rails/inst/connection_adapters/utils5x.rb</h3>
    <h4><span class="yellow">87.27 %</span> covered</h4>
    <div>
      <b>55</b> relevant lines. 
      <span class="green"><b>48</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="4">
          <span class="hits">6</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="5">
          <span class="hits">6</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="6">
          <span class="hits">6</span>
          
          <code class="ruby">    module ConnectionAdapters</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="7">
          <span class="hits">6</span>
          
          <code class="ruby">      module Utils</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="9">
          <span class="hits">6</span>
          
          <code class="ruby">        def extract_trace_details(sql, name = nil, binds = [])</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="10">
          <span class="hits">75</span>
          
          <code class="ruby">          opts = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="12">
          <span class="hits">75</span>
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="13">
          <span class="hits">75</span>
          
          <code class="ruby">            if AppOpticsAPM::Config[:sanitize_sql]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">              # Sanitize SQL and don&#39;t report binds</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="15">
          <span class="hits">18</span>
          
          <code class="ruby">              opts[:Query] = AppOpticsAPM::Util.sanitize_sql(sql)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">              # Report raw SQL and any binds if they exist</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="18">
          <span class="hits">57</span>
          
          <code class="ruby">              opts[:Query] = sql.to_s</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="19">
          <span class="hits">57</span>
          
          <code class="ruby">              if binds &amp;&amp; !binds.empty?</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="20">
          <span class="hits">57</span>
          
          <code class="ruby">                opts[:QueryArgs] = binds.map(&amp;:value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="24">
          <span class="hits">75</span>
          
          <code class="ruby">            opts[:Name] = name.to_s if name</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="25">
          <span class="hits">75</span>
          
          <code class="ruby">            if AppOpticsAPM::Config[:active_record] &amp;&amp; AppOpticsAPM::Config[:active_record][:collect_backtraces]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">              opts[:Backtrace] = AppOpticsAPM::API.backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="29">
          <span class="hits">75</span>
          
          <code class="ruby">            if ::Rails::VERSION::MAJOR == 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">              config = ::Rails.configuration.database_configuration[::Rails.env]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="32">
          <span class="hits">75</span>
          
          <code class="ruby">              config = ActiveRecord::Base.connection.instance_variable_get(:@config)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="35">
          <span class="hits">75</span>
          
          <code class="ruby">            if config</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="36">
          <span class="hits">75</span>
          
          <code class="ruby">              opts[:Database]   = config[&#39;database&#39;] if config.key?(&#39;database&#39;)</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="37">
          <span class="hits">75</span>
          
          <code class="ruby">              opts[:RemoteHost] = config[&#39;host&#39;]     if config.key?(&#39;host&#39;)</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="38">
          <span class="hits">75</span>
          
          <code class="ruby">              adapter_name = config[:adapter]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="40">
          <span class="hits">75</span>
          
          <code class="ruby">              case adapter_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">              when /mysql/i</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="42">
          <span class="hits">42</span>
          
          <code class="ruby">                opts[:Flavor] = &#39;mysql&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">              when /postgres/i</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="44">
          <span class="hits">33</span>
          
          <code class="ruby">                opts[:Flavor] = &#39;postgresql&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">          rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">            AppOpticsAPM.logger.debug &quot;Exception raised capturing ActiveRecord KVs: #{e.inspect}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">            AppOpticsAPM.logger.debug e.backtrace.join(&#39;\n&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="52">
          <span class="hits">75</span>
          
          <code class="ruby">          opts || {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">        # We don&#39;t want to trace framework caches.  Only instrument SQL that</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">        # directly hits the database.</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="57">
          <span class="hits">6</span>
          
          <code class="ruby">        def ignore_payload?(name)</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="58">
          <span class="hits">25</span>
          
          <code class="ruby">          %w(SCHEMA EXPLAIN CACHE).include?(name.to_s) ||</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="59">
          <span class="hits">75</span>
          
          <code class="ruby">            (name &amp;&amp; name.to_sym == :skip_logging) ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">            name == &#39;ActiveRecord::SchemaMigration Load&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="63">
          <span class="hits">6</span>
          
          <code class="ruby">        def exec_query_with_appoptics(sql, name = nil, binds = [], prepare: false)</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="64">
          <span class="hits">54</span>
          
          <code class="ruby">          if AppOpticsAPM.tracing? &amp;&amp; AppOpticsAPM.layer_op != :ar_started &amp;&amp; !ignore_payload?(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="66">
          <span class="hits">36</span>
          
          <code class="ruby">            opts = extract_trace_details(sql, name, binds)</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="67">
          <span class="hits">36</span>
          
          <code class="ruby">            AppOpticsAPM::API.trace(&#39;activerecord&#39;, opts) do</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="68">
          <span class="hits">36</span>
          
          <code class="ruby">              exec_query_without_appoptics(sql, name, binds)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="71">
          <span class="hits">18</span>
          
          <code class="ruby">            exec_query_without_appoptics(sql, name, binds)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="75">
          <span class="hits">6</span>
          
          <code class="ruby">        def exec_insert_with_appoptics(sql, name = nil, binds = [], *args)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="76">
          <span class="hits">18</span>
          
          <code class="ruby">          if AppOpticsAPM.tracing? &amp;&amp; !ignore_payload?(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="78">
          <span class="hits">18</span>
          
          <code class="ruby">            opts = extract_trace_details(sql, name, binds)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="79">
          <span class="hits">18</span>
          
          <code class="ruby">            AppOpticsAPM::API.trace(&#39;activerecord&#39;, opts, :ar_started) do</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="80">
          <span class="hits">18</span>
          
          <code class="ruby">              exec_insert_without_appoptics(sql, name, binds, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">            exec_insert_without_appoptics(sql, name, binds, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="87">
          <span class="hits">6</span>
          
          <code class="ruby">        def exec_delete_with_appoptics(sql, name = nil, binds = [])</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="88">
          <span class="hits">15</span>
          
          <code class="ruby">          if AppOpticsAPM.tracing? &amp;&amp; !ignore_payload?(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="90">
          <span class="hits">15</span>
          
          <code class="ruby">            opts = extract_trace_details(sql, name, binds)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="91">
          <span class="hits">15</span>
          
          <code class="ruby">            AppOpticsAPM::API.trace(&#39;activerecord&#39;, opts, :ar_started) do</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="92">
          <span class="hits">15</span>
          
          <code class="ruby">              exec_delete_without_appoptics(sql, name, binds)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">            exec_delete_without_appoptics(sql, name, binds)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="99">
          <span class="hits">6</span>
          
          <code class="ruby">        def exec_update_with_appoptics(sql, name = nil, binds = [])</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="100">
          <span class="hits">6</span>
          
          <code class="ruby">          if AppOpticsAPM.tracing? &amp;&amp; !ignore_payload?(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="102">
          <span class="hits">6</span>
          
          <code class="ruby">            opts = extract_trace_details(sql, name, binds)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="103">
          <span class="hits">6</span>
          
          <code class="ruby">            AppOpticsAPM::API.trace(&#39;activerecord&#39;, opts, :ar_started) do</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="104">
          <span class="hits">6</span>
          
          <code class="ruby">              exec_update_without_appoptics(sql, name, binds)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">            exec_update_without_appoptics(sql, name, binds)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">      end # Utils</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="42d1f42fe0c9fd416412dc900355f890813ba923">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/sinatra.rb</h3>
    <h4><span class="yellow">83.78 %</span> covered</h4>
    <div>
      <b>37</b> relevant lines. 
      <span class="green"><b>31</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Sinatra</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    module Base</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="8">
          <span class="hits">16</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :dispatch!,         ::Sinatra::Base)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="9">
          <span class="hits">16</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :handle_exception!, ::Sinatra::Base)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="12">
          <span class="hits">28</span>
          
          <code class="ruby">      def dispatch_with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="14">
          <span class="hits">21</span>
          
          <code class="ruby">        ::AppOpticsAPM::API.log_entry(&#39;sinatra&#39;, {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="16">
          <span class="hits">21</span>
          
          <code class="ruby">        response = dispatch_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">        # Report Controller/Action and transaction as best possible</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="19">
          <span class="hits">21</span>
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="20">
          <span class="hits">21</span>
          
          <code class="ruby">        report_kvs[:Controller] = self.class</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="21">
          <span class="hits">21</span>
          
          <code class="ruby">        report_kvs[:Action] = env[&#39;sinatra.route&#39;]</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="22">
          <span class="hits">21</span>
          
          <code class="ruby">        env[&#39;appoptics_apm.controller&#39;] = report_kvs[:Controller]</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="23">
          <span class="hits">21</span>
          
          <code class="ruby">        env[&#39;appoptics_apm.action&#39;]     = report_kvs[:Action]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="25">
          <span class="hits">21</span>
          
          <code class="ruby">        response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      ensure</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="27">
          <span class="hits">21</span>
          
          <code class="ruby">        ::AppOpticsAPM::API.log_exit(&#39;sinatra&#39;, report_kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="30">
          <span class="hits">28</span>
          
          <code class="ruby">      def handle_exception_with_appoptics(boom)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        AppOpticsAPM::API.log_exception(nil, boom)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        handle_exception_without_appoptics(boom)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="35">
          <span class="hits">28</span>
          
          <code class="ruby">      def appoptics_rum_header</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &#39;[appoptics_apm/warn] Note that appoptics_rum_header is deprecated.  It is now a no-op and should be removed from your application code.&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        return &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="39">
          <span class="hits">28</span>
          
          <code class="ruby">      alias_method :oboe_rum_header, :appoptics_rum_header</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="41">
          <span class="hits">28</span>
          
          <code class="ruby">      def appoptics_rum_footer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &#39;[appoptics_apm/warn] Note that appoptics_rum_footer is deprecated.  It is now a no-op and should be removed from your application code.&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        return &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="45">
          <span class="hits">28</span>
          
          <code class="ruby">      alias_method :oboe_rum_footer, :appoptics_rum_footer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="50">
          <span class="hits">28</span>
          
          <code class="ruby">if defined?(::Sinatra)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="51">
          <span class="hits">16</span>
          
          <code class="ruby">  require &#39;appoptics_apm/inst/rack&#39;</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="52">
          <span class="hits">16</span>
          
          <code class="ruby">  require &#39;appoptics_apm/frameworks/sinatra/templates&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="54">
          <span class="hits">16</span>
          
          <code class="ruby">  AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting Sinatra&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="56">
          <span class="hits">16</span>
          
          <code class="ruby">  AppOpticsAPM::Inst.load_instrumentation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="58">
          <span class="hits">16</span>
          
          <code class="ruby">  ::Sinatra::Base.use AppOpticsAPM::Rack</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  # When in the gem TEST environment, we load this instrumentation regardless.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  # Otherwise, only when Padrino isn&#39;t around.</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="62">
          <span class="hits">16</span>
          
          <code class="ruby">  unless defined?(::Padrino) &amp;&amp; !ENV.key?(&#39;APPOPTICS_GEM_TEST&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    # Padrino has &#39;enhanced&#39; routes and rendering so the Sinatra</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    # instrumentation won&#39;t work anyways.  Only load for pure Sinatra apps.</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="65">
          <span class="hits">16</span>
          
          <code class="ruby">    ::AppOpticsAPM::Util.send_include(::Sinatra::Base,      ::AppOpticsAPM::Sinatra::Base)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="66">
          <span class="hits">16</span>
          
          <code class="ruby">    ::AppOpticsAPM::Util.send_include(::Sinatra::Templates, ::AppOpticsAPM::Sinatra::Templates)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    # Report __Init after fork when in Heroku</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="69">
          <span class="hits">16</span>
          
          <code class="ruby">    AppOpticsAPM::API.report_init unless AppOpticsAPM.heroku?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d3aabd712e5c24b83ec3425b925e533bc17c3668">
  <div class="header">
    <h3>lib/appoptics_apm/frameworks/sinatra/templates.rb</h3>
    <h4><span class="yellow">88.89 %</span> covered</h4>
    <div>
      <b>27</b> relevant lines. 
      <span class="green"><b>24</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="4">
          <span class="hits">16</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="5">
          <span class="hits">16</span>
          
          <code class="ruby">  module Sinatra</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="6">
          <span class="hits">16</span>
          
          <code class="ruby">    module Templates</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="7">
          <span class="hits">16</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="8">
          <span class="hits">16</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :render, ::Sinatra::Templates)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="11">
          <span class="hits">16</span>
          
          <code class="ruby">      def render_with_appoptics(engine, data, options = {}, locals = {}, &amp;block)</code>
        </li>
      
        <li class="covered" data-hits="90" data-linenumber="12">
          <span class="hits">90</span>
          
          <code class="ruby">        if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="90" data-linenumber="13">
          <span class="hits">90</span>
          
          <code class="ruby">          report_kvs = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="90" data-linenumber="15">
          <span class="hits">90</span>
          
          <code class="ruby">          report_kvs[:engine] = engine</code>
        </li>
      
        <li class="covered" data-hits="90" data-linenumber="16">
          <span class="hits">90</span>
          
          <code class="ruby">          report_kvs[:template] = data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="90" data-linenumber="18">
          <span class="hits">90</span>
          
          <code class="ruby">          if AppOpticsAPM.tracing_layer_op?(:render)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">            # For recursive calls to :render (for sub-partials and layouts),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">            # use method profiling.</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="21">
          <span class="hits">45</span>
          
          <code class="ruby">            begin</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="22">
          <span class="hits">45</span>
          
          <code class="ruby">              name = data</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="23">
          <span class="hits">45</span>
          
          <code class="ruby">              report_kvs[:FunctionName] = :render</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="24">
          <span class="hits">45</span>
          
          <code class="ruby">              report_kvs[:Class]        = :Templates</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="25">
          <span class="hits">45</span>
          
          <code class="ruby">              report_kvs[:Module]       = :&#39;Sinatra::Templates&#39;</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="26">
          <span class="hits">45</span>
          
          <code class="ruby">              report_kvs[:File]         = __FILE__</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="27">
          <span class="hits">45</span>
          
          <code class="ruby">              report_kvs[:LineNumber]   = __LINE__</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">            rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">              ::AppOpticsAPM.logger.debug e.message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">              ::AppOpticsAPM.logger.debug e.backtrace.join(&#39;, &#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="33">
          <span class="hits">45</span>
          
          <code class="ruby">            AppOpticsAPM::API.profile(name, report_kvs, false) do</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="34">
          <span class="hits">45</span>
          
          <code class="ruby">              render_without_appoptics(engine, data, options, locals, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">            # Fall back to the raw tracing API so we can pass KVs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">            # back on exit (a limitation of the AppOpticsAPM::API.trace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">            # block method) This removes the need for an info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">            # event to send additonal KVs</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="42">
          <span class="hits">45</span>
          
          <code class="ruby">            ::AppOpticsAPM::API.log_entry(:render, {}, :render)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="44">
          <span class="hits">45</span>
          
          <code class="ruby">            begin</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="45">
          <span class="hits">45</span>
          
          <code class="ruby">              render_without_appoptics(engine, data, options, locals, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">            ensure</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="47">
          <span class="hits">45</span>
          
          <code class="ruby">              ::AppOpticsAPM::API.log_exit(:render, report_kvs, :render)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">          render_without_appoptics(engine, data, options, locals, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2244c8a293b746e05d776637528fe5e9719a8f44">
  <div class="header">
    <h3>lib/appoptics_apm/inst/bunny-client.rb</h3>
    <h4><span class="yellow">83.16 %</span> covered</h4>
    <div>
      <b>95</b> relevant lines. 
      <span class="green"><b>79</b> lines covered</span> and
      <span class="red"><b>16</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    module BunnyExchange</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="8">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :delete, ::Bunny::Exchange)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="11">
          <span class="hits">28</span>
          
          <code class="ruby">      def delete_with_appoptics(opts = {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">        # If we&#39;re not tracing, just do a fast return.</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="13">
          <span class="hits">3</span>
          
          <code class="ruby">        return delete_without_appoptics(opts) if !AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="15">
          <span class="hits">3</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="16">
          <span class="hits">3</span>
          
          <code class="ruby">          kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="17">
          <span class="hits">3</span>
          
          <code class="ruby">          kvs[:Spec] = :pushq</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="18">
          <span class="hits">3</span>
          
          <code class="ruby">          kvs[:Flavor] = :rabbitmq</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="19">
          <span class="hits">3</span>
          
          <code class="ruby">          kvs[:Op] = :delete</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="20">
          <span class="hits">3</span>
          
          <code class="ruby">          kvs[:ExchangeType]   = @type</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="21">
          <span class="hits">3</span>
          
          <code class="ruby">          kvs[:RemoteHost]     = channel.connection.host</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="22">
          <span class="hits">3</span>
          
          <code class="ruby">          kvs[:RemotePort]     = channel.connection.port.to_i</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="23">
          <span class="hits">3</span>
          
          <code class="ruby">          kvs[:VirtualHost] = channel.connection.vhost</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="25">
          <span class="hits">3</span>
          
          <code class="ruby">          if @name.is_a?(String) &amp;&amp; !@name.empty?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="26">
          <span class="hits">3</span>
          
          <code class="ruby">            kvs[:ExchangeName] = @name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">            kvs[:ExchangeName] = :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="31">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(:&#39;rabbitmq-client&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="33">
          <span class="hits">3</span>
          
          <code class="ruby">          delete_without_appoptics(opts)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(nil, e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">          raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="38">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exit(:&#39;rabbitmq-client&#39;, kvs)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="39">
          <span class="hits">2</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="43">
          <span class="hits">28</span>
          
          <code class="ruby">    module BunnyChannel</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="44">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="45">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :basic_publish,     ::Bunny::Channel)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="46">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :queue,             ::Bunny::Channel)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="47">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :wait_for_confirms, ::Bunny::Channel)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3055" data-linenumber="50">
          <span class="hits">3055</span>
          
          <code class="ruby">      def collect_channel_kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="3027" data-linenumber="52">
          <span class="hits">3027</span>
          
          <code class="ruby">          kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="3027" data-linenumber="53">
          <span class="hits">3027</span>
          
          <code class="ruby">          kvs[:Spec] = :pushq</code>
        </li>
      
        <li class="covered" data-hits="3027" data-linenumber="54">
          <span class="hits">3027</span>
          
          <code class="ruby">          kvs[:Flavor] = :rabbitmq</code>
        </li>
      
        <li class="covered" data-hits="3027" data-linenumber="55">
          <span class="hits">3027</span>
          
          <code class="ruby">          kvs[:RemoteHost] = @connection.host</code>
        </li>
      
        <li class="covered" data-hits="3027" data-linenumber="56">
          <span class="hits">3027</span>
          
          <code class="ruby">          kvs[:RemotePort] = @connection.port.to_i</code>
        </li>
      
        <li class="covered" data-hits="3027" data-linenumber="57">
          <span class="hits">3027</span>
          
          <code class="ruby">          kvs[:VirtualHost] = @connection.vhost</code>
        </li>
      
        <li class="covered" data-hits="3027" data-linenumber="58">
          <span class="hits">3027</span>
          
          <code class="ruby">          kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:bunnyclient][:collect_backtraces]</code>
        </li>
      
        <li class="covered" data-hits="3027" data-linenumber="59">
          <span class="hits">3027</span>
          
          <code class="ruby">          kvs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="3027" data-linenumber="63">
          <span class="hits">3027</span>
          
          <code class="ruby">          return kvs</code>
        </li>
      
        <li class="covered" data-hits="2018" data-linenumber="64">
          <span class="hits">2018</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="67">
          <span class="hits">28</span>
          
          <code class="ruby">      def basic_publish_with_appoptics(payload, exchange, routing_key, opts = {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">        # If we&#39;re not tracing, just do a fast return.</code>
        </li>
      
        <li class="covered" data-hits="3030" data-linenumber="69">
          <span class="hits">3030</span>
          
          <code class="ruby">        return basic_publish_without_appoptics(payload, exchange, routing_key, opts) if !AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3021" data-linenumber="71">
          <span class="hits">3021</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="3021" data-linenumber="72">
          <span class="hits">3021</span>
          
          <code class="ruby">          kvs = collect_channel_kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3021" data-linenumber="74">
          <span class="hits">3021</span>
          
          <code class="ruby">          if exchange.respond_to?(:name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">            kvs[:ExchangeName] = exchange.name</code>
        </li>
      
        <li class="covered" data-hits="3021" data-linenumber="76">
          <span class="hits">3021</span>
          
          <code class="ruby">          elsif exchange.respond_to?(:empty?) &amp;&amp; !exchange.empty?</code>
        </li>
      
        <li class="covered" data-hits="3012" data-linenumber="77">
          <span class="hits">3012</span>
          
          <code class="ruby">            kvs[:ExchangeName] = exchange</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="79">
          <span class="hits">9</span>
          
          <code class="ruby">            kvs[:ExchangeName] = :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3021" data-linenumber="82">
          <span class="hits">3021</span>
          
          <code class="ruby">          kvs[:Queue]       = opts[:queue] if opts.key?(:queue)</code>
        </li>
      
        <li class="covered" data-hits="3021" data-linenumber="83">
          <span class="hits">3021</span>
          
          <code class="ruby">          kvs[:RoutingKey]  = routing_key if routing_key</code>
        </li>
      
        <li class="covered" data-hits="3021" data-linenumber="84">
          <span class="hits">3021</span>
          
          <code class="ruby">          kvs[:Op]          = :publish</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3021" data-linenumber="86">
          <span class="hits">3021</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(:&#39;rabbitmq-client&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">          # Pass the tracing context as a header</code>
        </li>
      
        <li class="covered" data-hits="3021" data-linenumber="89">
          <span class="hits">3021</span>
          
          <code class="ruby">          opts[:headers] ||= {}</code>
        </li>
      
        <li class="covered" data-hits="3021" data-linenumber="90">
          <span class="hits">3021</span>
          
          <code class="ruby">          opts[:headers][:SourceTrace] = AppOpticsAPM::Context.toString if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3021" data-linenumber="92">
          <span class="hits">3021</span>
          
          <code class="ruby">          basic_publish_without_appoptics(payload, exchange, routing_key, opts)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(nil, e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">          raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="3021" data-linenumber="97">
          <span class="hits">3021</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exit(:&#39;rabbitmq-client&#39;, kvs)</code>
        </li>
      
        <li class="covered" data-hits="2014" data-linenumber="98">
          <span class="hits">2014</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="101">
          <span class="hits">28</span>
          
          <code class="ruby">      def queue_with_appoptics(name = AMQ::Protocol::EMPTY_STRING, opts = {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">        # If we&#39;re not tracing, just do a fast return.</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="103">
          <span class="hits">24</span>
          
          <code class="ruby">        return queue_without_appoptics(name, opts) if !AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="105">
          <span class="hits">3</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="106">
          <span class="hits">3</span>
          
          <code class="ruby">          kvs = collect_channel_kvs</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="107">
          <span class="hits">3</span>
          
          <code class="ruby">          kvs[:Op] = :queue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="109">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(:&#39;rabbitmq-client&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="111">
          <span class="hits">3</span>
          
          <code class="ruby">          result = queue_without_appoptics(name, opts)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="112">
          <span class="hits">3</span>
          
          <code class="ruby">          kvs[:Queue] = result.name</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="113">
          <span class="hits">3</span>
          
          <code class="ruby">          result</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(nil, e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">          raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="118">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exit(:&#39;rabbitmq-client&#39;, kvs)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="119">
          <span class="hits">2</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="122">
          <span class="hits">28</span>
          
          <code class="ruby">      def wait_for_confirms_with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">        # If we&#39;re not tracing, just do a fast return.</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="124">
          <span class="hits">3</span>
          
          <code class="ruby">        return wait_for_confirms_without_appoptics if !AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="126">
          <span class="hits">3</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="127">
          <span class="hits">3</span>
          
          <code class="ruby">          kvs = collect_channel_kvs</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="128">
          <span class="hits">3</span>
          
          <code class="ruby">          kvs[:Op] = :wait_for_confirms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="130">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(:&#39;rabbitmq-client&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="132">
          <span class="hits">3</span>
          
          <code class="ruby">          wait_for_confirms_without_appoptics</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(nil, e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">          raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="137">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exit(:&#39;rabbitmq-client&#39;, kvs)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="138">
          <span class="hits">2</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="144">
          <span class="hits">28</span>
          
          <code class="ruby">if AppOpticsAPM::Config[:bunnyclient][:enabled] &amp;&amp; defined?(::Bunny)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="145">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting bunny client&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="146">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_include(::Bunny::Exchange, ::AppOpticsAPM::Inst::BunnyExchange)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="147">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_include(::Bunny::Channel, ::AppOpticsAPM::Inst::BunnyChannel)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="687c0dbd14f83066c8bd7a5b60b4bc7fbc571b10">
  <div class="header">
    <h3>lib/appoptics_apm/inst/bunny-consumer.rb</h3>
    <h4><span class="green">90.2 %</span> covered</h4>
    <div>
      <b>51</b> relevant lines. 
      <span class="green"><b>46</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    module BunnyConsumer</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="8">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :call, ::Bunny::Consumer)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="40" data-linenumber="11">
          <span class="hits">40</span>
          
          <code class="ruby">      def collect_consumer_kvs(args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="13">
          <span class="hits">12</span>
          
          <code class="ruby">          kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="14">
          <span class="hits">12</span>
          
          <code class="ruby">          kvs[:Spec] = :job</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="15">
          <span class="hits">12</span>
          
          <code class="ruby">          kvs[:Flavor] = :rabbitmq</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="16">
          <span class="hits">12</span>
          
          <code class="ruby">          kvs[:RemoteHost]  = @channel.connection.host</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="17">
          <span class="hits">12</span>
          
          <code class="ruby">          kvs[:RemotePort]  = @channel.connection.port.to_i</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="18">
          <span class="hits">12</span>
          
          <code class="ruby">          kvs[:VirtualHost] = @channel.connection.vhost</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="20">
          <span class="hits">12</span>
          
          <code class="ruby">          mp = args[1]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="21">
          <span class="hits">12</span>
          
          <code class="ruby">          kvs[:RoutingKey] = args[0].routing_key if args[0].routing_key</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="22">
          <span class="hits">12</span>
          
          <code class="ruby">          kvs[:MsgID]      = args[1].message_id  if mp.message_id</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="23">
          <span class="hits">12</span>
          
          <code class="ruby">          kvs[:AppID]      = args[1].app_id      if mp.app_id</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="24">
          <span class="hits">12</span>
          
          <code class="ruby">          kvs[:Priority]   = args[1].priority    if mp.priority</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="26">
          <span class="hits">12</span>
          
          <code class="ruby">          if @queue.respond_to?(:name)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="27">
          <span class="hits">12</span>
          
          <code class="ruby">            kvs[:Queue] = @queue.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">            kvs[:Queue] = @queue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">          # Report configurable Controller/Action KVs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">          # See AppOpticsAPM::Config[:bunnyconsumer] in lib/appoptics_apm/config.rb</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">          # Used for dashboard trace filtering</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="35">
          <span class="hits">12</span>
          
          <code class="ruby">          controller_key = AppOpticsAPM::Config[:bunnyconsumer][:controller]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="36">
          <span class="hits">12</span>
          
          <code class="ruby">          if mp.respond_to?(controller_key)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="37">
          <span class="hits">12</span>
          
          <code class="ruby">            value = mp.method(controller_key).call</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="38">
          <span class="hits">12</span>
          
          <code class="ruby">            kvs[:Controller] = value if value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="41">
          <span class="hits">12</span>
          
          <code class="ruby">          action_key = AppOpticsAPM::Config[:bunnyconsumer][:action]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="42">
          <span class="hits">12</span>
          
          <code class="ruby">          if mp.respond_to?(action_key)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="43">
          <span class="hits">12</span>
          
          <code class="ruby">            value = mp.method(action_key).call</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="44">
          <span class="hits">12</span>
          
          <code class="ruby">            kvs[:Action] = value if value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="47">
          <span class="hits">12</span>
          
          <code class="ruby">          if kvs[:Queue]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="48">
          <span class="hits">12</span>
          
          <code class="ruby">            kvs[:URL] = &quot;/bunny/#{kvs[:Queue]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">            kvs[:URL] = &quot;/bunny/consumer&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="53">
          <span class="hits">12</span>
          
          <code class="ruby">          if AppOpticsAPM::Config[:bunnyconsumer][:log_args] &amp;&amp; @arguments</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">            kvs[:Args] = @arguments.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="57">
          <span class="hits">12</span>
          
          <code class="ruby">          kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:bunnyconsumer][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="59">
          <span class="hits">12</span>
          
          <code class="ruby">          kvs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="63">
          <span class="hits">12</span>
          
          <code class="ruby">          return kvs</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="64">
          <span class="hits">8</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="67">
          <span class="hits">28</span>
          
          <code class="ruby">      def call_with_appoptics(*args)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="68">
          <span class="hits">12</span>
          
          <code class="ruby">        report_kvs = collect_consumer_kvs(args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">        # If SourceTrace was passed, capture and report it</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="71">
          <span class="hits">12</span>
          
          <code class="ruby">        headers = args[1][:headers]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="73">
          <span class="hits">12</span>
          
          <code class="ruby">        if headers &amp;&amp; headers[&#39;SourceTrace&#39;]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="74">
          <span class="hits">6</span>
          
          <code class="ruby">          report_kvs[:SourceTrace] = headers[&#39;SourceTrace&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">          # Remove SourceTrace</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="77">
          <span class="hits">6</span>
          
          <code class="ruby">          headers.delete(&#39;SourceTrace&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="80">
          <span class="hits">12</span>
          
          <code class="ruby">        result = AppOpticsAPM::API.start_trace(:&#39;rabbitmq-consumer&#39;, nil, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="81">
          <span class="hits">12</span>
          
          <code class="ruby">          call_without_appoptics(*args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="83">
          <span class="hits">9</span>
          
          <code class="ruby">        result[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="89">
          <span class="hits">28</span>
          
          <code class="ruby">if AppOpticsAPM::Config[:bunnyconsumer][:enabled] &amp;&amp; defined?(::Bunny)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="90">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting bunny consumer&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="91">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_include(::Bunny::Consumer, ::AppOpticsAPM::Inst::BunnyConsumer)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="dc2e6465384926dfb8288f75186b87b1c333f967">
  <div class="header">
    <h3>lib/appoptics_apm/inst/curb.rb</h3>
    <h4><span class="yellow">85.71 %</span> covered</h4>
    <div>
      <b>147</b> relevant lines. 
      <span class="green"><b>126</b> lines covered</span> and
      <span class="red"><b>21</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    # Curb instrumentation wraps instance and class methods in two classes:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    # Curl::Easy and Curl::Multi.  This CurlUtility module is used as a common module</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # to be shared among both modules.</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="10">
          <span class="hits">28</span>
          
          <code class="ruby">    module CurlUtility</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="12">
          <span class="hits">28</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      # appoptics_collect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      # Used as a central area to retrieve and return values</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      # that we&#39;re interesting in reporting to AppOpticsAPM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="19">
          <span class="hits">28</span>
          
          <code class="ruby">      def appoptics_collect(verb = nil)</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="20">
          <span class="hits">75</span>
          
          <code class="ruby">        kvs = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="22">
          <span class="hits">75</span>
          
          <code class="ruby">        kvs[:IsService] = 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">        # Conditionally log query args</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="25">
          <span class="hits">75</span>
          
          <code class="ruby">        if AppOpticsAPM::Config[:curb][:log_args]</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="26">
          <span class="hits">72</span>
          
          <code class="ruby">          kvs[:RemoteURL] = url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="28">
          <span class="hits">3</span>
          
          <code class="ruby">          kvs[:RemoteURL] = url.split(&#39;?&#39;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="31">
          <span class="hits">75</span>
          
          <code class="ruby">        kvs[:HTTPMethod] = verb if verb</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        # Avoid cross host tracing for blacklisted domains</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="34">
          <span class="hits">75</span>
          
          <code class="ruby">        kvs[:blacklisted] = AppOpticsAPM::API.blacklisted?(URI(url).hostname)</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="35">
          <span class="hits">75</span>
          
          <code class="ruby">        kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:curb][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="37">
          <span class="hits">75</span>
          
          <code class="ruby">        kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] Error capturing curb KVs: #{e.message}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug e.backtrace.join(&#39;\n&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      ensure</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="45">
          <span class="hits">75</span>
          
          <code class="ruby">        return kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      # profile_curb_method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      # An agnostic method that will profile any Curl::Easy method (and optional args and block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      # that you throw at it.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="54">
          <span class="hits">28</span>
          
          <code class="ruby">      def profile_curb_method(kvs, method, args, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">        # If we&#39;re not tracing, just do a fast return.</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="56">
          <span class="hits">75</span>
          
          <code class="ruby">        unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">          unless AppOpticsAPM::API.blacklisted?(URI(url).hostname)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">            self.headers[&#39;X-Trace&#39;] = AppOpticsAPM::Context.toString if AppOpticsAPM::Context.isValid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">          return self.send(method, args, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="63">
          <span class="hits">75</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="64">
          <span class="hits">75</span>
          
          <code class="ruby">          response_context = nil</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="65">
          <span class="hits">75</span>
          
          <code class="ruby">          kvs.merge! appoptics_collect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="67">
          <span class="hits">75</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(:curb, kvs)</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="68">
          <span class="hits">75</span>
          
          <code class="ruby">          kvs.clear</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">          # The core curb call</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="71">
          <span class="hits">75</span>
          
          <code class="ruby">          unless AppOpticsAPM::API.blacklisted?(URI(url).hostname)</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="72">
          <span class="hits">69</span>
          
          <code class="ruby">            self.headers[&#39;X-Trace&#39;] = AppOpticsAPM::Context.toString if AppOpticsAPM::Context.isValid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="74">
          <span class="hits">75</span>
          
          <code class="ruby">          response = self.send(method, *args, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="76">
          <span class="hits">72</span>
          
          <code class="ruby">            kvs[:HTTPStatus] = response_code</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">            # If we get a redirect, report the location header</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="79">
          <span class="hits">72</span>
          
          <code class="ruby">            if ((300..308).to_a.include? response_code) &amp;&amp; headers.key?(&quot;Location&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">              kvs[:Location] = headers[&quot;Location&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="83">
          <span class="hits">72</span>
          
          <code class="ruby">            _, *response_headers = header_str.split(/[\r\n]+/).map(&amp;:strip)</code>
        </li>
      
        <li class="covered" data-hits="234" data-linenumber="84">
          <span class="hits">234</span>
          
          <code class="ruby">            response_headers = Hash[response_headers.flat_map{ |s| s.scan(/^(\S+): (.+)/) }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="86">
          <span class="hits">72</span>
          
          <code class="ruby">            response_context = response_headers[&#39;X-Trace&#39;]</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="87">
          <span class="hits">72</span>
          
          <code class="ruby">            if response_context &amp;&amp; !kvs[:blacklisted]</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="88">
          <span class="hits">54</span>
          
          <code class="ruby">              AppOpticsAPM::XTrace.continue_service_context(self.headers[&#39;X-Trace&#39;], response_context)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="91">
          <span class="hits">72</span>
          
          <code class="ruby">          response</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="92">
          <span class="hits">3</span>
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="93">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(:curb, e)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="94">
          <span class="hits">3</span>
          
          <code class="ruby">          raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="96">
          <span class="hits">75</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exit(:curb, kvs)</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="97">
          <span class="hits">50</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    end # CurlUtility</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    # Instrumentation specific to ::Curl::Easy</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="103">
          <span class="hits">28</span>
          
          <code class="ruby">    module CurlEasy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">      # Common methods</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="105">
          <span class="hits">28</span>
          
          <code class="ruby">      include AppOpticsAPM::Inst::CurlUtility</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="107">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="108">
          <span class="hits">9</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :http, ::Curl::Easy)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="109">
          <span class="hits">9</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :perform, ::Curl::Easy)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="110">
          <span class="hits">9</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :http_put, ::Curl::Easy)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="111">
          <span class="hits">9</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :http_post, ::Curl::Easy)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      # http_post_with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">      # ::Curl::Easy.new.http_post wrapper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="119">
          <span class="hits">28</span>
          
          <code class="ruby">      def http_post_with_appoptics(*args, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">        # If we&#39;re not tracing, just do a fast return.</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="121">
          <span class="hits">9</span>
          
          <code class="ruby">        if !AppOpticsAPM.tracing? || AppOpticsAPM.tracing_layer?(:curb)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">          unless AppOpticsAPM::API.blacklisted?(URI(url).hostname)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">            self.headers[&#39;X-Trace&#39;] = AppOpticsAPM::Context.toString() if AppOpticsAPM::Context.isValid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">          return http_post_without_appoptics(*args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="128">
          <span class="hits">9</span>
          
          <code class="ruby">        kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="129">
          <span class="hits">9</span>
          
          <code class="ruby">        kvs[:HTTPMethod] = :POST</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="131">
          <span class="hits">9</span>
          
          <code class="ruby">        profile_curb_method(kvs, :http_post_without_appoptics, args, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      # http_put_with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">      # ::Curl::Easy.new.http_put wrapper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="139">
          <span class="hits">28</span>
          
          <code class="ruby">      def http_put_with_appoptics(*args, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">        # If we&#39;re not tracing, just do a fast return.</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="141">
          <span class="hits">9</span>
          
          <code class="ruby">        if !AppOpticsAPM.tracing? || AppOpticsAPM.tracing_layer?(:curb)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">          unless AppOpticsAPM::API.blacklisted?(URI(url).hostname)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">            self.headers[&#39;X-Trace&#39;] = AppOpticsAPM::Context.toString() if AppOpticsAPM::Context.isValid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">          return http_put_without_appoptics(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="148">
          <span class="hits">9</span>
          
          <code class="ruby">        kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="149">
          <span class="hits">9</span>
          
          <code class="ruby">        kvs[:HTTPMethod] = :PUT</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="151">
          <span class="hits">9</span>
          
          <code class="ruby">        profile_curb_method(kvs, :http_put_without_appoptics, args, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">      # perform_with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      # ::Curl::Easy.new.perform wrapper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="159">
          <span class="hits">28</span>
          
          <code class="ruby">      def perform_with_appoptics(&amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">        # If we&#39;re not tracing, just do a fast return.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">        # excluding curb layer: because the curb C code for easy.http calls perform,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">        # we have to make sure we don&#39;t log again</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="163">
          <span class="hits">63</span>
          
          <code class="ruby">        if !AppOpticsAPM.tracing? || AppOpticsAPM.tracing_layer?(:curb)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="164">
          <span class="hits">48</span>
          
          <code class="ruby">          unless AppOpticsAPM::API.blacklisted?(URI(url).hostname)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="165">
          <span class="hits">48</span>
          
          <code class="ruby">            self.headers[&#39;X-Trace&#39;] = AppOpticsAPM::Context.toString() if AppOpticsAPM::Context.isValid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="167">
          <span class="hits">48</span>
          
          <code class="ruby">          return perform_without_appoptics(&amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="170">
          <span class="hits">15</span>
          
          <code class="ruby">        kvs = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">        # This perform gets called from two places, ::Curl::Easy.new.perform</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">        # and Curl::Easy.new.http_head. In the case of http_head we detect the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">        # HTTP verb via get info.</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="174">
          <span class="hits">15</span>
          
          <code class="ruby">        if self.getinfo(self.sym2curl(:nobody))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">          kvs[:HTTPMethod] = :HEAD</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="177">
          <span class="hits">15</span>
          
          <code class="ruby">          kvs[:HTTPMethod] = :GET</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="180">
          <span class="hits">15</span>
          
          <code class="ruby">        profile_curb_method(kvs, :perform_without_appoptics, nil, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">      # http_with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">      # ::Curl::Easy.new.http wrapper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="188">
          <span class="hits">28</span>
          
          <code class="ruby">      def http_with_appoptics(verb, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">        # If we&#39;re not tracing, just do a fast return.</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="190">
          <span class="hits">57</span>
          
          <code class="ruby">        unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="191">
          <span class="hits">15</span>
          
          <code class="ruby">          unless AppOpticsAPM::API.blacklisted?(URI(url).hostname)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="192">
          <span class="hits">15</span>
          
          <code class="ruby">            self.headers[&#39;X-Trace&#39;] = AppOpticsAPM::Context.toString() if AppOpticsAPM::Context.isValid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="194">
          <span class="hits">15</span>
          
          <code class="ruby">          return http_without_appoptics(verb)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="197">
          <span class="hits">42</span>
          
          <code class="ruby">        kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="198">
          <span class="hits">42</span>
          
          <code class="ruby">        kvs[:HTTPMethod] = verb</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="200">
          <span class="hits">42</span>
          
          <code class="ruby">        profile_curb_method(kvs, :http_without_appoptics, [verb], &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">    # CurlMultiCM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">    # This module contains the class method wrappers for the CurlMulti class.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">    # This module should be _extended_ by CurlMulti.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="210">
          <span class="hits">28</span>
          
          <code class="ruby">    module CurlMultiCM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="211">
          <span class="hits">28</span>
          
          <code class="ruby">      include AppOpticsAPM::Inst::CurlUtility</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="213">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.extended(klass)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="214">
          <span class="hits">9</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.class_method_alias(klass, :http, ::Curl::Multi)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">      # http_with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">      # ::Curl::Multi.new.http wrapper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="222">
          <span class="hits">28</span>
          
          <code class="ruby">      def http_with_appoptics(urls_with_config, multi_options={}, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">        # If we&#39;re not tracing, just do a fast return.</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="224">
          <span class="hits">27</span>
          
          <code class="ruby">        unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="225">
          <span class="hits">12</span>
          
          <code class="ruby">          urls_with_config.each do |conf|</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="226">
          <span class="hits">36</span>
          
          <code class="ruby">            unless AppOpticsAPM::API.blacklisted?(URI(conf[:url]).hostname)</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="227">
          <span class="hits">36</span>
          
          <code class="ruby">              conf[:headers] ||= {}</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="228">
          <span class="hits">36</span>
          
          <code class="ruby">              conf[:headers][&#39;X-Trace&#39;] = AppOpticsAPM::Context.toString if AppOpticsAPM::Context.isValid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="231">
          <span class="hits">12</span>
          
          <code class="ruby">          return http_without_appoptics(urls_with_config, multi_options, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="234">
          <span class="hits">15</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="235">
          <span class="hits">15</span>
          
          <code class="ruby">          kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="236">
          <span class="hits">15</span>
          
          <code class="ruby">          kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:curb][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="238">
          <span class="hits">15</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(:curb_multi, kvs)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="239">
          <span class="hits">15</span>
          
          <code class="ruby">          context = AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="240">
          <span class="hits">15</span>
          
          <code class="ruby">          urls_with_config.each do |conf|</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="241">
          <span class="hits">45</span>
          
          <code class="ruby">            unless AppOpticsAPM::API.blacklisted?(URI(conf[:url]).hostname)</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="242">
          <span class="hits">45</span>
          
          <code class="ruby">              conf[:headers] ||= {}</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="243">
          <span class="hits">45</span>
          
          <code class="ruby">              conf[:headers][&#39;X-Trace&#39;] = context if AppOpticsAPM::Context.isValid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="247">
          <span class="hits">15</span>
          
          <code class="ruby">          traces = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">          # The core curb call</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="249">
          <span class="hits">15</span>
          
          <code class="ruby">          http_without_appoptics(urls_with_config, multi_options) do |easy, response_code, method|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">            # this is the only way we can access the headers, they are not exposed otherwise</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="251">
          <span class="hits">27</span>
          
          <code class="ruby">            unless AppOpticsAPM::API.blacklisted?(URI(easy.url).hostname)</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="252">
          <span class="hits">54</span>
          
          <code class="ruby">              xtrace = easy.header_str.scan(/X-Trace: ([0-9A-F]*)/).map{ |m| m[0] }</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="253">
          <span class="hits">27</span>
          
          <code class="ruby">              traces &lt;&lt; xtrace[0] unless xtrace.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="255">
          <span class="hits">27</span>
          
          <code class="ruby">            block.call(easy, response_code, method) if block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="257">
          <span class="hits">15</span>
          
          <code class="ruby">          AppOpticsAPM::XTrace.continue_service_context(context, traces.pop) unless traces.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(:curb_multi, e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">          raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="262">
          <span class="hits">15</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_multi_exit(:curb_multi, traces)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="263">
          <span class="hits">10</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">    # CurlMultiIM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">    # This module contains the instance method wrappers for the CurlMulti class.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">    # This module should be _included_ into CurlMulti.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="273">
          <span class="hits">28</span>
          
          <code class="ruby">    module CurlMultiIM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="274">
          <span class="hits">28</span>
          
          <code class="ruby">      include AppOpticsAPM::Inst::CurlUtility</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="276">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="277">
          <span class="hits">9</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :perform, ::Curl::Multi)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">      # perform_with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">      # ::Curl::Multi.new.perform wrapper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">      # the reason we instrument this method is because it can be called directly,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">      # therefore we exclude calls that already have a curb layer assigned</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">      # Be aware: this method is also called from the c-implementation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="289">
          <span class="hits">28</span>
          
          <code class="ruby">      def perform_with_appoptics(&amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">        # If we&#39;re not tracing or we&#39;re already tracing curb, just do a fast return.</code>
        </li>
      
        <li class="covered" data-hits="93" data-linenumber="291">
          <span class="hits">93</span>
          
          <code class="ruby">        if !AppOpticsAPM.tracing? || [:curb, :curb_multi].include?(AppOpticsAPM.layer)</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="292">
          <span class="hits">84</span>
          
          <code class="ruby">          self.requests.each do |request|</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="293">
          <span class="hits">126</span>
          
          <code class="ruby">            unless AppOpticsAPM::API.blacklisted?(URI(request.url).hostname)</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="294">
          <span class="hits">126</span>
          
          <code class="ruby">              request.headers[&#39;X-Trace&#39;] = AppOpticsAPM::Context.toString if AppOpticsAPM::Context.isValid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="297">
          <span class="hits">84</span>
          
          <code class="ruby">          return perform_without_appoptics(&amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="300">
          <span class="hits">9</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="301">
          <span class="hits">9</span>
          
          <code class="ruby">          kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="302">
          <span class="hits">9</span>
          
          <code class="ruby">          kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:curb][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="304">
          <span class="hits">9</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(:curb_multi, kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="306">
          <span class="hits">9</span>
          
          <code class="ruby">          self.requests.each do |request|</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="307">
          <span class="hits">27</span>
          
          <code class="ruby">            unless AppOpticsAPM::API.blacklisted?(URI(request.url).hostname)</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="308">
          <span class="hits">27</span>
          
          <code class="ruby">              request.headers[&#39;X-Trace&#39;] = AppOpticsAPM::Context.toString if AppOpticsAPM::Context.isValid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="312">
          <span class="hits">9</span>
          
          <code class="ruby">          perform_without_appoptics(&amp;block)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(:curb_multi, e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">          raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="317">
          <span class="hits">9</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exit(:curb_multi)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="318">
          <span class="hits">6</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="324">
          <span class="hits">28</span>
          
          <code class="ruby">if AppOpticsAPM::Config[:curb][:enabled] &amp;&amp; defined?(::Curl)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="325">
          <span class="hits">9</span>
          
          <code class="ruby">  ::AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting curb&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="326">
          <span class="hits">9</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_include(::Curl::Easy, ::AppOpticsAPM::Inst::CurlEasy)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="327">
          <span class="hits">9</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_extend(::Curl::Multi, ::AppOpticsAPM::Inst::CurlMultiCM)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="328">
          <span class="hits">9</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_include(::Curl::Multi, ::AppOpticsAPM::Inst::CurlMultiIM)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9cddf1ac04e3f42169c65199808a463061ee8b79">
  <div class="header">
    <h3>lib/appoptics_apm/inst/dalli.rb</h3>
    <h4><span class="green">95.83 %</span> covered</h4>
    <div>
      <b>48</b> relevant lines. 
      <span class="green"><b>46</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    module Dalli</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">      include AppOpticsAPM::API::Memcache</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="9">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(cls)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="10">
          <span class="hits">3</span>
          
          <code class="ruby">        cls.class_eval do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="11">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting memcache (dalli)&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="12">
          <span class="hits">3</span>
          
          <code class="ruby">          if ::Dalli::Client.private_method_defined? :perform</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="13">
          <span class="hits">3</span>
          
          <code class="ruby">            alias perform_without_appoptics perform</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="14">
          <span class="hits">3</span>
          
          <code class="ruby">            alias perform perform_with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">            AppOpticsAPM.logger.warn &#39;[appoptics_apm/loading] Couldn\&#39;t properly instrument Memcache (Dalli).  Partial traces may occur.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="19">
          <span class="hits">3</span>
          
          <code class="ruby">          if ::Dalli::Client.method_defined? :get_multi</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="20">
          <span class="hits">3</span>
          
          <code class="ruby">            alias get_multi_without_appoptics get_multi</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="21">
          <span class="hits">3</span>
          
          <code class="ruby">            alias get_multi get_multi_with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="26">
          <span class="hits">28</span>
          
          <code class="ruby">      def perform_with_appoptics(*all_args, &amp;blk)</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="27">
          <span class="hits">42</span>
          
          <code class="ruby">        op, key, *args = *all_args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="29">
          <span class="hits">42</span>
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="30">
          <span class="hits">42</span>
          
          <code class="ruby">        report_kvs[:KVOp] = op</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="31">
          <span class="hits">42</span>
          
          <code class="ruby">        report_kvs[:KVKey] = key</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="32">
          <span class="hits">42</span>
          
          <code class="ruby">        if @servers.is_a?(Array) &amp;&amp; !@servers.empty?</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="33">
          <span class="hits">42</span>
          
          <code class="ruby">          report_kvs[:RemoteHost] = @servers.join(&quot;, &quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="36">
          <span class="hits">42</span>
          
          <code class="ruby">        if AppOpticsAPM.tracing? &amp;&amp; !AppOpticsAPM.tracing_layer_op?(:get_multi)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="37">
          <span class="hits">24</span>
          
          <code class="ruby">          AppOpticsAPM::API.trace(:memcache, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="38">
          <span class="hits">24</span>
          
          <code class="ruby">            result = perform_without_appoptics(*all_args, &amp;blk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">            # Clear the hash for a potential info event</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="41">
          <span class="hits">24</span>
          
          <code class="ruby">            report_kvs.clear</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="42">
          <span class="hits">24</span>
          
          <code class="ruby">            report_kvs[:KVHit] = memcache_hit?(result) if op == :get &amp;&amp; key.class == String</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="43">
          <span class="hits">24</span>
          
          <code class="ruby">            report_kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:dalli][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="45">
          <span class="hits">24</span>
          
          <code class="ruby">            AppOpticsAPM::API.log(:memcache, :info, report_kvs) unless report_kvs.empty?</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="46">
          <span class="hits">24</span>
          
          <code class="ruby">            result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="49">
          <span class="hits">18</span>
          
          <code class="ruby">          perform_without_appoptics(*all_args, &amp;blk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="53">
          <span class="hits">28</span>
          
          <code class="ruby">      def get_multi_with_appoptics(*keys)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="54">
          <span class="hits">3</span>
          
          <code class="ruby">        return get_multi_without_appoptics(*keys) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="56">
          <span class="hits">3</span>
          
          <code class="ruby">        info_kvs = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="58">
          <span class="hits">3</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="59">
          <span class="hits">3</span>
          
          <code class="ruby">          info_kvs[:KVKeyCount] = keys.flatten.length</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="60">
          <span class="hits">3</span>
          
          <code class="ruby">          info_kvs[:KVKeyCount] = (info_kvs[:KVKeyCount] - 1) if keys.last.is_a?(Hash) || keys.last.nil?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="61">
          <span class="hits">3</span>
          
          <code class="ruby">          if @servers.is_a?(Array) &amp;&amp; !@servers.empty?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="62">
          <span class="hits">3</span>
          
          <code class="ruby">            info_kvs[:RemoteHost] = @servers.join(&quot;, &quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="68">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:memcache, { :KVOp =&gt; :get_multi }, :get_multi) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="69">
          <span class="hits">3</span>
          
          <code class="ruby">          values = get_multi_without_appoptics(*keys)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="71">
          <span class="hits">3</span>
          
          <code class="ruby">          info_kvs[:KVHitCount] = values.length</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="72">
          <span class="hits">3</span>
          
          <code class="ruby">          info_kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:dalli][:collect_backtraces]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="73">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM::API.log(:memcache, :info, info_kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="75">
          <span class="hits">3</span>
          
          <code class="ruby">          values</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="82">
          <span class="hits">28</span>
          
          <code class="ruby">if defined?(Dalli) &amp;&amp; AppOpticsAPM::Config[:dalli][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="83">
          <span class="hits">3</span>
          
          <code class="ruby">  ::Dalli::Client.module_eval do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="84">
          <span class="hits">3</span>
          
          <code class="ruby">    include AppOpticsAPM::Inst::Dalli</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c074cf4df4d4b2b6602af174541e80992a770eb4">
  <div class="header">
    <h3>lib/appoptics_apm/inst/delayed_job.rb</h3>
    <h4><span class="green">91.11 %</span> covered</h4>
    <div>
      <b>45</b> relevant lines. 
      <span class="green"><b>41</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">if defined?(::Delayed)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="5">
          <span class="hits">3</span>
          
          <code class="ruby">  module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="6">
          <span class="hits">3</span>
          
          <code class="ruby">    module Inst</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="7">
          <span class="hits">3</span>
          
          <code class="ruby">      module DelayedJob</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">        ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">        # ForkHandler</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">        # Since delayed job doesn&#39;t offer a hook into `after_fork`, we alias the method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">        # here to do our magic after a fork happens.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="14">
          <span class="hits">3</span>
          
          <code class="ruby">        module ForkHandler</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="15">
          <span class="hits">3</span>
          
          <code class="ruby">          def self.extended(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="16">
          <span class="hits">3</span>
          
          <code class="ruby">            ::AppOpticsAPM::Util.class_method_alias(klass, :after_fork, ::Delayed::Worker)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="19">
          <span class="hits">3</span>
          
          <code class="ruby">          def after_fork_with_appoptics</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">            ::AppOpticsAPM.logger.info &#39;[appoptics_apm/delayed_job] Detected fork.  Restarting AppOpticsAPM reporter.&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">            ::AppOpticsAPM::Reporter.restart unless ENV.key?(&#39;APPOPTICS_GEM_TEST&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">            after_fork_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        # AppOpticsAPM::Inst::DelayedJob::Plugin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        # The AppOpticsAPM DelayedJob plugin.  Here we wrap `enqueue` and</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">        # `perform` to capture the timing of the bits we&#39;re interested</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        # in.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="34">
          <span class="hits">3</span>
          
          <code class="ruby">        class Plugin &lt; Delayed::Plugin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="35">
          <span class="hits">3</span>
          
          <code class="ruby">          callbacks do |lifecycle|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">            # enqueue</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="38">
          <span class="hits">3</span>
          
          <code class="ruby">            if AppOpticsAPM::Config[:delayed_jobclient][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="39">
          <span class="hits">3</span>
          
          <code class="ruby">              lifecycle.around(:enqueue) do |job, &amp;block|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">                begin</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="41">
          <span class="hits">15</span>
          
          <code class="ruby">                  report_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="42">
          <span class="hits">15</span>
          
          <code class="ruby">                  report_kvs[:Spec] = :pushq</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="43">
          <span class="hits">15</span>
          
          <code class="ruby">                  report_kvs[:Flavor] = :DelayedJob</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="44">
          <span class="hits">15</span>
          
          <code class="ruby">                  report_kvs[:JobName] = job.name</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="45">
          <span class="hits">15</span>
          
          <code class="ruby">                  report_kvs[:MsgID] = job.id</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="46">
          <span class="hits">15</span>
          
          <code class="ruby">                  report_kvs[:Queue] = job.queue if job.queue</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="47">
          <span class="hits">15</span>
          
          <code class="ruby">                  report_kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:delayed_jobclient][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="49">
          <span class="hits">15</span>
          
          <code class="ruby">                  AppOpticsAPM::API.trace(:&#39;delayed_job-client&#39;, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="50">
          <span class="hits">15</span>
          
          <code class="ruby">                    block.call(job)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">                  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">            # invoke_job</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="57">
          <span class="hits">3</span>
          
          <code class="ruby">            if AppOpticsAPM::Config[:delayed_jobworker][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="58">
          <span class="hits">3</span>
          
          <code class="ruby">              lifecycle.around(:perform) do |worker, job, &amp;block|</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="59">
          <span class="hits">9</span>
          
          <code class="ruby">                begin</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="60">
          <span class="hits">9</span>
          
          <code class="ruby">                  report_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="61">
          <span class="hits">9</span>
          
          <code class="ruby">                  report_kvs[:Spec] = :job</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="62">
          <span class="hits">9</span>
          
          <code class="ruby">                  report_kvs[:Flavor] = :DelayedJob</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="63">
          <span class="hits">9</span>
          
          <code class="ruby">                  report_kvs[:JobName] = job.name</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="64">
          <span class="hits">9</span>
          
          <code class="ruby">                  report_kvs[:MsgID] = job.id</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="65">
          <span class="hits">9</span>
          
          <code class="ruby">                  report_kvs[:Queue] = job.queue if job.queue</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="66">
          <span class="hits">9</span>
          
          <code class="ruby">                  report_kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:delayed_jobworker][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">                  # DelayedJob Specific KVs</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="69">
          <span class="hits">9</span>
          
          <code class="ruby">                  report_kvs[:priority] = job.priority</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="70">
          <span class="hits">9</span>
          
          <code class="ruby">                  report_kvs[:attempts] = job.attempts</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="71">
          <span class="hits">9</span>
          
          <code class="ruby">                  report_kvs[:WorkerName] = job.locked_by</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">                rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">                  AppOpticsAPM.logger.warn &quot;[appoptics_apm/warning] inst/delayed_job.rb: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="76">
          <span class="hits">9</span>
          
          <code class="ruby">                result = AppOpticsAPM::API.start_trace(:&#39;delayed_job-worker&#39;, nil, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="77">
          <span class="hits">9</span>
          
          <code class="ruby">                  block.call(worker, job)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="78">
          <span class="hits">9</span>
          
          <code class="ruby">                  AppOpticsAPM::API.log_exception(nil, job.error) if job.error</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="80">
          <span class="hits">9</span>
          
          <code class="ruby">                result[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="89">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting delayed_job&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="90">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_extend(::Delayed::Worker, ::AppOpticsAPM::Inst::DelayedJob::ForkHandler)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="91">
          <span class="hits">3</span>
          
          <code class="ruby">  ::Delayed::Worker.plugins &lt;&lt; ::AppOpticsAPM::Inst::DelayedJob::Plugin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="97d36c893d3b23333dd49fc56ae17fc271c03222">
  <div class="header">
    <h3>lib/appoptics_apm/inst/em-http-request.rb</h3>
    <h4><span class="red">14.29 %</span> covered</h4>
    <div>
      <b>56</b> relevant lines. 
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>48</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    module EventMachine</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">      module HttpConnection</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="8">
          <span class="hits">28</span>
          
          <code class="ruby">        def setup_request_with_appoptics(*args, &amp;block)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">          context = AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">          blacklisted = AppOpticsAPM::API.blacklisted?(@uri)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">          if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">            report_kvs = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">            begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">              report_kvs[:IsService] = 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">              report_kvs[:RemoteURL] = @uri</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">              report_kvs[:HTTPMethod] = args[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">              report_kvs[:Blacklisted] = true if blacklisted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">              if AppOpticsAPM::Config[:em_http_request][:collect_backtraces]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">                report_kvs[:Backtrace] = AppOpticsAPM::API.backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">            rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">              AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] em-http-request KV error: #{e.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">            ::AppOpticsAPM::API.log_entry(&#39;em-http-request&#39;, report_kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">          client = setup_request_without_appoptics(*args, &amp;block)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">          client.req.headers[&#39;X-Trace&#39;] = context unless blacklisted</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">          client</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="36">
          <span class="hits">28</span>
          
          <code class="ruby">      module HttpClient</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="37">
          <span class="hits">28</span>
          
          <code class="ruby">        def parse_response_header_with_appoptics(*args, &amp;block)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">          report_kvs = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">          xtrace = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">          blacklisted = AppOpticsAPM::API.blacklisted?(@uri)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">            report_kvs[:HTTPStatus] = args[2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">            report_kvs[:Async] = 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">          rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">            AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] em-http-request KV error: #{e.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">          parse_response_header_without_appoptics(*args, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">          unless blacklisted</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">            headers = args[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">            context = AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">            task_id = AppOpticsAPM::XTrace.task_id(context)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">            if headers.is_a?(Hash) &amp;&amp; headers.key?(&#39;X-Trace&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">              xtrace = headers[&#39;X-Trace&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">            if AppOpticsAPM::XTrace.valid?(xtrace) &amp;&amp; AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">              # Assure that we received back a valid X-Trace with the same task_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">              if task_id == AppOpticsAPM::XTrace.task_id(xtrace)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">                AppOpticsAPM::Context.fromString(xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">                AppOpticsAPM.logger.debug &quot;Mismatched returned X-Trace ID : #{xtrace}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">          ::AppOpticsAPM::API.log_exit(:&#39;em-http-request&#39;, report_kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="79">
          <span class="hits">28</span>
          
          <code class="ruby">if defined?(::EventMachine::HttpConnection) &amp;&amp; defined?(::EventMachine::HttpClient) &amp;&amp; AppOpticsAPM::Config[:em_http_request][:enabled]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">  AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting em-http-request&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">  class ::EventMachine::HttpConnection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    include AppOpticsAPM::Inst::EventMachine::HttpConnection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    if method_defined?(:setup_request)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">      class_eval &#39;alias :setup_request_without_appoptics :setup_request&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">      class_eval &#39;alias :setup_request :setup_request_with_appoptics&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">      AppOpticsAPM.logger.warn &#39;[appoptics_apm/loading] Couldn\&#39;t properly instrument em-http-request (:setup_request).  Partial traces may occur.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">  class ::EventMachine::HttpClient</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    include AppOpticsAPM::Inst::EventMachine::HttpClient</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">    if method_defined?(:parse_response_header)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">      class_eval &#39;alias :parse_response_header_without_appoptics :parse_response_header&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      class_eval &#39;alias :parse_response_header :parse_response_header_with_appoptics&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">      AppOpticsAPM.logger.warn &#39;[appoptics_apm/loading] Couldn\&#39;t properly instrument em-http-request (:parse_response_header).  Partial traces may occur.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3484bd1d1cc873539c958aa5422fe4274685003e">
  <div class="header">
    <h3>lib/appoptics_apm/inst/excon.rb</h3>
    <h4><span class="green">95.38 %</span> covered</h4>
    <div>
      <b>65</b> relevant lines. 
      <span class="green"><b>62</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    module ExconConnection</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="8">
          <span class="hits">9</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :request, ::Excon::Connection)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="9">
          <span class="hits">9</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :requests, ::Excon::Connection)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="12">
          <span class="hits">28</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="14">
          <span class="hits">28</span>
          
          <code class="ruby">      def appoptics_collect(params)</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="15">
          <span class="hits">75</span>
          
          <code class="ruby">        kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="16">
          <span class="hits">75</span>
          
          <code class="ruby">        kvs[:IsService] = 1</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="17">
          <span class="hits">75</span>
          
          <code class="ruby">        kvs[:RemoteProtocol] = ::AppOpticsAPM::Util.upcase(@data[:scheme])</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="18">
          <span class="hits">75</span>
          
          <code class="ruby">        kvs[:RemoteHost] = @data[:host]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">        # Conditionally log query args</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="21">
          <span class="hits">75</span>
          
          <code class="ruby">        if AppOpticsAPM::Config[:excon][:log_args] &amp;&amp; @data[:query]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="22">
          <span class="hits">12</span>
          
          <code class="ruby">          if @data[:query].is_a?(Hash)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="23">
          <span class="hits">3</span>
          
          <code class="ruby">            kvs[:ServiceArg] = &quot;#{@data[:path]}?#{URI.encode_www_form(@data[:query])}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="25">
          <span class="hits">9</span>
          
          <code class="ruby">            kvs[:ServiceArg] = &quot;#{@data[:path]}?#{@data[:query]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="28">
          <span class="hits">63</span>
          
          <code class="ruby">          kvs[:ServiceArg] = @data[:path]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">        # In the case of HTTP pipelining, params could be an array of</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        # request hashes.</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="33">
          <span class="hits">75</span>
          
          <code class="ruby">        if params.is_a?(Array)</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="34">
          <span class="hits">27</span>
          
          <code class="ruby">          methods = []</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="35">
          <span class="hits">27</span>
          
          <code class="ruby">          params.each do |p|</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="36">
          <span class="hits">54</span>
          
          <code class="ruby">            methods &lt;&lt; ::AppOpticsAPM::Util.upcase(p[:method])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="38">
          <span class="hits">27</span>
          
          <code class="ruby">          kvs[:HTTPMethods] = methods.join(&#39;, &#39;)[0..1024]</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="39">
          <span class="hits">27</span>
          
          <code class="ruby">          kvs[:Pipeline] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="41">
          <span class="hits">48</span>
          
          <code class="ruby">          kvs[:HTTPMethod] = ::AppOpticsAPM::Util.upcase(params[:method])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="43">
          <span class="hits">75</span>
          
          <code class="ruby">        kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:excon][:collect_backtraces]</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="44">
          <span class="hits">75</span>
          
          <code class="ruby">        kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] Error capturing excon KVs: #{e.message}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug e.backtrace.join(&#39;\n&#39;) if ::AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      ensure</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="49">
          <span class="hits">75</span>
          
          <code class="ruby">        return kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="52">
          <span class="hits">28</span>
          
          <code class="ruby">      public</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="54">
          <span class="hits">28</span>
          
          <code class="ruby">      def requests_with_appoptics(pipeline_params)</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="55">
          <span class="hits">27</span>
          
          <code class="ruby">        responses = nil</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="56">
          <span class="hits">27</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:excon, appoptics_collect(pipeline_params)) do</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="57">
          <span class="hits">27</span>
          
          <code class="ruby">          responses = requests_without_appoptics(pipeline_params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="59">
          <span class="hits">27</span>
          
          <code class="ruby">        responses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="62">
          <span class="hits">28</span>
          
          <code class="ruby">      def request_with_appoptics(params={}, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        # Avoid cross host tracing for blacklisted domains</code>
        </li>
      
        <li class="covered" data-hits="114" data-linenumber="64">
          <span class="hits">114</span>
          
          <code class="ruby">        blacklisted = AppOpticsAPM::API.blacklisted?(@data[:hostname] || @data[:host])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        # If we&#39;re not tracing, just do a fast return.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">        # If making HTTP pipeline requests (ordered batched)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">        # then just return as we&#39;re tracing from parent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">        # &lt;tt&gt;requests&lt;/tt&gt;</code>
        </li>
      
        <li class="covered" data-hits="114" data-linenumber="70">
          <span class="hits">114</span>
          
          <code class="ruby">        if !AppOpticsAPM.tracing? || params[:pipeline]</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="71">
          <span class="hits">66</span>
          
          <code class="ruby">          @data[:headers][&#39;X-Trace&#39;] = AppOpticsAPM::Context.toString if AppOpticsAPM::Context.isValid &amp;&amp; !blacklisted</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="72">
          <span class="hits">66</span>
          
          <code class="ruby">          return request_without_appoptics(params, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="75">
          <span class="hits">48</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="76">
          <span class="hits">48</span>
          
          <code class="ruby">          response_context = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="78">
          <span class="hits">48</span>
          
          <code class="ruby">          kvs = appoptics_collect(params)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="79">
          <span class="hits">48</span>
          
          <code class="ruby">          kvs[:Blacklisted] = true if blacklisted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="81">
          <span class="hits">48</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(:excon, kvs)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="82">
          <span class="hits">48</span>
          
          <code class="ruby">          kvs.clear</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="84">
          <span class="hits">48</span>
          
          <code class="ruby">          req_context = AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="85">
          <span class="hits">48</span>
          
          <code class="ruby">          @data[:headers][&#39;X-Trace&#39;] = req_context unless blacklisted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">          # The core excon call</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="88">
          <span class="hits">48</span>
          
          <code class="ruby">          response = request_without_appoptics(params, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">          # excon only passes back a hash (datum) for HTTP pipelining...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">          # In that case, we should never arrive here but for the OCD, double check</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">          # the datatype before trying to extract pertinent info</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="93">
          <span class="hits">45</span>
          
          <code class="ruby">          if response.is_a?(Excon::Response)</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="94">
          <span class="hits">45</span>
          
          <code class="ruby">            response_context = response.headers[&#39;X-Trace&#39;]</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="95">
          <span class="hits">45</span>
          
          <code class="ruby">            kvs[:HTTPStatus] = response.status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">            # If we get a redirect, report the location header</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="98">
          <span class="hits">45</span>
          
          <code class="ruby">            if ((300..308).to_a.include? response.status.to_i) &amp;&amp; response.headers.key?(&#39;Location&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">              kvs[:Location] = response.headers[&#39;Location&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="102">
          <span class="hits">45</span>
          
          <code class="ruby">            if response_context &amp;&amp; !blacklisted</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="103">
          <span class="hits">27</span>
          
          <code class="ruby">              AppOpticsAPM::XTrace.continue_service_context(req_context, response_context)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="107">
          <span class="hits">45</span>
          
          <code class="ruby">          response</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="108">
          <span class="hits">3</span>
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="109">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(:excon, e)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="110">
          <span class="hits">3</span>
          
          <code class="ruby">          raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="112">
          <span class="hits">48</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exit(:excon, kvs) unless params[:pipeline]</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="113">
          <span class="hits">32</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="119">
          <span class="hits">28</span>
          
          <code class="ruby">if AppOpticsAPM::Config[:excon][:enabled] &amp;&amp; defined?(::Excon)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="120">
          <span class="hits">9</span>
          
          <code class="ruby">  ::AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting excon&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="121">
          <span class="hits">9</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_include(::Excon::Connection, ::AppOpticsAPM::Inst::ExconConnection)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3e8acb3c6d7bdb2020cd5b336613515c405c1700">
  <div class="header">
    <h3>lib/appoptics_apm/inst/faraday.rb</h3>
    <h4><span class="green">94.0 %</span> covered</h4>
    <div>
      <b>50</b> relevant lines. 
      <span class="green"><b>47</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    module FaradayConnection</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="8">
          <span class="hits">9</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :run_request, ::Faraday::Connection)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="11">
          <span class="hits">28</span>
          
          <code class="ruby">      def run_request_with_appoptics(method, url, body, headers, &amp;block)</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="12">
          <span class="hits">45</span>
          
          <code class="ruby">        blacklisted = url_blacklisted?</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="13">
          <span class="hits">45</span>
          
          <code class="ruby">        unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="14">
          <span class="hits">12</span>
          
          <code class="ruby">          xtrace = AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="15">
          <span class="hits">12</span>
          
          <code class="ruby">          @headers[&#39;X-Trace&#39;] = xtrace if AppOpticsAPM::XTrace.valid?(xtrace) &amp;&amp; !blacklisted</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="16">
          <span class="hits">12</span>
          
          <code class="ruby">          return run_request_without_appoptics(method, url, body, headers, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="19">
          <span class="hits">33</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="20">
          <span class="hits">33</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(:faraday)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="22">
          <span class="hits">33</span>
          
          <code class="ruby">          xtrace = AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="23">
          <span class="hits">33</span>
          
          <code class="ruby">          @headers[&#39;X-Trace&#39;] = xtrace if AppOpticsAPM::XTrace.valid?(xtrace) &amp;&amp; !blacklisted</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="24">
          <span class="hits">33</span>
          
          <code class="ruby">          result = run_request_without_appoptics(method, url, body, headers, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="26">
          <span class="hits">33</span>
          
          <code class="ruby">          kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="27">
          <span class="hits">33</span>
          
          <code class="ruby">          kvs[:Middleware] = @builder.handlers</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="28">
          <span class="hits">33</span>
          
          <code class="ruby">          kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:faraday][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">          # Only send service KVs if we&#39;re not using the Net::HTTP adapter</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">          # Otherwise, the Net::HTTP instrumentation will send the service KVs</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="32">
          <span class="hits">33</span>
          
          <code class="ruby">          handle_service = !@builder.handlers.include?(Faraday::Adapter::NetHttp) &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">              !@builder.handlers.include?(Faraday::Adapter::Excon)</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="34">
          <span class="hits">33</span>
          
          <code class="ruby">          if handle_service</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="35">
          <span class="hits">3</span>
          
          <code class="ruby">            context = AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="36">
          <span class="hits">3</span>
          
          <code class="ruby">            task_id = AppOpticsAPM::XTrace.task_id(context)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">            # Avoid cross host tracing for blacklisted domains</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">            # Conditionally add the X-Trace header to the outgoing request</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="40">
          <span class="hits">3</span>
          
          <code class="ruby">            @headers[&#39;X-Trace&#39;] = context unless blacklisted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="42">
          <span class="hits">3</span>
          
          <code class="ruby">            kvs[:IsService] = 1</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="43">
          <span class="hits">3</span>
          
          <code class="ruby">            kvs[:RemoteProtocol] = (@url_prefix.scheme == &#39;https&#39;) ? &#39;HTTPS&#39; : &#39;HTTP&#39;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="44">
          <span class="hits">3</span>
          
          <code class="ruby">            kvs[:RemoteHost] = @url_prefix.host</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="45">
          <span class="hits">3</span>
          
          <code class="ruby">            kvs[:RemotePort] = @url_prefix.port</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="46">
          <span class="hits">3</span>
          
          <code class="ruby">            kvs[:ServiceArg] = url</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="47">
          <span class="hits">3</span>
          
          <code class="ruby">            kvs[:HTTPMethod] = method</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="48">
          <span class="hits">3</span>
          
          <code class="ruby">            kvs[:HTTPStatus] = result.status</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="49">
          <span class="hits">3</span>
          
          <code class="ruby">            kvs[:Blacklisted] = true if blacklisted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">            # Re-attach net::http edge unless it&#39;s blacklisted or if we don&#39;t have a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">            # valid X-Trace header</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="53">
          <span class="hits">3</span>
          
          <code class="ruby">            unless blacklisted</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="54">
          <span class="hits">3</span>
          
          <code class="ruby">              xtrace = result.headers[&#39;X-Trace&#39;]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="55">
          <span class="hits">3</span>
          
          <code class="ruby">              AppOpticsAPM::XTrace.continue_service_context(context, xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="59">
          <span class="hits">33</span>
          
          <code class="ruby">          AppOpticsAPM::API.log(:faraday, :info, kvs)</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="60">
          <span class="hits">33</span>
          
          <code class="ruby">          result</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(:faraday, e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">          raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="65">
          <span class="hits">33</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exit(:faraday)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="66">
          <span class="hits">22</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="69">
          <span class="hits">28</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="71">
          <span class="hits">28</span>
          
          <code class="ruby">      def url_blacklisted?</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="72">
          <span class="hits">45</span>
          
          <code class="ruby">        url = @url_prefix ? @url_prefix.to_s : @host</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="73">
          <span class="hits">45</span>
          
          <code class="ruby">        AppOpticsAPM::API.blacklisted?(url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="79">
          <span class="hits">28</span>
          
          <code class="ruby">if AppOpticsAPM::Config[:faraday][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="80">
          <span class="hits">28</span>
          
          <code class="ruby">  if defined?(::Faraday)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="81">
          <span class="hits">9</span>
          
          <code class="ruby">    AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting faraday&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="82">
          <span class="hits">9</span>
          
          <code class="ruby">    ::AppOpticsAPM::Util.send_include(::Faraday::Connection, ::AppOpticsAPM::Inst::FaradayConnection)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c545f810d384b1df8fb9c0b8e54c9ce5f4ec695b">
  <div class="header">
    <h3>lib/appoptics_apm/inst/http.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>40</b> relevant lines. 
      <span class="green"><b>40</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">require &#39;net/http&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">if AppOpticsAPM::Config[:nethttp][:enabled]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="8">
          <span class="hits">28</span>
          
          <code class="ruby">  Net::HTTP.class_eval do</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="9">
          <span class="hits">28</span>
          
          <code class="ruby">    def request_with_appoptics(*args, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      # Avoid cross host tracing for blacklisted domains</code>
        </li>
      
        <li class="covered" data-hits="527" data-linenumber="11">
          <span class="hits">527</span>
          
          <code class="ruby">      blacklisted = AppOpticsAPM::API.blacklisted?(addr_port)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      # If we&#39;re not tracing, just do a fast return. Since</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      # net/http.request calls itself, only trace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      # once the http session has been started.</code>
        </li>
      
        <li class="covered" data-hits="527" data-linenumber="16">
          <span class="hits">527</span>
          
          <code class="ruby">      if !AppOpticsAPM.tracing? || !started?</code>
        </li>
      
        <li class="covered" data-hits="443" data-linenumber="17">
          <span class="hits">443</span>
          
          <code class="ruby">        unless blacklisted</code>
        </li>
      
        <li class="covered" data-hits="437" data-linenumber="18">
          <span class="hits">437</span>
          
          <code class="ruby">          xtrace = AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="covered" data-hits="437" data-linenumber="19">
          <span class="hits">437</span>
          
          <code class="ruby">          args[0][&#39;X-Trace&#39;] = xtrace if AppOpticsAPM::XTrace.valid?(xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="443" data-linenumber="21">
          <span class="hits">443</span>
          
          <code class="ruby">        return request_without_appoptics(*args, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="24">
          <span class="hits">84</span>
          
          <code class="ruby">      AppOpticsAPM::API.trace(:&#39;net-http&#39;) do</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="25">
          <span class="hits">84</span>
          
          <code class="ruby">        opts = {}</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="26">
          <span class="hits">84</span>
          
          <code class="ruby">        context = AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="27">
          <span class="hits">84</span>
          
          <code class="ruby">        task_id = AppOpticsAPM::XTrace.task_id(context)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        # Collect KVs to report in the info event</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="30">
          <span class="hits">84</span>
          
          <code class="ruby">        if args.length &amp;&amp; args[0]</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="31">
          <span class="hits">84</span>
          
          <code class="ruby">          req = args[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="33">
          <span class="hits">84</span>
          
          <code class="ruby">          opts[:IsService] = 1</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="34">
          <span class="hits">84</span>
          
          <code class="ruby">          opts[:RemoteProtocol] = use_ssl? ? :HTTPS : :HTTP</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="35">
          <span class="hits">84</span>
          
          <code class="ruby">          opts[:RemoteHost] = addr_port</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">          # Conditionally log query params</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="38">
          <span class="hits">84</span>
          
          <code class="ruby">          if AppOpticsAPM::Config[:nethttp][:log_args]</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="39">
          <span class="hits">81</span>
          
          <code class="ruby">            opts[:ServiceArg] = req.path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="41">
          <span class="hits">3</span>
          
          <code class="ruby">            opts[:ServiceArg] = req.path.split(&#39;?&#39;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="44">
          <span class="hits">84</span>
          
          <code class="ruby">          opts[:HTTPMethod] = req.method</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="45">
          <span class="hits">84</span>
          
          <code class="ruby">          opts[:Blacklisted] = true if blacklisted</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="46">
          <span class="hits">84</span>
          
          <code class="ruby">          opts[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:nethttp][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="48">
          <span class="hits">84</span>
          
          <code class="ruby">          req[&#39;X-Trace&#39;] = context unless blacklisted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="51">
          <span class="hits">84</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">          # The actual net::http call</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="53">
          <span class="hits">84</span>
          
          <code class="ruby">          resp = request_without_appoptics(*args, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">          # Re-attach net::http edge unless blacklisted and is a valid X-Trace ID</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="56">
          <span class="hits">84</span>
          
          <code class="ruby">          unless blacklisted</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="57">
          <span class="hits">78</span>
          
          <code class="ruby">            xtrace = resp.get_fields(&#39;X-Trace&#39;)</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="58">
          <span class="hits">78</span>
          
          <code class="ruby">            xtrace = xtrace[0] if xtrace &amp;&amp; xtrace.is_a?(Array)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="60">
          <span class="hits">78</span>
          
          <code class="ruby">            AppOpticsAPM::XTrace.continue_service_context(context, xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="63">
          <span class="hits">84</span>
          
          <code class="ruby">          opts[:HTTPStatus] = resp.code</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">          # If we get a redirect, report the location header</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="66">
          <span class="hits">84</span>
          
          <code class="ruby">          if ((300..308).to_a.include? resp.code.to_i) &amp;&amp; resp.header[&quot;Location&quot;]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="67">
          <span class="hits">3</span>
          
          <code class="ruby">            opts[:Location] = resp.header[&quot;Location&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="70">
          <span class="hits">84</span>
          
          <code class="ruby">          next resp</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">          # Log the info event with the KVs in opts</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="73">
          <span class="hits">84</span>
          
          <code class="ruby">          AppOpticsAPM::API.log(:&#39;net-http&#39;, :info, opts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="78">
          <span class="hits">28</span>
          
          <code class="ruby">    alias request_without_appoptics request</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="79">
          <span class="hits">28</span>
          
          <code class="ruby">    alias request request_with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="81">
          <span class="hits">28</span>
          
          <code class="ruby">    AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting net/http&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="412386c97055243674e885f2ec18b629641dc132">
  <div class="header">
    <h3>lib/appoptics_apm/inst/httpclient.rb</h3>
    <h4><span class="green">96.08 %</span> covered</h4>
    <div>
      <b>102</b> relevant lines. 
      <span class="green"><b>98</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    module HTTPClient</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="8">
          <span class="hits">9</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :do_request, ::HTTPClient)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="9">
          <span class="hits">9</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :do_request_async, ::HTTPClient)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="10">
          <span class="hits">9</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :do_get_stream, ::HTTPClient)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="13">
          <span class="hits">28</span>
          
          <code class="ruby">      def appoptics_collect(method, uri, query = nil)</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="14">
          <span class="hits">78</span>
          
          <code class="ruby">        kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="15">
          <span class="hits">78</span>
          
          <code class="ruby">        kvs[:IsService] = 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">        # Conditionally log URL query params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">        # Because of the hook points, the query arg can come in under &lt;tt&gt;query&lt;/tt&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        # or as a part of &lt;tt&gt;uri&lt;/tt&gt; (not both).  Here we handle both cases.</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="20">
          <span class="hits">78</span>
          
          <code class="ruby">        if AppOpticsAPM::Config[:httpclient][:log_args]</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="21">
          <span class="hits">75</span>
          
          <code class="ruby">          if query</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="22">
          <span class="hits">9</span>
          
          <code class="ruby">            kvs[:RemoteURL] = uri.to_s + &#39;?&#39; + AppOpticsAPM::Util.to_query(query)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="24">
          <span class="hits">66</span>
          
          <code class="ruby">            kvs[:RemoteURL] = uri.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="27">
          <span class="hits">3</span>
          
          <code class="ruby">          kvs[:RemoteURL] = uri.to_s.split(&#39;?&#39;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="30">
          <span class="hits">78</span>
          
          <code class="ruby">        kvs[:RemoteProtocol] = uri.scheme.upcase</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="31">
          <span class="hits">78</span>
          
          <code class="ruby">        kvs[:RemoteHost] = &quot;#{uri.host}:#{uri.port}&quot;</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="32">
          <span class="hits">78</span>
          
          <code class="ruby">        kvs[:ServiceArg] = &quot;/?#{uri.query}&quot;</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="33">
          <span class="hits">78</span>
          
          <code class="ruby">        kvs[:HTTPMethod] = ::AppOpticsAPM::Util.upcase(method)</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="34">
          <span class="hits">78</span>
          
          <code class="ruby">        kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:httpclient][:collect_backtraces]</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="35">
          <span class="hits">78</span>
          
          <code class="ruby">        kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] Error capturing httpclient KVs: #{e.message}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug e.backtrace.join(&#39;\n&#39;) if ::AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      ensure</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="40">
          <span class="hits">78</span>
          
          <code class="ruby">        return kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="43">
          <span class="hits">28</span>
          
          <code class="ruby">      def do_request_with_appoptics(method, uri, query, body, header, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        # Avoid cross host tracing for blacklisted domains</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="45">
          <span class="hits">72</span>
          
          <code class="ruby">        blacklisted = AppOpticsAPM::API.blacklisted?(uri.hostname)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">        # If we&#39;re not tracing, just do a fast return.</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="48">
          <span class="hits">72</span>
          
          <code class="ruby">        unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="49">
          <span class="hits">21</span>
          
          <code class="ruby">          add_xtrace_header(header) unless blacklisted</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="50">
          <span class="hits">21</span>
          
          <code class="ruby">          return do_request_without_appoptics(method, uri, query, body, header, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="53">
          <span class="hits">51</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="54">
          <span class="hits">51</span>
          
          <code class="ruby">          req_context = nil</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="55">
          <span class="hits">51</span>
          
          <code class="ruby">          response_context = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="57">
          <span class="hits">51</span>
          
          <code class="ruby">          kvs = appoptics_collect(method, uri, query)</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="58">
          <span class="hits">51</span>
          
          <code class="ruby">          kvs[:Blacklisted] = true if blacklisted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="60">
          <span class="hits">51</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(:httpclient, kvs)</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="61">
          <span class="hits">51</span>
          
          <code class="ruby">          kvs.clear</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="63">
          <span class="hits">51</span>
          
          <code class="ruby">          req_context = add_xtrace_header(header) unless blacklisted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">          # The core httpclient call</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="66">
          <span class="hits">51</span>
          
          <code class="ruby">          response = do_request_without_appoptics(method, uri, query, body, header, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="68">
          <span class="hits">48</span>
          
          <code class="ruby">          response_context = response.headers[&#39;X-Trace&#39;]</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="69">
          <span class="hits">48</span>
          
          <code class="ruby">          kvs[:HTTPStatus] = response.status_code</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">          # If we get a redirect, report the location header</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="72">
          <span class="hits">48</span>
          
          <code class="ruby">          if ((300..308).to_a.include? response.status.to_i) &amp;&amp; response.headers.key?(&#39;Location&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">            kvs[:Location] = response.headers[&#39;Location&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="76">
          <span class="hits">48</span>
          
          <code class="ruby">          if response_context &amp;&amp; !blacklisted</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="77">
          <span class="hits">24</span>
          
          <code class="ruby">            AppOpticsAPM::XTrace.continue_service_context(req_context, response_context)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="80">
          <span class="hits">48</span>
          
          <code class="ruby">          response</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="81">
          <span class="hits">3</span>
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="82">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(:httpclient, e)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="83">
          <span class="hits">3</span>
          
          <code class="ruby">          raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="85">
          <span class="hits">51</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exit(:httpclient, kvs)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="86">
          <span class="hits">34</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="89">
          <span class="hits">28</span>
          
          <code class="ruby">      def do_request_async_with_appoptics(method, uri, query, body, header)</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="90">
          <span class="hits">45</span>
          
          <code class="ruby">        add_xtrace_header(header)</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="91">
          <span class="hits">45</span>
          
          <code class="ruby">        do_request_async_without_appoptics(method, uri, query, body, header)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="94">
          <span class="hits">28</span>
          
          <code class="ruby">      def do_get_stream_with_appoptics(req, proxy, conn)</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="95">
          <span class="hits">45</span>
          
          <code class="ruby">        AppOpticsAPM::Context.fromString(req.header[&#39;X-Trace&#39;].first) unless req.header[&#39;X-Trace&#39;].empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">        # Avoid cross host tracing for blacklisted domains</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="97">
          <span class="hits">45</span>
          
          <code class="ruby">        uri = req.http_header.request_uri</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="98">
          <span class="hits">45</span>
          
          <code class="ruby">        blacklisted = AppOpticsAPM::API.blacklisted?(uri.hostname)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="100">
          <span class="hits">45</span>
          
          <code class="ruby">        unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="101">
          <span class="hits">18</span>
          
          <code class="ruby">          req.header.delete(&#39;X-Trace&#39;) if blacklisted</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="102">
          <span class="hits">18</span>
          
          <code class="ruby">          return do_get_stream_without_appoptics(req, proxy, conn)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="105">
          <span class="hits">27</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="106">
          <span class="hits">27</span>
          
          <code class="ruby">          response = nil</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="107">
          <span class="hits">27</span>
          
          <code class="ruby">          req_context = nil</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="108">
          <span class="hits">27</span>
          
          <code class="ruby">          method = req.http_header.request_method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="110">
          <span class="hits">27</span>
          
          <code class="ruby">          kvs = appoptics_collect(method, uri)</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="111">
          <span class="hits">27</span>
          
          <code class="ruby">          kvs[:Blacklisted] = true if blacklisted</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="112">
          <span class="hits">27</span>
          
          <code class="ruby">          kvs[:Async] = 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="114">
          <span class="hits">27</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(:httpclient, kvs)</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="115">
          <span class="hits">27</span>
          
          <code class="ruby">          kvs.clear</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="117">
          <span class="hits">27</span>
          
          <code class="ruby">          blacklisted ? req.header.delete(&#39;X-Trace&#39;) : req_context = add_xtrace_header(req.header)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">          # The core httpclient call</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="120">
          <span class="hits">27</span>
          
          <code class="ruby">          result = do_get_stream_without_appoptics(req, proxy, conn)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">          # Older HTTPClient &lt; 2.6.0 returns HTTPClient::Connection</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="123">
          <span class="hits">27</span>
          
          <code class="ruby">          if result.is_a?(::HTTP::Message)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="124">
          <span class="hits">3</span>
          
          <code class="ruby">            response = result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="126">
          <span class="hits">24</span>
          
          <code class="ruby">            response = conn.pop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="129">
          <span class="hits">3</span>
          
          <code class="ruby">          response_context = response.headers[&#39;X-Trace&#39;]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="130">
          <span class="hits">3</span>
          
          <code class="ruby">          kvs[:HTTPStatus] = response.status_code</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">          # If we get a redirect, report the location header</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="133">
          <span class="hits">3</span>
          
          <code class="ruby">          if ((300..308).to_a.include? response.status.to_i) &amp;&amp; response.headers.key?(&#39;Location&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">            kvs[:Location] = response.headers[&#39;Location&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="137">
          <span class="hits">3</span>
          
          <code class="ruby">          if response_context &amp;&amp; !blacklisted</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="138">
          <span class="hits">3</span>
          
          <code class="ruby">            AppOpticsAPM::XTrace.continue_service_context(req_context, response_context)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">          # Older HTTPClient &lt; 2.6.0 returns HTTPClient::Connection</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="142">
          <span class="hits">3</span>
          
          <code class="ruby">          conn.push response if result.is_a?(::HTTPClient::Connection)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="143">
          <span class="hits">3</span>
          
          <code class="ruby">          result</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="144">
          <span class="hits">24</span>
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="145">
          <span class="hits">24</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(:httpclient, e)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="146">
          <span class="hits">24</span>
          
          <code class="ruby">          raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">          # AppOpticsAPM::API.log_exit(&#39;httpclient&#39;, kvs.merge(&#39;Async&#39; =&gt; 1))</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="149">
          <span class="hits">27</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exit(:httpclient, kvs)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="150">
          <span class="hits">18</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="153">
          <span class="hits">28</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="155">
          <span class="hits">28</span>
          
          <code class="ruby">      def add_xtrace_header(headers)</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="156">
          <span class="hits">126</span>
          
          <code class="ruby">        req_context = AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="157">
          <span class="hits">126</span>
          
          <code class="ruby">        return nil unless AppOpticsAPM::XTrace.valid?(req_context)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">        # Be aware of various ways to call/use httpclient</code>
        </li>
      
        <li class="covered" data-hits="111" data-linenumber="159">
          <span class="hits">111</span>
          
          <code class="ruby">        if headers.is_a?(Array)</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="160">
          <span class="hits">81</span>
          
          <code class="ruby">          headers.delete_if { |kv| kv[0] == &#39;X-Trace&#39; }</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="161">
          <span class="hits">27</span>
          
          <code class="ruby">          headers.push [&#39;X-Trace&#39;, req_context]</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="162">
          <span class="hits">84</span>
          
          <code class="ruby">        elsif headers.is_a?(Hash)</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="163">
          <span class="hits">63</span>
          
          <code class="ruby">          headers[&#39;X-Trace&#39;] = req_context</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="164">
          <span class="hits">21</span>
          
          <code class="ruby">        elsif headers.is_a? HTTP::Message::Headers</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="165">
          <span class="hits">21</span>
          
          <code class="ruby">          headers.set(&#39;X-Trace&#39;, req_context)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="111" data-linenumber="167">
          <span class="hits">111</span>
          
          <code class="ruby">        req_context</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="173">
          <span class="hits">28</span>
          
          <code class="ruby">if AppOpticsAPM::Config[:httpclient][:enabled] &amp;&amp; defined?(::HTTPClient)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="174">
          <span class="hits">9</span>
          
          <code class="ruby">  ::AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting httpclient&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="175">
          <span class="hits">9</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_include(::HTTPClient, ::AppOpticsAPM::Inst::HTTPClient)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="424bca7a55c6514f0ce909aeeac186e1adf66714">
  <div class="header">
    <h3>lib/appoptics_apm/inst/memcached.rb</h3>
    <h4><span class="green">92.31 %</span> covered</h4>
    <div>
      <b>52</b> relevant lines. 
      <span class="green"><b>48</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    module Memcached</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">      include AppOpticsAPM::API::Memcache</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="9">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(cls)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="10">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting memcached&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="12">
          <span class="hits">3</span>
          
          <code class="ruby">        cls.class_eval do</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="13">
          <span class="hits">42</span>
          
          <code class="ruby">          MEMCACHE_OPS.reject { |m| !method_defined?(m) }.each do |m|</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="14">
          <span class="hits">36</span>
          
          <code class="ruby">            define_method(&quot;#{m}_with_appoptics&quot;) do |*args|</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="15">
          <span class="hits">51</span>
          
          <code class="ruby">              opts = { :KVOp =&gt; m }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="17">
          <span class="hits">51</span>
          
          <code class="ruby">              if args.length &amp;&amp; !args[0].is_a?(Array)</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="18">
          <span class="hits">51</span>
          
          <code class="ruby">                opts[:KVKey] = args[0].to_s</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="19">
          <span class="hits">51</span>
          
          <code class="ruby">                rhost = remote_host(args[0].to_s)</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="20">
          <span class="hits">51</span>
          
          <code class="ruby">                opts[:RemoteHost] = rhost if rhost</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="23">
          <span class="hits">51</span>
          
          <code class="ruby">              AppOpticsAPM::API.trace(:memcache, opts) do</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="24">
          <span class="hits">51</span>
          
          <code class="ruby">                result = send(&quot;#{m}_without_appoptics&quot;, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="26">
          <span class="hits">48</span>
          
          <code class="ruby">                info_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="27">
          <span class="hits">48</span>
          
          <code class="ruby">                info_kvs[:KVHit] = memcache_hit?(result) if m == :get &amp;&amp; args.length &amp;&amp; args[0].class == String</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="28">
          <span class="hits">48</span>
          
          <code class="ruby">                info_kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:memcached][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="30">
          <span class="hits">48</span>
          
          <code class="ruby">                AppOpticsAPM::API.log(:memcache, :info, info_kvs) unless info_kvs.empty?</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="31">
          <span class="hits">48</span>
          
          <code class="ruby">                result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="35">
          <span class="hits">36</span>
          
          <code class="ruby">            class_eval &quot;alias #{m}_without_appoptics #{m}&quot;</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="36">
          <span class="hits">36</span>
          
          <code class="ruby">            class_eval &quot;alias #{m} #{m}_with_appoptics&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end # module Memcached</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="43">
          <span class="hits">28</span>
          
          <code class="ruby">    module MemcachedRails</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="44">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(cls)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="45">
          <span class="hits">3</span>
          
          <code class="ruby">        cls.class_eval do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="46">
          <span class="hits">3</span>
          
          <code class="ruby">          if ::Memcached::Rails.method_defined? :get_multi</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="47">
          <span class="hits">3</span>
          
          <code class="ruby">            alias get_multi_without_appoptics get_multi</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="48">
          <span class="hits">3</span>
          
          <code class="ruby">            alias get_multi get_multi_with_appoptics</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">          elsif AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">            AppOpticsAPM.logger.warn &#39;[appoptics_apm/loading] Couldn\&#39;t properly instrument Memcached.  Partial traces may occur.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="55">
          <span class="hits">28</span>
          
          <code class="ruby">      def get_multi_with_appoptics(keys, raw = false)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="56">
          <span class="hits">3</span>
          
          <code class="ruby">        if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="57">
          <span class="hits">3</span>
          
          <code class="ruby">          layer_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="58">
          <span class="hits">3</span>
          
          <code class="ruby">          layer_kvs[:KVOp] = :get_multi</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="60">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM::API.trace(:memcache, layer_kvs || {}, :get_multi) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="61">
          <span class="hits">3</span>
          
          <code class="ruby">            begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="62">
          <span class="hits">3</span>
          
          <code class="ruby">              info_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="63">
          <span class="hits">3</span>
          
          <code class="ruby">              info_kvs[:KVKeyCount] = keys.flatten.length</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="65">
          <span class="hits">3</span>
          
          <code class="ruby">              values = get_multi_without_appoptics(keys, raw)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="67">
          <span class="hits">3</span>
          
          <code class="ruby">              info_kvs[:KVHitCount] = values.length</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="68">
          <span class="hits">3</span>
          
          <code class="ruby">              info_kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:memcached][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="70">
          <span class="hits">3</span>
          
          <code class="ruby">              AppOpticsAPM::API.log(:memcache, :info, info_kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">            rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">              values = get_multi_without_appoptics(keys, raw)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="74">
          <span class="hits">3</span>
          
          <code class="ruby">            values</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">          get_multi_without_appoptics(keys, raw)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    end # module MemcachedRails</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  end # module Inst</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">end # module AppOpticsAPM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="84">
          <span class="hits">28</span>
          
          <code class="ruby">if defined?(::Memcached) &amp;&amp; AppOpticsAPM::Config[:memcached][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="85">
          <span class="hits">3</span>
          
          <code class="ruby">  ::Memcached.class_eval do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="86">
          <span class="hits">3</span>
          
          <code class="ruby">    include AppOpticsAPM::Inst::Memcached</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="89">
          <span class="hits">3</span>
          
          <code class="ruby">  if defined?(::Memcached::Rails)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="90">
          <span class="hits">3</span>
          
          <code class="ruby">    ::Memcached::Rails.class_eval do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="91">
          <span class="hits">3</span>
          
          <code class="ruby">      include AppOpticsAPM::Inst::MemcachedRails</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="63a9d162524b2990106525607f95655e2f14ad01">
  <div class="header">
    <h3>lib/appoptics_apm/inst/mongo.rb</h3>
    <h4><span class="red">8.46 %</span> covered</h4>
    <div>
      <b>130</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>119</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">require &#39;json&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="8">
          <span class="hits">28</span>
          
          <code class="ruby">    module Mongo</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="9">
          <span class="hits">28</span>
          
          <code class="ruby">      FLAVOR = &#39;mongodb&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      # Operations for Mongo::DB</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="12">
          <span class="hits">28</span>
          
          <code class="ruby">      DB_OPS         = [:create_collection, :drop_collection]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      # Operations for Mongo::Cursor</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="15">
          <span class="hits">28</span>
          
          <code class="ruby">      CURSOR_OPS     = [:count]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      # Operations for Mongo::Collection</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="18">
          <span class="hits">28</span>
          
          <code class="ruby">      COLL_WRITE_OPS = [:find_and_modify, :insert, :map_reduce, :remove, :rename, :update]</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="19">
          <span class="hits">28</span>
          
          <code class="ruby">      COLL_QUERY_OPS = [:distinct, :find, :group]</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="20">
          <span class="hits">28</span>
          
          <code class="ruby">      COLL_INDEX_OPS = [:create_index, :drop_index, :drop_indexes, :ensure_index, :index_information]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="25">
          <span class="hits">28</span>
          
          <code class="ruby">if defined?(::Mongo) &amp;&amp; (Gem.loaded_specs[&#39;mongo&#39;].version.to_s &lt; &#39;2.0.0&#39;) &amp;&amp; AppOpticsAPM::Config[:mongo][:enabled]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">  AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting mongo&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">  if defined?(::Mongo::DB)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    module ::Mongo</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      class DB</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        include AppOpticsAPM::Inst::Mongo</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        # Instrument DB operations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">        AppOpticsAPM::Inst::Mongo::DB_OPS.reject { |m| !method_defined?(m) }.each do |m|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">          define_method(&quot;#{m}_with_appoptics&quot;) do |*args|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">            report_kvs = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">            begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">              report_kvs[:Flavor] = AppOpticsAPM::Inst::Mongo::FLAVOR</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">              report_kvs[:Database] = @name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">              # Mongo &gt;= 1.10 uses @client instead of @connection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">              # Avoid the nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">              if @connection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">                report_kvs[:RemoteHost] = @connection.host</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">                report_kvs[:RemotePort] = @connection.port</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">              elsif @client</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">                report_kvs[:RemoteHost] = @client.host</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">                report_kvs[:RemotePort] = @client.port</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">              report_kvs[:QueryOp] = m</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">              report_kvs[:New_Collection_Name] = args[0] if m == :create_collection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">              report_kvs[:Collection] = args[0]          if m == :drop_collection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">              report_kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:mongo][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">            rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">              AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">            AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">              send(&quot;#{m}_without_appoptics&quot;, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">          class_eval &quot;alias #{m}_without_appoptics #{m}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">          class_eval &quot;alias #{m} #{m}_with_appoptics&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">  if defined?(::Mongo::Cursor)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    module ::Mongo</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">      class Cursor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">        include AppOpticsAPM::Inst::Mongo</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">        # Instrument DB cursor operations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">        AppOpticsAPM::Inst::Mongo::CURSOR_OPS.reject { |m| !method_defined?(m) }.each do |m|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">          define_method(&quot;#{m}_with_appoptics&quot;) do |*args|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">            report_kvs = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">            begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">              report_kvs[:Flavor] = AppOpticsAPM::Inst::Mongo::FLAVOR</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">              report_kvs[:Database] = @db.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">              report_kvs[:RemoteHost] = @connection.host</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">              report_kvs[:RemotePort] = @connection.port</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">              report_kvs[:QueryOp] = m</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">              if m == :count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">                unless @selector.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">                  report_kvs[:Query] = @selector.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">                else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">                  report_kvs[:Query] = :all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">                report_kvs[:Limit] = @limit if @limit != 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">            rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">              AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">            AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">              send(&quot;#{m}_without_appoptics&quot;, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">          class_eval &quot;alias #{m}_without_appoptics #{m}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">          class_eval &quot;alias #{m} #{m}_with_appoptics&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">  if defined?(::Mongo::Collection)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">    module ::Mongo</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">      class Collection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">        include AppOpticsAPM::Inst::Mongo</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">        def appoptics_collect(m, args)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">          kvs = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">          kvs[:Flavor] = AppOpticsAPM::Inst::Mongo::FLAVOR</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">          kvs[:Database] = @db.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">          kvs[:RemoteHost] = @db.connection.host</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">          kvs[:RemotePort] = @db.connection.port</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">          kvs[:Collection] = @name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">          kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:mongo][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">          kvs[:QueryOp] = m</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">          kvs[:Query] = args[0].to_json if args &amp;&amp; !args.empty? &amp;&amp; args[0].class == Hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] Exception in appoptics_collect KV collection: #{e.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">          return kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">        # Instrument Collection write operations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">        AppOpticsAPM::Inst::Mongo::COLL_WRITE_OPS.reject { |m| !method_defined?(m) }.each do |m|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">          define_method(&quot;#{m}_with_appoptics&quot;) do |*args|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">            report_kvs = appoptics_collect(m, args)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">            args_length = args.length</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">            begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">              if m == :find_and_modify &amp;&amp; args[0] &amp;&amp; args[0].key?(:update)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">                report_kvs[:Update_Document] = args[0][:update].inspect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">              if m == :map_reduce</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">                report_kvs[:Map_Function]    = args[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">                report_kvs[:Reduce_Function] = args[1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">                report_kvs[:Limit] = args[2][:limit] if args[2] &amp;&amp; args[2].key?(:limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">              report_kvs[:New_Collection_Name] = args[0] if m == :rename</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">              if m == :update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">                if args_length &gt;= 3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">                  report_kvs[:Update_Document] = args[1].to_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">                  report_kvs[:Multi] = args[2][:multi] if args[2] &amp;&amp; args[2].key?(:multi)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">            rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">              AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">            AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">              send(&quot;#{m}_without_appoptics&quot;, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">          class_eval &quot;alias #{m}_without_appoptics #{m}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">          class_eval &quot;alias #{m} #{m}_with_appoptics&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">        # Instrument Collection query operations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">        AppOpticsAPM::Inst::Mongo::COLL_QUERY_OPS.reject { |m| !method_defined?(m) }.each do |m|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">          define_method(&quot;#{m}_with_appoptics&quot;) do |*args, &amp;blk|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">            begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">              report_kvs = appoptics_collect(m, args)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">              args_length = args.length</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">              if m == :distinct &amp;&amp; args_length &gt;= 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">                report_kvs[:Key]   = args[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">                report_kvs[:Query] = args[1].to_json if args[1] &amp;&amp; args[1].class == Hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">              if m == :find &amp;&amp; args_length &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">                report_kvs[:Limit] = args[0][:limit] if !args[0].nil? &amp;&amp; args[0].key?(:limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">              if m == :group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">                unless args.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">                  if args[0].is_a?(Hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">                    report_kvs[:Group_Key]       = args[0][:key].to_json     if args[0].key?(:key)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">                    report_kvs[:Group_Condition] = args[0][:cond].to_json    if args[0].key?(:cond)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">                    report_kvs[:Group_Initial]   = args[0][:initial].to_json if args[0].key?(:initial)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">                    report_kvs[:Group_Reduce]    = args[0][:reduce]          if args[0].key?(:reduce)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">                  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">            rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">              AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">            AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">              send(&quot;#{m}_without_appoptics&quot;, *args, &amp;blk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">          class_eval &quot;alias #{m}_without_appoptics #{m}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">          class_eval &quot;alias #{m} #{m}_with_appoptics&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">        # Instrument Collection index operations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">        AppOpticsAPM::Inst::Mongo::COLL_INDEX_OPS.reject { |m| !method_defined?(m) }.each do |m|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">          define_method(&quot;#{m}_with_appoptics&quot;) do |*args|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">            report_kvs = appoptics_collect(m, args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">            begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">              if [:create_index, :ensure_index, :drop_index].include?(m) &amp;&amp; !args.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">                report_kvs[:Index] = args[0].to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">            rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">              AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">            AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">              send(&quot;#{m}_without_appoptics&quot;, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">          class_eval &quot;alias #{m}_without_appoptics #{m}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">          class_eval &quot;alias #{m} #{m}_with_appoptics&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="1979cde34f623146357229498f24e67afbe56473">
  <div class="header">
    <h3>lib/appoptics_apm/inst/mongo2.rb</h3>
    <h4><span class="yellow">87.38 %</span> covered</h4>
    <div>
      <b>103</b> relevant lines. 
      <span class="green"><b>90</b> lines covered</span> and
      <span class="red"><b>13</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">require &#39;json&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">if AppOpticsAPM::Config[:mongo][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">  if defined?(::Mongo) &amp;&amp; (Gem.loaded_specs[&#39;mongo&#39;].version.to_s &gt;= &#39;2.0.0&#39;)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="8">
          <span class="hits">3</span>
          
          <code class="ruby">    ::AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting mongo&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    # Collection Related Operations</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="11">
          <span class="hits">3</span>
          
          <code class="ruby">    COLL_OTHER_OPS = [:create, :drop, :insert_one, :insert_many, :bulk_write, :map_reduce].freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    # Mongo 2.2 only ops</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="14">
          <span class="hits">3</span>
          
          <code class="ruby">    if Mongo::VERSION &gt;= &#39;2.1&#39;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="15">
          <span class="hits">3</span>
          
          <code class="ruby">      COLL_QUERY_OPS = [:find, :find_one_and_delete, :find_one_and_update, :find_one_and_replace, :update_one, :update_many, :delete_one, :delete_many, :replace_one].freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      COLL_QUERY_OPS = [:find, :update_many, :delete_one].freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="20">
          <span class="hits">3</span>
          
          <code class="ruby">    COLL_OPS = COLL_QUERY_OPS + COLL_OTHER_OPS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="22">
          <span class="hits">3</span>
          
          <code class="ruby">    module Mongo</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="23">
          <span class="hits">3</span>
          
          <code class="ruby">      class Collection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">        ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        # collect_kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        # Used to collect up information to report and build a hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        # with the Keys/Values to report.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="30">
          <span class="hits">3</span>
          
          <code class="ruby">        def collect_kvs(op, args)</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="31">
          <span class="hits">57</span>
          
          <code class="ruby">          kvs = { :Flavor =&gt; :mongodb, :Database =&gt; @database.name }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="33">
          <span class="hits">57</span>
          
          <code class="ruby">          kvs[:QueryOp] = op</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="35">
          <span class="hits">57</span>
          
          <code class="ruby">          if op == :create</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="36">
          <span class="hits">6</span>
          
          <code class="ruby">            kvs[:New_Collection_Name] = @name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="38">
          <span class="hits">51</span>
          
          <code class="ruby">            kvs[:Collection] = @name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="41">
          <span class="hits">57</span>
          
          <code class="ruby">          if op == :map_reduce</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">            kvs[:Map_Function] = args[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">            kvs[:Reduce_Function] = args[1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">            kvs[:Limit] = args[2][:limit] if args[2].is_a?(Hash) &amp;&amp; args[2].key?(:limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="47">
          <span class="hits">57</span>
          
          <code class="ruby">          if AppOpticsAPM::Config[:mongo][:log_args]</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="48">
          <span class="hits">57</span>
          
          <code class="ruby">            if COLL_QUERY_OPS.include?(op)</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="49">
          <span class="hits">27</span>
          
          <code class="ruby">              kvs[:Query] = args.first.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="53">
          <span class="hits">57</span>
          
          <code class="ruby">          kvs[:RemoteHost] = @database.client.cluster.addresses.first.to_s</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="54">
          <span class="hits">57</span>
          
          <code class="ruby">          kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:mongo][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="58">
          <span class="hits">57</span>
          
          <code class="ruby">          return kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        # Here we dynamically define wrapper methods for the operations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        # we want to instrument in mongo</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="65">
          <span class="hits">48</span>
          
          <code class="ruby">        COLL_OPS.reject { |m| !method_defined?(m) }.each do |m|</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="66">
          <span class="hits">42</span>
          
          <code class="ruby">          define_method(&quot;#{m}_with_appoptics&quot;) do |*args|</code>
        </li>
      
        <li class="covered" data-hits="189" data-linenumber="67">
          <span class="hits">189</span>
          
          <code class="ruby">            begin</code>
        </li>
      
        <li class="covered" data-hits="189" data-linenumber="68">
          <span class="hits">189</span>
          
          <code class="ruby">              if !AppOpticsAPM.tracing? || AppOpticsAPM.tracing_layer?(:mongo)</code>
        </li>
      
        <li class="covered" data-hits="132" data-linenumber="69">
          <span class="hits">132</span>
          
          <code class="ruby">                mongo_skipped = true</code>
        </li>
      
        <li class="covered" data-hits="132" data-linenumber="70">
          <span class="hits">132</span>
          
          <code class="ruby">                return send(&quot;#{m}_without_appoptics&quot;, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="73">
          <span class="hits">57</span>
          
          <code class="ruby">              kvs = collect_kvs(m, args)</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="74">
          <span class="hits">57</span>
          
          <code class="ruby">              AppOpticsAPM::API.log_entry(:mongo, kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="76">
          <span class="hits">57</span>
          
          <code class="ruby">              send(&quot;#{m}_without_appoptics&quot;, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">            rescue =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="78">
          <span class="hits">3</span>
          
          <code class="ruby">              AppOpticsAPM::API.log_exception(:mongo, e)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="79">
          <span class="hits">3</span>
          
          <code class="ruby">              raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">            ensure</code>
        </li>
      
        <li class="covered" data-hits="189" data-linenumber="81">
          <span class="hits">189</span>
          
          <code class="ruby">              AppOpticsAPM::API.log_exit(:mongo) unless mongo_skipped</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="84">
          <span class="hits">42</span>
          
          <code class="ruby">          ::AppOpticsAPM::Util.method_alias(Mongo::Collection, m)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    # Mongo Collection View Instrumentation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">    # Collection View Related Operations</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="94">
          <span class="hits">3</span>
          
          <code class="ruby">    VIEW_QUERY_OPS = [:delete_one, :delete_many, :count, :distinct, :find_one_and_delete, :find_one_and_update,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">                      :replace_one, :update_one, :update_many].freeze</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="96">
          <span class="hits">3</span>
          
          <code class="ruby">    VIEW_OTHER_OPS = [:aggregate, :map_reduce ].freeze</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="97">
          <span class="hits">3</span>
          
          <code class="ruby">    VIEW_OPS = VIEW_QUERY_OPS + VIEW_OTHER_OPS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="99">
          <span class="hits">3</span>
          
          <code class="ruby">    module Mongo</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="100">
          <span class="hits">3</span>
          
          <code class="ruby">      class Collection</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="101">
          <span class="hits">3</span>
          
          <code class="ruby">        class View</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">          ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">          # collect_kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">          #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">          # Used to collect up information to report and build a hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">          # with the Keys/Values to report.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">          #</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="108">
          <span class="hits">3</span>
          
          <code class="ruby">          def collect_kvs(op, args)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="109">
          <span class="hits">48</span>
          
          <code class="ruby">            kvs = { :Flavor =&gt; :mongodb, :Database =&gt; @collection.database.name }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="111">
          <span class="hits">48</span>
          
          <code class="ruby">            kvs[:QueryOp] = op</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="112">
          <span class="hits">48</span>
          
          <code class="ruby">            kvs[:Collection] = @collection.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="114">
          <span class="hits">48</span>
          
          <code class="ruby">            if op == :map_reduce</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="115">
          <span class="hits">3</span>
          
          <code class="ruby">              kvs[:Map_Function] = args[0]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="116">
          <span class="hits">3</span>
          
          <code class="ruby">              kvs[:Reduce_Function] = args[1]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="117">
          <span class="hits">3</span>
          
          <code class="ruby">              kvs[:Limit] = args[2][:limit] if args[2].is_a?(Hash) &amp;&amp; args[2].key?(:limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="120">
          <span class="hits">48</span>
          
          <code class="ruby">            if AppOpticsAPM::Config[:mongo][:log_args]</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="121">
          <span class="hits">48</span>
          
          <code class="ruby">              if VIEW_QUERY_OPS.include?(op)</code>
        </li>
      
        <li class="covered" data-hits="39" data-linenumber="122">
          <span class="hits">39</span>
          
          <code class="ruby">                if defined?(filter)</code>
        </li>
      
        <li class="covered" data-hits="39" data-linenumber="123">
          <span class="hits">39</span>
          
          <code class="ruby">                  kvs[:Query] = filter.to_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">                elsif defined?(selector)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">                  kvs[:Query] = selector.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="130">
          <span class="hits">48</span>
          
          <code class="ruby">            kvs[:RemoteHost] = @collection.database.client.cluster.addresses.first.to_s</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="131">
          <span class="hits">48</span>
          
          <code class="ruby">            kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:mongo][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">          rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">            AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">          ensure</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="135">
          <span class="hits">48</span>
          
          <code class="ruby">            return kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">          ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">          # Here we dynamically define wrapper methods for the operations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">          # we want to instrument in mongo</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">          #</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="142">
          <span class="hits">36</span>
          
          <code class="ruby">          VIEW_OPS.reject { |m| !method_defined?(m) }.each do |m|</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="143">
          <span class="hits">33</span>
          
          <code class="ruby">            define_method(&quot;#{m}_with_appoptics&quot;) do |*args|</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="144">
          <span class="hits">72</span>
          
          <code class="ruby">              begin</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="145">
          <span class="hits">72</span>
          
          <code class="ruby">                if !AppOpticsAPM.tracing? || AppOpticsAPM.tracing_layer?(:mongo)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="146">
          <span class="hits">24</span>
          
          <code class="ruby">                  mongo_skipped = true</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="147">
          <span class="hits">24</span>
          
          <code class="ruby">                  return send(&quot;#{m}_without_appoptics&quot;, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="150">
          <span class="hits">48</span>
          
          <code class="ruby">                kvs = collect_kvs(m, args)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="151">
          <span class="hits">48</span>
          
          <code class="ruby">                AppOpticsAPM::API.log_entry(:mongo, kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="153">
          <span class="hits">48</span>
          
          <code class="ruby">                send(&quot;#{m}_without_appoptics&quot;, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">              rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">                AppOpticsAPM::API.log_exception(:mongo, e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">                raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">              ensure</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="158">
          <span class="hits">72</span>
          
          <code class="ruby">                AppOpticsAPM::API.log_exit(:mongo) unless mongo_skipped</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="161">
          <span class="hits">33</span>
          
          <code class="ruby">            ::AppOpticsAPM::Util.method_alias(Mongo::Collection::View, m)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">    # Mongo Collection Index View Instrumentation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">    # Collection Index View Related Operations</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="172">
          <span class="hits">3</span>
          
          <code class="ruby">    INDEX_OPS = [:create_one, :create_many, :drop_one, :drop_all].freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="174">
          <span class="hits">3</span>
          
          <code class="ruby">    module Mongo</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="175">
          <span class="hits">3</span>
          
          <code class="ruby">      module Index</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="176">
          <span class="hits">3</span>
          
          <code class="ruby">        class View</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">          ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">          # collect_kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">          #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">          # Used to collect up information to report and build a hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">          # with the Keys/Values to report.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">          #</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="183">
          <span class="hits">3</span>
          
          <code class="ruby">          def collect_index_kvs(op, args)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="184">
          <span class="hits">12</span>
          
          <code class="ruby">            kvs = { :Flavor =&gt; :mongodb, :Database =&gt; @collection.database.name }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="186">
          <span class="hits">12</span>
          
          <code class="ruby">            kvs[:QueryOp] = op</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="187">
          <span class="hits">12</span>
          
          <code class="ruby">            kvs[:Collection] = @collection.name</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="188">
          <span class="hits">12</span>
          
          <code class="ruby">            kvs[:RemoteHost] = @collection.database.client.cluster.addresses.first.to_s</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="189">
          <span class="hits">12</span>
          
          <code class="ruby">            kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:mongo][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">          rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">            AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">          ensure</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="193">
          <span class="hits">12</span>
          
          <code class="ruby">            return kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">          ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">          # Here we dynamically define wrapper methods for the operations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">          # we want to instrument in mongo</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">          #</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="200">
          <span class="hits">15</span>
          
          <code class="ruby">          INDEX_OPS.reject { |m| !method_defined?(m) }.each do |m|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="201">
          <span class="hits">12</span>
          
          <code class="ruby">            define_method(&quot;#{m}_with_appoptics&quot;) do |*args|</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="202">
          <span class="hits">33</span>
          
          <code class="ruby">              begin</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="203">
          <span class="hits">33</span>
          
          <code class="ruby">                if !AppOpticsAPM.tracing? || AppOpticsAPM.tracing_layer?(:mongo)</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="204">
          <span class="hits">21</span>
          
          <code class="ruby">                  mongo_skipped = true</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="205">
          <span class="hits">21</span>
          
          <code class="ruby">                  return send(&quot;#{m}_without_appoptics&quot;, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="208">
          <span class="hits">12</span>
          
          <code class="ruby">                kvs = collect_index_kvs(m, args)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="209">
          <span class="hits">12</span>
          
          <code class="ruby">                AppOpticsAPM::API.log_entry(:mongo, kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="211">
          <span class="hits">12</span>
          
          <code class="ruby">                send(&quot;#{m}_without_appoptics&quot;, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">              rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">                AppOpticsAPM::API.log_exception(:mongo, e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">                raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">              ensure</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="216">
          <span class="hits">33</span>
          
          <code class="ruby">                AppOpticsAPM::API.log_exit(:mongo) unless mongo_skipped</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="219">
          <span class="hits">12</span>
          
          <code class="ruby">            ::AppOpticsAPM::Util.method_alias(Mongo::Index::View, m)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9823ae1f08b7426581da78bf494419ead8afb947">
  <div class="header">
    <h3>lib/appoptics_apm/inst/moped.rb</h3>
    <h4><span class="yellow">90.0 %</span> covered</h4>
    <div>
      <b>240</b> relevant lines. 
      <span class="green"><b>216</b> lines covered</span> and
      <span class="red"><b>24</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">require &#39;json&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # Moped</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="11">
          <span class="hits">28</span>
          
          <code class="ruby">    module Moped</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="12">
          <span class="hits">28</span>
          
          <code class="ruby">      FLAVOR = :mongodb</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      # Moped::Database</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="15">
          <span class="hits">28</span>
          
          <code class="ruby">      DB_OPS         = [:command, :drop].freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      # Moped::Indexes</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="18">
          <span class="hits">28</span>
          
          <code class="ruby">      INDEX_OPS      = [:create, :drop].freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      # Moped::Query</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="21">
          <span class="hits">28</span>
          
          <code class="ruby">      QUERY_OPS      = [:count, :sort, :limit, :distinct, :update, :update_all, :upsert,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">                        :explain, :modify, :remove, :remove_all].freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      # Moped::Collection</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="25">
          <span class="hits">28</span>
          
          <code class="ruby">      COLLECTION_OPS = [:drop, :find, :indexes, :insert, :aggregate].freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      # remote_host</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      # This utility method converts the server into a host:port</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      # pair for reporting</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="33">
          <span class="hits">28</span>
          
          <code class="ruby">      def remote_host(server)</code>
        </li>
      
        <li class="covered" data-hits="108" data-linenumber="34">
          <span class="hits">108</span>
          
          <code class="ruby">        if ::Moped::VERSION &lt; &#39;2.0.0&#39;</code>
        </li>
      
        <li class="covered" data-hits="108" data-linenumber="35">
          <span class="hits">108</span>
          
          <code class="ruby">          server</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">          &quot;#{server.address.host}:#{server.address.port}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # MopedDatabase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="45">
          <span class="hits">28</span>
          
          <code class="ruby">    module MopedDatabase</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="46">
          <span class="hits">28</span>
          
          <code class="ruby">      include AppOpticsAPM::Inst::Moped</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="48">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="49">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::Inst::Moped::DB_OPS.each do |m|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="50">
          <span class="hits">6</span>
          
          <code class="ruby">          ::AppOpticsAPM::Util.method_alias(klass, m)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="54">
          <span class="hits">28</span>
          
          <code class="ruby">      def extract_trace_details(op)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="55">
          <span class="hits">6</span>
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="56">
          <span class="hits">6</span>
          
          <code class="ruby">        report_kvs[:Flavor] = AppOpticsAPM::Inst::Moped::FLAVOR</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">        # FIXME: We&#39;re only grabbing the first of potentially multiple servers here</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="58">
          <span class="hits">6</span>
          
          <code class="ruby">        report_kvs[:RemoteHost] = remote_host(session.cluster.seeds.first)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="59">
          <span class="hits">6</span>
          
          <code class="ruby">        report_kvs[:Database] = name</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="60">
          <span class="hits">6</span>
          
          <code class="ruby">        report_kvs[:QueryOp] = op.to_s</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="61">
          <span class="hits">6</span>
          
          <code class="ruby">        report_kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:moped][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      ensure</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="65">
          <span class="hits">6</span>
          
          <code class="ruby">        return report_kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="68">
          <span class="hits">28</span>
          
          <code class="ruby">      def command_with_appoptics(command)</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="69">
          <span class="hits">36</span>
          
          <code class="ruby">        if AppOpticsAPM.tracing? &amp;&amp; !AppOpticsAPM.layer_op &amp;&amp; command.key?(:mapreduce)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="70">
          <span class="hits">3</span>
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="71">
          <span class="hits">3</span>
          
          <code class="ruby">            report_kvs = extract_trace_details(:map_reduce)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="72">
          <span class="hits">3</span>
          
          <code class="ruby">            report_kvs[:Map_Function] = command[:map]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="73">
          <span class="hits">3</span>
          
          <code class="ruby">            report_kvs[:Reduce_Function] = command[:reduce]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">          rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">            AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="78">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="79">
          <span class="hits">3</span>
          
          <code class="ruby">            command_without_appoptics(command)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="82">
          <span class="hits">33</span>
          
          <code class="ruby">          command_without_appoptics(command)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="86">
          <span class="hits">28</span>
          
          <code class="ruby">      def drop_with_appoptics</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="87">
          <span class="hits">3</span>
          
          <code class="ruby">        return drop_without_appoptics unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="89">
          <span class="hits">3</span>
          
          <code class="ruby">        report_kvs = extract_trace_details(:drop_database)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="91">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="92">
          <span class="hits">3</span>
          
          <code class="ruby">          drop_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">    # MopedIndexes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="100">
          <span class="hits">28</span>
          
          <code class="ruby">    module MopedIndexes</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="101">
          <span class="hits">28</span>
          
          <code class="ruby">      include AppOpticsAPM::Inst::Moped</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="103">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="104">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::Inst::Moped::INDEX_OPS.each do |m|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="105">
          <span class="hits">6</span>
          
          <code class="ruby">          ::AppOpticsAPM::Util.method_alias(klass, m)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="109">
          <span class="hits">28</span>
          
          <code class="ruby">      def extract_trace_details(op)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="110">
          <span class="hits">6</span>
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="111">
          <span class="hits">6</span>
          
          <code class="ruby">        report_kvs[:Flavor] = AppOpticsAPM::Inst::Moped::FLAVOR</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">        # FIXME: We&#39;re only grabbing the first of potentially multiple servers here</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="114">
          <span class="hits">6</span>
          
          <code class="ruby">        first = database.session.cluster.seeds.first</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="115">
          <span class="hits">6</span>
          
          <code class="ruby">        if ::Moped::VERSION &lt; &#39;2.0.0&#39;</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="116">
          <span class="hits">6</span>
          
          <code class="ruby">          report_kvs[:RemoteHost] = first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">          report_kvs[:RemoteHost] = &quot;#{first.address.host}:#{first.address.port}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="120">
          <span class="hits">6</span>
          
          <code class="ruby">        report_kvs[:Database] = database.name</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="121">
          <span class="hits">6</span>
          
          <code class="ruby">        report_kvs[:QueryOp] = op.to_s</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="122">
          <span class="hits">6</span>
          
          <code class="ruby">        report_kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:moped][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">      ensure</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="126">
          <span class="hits">6</span>
          
          <code class="ruby">        return report_kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="129">
          <span class="hits">28</span>
          
          <code class="ruby">      def create_with_appoptics(key, options = {})</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="130">
          <span class="hits">3</span>
          
          <code class="ruby">        return create_without_appoptics(key, options) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="132">
          <span class="hits">3</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">          # We report :create_index here to be consistent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">          # with other mongo implementations</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="135">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs = extract_trace_details(:create_index)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="136">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs[:Key] = key.to_json</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="137">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs[:Options] = options.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="142">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:mongo, report_kvs, :create_index) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="143">
          <span class="hits">3</span>
          
          <code class="ruby">          create_without_appoptics(key, options = {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="147">
          <span class="hits">28</span>
          
          <code class="ruby">      def drop_with_appoptics(key = nil)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="148">
          <span class="hits">3</span>
          
          <code class="ruby">        return drop_without_appoptics(key) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="150">
          <span class="hits">3</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">          # We report :drop_indexes here to be consistent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">          # with other mongo implementations</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="153">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs = extract_trace_details(:drop_indexes)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="154">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs[:Key] = key.nil? ? :all : key.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="159">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="160">
          <span class="hits">3</span>
          
          <code class="ruby">          drop_without_appoptics(key = nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">    # MopedQuery</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="168">
          <span class="hits">28</span>
          
          <code class="ruby">    module MopedQuery</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="169">
          <span class="hits">28</span>
          
          <code class="ruby">      include AppOpticsAPM::Inst::Moped</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="171">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="172">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::Inst::Moped::QUERY_OPS.each do |m|</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="173">
          <span class="hits">33</span>
          
          <code class="ruby">          ::AppOpticsAPM::Util.method_alias(klass, m)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="177">
          <span class="hits">28</span>
          
          <code class="ruby">      def extract_trace_details(op)</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="178">
          <span class="hits">45</span>
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="179">
          <span class="hits">45</span>
          
          <code class="ruby">        report_kvs[:Flavor] = AppOpticsAPM::Inst::Moped::FLAVOR</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">        # FIXME: We&#39;re only grabbing the first of potentially multiple servers here</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="181">
          <span class="hits">45</span>
          
          <code class="ruby">        first = collection.database.session.cluster.seeds.first</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="182">
          <span class="hits">45</span>
          
          <code class="ruby">        report_kvs[:RemoteHost] = remote_host(first)</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="183">
          <span class="hits">45</span>
          
          <code class="ruby">        report_kvs[:Database] = collection.database.name</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="184">
          <span class="hits">45</span>
          
          <code class="ruby">        report_kvs[:Collection] = collection.name</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="185">
          <span class="hits">45</span>
          
          <code class="ruby">        report_kvs[:QueryOp] = op.to_s</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="186">
          <span class="hits">45</span>
          
          <code class="ruby">        report_kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:moped][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">      rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">      ensure</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="190">
          <span class="hits">45</span>
          
          <code class="ruby">        return report_kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="193">
          <span class="hits">28</span>
          
          <code class="ruby">      def count_with_appoptics</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="194">
          <span class="hits">15</span>
          
          <code class="ruby">        return count_without_appoptics unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="196">
          <span class="hits">3</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="197">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs = extract_trace_details(:count)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="198">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs[:Query] = selector.empty? ? :all : selector.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="203">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="204">
          <span class="hits">3</span>
          
          <code class="ruby">          count_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="208">
          <span class="hits">28</span>
          
          <code class="ruby">      def sort_with_appoptics(sort)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="209">
          <span class="hits">3</span>
          
          <code class="ruby">        return sort_without_appoptics(sort) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="211">
          <span class="hits">3</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="212">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs = extract_trace_details(:sort)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="213">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs[:Query] = selector.empty? ? :all : selector.to_json</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="214">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs[:Order] = sort.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="219">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="220">
          <span class="hits">3</span>
          
          <code class="ruby">          sort_without_appoptics(sort)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="224">
          <span class="hits">28</span>
          
          <code class="ruby">      def limit_with_appoptics(limit)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="225">
          <span class="hits">12</span>
          
          <code class="ruby">        if AppOpticsAPM.tracing? &amp;&amp; !AppOpticsAPM.tracing_layer_op?(:explain)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="226">
          <span class="hits">9</span>
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="227">
          <span class="hits">9</span>
          
          <code class="ruby">            report_kvs = extract_trace_details(:limit)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="228">
          <span class="hits">9</span>
          
          <code class="ruby">            report_kvs[:Query] = selector.empty? ? :all : selector.to_json</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="229">
          <span class="hits">9</span>
          
          <code class="ruby">            report_kvs[:Limit] = limit.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">          rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">            AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="234">
          <span class="hits">9</span>
          
          <code class="ruby">          AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="235">
          <span class="hits">9</span>
          
          <code class="ruby">            limit_without_appoptics(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="238">
          <span class="hits">3</span>
          
          <code class="ruby">          limit_without_appoptics(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="242">
          <span class="hits">28</span>
          
          <code class="ruby">      def distinct_with_appoptics(key)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="243">
          <span class="hits">3</span>
          
          <code class="ruby">        return distinct_without_appoptics(key) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="245">
          <span class="hits">3</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="246">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs = extract_trace_details(:distinct)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="247">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs[:Query] = selector.empty? ? :all : selector.to_json</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="248">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs[:Key] = key.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="253">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="254">
          <span class="hits">3</span>
          
          <code class="ruby">          distinct_without_appoptics(key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="258">
          <span class="hits">28</span>
          
          <code class="ruby">      def update_with_appoptics(change, flags = nil)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="259">
          <span class="hits">9</span>
          
          <code class="ruby">        if AppOpticsAPM.tracing? &amp;&amp; !AppOpticsAPM.tracing_layer_op?([:update_all, :upsert])</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="260">
          <span class="hits">3</span>
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="261">
          <span class="hits">3</span>
          
          <code class="ruby">            report_kvs = extract_trace_details(:update)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="262">
          <span class="hits">3</span>
          
          <code class="ruby">            report_kvs[:Flags] = flags.to_s if flags</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="263">
          <span class="hits">3</span>
          
          <code class="ruby">            report_kvs[:Update_Document] = change.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">          rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">            AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="268">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="269">
          <span class="hits">3</span>
          
          <code class="ruby">            update_without_appoptics(change, flags)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="272">
          <span class="hits">6</span>
          
          <code class="ruby">          update_without_appoptics(change, flags)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="276">
          <span class="hits">28</span>
          
          <code class="ruby">      def update_all_with_appoptics(change)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="277">
          <span class="hits">3</span>
          
          <code class="ruby">        return update_all_without_appoptics(change) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="279">
          <span class="hits">3</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="280">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs = extract_trace_details(:update_all)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="281">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs[:Update_Document] = change.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="283">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="286">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:mongo, report_kvs, :update_all) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="287">
          <span class="hits">3</span>
          
          <code class="ruby">          update_all_without_appoptics(change)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="291">
          <span class="hits">28</span>
          
          <code class="ruby">      def upsert_with_appoptics(change)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="292">
          <span class="hits">3</span>
          
          <code class="ruby">        return upsert_without_appoptics(change) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="294">
          <span class="hits">3</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="295">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs = extract_trace_details(:upsert)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="296">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs[:Query] = selector.to_json</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="297">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs[:Update_Document] = change.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="302">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:mongo, report_kvs, :upsert) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="303">
          <span class="hits">3</span>
          
          <code class="ruby">          upsert_without_appoptics(change)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="307">
          <span class="hits">28</span>
          
          <code class="ruby">      def explain_with_appoptics</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="308">
          <span class="hits">3</span>
          
          <code class="ruby">        return explain_without_appoptics unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="310">
          <span class="hits">3</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="311">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs = extract_trace_details(:explain)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="312">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs[:Query] = selector.empty? ? :all : selector.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="317">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:mongo, report_kvs, :explain) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="318">
          <span class="hits">3</span>
          
          <code class="ruby">          explain_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="322">
          <span class="hits">28</span>
          
          <code class="ruby">      def modify_with_appoptics(change, options = {})</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="323">
          <span class="hits">9</span>
          
          <code class="ruby">        return modify_without_appoptics(change, options) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="325">
          <span class="hits">9</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="326">
          <span class="hits">9</span>
          
          <code class="ruby">          report_kvs = extract_trace_details(:modify)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="327">
          <span class="hits">9</span>
          
          <code class="ruby">          report_kvs[:Update_Document] = selector.empty? ? :all : selector.to_json</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="328">
          <span class="hits">9</span>
          
          <code class="ruby">          report_kvs[:Change] = change.to_json</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="329">
          <span class="hits">9</span>
          
          <code class="ruby">          report_kvs[:Options] = options.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="334">
          <span class="hits">9</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="335">
          <span class="hits">9</span>
          
          <code class="ruby">          modify_without_appoptics(change, options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="339">
          <span class="hits">28</span>
          
          <code class="ruby">      def remove_with_appoptics</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="340">
          <span class="hits">3</span>
          
          <code class="ruby">        return remove_without_appoptics unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="342">
          <span class="hits">3</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="343">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs = extract_trace_details(:remove)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="344">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs[:Query] = selector.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="349">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="350">
          <span class="hits">3</span>
          
          <code class="ruby">          remove_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="354">
          <span class="hits">28</span>
          
          <code class="ruby">      def remove_all_with_appoptics</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="355">
          <span class="hits">3</span>
          
          <code class="ruby">        return remove_all_without_appoptics unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="357">
          <span class="hits">3</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="358">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs = extract_trace_details(:remove_all)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="359">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs[:Query] = selector.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="361">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="364">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="365">
          <span class="hits">3</span>
          
          <code class="ruby">          remove_all_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">    # MopedCollection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="373">
          <span class="hits">28</span>
          
          <code class="ruby">    module MopedCollection</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="374">
          <span class="hits">28</span>
          
          <code class="ruby">      include AppOpticsAPM::Inst::Moped</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="376">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="377">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::Inst::Moped::COLLECTION_OPS.each do |m|</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="378">
          <span class="hits">15</span>
          
          <code class="ruby">          ::AppOpticsAPM::Util.method_alias(klass, m)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="382">
          <span class="hits">28</span>
          
          <code class="ruby">      def extract_trace_details(op)</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="383">
          <span class="hits">57</span>
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="384">
          <span class="hits">57</span>
          
          <code class="ruby">        report_kvs[:Flavor] = AppOpticsAPM::Inst::Moped::FLAVOR</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby">        # FIXME: We&#39;re only grabbing the first of potentially multiple servers here</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="386">
          <span class="hits">57</span>
          
          <code class="ruby">        report_kvs[:RemoteHost] = remote_host(database.session.cluster.seeds.first)</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="387">
          <span class="hits">57</span>
          
          <code class="ruby">        report_kvs[:Database] = database.name</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="388">
          <span class="hits">57</span>
          
          <code class="ruby">        report_kvs[:Collection] = name</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="389">
          <span class="hits">57</span>
          
          <code class="ruby">        report_kvs[:QueryOp] = op.to_s</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="390">
          <span class="hits">57</span>
          
          <code class="ruby">        report_kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:moped][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby">      rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby">      ensure</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="394">
          <span class="hits">57</span>
          
          <code class="ruby">        return report_kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="397">
          <span class="hits">28</span>
          
          <code class="ruby">      def drop_with_appoptics</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="398">
          <span class="hits">60</span>
          
          <code class="ruby">        return drop_without_appoptics unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby">        # We report :drop_collection here to be consistent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">        # with other mongo implementations</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="402">
          <span class="hits">3</span>
          
          <code class="ruby">        report_kvs = extract_trace_details(:drop_collection)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="404">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="405">
          <span class="hits">3</span>
          
          <code class="ruby">          drop_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="409">
          <span class="hits">28</span>
          
          <code class="ruby">      def find_with_appoptics(selector = {})</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="410">
          <span class="hits">57</span>
          
          <code class="ruby">        return find_without_appoptics(selector) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="411">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="412">
          <span class="hits">45</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="413">
          <span class="hits">45</span>
          
          <code class="ruby">          report_kvs = extract_trace_details(:find)</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="414">
          <span class="hits">45</span>
          
          <code class="ruby">          report_kvs[:Query] = selector.empty? ? &#39;all&#39; : selector.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="416">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="419">
          <span class="hits">45</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="420">
          <span class="hits">45</span>
          
          <code class="ruby">          find_without_appoptics(selector)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="423">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="424">
          <span class="hits">28</span>
          
          <code class="ruby">      def indexes_with_appoptics</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="425">
          <span class="hits">6</span>
          
          <code class="ruby">        return indexes_without_appoptics unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="427">
          <span class="hits">6</span>
          
          <code class="ruby">        report_kvs = extract_trace_details(:indexes)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="428">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="429">
          <span class="hits">6</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="430">
          <span class="hits">6</span>
          
          <code class="ruby">          indexes_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="431">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="432">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="434">
          <span class="hits">28</span>
          
          <code class="ruby">      def insert_with_appoptics(documents, flags = nil)</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="435">
          <span class="hits">66</span>
          
          <code class="ruby">        if AppOpticsAPM.tracing? &amp;&amp; !AppOpticsAPM.tracing_layer_op?(:create_index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="436">
          
          
          <code class="ruby">          report_kvs = extract_trace_details(:insert)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="438">
          
          
          <code class="ruby">          AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="439">
          
          
          <code class="ruby">            insert_without_appoptics(documents, flags)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="440">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="442">
          <span class="hits">66</span>
          
          <code class="ruby">          insert_without_appoptics(documents, flags)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="443">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="445">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="446">
          <span class="hits">28</span>
          
          <code class="ruby">      def aggregate_with_appoptics(*pipeline)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="447">
          <span class="hits">3</span>
          
          <code class="ruby">        return aggregate_without_appoptics(*pipeline) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="448">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="449">
          <span class="hits">3</span>
          
          <code class="ruby">        report_kvs = extract_trace_details(:aggregate)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="450">
          <span class="hits">3</span>
          
          <code class="ruby">        report_kvs[:Query] = pipeline</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="451">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="452">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:mongo, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="453">
          <span class="hits">3</span>
          
          <code class="ruby">          aggregate_without_appoptics(pipeline)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="454">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="456">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="457">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="459">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="460">
          <span class="hits">28</span>
          
          <code class="ruby">if defined?(::Moped) &amp;&amp; AppOpticsAPM::Config[:moped][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="461">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting moped&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="462">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_include(::Moped::Database,   ::AppOpticsAPM::Inst::MopedDatabase)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="463">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_include(::Moped::Collection, ::AppOpticsAPM::Inst::MopedCollection)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="464">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_include(::Moped::Query,      ::AppOpticsAPM::Inst::MopedQuery)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="465">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_include(::Moped::Indexes,    ::AppOpticsAPM::Inst::MopedIndexes)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="466">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="6c55d8d4bd46293fa43f3dbe40600d99cdc1c5ce">
  <div class="header">
    <h3>lib/appoptics_apm/inst/rack.rb</h3>
    <h4><span class="green">96.84 %</span> covered</h4>
    <div>
      <b>95</b> relevant lines. 
      <span class="green"><b>92</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="4">
          <span class="hits">31</span>
          
          <code class="ruby">require &#39;uri&#39;</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="5">
          <span class="hits">31</span>
          
          <code class="ruby">require &#39;cgi&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="7">
          <span class="hits">31</span>
          
          <code class="ruby">if AppOpticsAPM.loaded</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="8">
          <span class="hits">28</span>
          
          <code class="ruby">  module AppOpticsAPM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    # AppOpticsAPM::Rack</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    # The AppOpticsAPM::Rack middleware used to sample a subset of incoming</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    # requests for instrumentation and reporting.  Tracing context can</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # be received here (via the X-Trace HTTP header) or initiated here</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # based on configured tracing mode.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    # After the rack layer passes on to the following layers (Rails, Sinatra,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    # Padrino, Grape), then the instrumentation downstream will</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # automatically detect whether this is a sampled request or not</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    # and act accordingly. (to instrument or not)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="22">
          <span class="hits">28</span>
          
          <code class="ruby">    class Rack</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="23">
          <span class="hits">28</span>
          
          <code class="ruby">      attr_reader :app</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="25">
          <span class="hits">28</span>
          
          <code class="ruby">      def initialize(app)</code>
        </li>
      
        <li class="covered" data-hits="505" data-linenumber="26">
          <span class="hits">505</span>
          
          <code class="ruby">        @app = app</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="29">
          <span class="hits">28</span>
          
          <code class="ruby">      def call(env)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        # In the case of nested Ruby apps such as Grape inside of Rails</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">        # or Grape inside of Grape, each app has it&#39;s own instance</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        # of rack middleware.  We avoid tracing rack more than once and</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        # instead start instrumenting from the first rack pass.</code>
        </li>
      
        <li class="covered" data-hits="817" data-linenumber="34">
          <span class="hits">817</span>
          
          <code class="ruby">        return call_app(env) if AppOpticsAPM.tracing? &amp;&amp; AppOpticsAPM.layer == :rack</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        # if we already have a context, we don&#39;t want to send metrics in the end</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="37">
          <span class="hits">805</span>
          
          <code class="ruby">        return sampling_call(env) if AppOpticsAPM::Context.isValid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        # else we also send metrics</code>
        </li>
      
        <li class="covered" data-hits="796" data-linenumber="40">
          <span class="hits">796</span>
          
          <code class="ruby">        metrics_sampling_call(env)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="43">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.noop?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">        false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="47">
          <span class="hits">28</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="49">
          <span class="hits">28</span>
          
          <code class="ruby">      def collect(req, env)</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="50">
          <span class="hits">805</span>
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="52">
          <span class="hits">805</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="53">
          <span class="hits">805</span>
          
          <code class="ruby">          report_kvs[:&#39;HTTP-Host&#39;]        = req.host</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="54">
          <span class="hits">805</span>
          
          <code class="ruby">          report_kvs[:Port]             = req.port</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="55">
          <span class="hits">805</span>
          
          <code class="ruby">          report_kvs[:Proto]            = req.scheme</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="56">
          <span class="hits">805</span>
          
          <code class="ruby">          report_kvs[:Method]            = req.request_method</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="57">
          <span class="hits">805</span>
          
          <code class="ruby">          report_kvs[:AJAX]             = true if req.xhr?</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="58">
          <span class="hits">805</span>
          
          <code class="ruby">          report_kvs[:ClientIP]         = req.ip</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="60">
          <span class="hits">805</span>
          
          <code class="ruby">          if AppOpticsAPM::Config[:rack][:log_args]</code>
        </li>
      
        <li class="covered" data-hits="802" data-linenumber="61">
          <span class="hits">802</span>
          
          <code class="ruby">            report_kvs[:&#39;Query-String&#39;]     = ::CGI.unescape(req.query_string) unless req.query_string.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">          # Report any request queue&#39;ing headers.  Report as &#39;Request-Start&#39; or the summed Queue-Time</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="65">
          <span class="hits">805</span>
          
          <code class="ruby">          report_kvs[:&#39;Request-Start&#39;]     = env[&#39;HTTP_X_REQUEST_START&#39;]    if env.key?(&#39;HTTP_X_REQUEST_START&#39;)</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="66">
          <span class="hits">805</span>
          
          <code class="ruby">          report_kvs[:&#39;Request-Start&#39;]     = env[&#39;HTTP_X_QUEUE_START&#39;]      if env.key?(&#39;HTTP_X_QUEUE_START&#39;)</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="67">
          <span class="hits">805</span>
          
          <code class="ruby">          report_kvs[:&#39;Queue-Time&#39;]        = env[&#39;HTTP_X_QUEUE_TIME&#39;]       if env.key?(&#39;HTTP_X_QUEUE_TIME&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="69">
          <span class="hits">805</span>
          
          <code class="ruby">          report_kvs[:&#39;Forwarded-For&#39;]     = env[&#39;HTTP_X_FORWARDED_FOR&#39;]    if env.key?(&#39;HTTP_X_FORWARDED_FOR&#39;)</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="70">
          <span class="hits">805</span>
          
          <code class="ruby">          report_kvs[:&#39;Forwarded-Host&#39;]    = env[&#39;HTTP_X_FORWARDED_HOST&#39;]   if env.key?(&#39;HTTP_X_FORWARDED_HOST&#39;)</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="71">
          <span class="hits">805</span>
          
          <code class="ruby">          report_kvs[:&#39;Forwarded-Proto&#39;]   = env[&#39;HTTP_X_FORWARDED_PROTO&#39;]  if env.key?(&#39;HTTP_X_FORWARDED_PROTO&#39;)</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="72">
          <span class="hits">805</span>
          
          <code class="ruby">          report_kvs[:&#39;Forwarded-Port&#39;]    = env[&#39;HTTP_X_FORWARDED_PORT&#39;]   if env.key?(&#39;HTTP_X_FORWARDED_PORT&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="74">
          <span class="hits">805</span>
          
          <code class="ruby">          report_kvs[:&#39;Ruby.AppOpticsAPM.Version&#39;] = ::AppOpticsAPM::Version::STRING</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="75">
          <span class="hits">805</span>
          
          <code class="ruby">          report_kvs[:ProcessID]         = Process.pid</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="76">
          <span class="hits">805</span>
          
          <code class="ruby">          report_kvs[:ThreadID]          = Thread.current.to_s[/0x\w*/]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">          # Discard any potential exceptions. Debug log and report whatever we can.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] Rack KV collection error: #{e.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="81">
          <span class="hits">805</span>
          
          <code class="ruby">        report_kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="84">
          <span class="hits">28</span>
          
          <code class="ruby">      def call_app(env)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="85">
          <span class="hits">9</span>
          
          <code class="ruby">        AppOpticsAPM.logger.debug &quot;[appoptics_apm/rack] Rack skipped!&quot;</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="86">
          <span class="hits">9</span>
          
          <code class="ruby">        @app.call(env)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">      # in this case we have an existing context</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="90">
          <span class="hits">28</span>
          
          <code class="ruby">      def sampling_call(env)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="91">
          <span class="hits">9</span>
          
          <code class="ruby">        req = ::Rack::Request.new(env)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="92">
          <span class="hits">9</span>
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="93">
          <span class="hits">9</span>
          
          <code class="ruby">        report_kvs[:URL] = AppOpticsAPM::Config[:rack][:log_args] ? ::CGI.unescape(req.fullpath) : ::CGI.unescape(req.path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="95">
          <span class="hits">9</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:rack, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="96">
          <span class="hits">9</span>
          
          <code class="ruby">          report_kvs = collect(req, env)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">          # We log an info event with the HTTP KVs found in AppOpticsAPM::Rack.collect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">          # This is done here so in the case of stacks that try/catch/abort</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">          # (looking at you Grape) we&#39;re sure the KVs get reported now as</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">          # this code may not be returned to later.</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="102">
          <span class="hits">9</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_info(:rack, report_kvs)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="103">
          <span class="hits">9</span>
          
          <code class="ruby">          @app.call(env)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="107">
          <span class="hits">28</span>
          
          <code class="ruby">      def metrics_sampling_call(env)</code>
        </li>
      
        <li class="covered" data-hits="796" data-linenumber="108">
          <span class="hits">796</span>
          
          <code class="ruby">        start = Time.now</code>
        </li>
      
        <li class="covered" data-hits="796" data-linenumber="109">
          <span class="hits">796</span>
          
          <code class="ruby">        AppOpticsAPM.transaction_name = nil</code>
        </li>
      
        <li class="covered" data-hits="796" data-linenumber="110">
          <span class="hits">796</span>
          
          <code class="ruby">        req = ::Rack::Request.new(env)</code>
        </li>
      
        <li class="covered" data-hits="796" data-linenumber="111">
          <span class="hits">796</span>
          
          <code class="ruby">        req_url = req.url   # saving it here because rails3.2 overrides it when there is a 500 error</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="796" data-linenumber="113">
          <span class="hits">796</span>
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="796" data-linenumber="114">
          <span class="hits">796</span>
          
          <code class="ruby">        report_kvs[:URL] = AppOpticsAPM::Config[:rack][:log_args] ? ::CGI.unescape(req.fullpath) : ::CGI.unescape(req.path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">        # Check for and validate X-Trace request header to pick up tracing context</code>
        </li>
      
        <li class="covered" data-hits="796" data-linenumber="117">
          <span class="hits">796</span>
          
          <code class="ruby">        xtrace = env.is_a?(Hash) ? env[&#39;HTTP_X_TRACE&#39;] : nil</code>
        </li>
      
        <li class="covered" data-hits="796" data-linenumber="118">
          <span class="hits">796</span>
          
          <code class="ruby">        xtrace = AppOpticsAPM::XTrace.valid?(xtrace) ? xtrace : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">        # TODO JRUBY</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">        # Under JRuby, JAppOpticsAPM may have already started a trace.  Make note of this</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">        # if so and don&#39;t clear context on log_end (see appoptics_apm/api/logging.rb)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">        # AppOpticsAPM.has_incoming_context = AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">        # AppOpticsAPM.has_xtrace_header = xtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">        # AppOpticsAPM.is_continued_trace = AppOpticsAPM.has_incoming_context || AppOpticsAPM.has_xtrace_header</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="796" data-linenumber="127">
          <span class="hits">796</span>
          
          <code class="ruby">        AppOpticsAPM::API.log_start(:rack, xtrace, report_kvs) unless ::AppOpticsAPM::Util.static_asset?(env[&#39;PATH_INFO&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">        # We log an info event with the HTTP KVs found in AppOpticsAPM::Rack.collect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">        # This is done here so in the case of stacks that try/catch/abort</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">        # (looking at you Grape) we&#39;re sure the KVs get reported now as</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">        # this code may not be returned to later.</code>
        </li>
      
        <li class="covered" data-hits="796" data-linenumber="133">
          <span class="hits">796</span>
          
          <code class="ruby">        AppOpticsAPM::API.log_info(:rack, collect(req, env))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="796" data-linenumber="135">
          <span class="hits">796</span>
          
          <code class="ruby">        status, headers, response = @app.call(env)</code>
        </li>
      
        <li class="covered" data-hits="784" data-linenumber="136">
          <span class="hits">784</span>
          
          <code class="ruby">        confirmed_transaction_name = send_metrics(env, req, req_url, start, status)</code>
        </li>
      
        <li class="covered" data-hits="784" data-linenumber="137">
          <span class="hits">784</span>
          
          <code class="ruby">        xtrace = AppOpticsAPM::API.log_end(:rack, :Status =&gt; status, :TransactionName =&gt; confirmed_transaction_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="784" data-linenumber="139">
          <span class="hits">784</span>
          
          <code class="ruby">        if headers &amp;&amp; AppOpticsAPM::XTrace.valid?(xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">          # TODO revisit this JRUBY condition</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">          # headers[&#39;X-Trace&#39;] = xtrace if headers.is_a?(Hash) unless defined?(JRUBY_VERSION) &amp;&amp; AppOpticsAPM.is_continued_trace?</code>
        </li>
      
        <li class="covered" data-hits="748" data-linenumber="142">
          <span class="hits">748</span>
          
          <code class="ruby">          headers[&#39;X-Trace&#39;] = xtrace if headers.is_a?(Hash) unless defined?(JRUBY_VERSION) &amp;&amp; AppOpticsAPM.is_continued_trace?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="784" data-linenumber="145">
          <span class="hits">784</span>
          
          <code class="ruby">        [status, headers, response]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">        # it is ok to rescue Exception here because we are reraising it (we just need a chance to log_end)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="148">
          <span class="hits">6</span>
          
          <code class="ruby">        AppOpticsAPM::API.log_exception(:rack, e)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="149">
          <span class="hits">6</span>
          
          <code class="ruby">        confirmed_transaction_name ||= send_metrics(env, req, req_url, start, status)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="150">
          <span class="hits">6</span>
          
          <code class="ruby">        xtrace = AppOpticsAPM::API.log_end(:rack, :Status =&gt; status, :TransactionName =&gt; confirmed_transaction_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="152">
          <span class="hits">6</span>
          
          <code class="ruby">        if headers &amp;&amp; AppOpticsAPM::XTrace.valid?(xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">          # TODO revisit this JRUBY condition</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">          # headers[&#39;X-Trace&#39;] = xtrace if headers.is_a?(Hash) unless defined?(JRUBY_VERSION) &amp;&amp; AppOpticsAPM.is_continued_trace?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">          headers[&#39;X-Trace&#39;] = xtrace if headers.is_a?(Hash) unless defined?(JRUBY_VERSION) &amp;&amp; AppOpticsAPM.is_continued_trace?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="158">
          <span class="hits">6</span>
          
          <code class="ruby">        raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="162">
          <span class="hits">28</span>
          
          <code class="ruby">      def send_metrics(env, req, req_url, start, status)</code>
        </li>
      
        <li class="covered" data-hits="790" data-linenumber="163">
          <span class="hits">790</span>
          
          <code class="ruby">        return if ::AppOpticsAPM::Util.static_asset?(env[&#39;PATH_INFO&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="772" data-linenumber="165">
          <span class="hits">772</span>
          
          <code class="ruby">        domain = nil</code>
        </li>
      
        <li class="covered" data-hits="772" data-linenumber="166">
          <span class="hits">772</span>
          
          <code class="ruby">        if AppOpticsAPM::Config[&#39;transaction_name&#39;][&#39;prepend_domain&#39;]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="167">
          <span class="hits">6</span>
          
          <code class="ruby">          domain = [80, 443].include?(req.port) ? req.host : &quot;#{req.host}:#{req.port}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="772" data-linenumber="169">
          <span class="hits">772</span>
          
          <code class="ruby">        status = status.to_i</code>
        </li>
      
        <li class="covered" data-hits="772" data-linenumber="170">
          <span class="hits">772</span>
          
          <code class="ruby">        error = status.between?(500,599) ? 1 : 0</code>
        </li>
      
        <li class="covered" data-hits="772" data-linenumber="171">
          <span class="hits">772</span>
          
          <code class="ruby">        duration =(1000 * 1000 * (Time.now - start)).round(0)</code>
        </li>
      
        <li class="covered" data-hits="772" data-linenumber="172">
          <span class="hits">772</span>
          
          <code class="ruby">        AppOpticsAPM::Span.createHttpSpan(transaction_name(env), req_url, domain, duration, status, req.request_method, error) || &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="175">
          <span class="hits">28</span>
          
          <code class="ruby">      def transaction_name(env)</code>
        </li>
      
        <li class="covered" data-hits="772" data-linenumber="176">
          <span class="hits">772</span>
          
          <code class="ruby">        if AppOpticsAPM.transaction_name</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="177">
          <span class="hits">21</span>
          
          <code class="ruby">          AppOpticsAPM.transaction_name</code>
        </li>
      
        <li class="covered" data-hits="751" data-linenumber="178">
          <span class="hits">751</span>
          
          <code class="ruby">        elsif env[&#39;appoptics_apm.controller&#39;] || env[&#39;appoptics_apm.action&#39;]</code>
        </li>
      
        <li class="covered" data-hits="367" data-linenumber="179">
          <span class="hits">367</span>
          
          <code class="ruby">          [env[&#39;appoptics_apm.controller&#39;], env[&#39;appoptics_apm.action&#39;]].join(&#39;.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="186">
          <span class="hits">3</span>
          
          <code class="ruby">  module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="187">
          <span class="hits">3</span>
          
          <code class="ruby">    class Rack</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="188">
          <span class="hits">3</span>
          
          <code class="ruby">      attr_reader :app</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="190">
          <span class="hits">3</span>
          
          <code class="ruby">      def initialize(app)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="191">
          <span class="hits">3</span>
          
          <code class="ruby">        @app = app</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="194">
          <span class="hits">3</span>
          
          <code class="ruby">      def call(env)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="195">
          <span class="hits">3</span>
          
          <code class="ruby">        @app.call(env)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="198">
          <span class="hits">3</span>
          
          <code class="ruby">      def self.noop?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="199">
          <span class="hits">3</span>
          
          <code class="ruby">        true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8f0a2b577507604412be43fd399be55f7268bd7c">
  <div class="header">
    <h3>lib/appoptics_apm/inst/redis.rb</h3>
    <h4><span class="yellow">81.25 %</span> covered</h4>
    <div>
      <b>112</b> relevant lines. 
      <span class="green"><b>91</b> lines covered</span> and
      <span class="red"><b>21</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    module Redis</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">      module Client</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">        # The operations listed in this constant skip collecting KVKey</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="9">
          <span class="hits">28</span>
          
          <code class="ruby">        NO_KEY_OPS = [:auth, :keys, :randomkey, :scan, :sdiff, :sdiffstore, :sinter,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">                      :sinterstore, :smove, :sunion, :sunionstore, :zinterstore,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">                      :zunionstore, :publish, :select, :eval, :evalsha, :script].freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">        # Instead of a giant switch statement, we use a hash constant to map out what</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">        # KVs need to be collected for each of the many many Redis operations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">        # Hash formatting by undiagnosed OCD</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="16">
          <span class="hits">28</span>
          
          <code class="ruby">        KV_COLLECT_MAP = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">          :brpoplpush  =&gt; { :destination  =&gt; 2 }, :rpoplpush   =&gt; { :destination  =&gt; 2 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">          :sdiffstore  =&gt; { :destination  =&gt; 1 }, :sinterstore =&gt; { :destination  =&gt; 1 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">          :sunionstore =&gt; { :destination  =&gt; 1 }, :zinterstore =&gt; { :destination  =&gt; 1 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">          :zunionstore =&gt; { :destination  =&gt; 1 }, :publish     =&gt; { :channel      =&gt; 1 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">          :incrby      =&gt; { :increment    =&gt; 2 }, :incrbyfloat =&gt; { :increment    =&gt; 2 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">          :pexpire     =&gt; { :milliseconds =&gt; 2 }, :pexpireat   =&gt; { :milliseconds =&gt; 2 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">          :expireat    =&gt; { :timestamp    =&gt; 2 }, :decrby      =&gt; { :decrement    =&gt; 2 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">          :psetex      =&gt; { :ttl     =&gt; 2 },      :restore  =&gt; { :ttl     =&gt; 2 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">          :setex       =&gt; { :ttl     =&gt; 2 },      :setnx    =&gt; { :ttl     =&gt; 2 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">          :move        =&gt; { :db      =&gt; 2 },      :select   =&gt; { :db      =&gt; 1 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">          :lindex      =&gt; { :index   =&gt; 2 },      :getset   =&gt; { :value   =&gt; 2 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">          :keys        =&gt; { :pattern =&gt; 1 },      :expire   =&gt; { :seconds =&gt; 2 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">          :rename      =&gt; { :newkey  =&gt; 2 },      :renamenx =&gt; { :newkey  =&gt; 2 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">          :getbit      =&gt; { :offset  =&gt; 2 },      :setbit   =&gt; { :offset  =&gt; 2 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">          :setrange    =&gt; { :offset  =&gt; 2 },      :evalsha  =&gt; { :sha     =&gt; 1 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">          :getrange    =&gt; { :start =&gt; 2, :end       =&gt; 3 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">          :zrange      =&gt; { :start =&gt; 2, :end       =&gt; 3 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">          :bitcount    =&gt; { :start =&gt; 2, :stop      =&gt; 3 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">          :lrange      =&gt; { :start =&gt; 2, :stop      =&gt; 3 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">          :zrevrange   =&gt; { :start =&gt; 2, :stop      =&gt; 3 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">          :hincrby     =&gt; { :field =&gt; 2, :increment =&gt; 3 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">          :smove           =&gt; { :source    =&gt; 1, :destination =&gt; 2 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">          :bitop           =&gt; { :operation =&gt; 1, :destkey     =&gt; 2 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">          :hincrbyfloat    =&gt; { :field     =&gt; 2, :increment   =&gt; 3 },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">          :zremrangebyrank =&gt; { :start     =&gt; 2, :stop        =&gt; 3 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">        }.freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        # The following operations don&#39;t require any special handling. For these,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">        # we only collect KVKey and KVOp</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">        # :append, :blpop, :brpop, :decr, :del, :dump, :exists,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">        # :hgetall, :hkeys, :hlen, :hvals, :hmset, :incr, :linsert,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">        # :llen, :lpop, :lpush, :lpushx, :lrem, :lset, :ltrim,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">        # :persist, :pttl, :hscan, :rpop, :rpush, :rpushx, :sadd,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        # :scard, :sismember, :smembers, :strlen, :sort, :spop,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        # :srandmember, :srem, :sscan, :ttl, :type, :zadd, :zcard,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        # :zcount, :zincrby, :zrangebyscore, :zrank, :zrem,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">        # :zremrangebyscore, :zrevrank, :zrevrangebyscore, :zscore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">        # For the operations in NO_KEY_OPS (above) we only collect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">        # KVOp (no KVKey)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="59">
          <span class="hits">28</span>
          
          <code class="ruby">        def self.included(klass)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">          # We wrap two of the Redis methods to instrument</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">          # operations</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="62">
          <span class="hits">16</span>
          
          <code class="ruby">          ::AppOpticsAPM::Util.method_alias(klass, :call, ::Redis::Client)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="63">
          <span class="hits">16</span>
          
          <code class="ruby">          ::AppOpticsAPM::Util.method_alias(klass, :call_pipeline, ::Redis::Client)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        # Given any Redis operation command array, this method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">        # extracts the Key/Values to report to the AppOptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">        # dashboard.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">        # @param command [Array] the Redis operation array</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        # @param r [Return] the return value from the operation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">        # @return [Hash] the Key/Values to report</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="73">
          <span class="hits">28</span>
          
          <code class="ruby">        def extract_trace_details(command, r)</code>
        </li>
      
        <li class="covered" data-hits="391" data-linenumber="74">
          <span class="hits">391</span>
          
          <code class="ruby">          kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="391" data-linenumber="75">
          <span class="hits">391</span>
          
          <code class="ruby">          op = command.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="391" data-linenumber="77">
          <span class="hits">391</span>
          
          <code class="ruby">          kvs[:KVOp] = command[0]</code>
        </li>
      
        <li class="covered" data-hits="391" data-linenumber="78">
          <span class="hits">391</span>
          
          <code class="ruby">          kvs[:RemoteHost] = @options[:host]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="391" data-linenumber="80">
          <span class="hits">391</span>
          
          <code class="ruby">          unless NO_KEY_OPS.include?(op) || (command[1].is_a?(Array) &amp;&amp; command[1].count &gt; 1)</code>
        </li>
      
        <li class="covered" data-hits="296" data-linenumber="81">
          <span class="hits">296</span>
          
          <code class="ruby">            if command[1].is_a?(Array)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="82">
          <span class="hits">6</span>
          
          <code class="ruby">              kvs[:KVKey] = command[1].first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="covered" data-hits="290" data-linenumber="84">
          <span class="hits">290</span>
          
          <code class="ruby">              kvs[:KVKey] = command[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="391" data-linenumber="88">
          <span class="hits">391</span>
          
          <code class="ruby">          if KV_COLLECT_MAP[op]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">            # Extract KVs from command for this op</code>
        </li>
      
        <li class="covered" data-hits="270" data-linenumber="90">
          <span class="hits">270</span>
          
          <code class="ruby">            KV_COLLECT_MAP[op].each { |k, v| kvs[k] = command[v] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">            # This case statement handle special cases not handled</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">            # by KV_COLLECT_MAP</code>
        </li>
      
        <li class="covered" data-hits="271" data-linenumber="94">
          <span class="hits">271</span>
          
          <code class="ruby">            case op</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">            when :set</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="96">
          <span class="hits">6</span>
          
          <code class="ruby">              if command.count &gt; 3</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="97">
          <span class="hits">3</span>
          
          <code class="ruby">                if command[3].is_a?(Hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">                  options = command[3]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">                  kvs[:ex] = options[:ex] if options.key?(:ex)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">                  kvs[:px] = options[:px] if options.key?(:px)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">                  kvs[:nx] = options[:nx] if options.key?(:nx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">                  kvs[:xx] = options[:xx] if options.key?(:xx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">                else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="104">
          <span class="hits">3</span>
          
          <code class="ruby">                  options = command[3..-1]</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="105">
          <span class="hits">9</span>
          
          <code class="ruby">                  until (opts = options.shift(2)).empty?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="106">
          <span class="hits">3</span>
          
          <code class="ruby">                    case opts[0]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="107">
          <span class="hits">3</span>
          
          <code class="ruby">                    when &#39;EX&#39; then; kvs[:ex] = opts[1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">                    when &#39;PX&#39; then; kvs[:px] = opts[1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">                    when &#39;NX&#39; then; kvs[:nx] = opts[1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">                    when &#39;XX&#39; then; kvs[:xx] = opts[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">                    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">                  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">            when :get</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="117">
          <span class="hits">3</span>
          
          <code class="ruby">              kvs[:KVHit] = r.nil? ? 0 : 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">            when :hdel, :hexists, :hget, :hset, :hsetnx</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="120">
          <span class="hits">21</span>
          
          <code class="ruby">              kvs[:field] = command[2] unless command[2].is_a?(Array)</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="121">
          <span class="hits">21</span>
          
          <code class="ruby">              if op == :hget</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="122">
          <span class="hits">6</span>
          
          <code class="ruby">                kvs[:KVHit] = r.nil? ? 0 : 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">            when :eval</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="126">
          <span class="hits">9</span>
          
          <code class="ruby">              if command[1].length &gt; 1024</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">                kvs[:Script] = command[1][0..1023] + &#39;(...snip...)&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="129">
          <span class="hits">9</span>
          
          <code class="ruby">                kvs[:Script] = command[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">            when :script</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="133">
          <span class="hits">12</span>
          
          <code class="ruby">              kvs[:subcommand] = command[1]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="134">
          <span class="hits">12</span>
          
          <code class="ruby">              kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:redis][:collect_backtraces]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="135">
          <span class="hits">12</span>
          
          <code class="ruby">              if command[1] == &#39;load&#39;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="136">
          <span class="hits">3</span>
          
          <code class="ruby">                if command[1].length &gt; 1024</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">                  kvs[:Script] = command[2][0..1023] + &#39;(...snip...)&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">                else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="139">
          <span class="hits">3</span>
          
          <code class="ruby">                  kvs[:Script] = command[2]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="141">
          <span class="hits">9</span>
          
          <code class="ruby">              elsif command[1] == :exists</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="142">
          <span class="hits">6</span>
          
          <code class="ruby">                if command[2].is_a?(Array)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="143">
          <span class="hits">3</span>
          
          <code class="ruby">                  kvs[:KVKey] = command[2].inspect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">                else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="145">
          <span class="hits">3</span>
          
          <code class="ruby">                  kvs[:KVKey] = command[2]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">            when :mget</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="150">
          <span class="hits">6</span>
          
          <code class="ruby">              if command[1].is_a?(Array)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="151">
          <span class="hits">3</span>
          
          <code class="ruby">                kvs[:KVKeyCount] = command[1].count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="153">
          <span class="hits">3</span>
          
          <code class="ruby">                kvs[:KVKeyCount] = command.count - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="155">
          <span class="hits">18</span>
          
          <code class="ruby">              values = r.select { |i| i }</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="156">
          <span class="hits">6</span>
          
          <code class="ruby">              kvs[:KVHitCount] = values.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">            when :hmget</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="159">
          <span class="hits">3</span>
          
          <code class="ruby">              kvs[:KVKeyCount] = command.count - 2</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="160">
          <span class="hits">15</span>
          
          <code class="ruby">              values = r.select { |i| i }</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="161">
          <span class="hits">3</span>
          
          <code class="ruby">              kvs[:KVHitCount] = values.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">            when :mset, :msetnx</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="164">
          <span class="hits">9</span>
          
          <code class="ruby">              if command[1].is_a?(Array)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="165">
          <span class="hits">6</span>
          
          <code class="ruby">                kvs[:KVKeyCount] = command[1].count / 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="167">
          <span class="hits">3</span>
          
          <code class="ruby">                kvs[:KVKeyCount] = (command.count - 1) / 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">            end # case op</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">          end # if KV_COLLECT_MAP[op]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;Error collecting redis KVs: #{e.message}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug e.backtrace.join(&#39;\n&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="391" data-linenumber="175">
          <span class="hits">391</span>
          
          <code class="ruby">          return kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">        # Extracts the Key/Values to report from a pipelined</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">        # call to the AppOptics dashboard.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">        # @param pipeline [Redis::Pipeline] the Redis pipeline instance</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">        # @return [Hash] the Key/Values to report</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="183">
          <span class="hits">28</span>
          
          <code class="ruby">        def extract_pipeline_details(pipeline)</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="184">
          <span class="hits">49</span>
          
          <code class="ruby">          kvs = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="186">
          <span class="hits">49</span>
          
          <code class="ruby">          kvs[:RemoteHost] = @options[:host]</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="187">
          <span class="hits">49</span>
          
          <code class="ruby">          kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:redis][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="189">
          <span class="hits">49</span>
          
          <code class="ruby">          command_count = pipeline.commands.count</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="190">
          <span class="hits">49</span>
          
          <code class="ruby">          kvs[:KVOpCount] = command_count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="192">
          <span class="hits">49</span>
          
          <code class="ruby">          kvs[:KVOp] = if pipeline.commands.first == :multi</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">            :multi</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="195">
          <span class="hits">49</span>
          
          <code class="ruby">            :pipeline</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">          # Report pipelined operations  if the number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">          # of ops is reasonable</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="200">
          <span class="hits">49</span>
          
          <code class="ruby">          if command_count &lt; 12</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="201">
          <span class="hits">49</span>
          
          <code class="ruby">            ops = []</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="202">
          <span class="hits">49</span>
          
          <code class="ruby">            pipeline.commands.each do |c|</code>
        </li>
      
        <li class="covered" data-hits="184" data-linenumber="203">
          <span class="hits">184</span>
          
          <code class="ruby">              ops &lt;&lt; c.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="205">
          <span class="hits">49</span>
          
          <code class="ruby">            kvs[:KVOps] = ops.join(&#39;, &#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">        rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] Error extracting pipelined commands: #{e.message}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug e.backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="211">
          <span class="hits">49</span>
          
          <code class="ruby">          return kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">        # The wrapper method for Redis::Client.call.  Here</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">        # (when tracing) we capture KVs to report and pass</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">        # the call along</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="219">
          <span class="hits">28</span>
          
          <code class="ruby">        def call_with_appoptics(command, &amp;block)</code>
        </li>
      
        <li class="covered" data-hits="1766" data-linenumber="220">
          <span class="hits">1766</span>
          
          <code class="ruby">          if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="391" data-linenumber="221">
          <span class="hits">391</span>
          
          <code class="ruby">            ::AppOpticsAPM::API.log_entry(:redis, {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="391" data-linenumber="223">
          <span class="hits">391</span>
          
          <code class="ruby">            begin</code>
        </li>
      
        <li class="covered" data-hits="391" data-linenumber="224">
          <span class="hits">391</span>
          
          <code class="ruby">              r = call_without_appoptics(command, &amp;block)</code>
        </li>
      
        <li class="covered" data-hits="391" data-linenumber="225">
          <span class="hits">391</span>
          
          <code class="ruby">              report_kvs = extract_trace_details(command, r)</code>
        </li>
      
        <li class="covered" data-hits="391" data-linenumber="226">
          <span class="hits">391</span>
          
          <code class="ruby">              r</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">            rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">              ::AppOpticsAPM::API.log_exception(:redis, e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">              raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">            ensure</code>
        </li>
      
        <li class="covered" data-hits="391" data-linenumber="231">
          <span class="hits">391</span>
          
          <code class="ruby">              ::AppOpticsAPM::API.log_exit(:redis, report_kvs)</code>
        </li>
      
        <li class="covered" data-hits="260" data-linenumber="232">
          <span class="hits">260</span>
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="1375" data-linenumber="235">
          <span class="hits">1375</span>
          
          <code class="ruby">            call_without_appoptics(command, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">        # The wrapper method for Redis::Client.call_pipeline.  Here</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">        # (when tracing) we capture KVs to report and pass the call along</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="243">
          <span class="hits">28</span>
          
          <code class="ruby">        def call_pipeline_with_appoptics(pipeline)</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="244">
          <span class="hits">67</span>
          
          <code class="ruby">          if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">            # Fall back to the raw tracing API so we can pass KVs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">            # back on exit (a limitation of the AppOpticsAPM::API.trace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">            # block method)  This removes the need for an info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">            # event to send additonal KVs</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="249">
          <span class="hits">49</span>
          
          <code class="ruby">            ::AppOpticsAPM::API.log_entry(:redis, {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="251">
          <span class="hits">49</span>
          
          <code class="ruby">            report_kvs = extract_pipeline_details(pipeline)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="253">
          <span class="hits">49</span>
          
          <code class="ruby">            begin</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="254">
          <span class="hits">49</span>
          
          <code class="ruby">              call_pipeline_without_appoptics(pipeline)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">            rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">              ::AppOpticsAPM::API.log_exception(:redis, e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">              raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">            ensure</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="259">
          <span class="hits">49</span>
          
          <code class="ruby">              ::AppOpticsAPM::API.log_exit(:redis, report_kvs)</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="260">
          <span class="hits">33</span>
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="262">
          <span class="hits">18</span>
          
          <code class="ruby">            call_pipeline_without_appoptics(pipeline)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="270">
          <span class="hits">28</span>
          
          <code class="ruby">if AppOpticsAPM::Config[:redis][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="271">
          <span class="hits">28</span>
          
          <code class="ruby">  if defined?(::Redis) &amp;&amp; Gem::Version.new(::Redis::VERSION) &gt;= Gem::Version.new(&#39;3.0.0&#39;)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="272">
          <span class="hits">16</span>
          
          <code class="ruby">    AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting redis&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="273">
          <span class="hits">16</span>
          
          <code class="ruby">    ::AppOpticsAPM::Util.send_include(::Redis::Client, ::AppOpticsAPM::Inst::Redis::Client)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ef0b992ac72f7add994a0169bb585e59c180fc2d">
  <div class="header">
    <h3>lib/appoptics_apm/inst/resque.rb</h3>
    <h4><span class="red">63.75 %</span> covered</h4>
    <div>
      <b>80</b> relevant lines. 
      <span class="green"><b>51</b> lines covered</span> and
      <span class="red"><b>29</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">require &#39;socket&#39;</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">require &#39;json&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="8">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="9">
          <span class="hits">28</span>
          
          <code class="ruby">    module ResqueClient</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="10">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="11">
          <span class="hits">3</span>
          
          <code class="ruby">        klass.send :extend, ::Resque</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="12">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :enqueue, ::Resque)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="13">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :enqueue_to, ::Resque)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="14">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :dequeue, ::Resque)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="17">
          <span class="hits">28</span>
          
          <code class="ruby">      def extract_trace_details(op, klass, args)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="18">
          <span class="hits">18</span>
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="20">
          <span class="hits">18</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="21">
          <span class="hits">18</span>
          
          <code class="ruby">          report_kvs[:Spec] = :pushq</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="22">
          <span class="hits">18</span>
          
          <code class="ruby">          report_kvs[:Flavor] = :resque</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="23">
          <span class="hits">18</span>
          
          <code class="ruby">          report_kvs[:JobName] = klass.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="25">
          <span class="hits">18</span>
          
          <code class="ruby">          if AppOpticsAPM::Config[:resqueclient][:log_args]</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="26">
          <span class="hits">15</span>
          
          <code class="ruby">            kv_args = args.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">            # Limit the argument json string to 1024 bytes</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="29">
          <span class="hits">15</span>
          
          <code class="ruby">            if kv_args.length &gt; 1024</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">              report_kvs[:Args] = kv_args[0..1023] + &#39;...[snipped]&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="32">
          <span class="hits">15</span>
          
          <code class="ruby">              report_kvs[:Args] = kv_args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="35">
          <span class="hits">18</span>
          
          <code class="ruby">          report_kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:resqueclient][:collect_backtraces]</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="36">
          <span class="hits">18</span>
          
          <code class="ruby">          report_kvs[:Queue] = klass.instance_variable_get(:@queue)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="41">
          <span class="hits">18</span>
          
          <code class="ruby">        report_kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="44">
          <span class="hits">28</span>
          
          <code class="ruby">      def enqueue_with_appoptics(klass, *args)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="45">
          <span class="hits">18</span>
          
          <code class="ruby">        if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="46">
          <span class="hits">15</span>
          
          <code class="ruby">          report_kvs = extract_trace_details(:enqueue, klass, args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="48">
          <span class="hits">15</span>
          
          <code class="ruby">          AppOpticsAPM::API.trace(:&#39;resque-client&#39;, report_kvs, :enqueue) do</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="49">
          <span class="hits">15</span>
          
          <code class="ruby">            enqueue_without_appoptics(klass, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="52">
          <span class="hits">3</span>
          
          <code class="ruby">          enqueue_without_appoptics(klass, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="56">
          <span class="hits">28</span>
          
          <code class="ruby">      def enqueue_to_with_appoptics(queue, klass, *args)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="57">
          <span class="hits">18</span>
          
          <code class="ruby">        if AppOpticsAPM.tracing? &amp;&amp; !AppOpticsAPM.tracing_layer_op?(:enqueue)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">          report_kvs = extract_trace_details(:enqueue_to, klass, args)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">          report_kvs[:Queue] = queue.to_s if queue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">          AppOpticsAPM::API.trace(:&#39;resque-client&#39;, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">            enqueue_to_without_appoptics(queue, klass, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="65">
          <span class="hits">18</span>
          
          <code class="ruby">          enqueue_to_without_appoptics(queue, klass, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="69">
          <span class="hits">28</span>
          
          <code class="ruby">      def dequeue_with_appoptics(klass, *args)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="70">
          <span class="hits">3</span>
          
          <code class="ruby">        if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="71">
          <span class="hits">3</span>
          
          <code class="ruby">          report_kvs = extract_trace_details(:dequeue, klass, args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="73">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM::API.trace(:&#39;resque-client&#39;, report_kvs) do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="74">
          <span class="hits">3</span>
          
          <code class="ruby">            dequeue_without_appoptics(klass, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">          dequeue_without_appoptics(klass, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="82">
          <span class="hits">28</span>
          
          <code class="ruby">    module ResqueWorker</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="83">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="84">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :perform, ::Resque::Worker)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="87">
          <span class="hits">28</span>
          
          <code class="ruby">      def perform_with_appoptics(job)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">          report_kvs[:Spec] = :job</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">          report_kvs[:Flavor] = :resque</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">          report_kvs[:JobName] = job.payload[&#39;class&#39;].to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">          report_kvs[:Queue] = job.queue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">          # Set these keys for the ability to separate out</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">          # background tasks into a separate app on the server-side UI</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">          report_kvs[:&#39;HTTP-Host&#39;] = Socket.gethostname</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">          report_kvs[:Controller] = &quot;Resque_#{job.queue}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">          report_kvs[:Action] = job.payload[&#39;class&#39;].to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">          report_kvs[:URL] = &quot;/resque/#{job.queue}/#{job.payload[&#39;class&#39;]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">          if AppOpticsAPM::Config[:resqueworker][:log_args]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">            kv_args = job.payload[&#39;args&#39;].to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">            # Limit the argument json string to 1024 bytes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">            if kv_args.length &gt; 1024</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">              report_kvs[:Args] = kv_args[0..1023] + &#39;...[snipped]&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">              report_kvs[:Args] = kv_args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">          report_kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:resqueworker][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">        AppOpticsAPM::API.start_trace(:&#39;resque-worker&#39;, nil, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">          perform_without_appoptics(job)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="126">
          <span class="hits">28</span>
          
          <code class="ruby">    module ResqueJob</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="127">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="128">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :fail, ::Resque::Job)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="131">
          <span class="hits">28</span>
          
          <code class="ruby">      def fail_with_appoptics(exception)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">        if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(:resque, exception)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">        fail_without_appoptics(exception)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="141">
          <span class="hits">28</span>
          
          <code class="ruby">if defined?(::Resque)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="142">
          <span class="hits">3</span>
          
          <code class="ruby">  AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting resque&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="144">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_include(::Resque,         ::AppOpticsAPM::Inst::ResqueClient) if AppOpticsAPM::Config[:resqueclient][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="145">
          <span class="hits">3</span>
          
          <code class="ruby">  ::AppOpticsAPM::Util.send_include(::Resque::Worker, ::AppOpticsAPM::Inst::ResqueWorker) if AppOpticsAPM::Config[:resqueworker][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="146">
          <span class="hits">3</span>
          
          <code class="ruby">  if AppOpticsAPM::Config[:resqueclient][:enabled] || AppOpticsAPM::Config[:resqueworker][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="147">
          <span class="hits">3</span>
          
          <code class="ruby">    ::AppOpticsAPM::Util.send_include(::Resque::Job,    ::AppOpticsAPM::Inst::ResqueJob)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3a7171132a5d77b2f2e34a039cc752a4aecfe04b">
  <div class="header">
    <h3>lib/appoptics_apm/inst/rest-client.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>26</b> relevant lines. 
      <span class="green"><b>26</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    module RestClientRequest</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="8">
          <span class="hits">9</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :execute, ::RestClient::Request)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      # execute_with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      # The wrapper method for RestClient::Request.execute</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="16">
          <span class="hits">28</span>
          
          <code class="ruby">      def execute_with_appoptics(&amp;block)</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="17">
          <span class="hits">63</span>
          
          <code class="ruby">        blacklisted = AppOpticsAPM::API.blacklisted?(url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="19">
          <span class="hits">63</span>
          
          <code class="ruby">        unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="20">
          <span class="hits">18</span>
          
          <code class="ruby">          xtrace = AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="21">
          <span class="hits">18</span>
          
          <code class="ruby">          @processed_headers[&#39;X-Trace&#39;] = AppOpticsAPM::Context.toString if AppOpticsAPM::XTrace.valid?(xtrace) &amp;&amp; !blacklisted</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="22">
          <span class="hits">18</span>
          
          <code class="ruby">          return execute_without_appoptics(&amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="25">
          <span class="hits">45</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="26">
          <span class="hits">45</span>
          
          <code class="ruby">          kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="27">
          <span class="hits">45</span>
          
          <code class="ruby">          kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:rest_client][:collect_backtraces]</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="28">
          <span class="hits">45</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(&#39;rest-client&#39;, kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="30">
          <span class="hits">45</span>
          
          <code class="ruby">          @processed_headers[&#39;X-Trace&#39;] = AppOpticsAPM::Context.toString unless blacklisted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">          # The core rest-client call</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="33">
          <span class="hits">45</span>
          
          <code class="ruby">          execute_without_appoptics(&amp;block)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="34">
          <span class="hits">3</span>
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="35">
          <span class="hits">3</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(&#39;rest-client&#39;, e)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="36">
          <span class="hits">3</span>
          
          <code class="ruby">          raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="38">
          <span class="hits">45</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exit(&#39;rest-client&#39;)</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="39">
          <span class="hits">30</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="45">
          <span class="hits">28</span>
          
          <code class="ruby">if AppOpticsAPM::Config[:rest_client][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="46">
          <span class="hits">28</span>
          
          <code class="ruby">  if defined?(::RestClient)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="47">
          <span class="hits">9</span>
          
          <code class="ruby">    AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting rest-client&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="48">
          <span class="hits">9</span>
          
          <code class="ruby">    ::AppOpticsAPM::Util.send_include(::RestClient::Request, ::AppOpticsAPM::Inst::RestClientRequest)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b5813e6e5fe63f5bc4021d67ad852971a93e0283">
  <div class="header">
    <h3>lib/appoptics_apm/inst/sequel.rb</h3>
    <h4><span class="green">91.46 %</span> covered</h4>
    <div>
      <b>82</b> relevant lines. 
      <span class="green"><b>75</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    # AppOpticsAPM::Inst::Sequel</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # The common (shared) methods used by the AppOpticsAPM Sequel instrumentation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    # across multiple modules/classes.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="12">
          <span class="hits">28</span>
          
          <code class="ruby">    module Sequel</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      # extract_trace_details</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      # Given SQL and the options hash, this method extracts the interesting</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      # bits for reporting to the AppOptics dashboard.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="19">
          <span class="hits">28</span>
          
          <code class="ruby">      def extract_trace_details(sql, opts)</code>
        </li>
      
        <li class="covered" data-hits="105" data-linenumber="20">
          <span class="hits">105</span>
          
          <code class="ruby">        kvs = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="105" data-linenumber="22">
          <span class="hits">105</span>
          
          <code class="ruby">        if !sql.is_a?(String)</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="23">
          <span class="hits">20</span>
          
          <code class="ruby">          kvs[:IsPreparedStatement] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="105" data-linenumber="26">
          <span class="hits">105</span>
          
          <code class="ruby">        if ::Sequel::VERSION &gt; &#39;4.36.0&#39; &amp;&amp; !sql.is_a?(String)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">          # In 4.37.0, sql was converted to a prepared statement object</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="28">
          <span class="hits">20</span>
          
          <code class="ruby">          sql = sql.prepared_sql unless sql.is_a?(Symbol)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="105" data-linenumber="31">
          <span class="hits">105</span>
          
          <code class="ruby">        if AppOpticsAPM::Config[:sanitize_sql]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">          # Sanitize SQL and don&#39;t report binds</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="33">
          <span class="hits">30</span>
          
          <code class="ruby">          if sql.is_a?(Symbol)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="34">
          <span class="hits">4</span>
          
          <code class="ruby">            kvs[:Query] = sql</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="36">
          <span class="hits">26</span>
          
          <code class="ruby">            kvs[:Query] = AppOpticsAPM::Util.sanitize_sql(sql)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">          # Report raw SQL and any binds if they exist</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="40">
          <span class="hits">75</span>
          
          <code class="ruby">          kvs[:Query] = sql.to_s</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="41">
          <span class="hits">75</span>
          
          <code class="ruby">          kvs[:QueryArgs] = opts[:arguments] if opts.is_a?(Hash) &amp;&amp; opts.key?(:arguments)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="105" data-linenumber="44">
          <span class="hits">105</span>
          
          <code class="ruby">        kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:sequel][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="105" data-linenumber="46">
          <span class="hits">105</span>
          
          <code class="ruby">        if ::Sequel::VERSION &lt; &#39;3.41.0&#39; &amp;&amp; !(self.class.to_s =~ /Dataset$/)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">          db_opts = @opts</code>
        </li>
      
        <li class="covered" data-hits="105" data-linenumber="48">
          <span class="hits">105</span>
          
          <code class="ruby">        elsif @pool</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="49">
          <span class="hits">49</span>
          
          <code class="ruby">          db_opts = @pool.db.opts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="56" data-linenumber="51">
          <span class="hits">56</span>
          
          <code class="ruby">          db_opts = @db.opts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="105" data-linenumber="54">
          <span class="hits">105</span>
          
          <code class="ruby">        kvs[:Database]   = db_opts[:database]</code>
        </li>
      
        <li class="covered" data-hits="105" data-linenumber="55">
          <span class="hits">105</span>
          
          <code class="ruby">        kvs[:RemoteHost] = db_opts[:host]</code>
        </li>
      
        <li class="covered" data-hits="105" data-linenumber="56">
          <span class="hits">105</span>
          
          <code class="ruby">        kvs[:RemotePort] = db_opts[:port] if db_opts.key?(:port)</code>
        </li>
      
        <li class="covered" data-hits="105" data-linenumber="57">
          <span class="hits">105</span>
          
          <code class="ruby">        kvs[:Flavor]     = db_opts[:adapter]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug Error capturing Sequel KVs: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      ensure</code>
        </li>
      
        <li class="covered" data-hits="105" data-linenumber="61">
          <span class="hits">105</span>
          
          <code class="ruby">        return kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      # exec_with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      # This method wraps and routes the call to the specified</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      # original method call</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="70">
          <span class="hits">28</span>
          
          <code class="ruby">      def exec_with_appoptics(method, sql, opts = ::Sequel::OPTS, &amp;block)</code>
        </li>
      
        <li class="covered" data-hits="143" data-linenumber="71">
          <span class="hits">143</span>
          
          <code class="ruby">        if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="70" data-linenumber="72">
          <span class="hits">70</span>
          
          <code class="ruby">          kvs = extract_trace_details(sql, opts)</code>
        </li>
      
        <li class="covered" data-hits="70" data-linenumber="73">
          <span class="hits">70</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(:sequel, kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="143" data-linenumber="76">
          <span class="hits">143</span>
          
          <code class="ruby">        send(method, sql, opts, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="78">
          <span class="hits">4</span>
          
          <code class="ruby">        AppOpticsAPM::API.log_exception(:sequel, e)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="79">
          <span class="hits">4</span>
          
          <code class="ruby">        raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      ensure</code>
        </li>
      
        <li class="covered" data-hits="143" data-linenumber="81">
          <span class="hits">143</span>
          
          <code class="ruby">        AppOpticsAPM::API.log_exit(:sequel)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="85">
          <span class="hits">28</span>
          
          <code class="ruby">    module SequelDatabase</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="86">
          <span class="hits">28</span>
          
          <code class="ruby">      include AppOpticsAPM::Inst::Sequel</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="88">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="89">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :run, ::Sequel::Database)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="90">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :execute_ddl, ::Sequel::Database)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="91">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :execute_dui, ::Sequel::Database)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="92">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :execute_insert, ::Sequel::Database)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="95">
          <span class="hits">28</span>
          
          <code class="ruby">      def run_with_appoptics(sql, opts = ::Sequel::OPTS)</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="96">
          <span class="hits">35</span>
          
          <code class="ruby">        if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="97">
          <span class="hits">35</span>
          
          <code class="ruby">          kvs = extract_trace_details(sql, opts)</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="98">
          <span class="hits">35</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(:sequel, kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="101">
          <span class="hits">35</span>
          
          <code class="ruby">        run_without_appoptics(sql, opts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="103">
          <span class="hits">7</span>
          
          <code class="ruby">        AppOpticsAPM::API.log_exception(:sequel, e)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="104">
          <span class="hits">7</span>
          
          <code class="ruby">        raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">      ensure</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="106">
          <span class="hits">35</span>
          
          <code class="ruby">        AppOpticsAPM::API.log_exit(:sequel)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="109">
          <span class="hits">28</span>
          
          <code class="ruby">      def execute_ddl_with_appoptics(sql, opts = ::Sequel::OPTS, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">        # If we&#39;re already tracing a sequel operation, then this call likely came</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        # from Sequel::Dataset.  In this case, just pass it on.</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="112">
          <span class="hits">63</span>
          
          <code class="ruby">        return execute_ddl_without_appoptics(sql, opts, &amp;block) if AppOpticsAPM.tracing_layer?(:sequel)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="114">
          <span class="hits">28</span>
          
          <code class="ruby">        exec_with_appoptics(:execute_ddl_without_appoptics, sql, opts, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="117">
          <span class="hits">28</span>
          
          <code class="ruby">      def execute_dui_with_appoptics(sql, opts = ::Sequel::OPTS, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        # If we&#39;re already tracing a sequel operation, then this call likely came</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">        # from Sequel::Dataset.  In this case, just pass it on.</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="120">
          <span class="hits">30</span>
          
          <code class="ruby">        return execute_dui_without_appoptics(sql, opts, &amp;block) if AppOpticsAPM.tracing_layer?(:sequel)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="122">
          <span class="hits">6</span>
          
          <code class="ruby">        exec_with_appoptics(:execute_dui_without_appoptics, sql, opts, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="125">
          <span class="hits">28</span>
          
          <code class="ruby">      def execute_insert_with_appoptics(sql, opts = ::Sequel::OPTS, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">        # If we&#39;re already tracing a sequel operation, then this call likely came</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        # from Sequel::Dataset.  In this case, just pass it on.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">        return execute_insert_without_appoptics(sql, opts, &amp;block) if AppOpticsAPM.tracing_layer?(:sequel)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">        exec_with_appoptics(:execute_insert_without_appoptics, sql, opts, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">    end # module SequelDatabase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="134">
          <span class="hits">28</span>
          
          <code class="ruby">    module SequelDataset</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="135">
          <span class="hits">28</span>
          
          <code class="ruby">      include AppOpticsAPM::Inst::Sequel</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="137">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="138">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :execute, ::Sequel::Dataset)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="139">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :execute_ddl, ::Sequel::Dataset)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="140">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :execute_dui, ::Sequel::Dataset)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="141">
          <span class="hits">3</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :execute_insert, ::Sequel::Dataset)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="144">
          <span class="hits">28</span>
          
          <code class="ruby">      def execute_with_appoptics(sql, opts = ::Sequel::OPTS, &amp;block)</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="145">
          <span class="hits">94</span>
          
          <code class="ruby">        exec_with_appoptics(:execute_without_appoptics, sql, opts, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="148">
          <span class="hits">28</span>
          
          <code class="ruby">      def execute_ddl_with_appoptics(sql, opts = ::Sequel::OPTS, &amp;block)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">        exec_with_appoptics(:execute_ddl_without_appoptics, sql, opts, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="152">
          <span class="hits">28</span>
          
          <code class="ruby">      def execute_dui_with_appoptics(sql, opts = ::Sequel::OPTS, &amp;block)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="153">
          <span class="hits">7</span>
          
          <code class="ruby">        exec_with_appoptics(:execute_dui_without_appoptics, sql, opts, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="156">
          <span class="hits">28</span>
          
          <code class="ruby">      def execute_insert_with_appoptics(sql, opts = ::Sequel::OPTS, &amp;block)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="157">
          <span class="hits">8</span>
          
          <code class="ruby">        exec_with_appoptics(:execute_insert_without_appoptics, sql, opts, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">    end # module SequelDataset</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">  end # module Inst</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">end # module AppOpticsAPM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="164">
          <span class="hits">28</span>
          
          <code class="ruby">if AppOpticsAPM::Config[:sequel][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="165">
          <span class="hits">28</span>
          
          <code class="ruby">  if defined?(::Sequel) &amp;&amp; ::Sequel::VERSION &lt; &#39;4.0.0&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">    # For versions before 4.0.0, Sequel::OPTS wasn&#39;t defined.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    # Define it as an empty hash for backwards compatibility.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">    module ::Sequel</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">      OPTS = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="173">
          <span class="hits">28</span>
          
          <code class="ruby">  if defined?(::Sequel)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="174">
          <span class="hits">3</span>
          
          <code class="ruby">    AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting sequel&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="175">
          <span class="hits">3</span>
          
          <code class="ruby">    ::AppOpticsAPM::Util.send_include(::Sequel::Database, ::AppOpticsAPM::Inst::SequelDatabase)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="176">
          <span class="hits">3</span>
          
          <code class="ruby">    ::AppOpticsAPM::Util.send_include(::Sequel::Dataset, ::AppOpticsAPM::Inst::SequelDataset)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="069e2ff3df1de81c27c1a1cc8fa29f11bbfc27ff">
  <div class="header">
    <h3>lib/appoptics_apm/inst/sidekiq-client.rb</h3>
    <h4><span class="green">90.32 %</span> covered</h4>
    <div>
      <b>31</b> relevant lines. 
      <span class="green"><b>28</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  class SidekiqClient</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    def collect_kvs(args)</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">        # Attempt to collect up pertinent info.  If we hit something unexpected,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">        # keep calm and instrument on.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="11">
          <span class="hits">28</span>
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="12">
          <span class="hits">28</span>
          
          <code class="ruby">        worker_class, msg, queue, _ = args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="14">
          <span class="hits">28</span>
          
          <code class="ruby">        report_kvs[:Spec]      = :pushq</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="15">
          <span class="hits">28</span>
          
          <code class="ruby">        report_kvs[:Flavor]    = :sidekiq</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="16">
          <span class="hits">28</span>
          
          <code class="ruby">        report_kvs[:Queue]     = queue</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="17">
          <span class="hits">28</span>
          
          <code class="ruby">        report_kvs[:Retry]     = msg[&#39;retry&#39;]</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="18">
          <span class="hits">28</span>
          
          <code class="ruby">        report_kvs[:JobName]   = msg[&#39;wrapped&#39;] || worker_class</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="19">
          <span class="hits">28</span>
          
          <code class="ruby">        report_kvs[:MsgID]     = msg[&#39;jid&#39;]</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="20">
          <span class="hits">28</span>
          
          <code class="ruby">        report_kvs[:Args]      = msg[&#39;args&#39;].to_s[0..1024] if AppOpticsAPM::Config[:sidekiqclient][:log_args]</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="21">
          <span class="hits">28</span>
          
          <code class="ruby">        report_kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:sidekiqclient][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;[appoptics_apm/sidekiq] Non-fatal error capturing KVs: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="25">
          <span class="hits">28</span>
          
          <code class="ruby">      report_kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="28">
          <span class="hits">28</span>
          
          <code class="ruby">    def call(*args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      # args: 0: worker_class, 1: msg, 2: queue, 3: redis_pool</code>
        </li>
      
        <li class="covered" data-hits="43" data-linenumber="30">
          <span class="hits">43</span>
          
          <code class="ruby">      if AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="31">
          <span class="hits">28</span>
          
          <code class="ruby">        report_kvs = collect_kvs(args)</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="32">
          <span class="hits">28</span>
          
          <code class="ruby">        AppOpticsAPM::API.log_entry(:&#39;sidekiq-client&#39;, report_kvs)</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="33">
          <span class="hits">28</span>
          
          <code class="ruby">        args[1][&#39;SourceTrace&#39;] = AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="43" data-linenumber="36">
          <span class="hits">43</span>
          
          <code class="ruby">      result = yield</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      AppOpticsAPM::API.log_exception(:&#39;sidekiq-client&#39;, e, { :JobID =&gt; result[&#39;jid&#39;] })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    ensure</code>
        </li>
      
        <li class="covered" data-hits="43" data-linenumber="41">
          <span class="hits">43</span>
          
          <code class="ruby">      AppOpticsAPM::API.log_exit(:&#39;sidekiq-client&#39;, { :JobID =&gt; result[&#39;jid&#39;] })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="46">
          <span class="hits">28</span>
          
          <code class="ruby">if defined?(::Sidekiq) &amp;&amp; AppOpticsAPM::Config[:sidekiqclient][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="47">
          <span class="hits">16</span>
          
          <code class="ruby">  ::AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting sidekiq client&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="49">
          <span class="hits">16</span>
          
          <code class="ruby">  ::Sidekiq.configure_client do |config|</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="50">
          <span class="hits">16</span>
          
          <code class="ruby">    config.client_middleware do |chain|</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="51">
          <span class="hits">16</span>
          
          <code class="ruby">      ::AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Adding Sidekiq client middleware&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="52">
          <span class="hits">16</span>
          
          <code class="ruby">      chain.add ::AppOpticsAPM::SidekiqClient</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7f8211a94b222c1b1276532c97dcbc07048aad2b">
  <div class="header">
    <h3>lib/appoptics_apm/inst/sidekiq-worker.rb</h3>
    <h4><span class="red">20.59 %</span> covered</h4>
    <div>
      <b>34</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>27</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  class SidekiqWorker</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    def collect_kvs(args)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">        # Attempt to collect up pertinent info.  If we hit something unexpected,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">        # keep calm and instrument on.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">        worker, msg, queue = args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">        # Background Job Spec KVs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">        report_kvs[:Spec]       = :job</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">        report_kvs[:Flavor]     = :sidekiq</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">        report_kvs[:Queue]      = queue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">        report_kvs[:Retry]      = msg[&#39;retry&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        report_kvs[:JobName]    = msg[&#39;wrapped&#39;] || msg[&#39;class&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        report_kvs[:MsgID]      = msg[&#39;jid&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        report_kvs[:Args]       = msg[&#39;args&#39;].to_s[0..1024] if AppOpticsAPM::Config[:sidekiqworker][:log_args]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">        report_kvs[:Backtrace]  = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:sidekiqworker][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        # Webserver Spec KVs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        report_kvs[:&#39;HTTP-Host&#39;] = Socket.gethostname</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">        report_kvs[:Controller] = &quot;Sidekiq_#{queue}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        report_kvs[:Action] = msg[&#39;wrapped&#39;] || msg[&#39;class&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        report_kvs[:URL] = &quot;/sidekiq/#{queue}/#{msg[&#39;wrapped&#39;] || msg[&#39;class&#39;]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;[appoptics_apm/sidekiq] Non-fatal error capturing KVs: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      report_kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="34">
          <span class="hits">28</span>
          
          <code class="ruby">    def call(*args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      # args: 0: worker, 1: msg, 2: queue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      report_kvs = collect_kvs(args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      # Something is happening across Celluloid threads where liboboe settings</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      # are being lost.  So we re-set the tracing mode to assure</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      # we sample as desired.  Setting the tracing mode will re-update</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      # the liboboe settings.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      AppOpticsAPM::Config[:tracing_mode] = AppOpticsAPM::Config[:tracing_mode]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      # Continue the trace from the enqueue side?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      if args[1].is_a?(Hash) &amp;&amp; AppOpticsAPM::XTrace.valid?(args[1][&#39;SourceTrace&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">        report_kvs[:SourceTrace] = args[1][&#39;SourceTrace&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">      result = AppOpticsAPM::API.start_trace(:&#39;sidekiq-worker&#39;, nil, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        yield</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      result[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="58">
          <span class="hits">28</span>
          
          <code class="ruby">if defined?(::Sidekiq) &amp;&amp; AppOpticsAPM::Config[:sidekiqworker][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="59">
          <span class="hits">16</span>
          
          <code class="ruby">  ::AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting sidekiq worker&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="61">
          <span class="hits">16</span>
          
          <code class="ruby">  ::Sidekiq.configure_server do |config|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    config.server_middleware do |chain|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      ::AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Adding Sidekiq worker middleware&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">      chain.add ::AppOpticsAPM::SidekiqWorker</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="603bb127c894515581ae7c6f2769b390d6c86054">
  <div class="header">
    <h3>lib/appoptics_apm/inst/twitter-cassandra.rb</h3>
    <h4><span class="red">21.77 %</span> covered</h4>
    <div>
      <b>147</b> relevant lines. 
      <span class="green"><b>32</b> lines covered</span> and
      <span class="red"><b>115</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    module Cassandra</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="7">
          <span class="hits">28</span>
          
          <code class="ruby">      def extract_trace_details(op, column_family, keys, args, options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">        report_kvs = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">          report_kvs[:Op] = op.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">          report_kvs[:Cf] = column_family.to_s if column_family</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">          report_kvs[:Key] = keys.inspect if keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">          # Open issue - how to handle multiple Cassandra servers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">          report_kvs[:RemoteHost], report_kvs[:RemotePort] = @servers.first.split(&#39;:&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">          report_kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:cassandra][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">          if options.empty? &amp;&amp; args.is_a?(Array)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">            options = args.last if args.last.is_a?(Hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">          unless options.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">            [:start_key, :finish_key, :key_count, :batch_size, :columns, :count, :start,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">             :stop, :finish, :finished, :reversed, :consistency, :ttl].each do |k|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">              report_kvs[k.to_s.capitalize] = options[k] if options.key?(k)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">            if op == :get_indexed_slices</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">              index_clause = columns_and_options[:index_clause] || {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">              unless index_clause.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">                [:column_name, :value, :comparison].each do |k|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">                  report_kvs[k.to_s.capitalize] = index_clause[k] if index_clause.key?(k)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        report_kvs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="46">
          <span class="hits">28</span>
          
          <code class="ruby">      def insert_with_appoptics(column_family, key, hash, options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        return insert_without_appoptics(column_family, key, hash, options = {}) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">        report_kvs = extract_trace_details(:insert, column_family, key, hash, options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">        AppOpticsAPM::API.trace(:cassandra, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">          insert_without_appoptics(column_family, key, hash, options = {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="56">
          <span class="hits">28</span>
          
          <code class="ruby">      def remove_with_appoptics(column_family, key, *columns_and_options)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        args = [column_family, key] + columns_and_options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        return send :remove_without_appoptics, *args unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        report_kvs = extract_trace_details(:remove, column_family, key, columns_and_options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        AppOpticsAPM::API.trace(:cassandra, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">          send :remove_without_appoptics, *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="68">
          <span class="hits">28</span>
          
          <code class="ruby">      def count_columns_with_appoptics(column_family, key, *columns_and_options)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">        args = [column_family, key] + columns_and_options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        return send :count_columns_without_appoptics, *args unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        report_kvs = extract_trace_details(:count_columns, column_family, key, columns_and_options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">        AppOpticsAPM::API.trace(:cassandra, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">          send :count_columns_without_appoptics, *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="80">
          <span class="hits">28</span>
          
          <code class="ruby">      def get_columns_with_appoptics(column_family, key, *columns_and_options)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">        args = [column_family, key] + columns_and_options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">        if AppOpticsAPM.tracing? &amp;&amp; !AppOpticsAPM.tracing_layer_op?(:multi_get_columns)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">          report_kvs = extract_trace_details(:get_columns, column_family, key, columns_and_options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">          AppOpticsAPM::API.trace(:cassandra, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">            send :get_columns_without_appoptics, *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">          send :get_columns_without_appoptics, *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="94">
          <span class="hits">28</span>
          
          <code class="ruby">      def multi_get_columns_with_appoptics(column_family, key, *columns_and_options)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">        args = [column_family, key] + columns_and_options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        return send :multi_get_columns_without_appoptics, *args unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        report_kvs = extract_trace_details(:multi_get_columns, column_family, key, columns_and_options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        AppOpticsAPM::API.trace(:cassandra, report_kvs, :multi_get_columns) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">          send :multi_get_columns_without_appoptics, *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="106">
          <span class="hits">28</span>
          
          <code class="ruby">      def get_with_appoptics(column_family, key, *columns_and_options)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">        args = [column_family, key] + columns_and_options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        return send :get_without_appoptics, *args unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">        report_kvs = extract_trace_details(:get, column_family, key, columns_and_options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">        AppOpticsAPM::API.trace(:cassandra, report_kvs, :get) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">          send :get_without_appoptics, *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="118">
          <span class="hits">28</span>
          
          <code class="ruby">      def multi_get_with_appoptics(column_family, key, *columns_and_options)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">        args = [column_family, key] + columns_and_options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">        if AppOpticsAPM.tracing? &amp;&amp; !AppOpticsAPM.tracing_layer_op?(:get)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">          report_kvs = extract_trace_details(:multi_get, column_family, key, columns_and_options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">          AppOpticsAPM::API.trace(:cassandra, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">            send :multi_get_without_appoptics, *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">          send :multi_get_without_appoptics, *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="132">
          <span class="hits">28</span>
          
          <code class="ruby">      def exists_with_appoptics?(column_family, key, *columns_and_options)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">        args = [column_family, key] + columns_and_options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">        return send :exists_without_appoptics?, *args unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">        report_kvs = extract_trace_details(:exists?, column_family, key, columns_and_options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">        AppOpticsAPM::API.trace(:cassandra, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">          send :exists_without_appoptics?, *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="144">
          <span class="hits">28</span>
          
          <code class="ruby">      def get_range_single_with_appoptics(column_family, options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">        if AppOpticsAPM.tracing? &amp;&amp; !AppOpticsAPM.tracing_layer_op?(:get_range_batch)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">          report_kvs = extract_trace_details(:get_range_single, column_family, nil, nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">          AppOpticsAPM::API.trace(:cassandra, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">            get_range_single_without_appoptics(column_family, options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">          get_range_single_without_appoptics(column_family, options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="156">
          <span class="hits">28</span>
          
          <code class="ruby">      def get_range_batch_with_appoptics(column_family, options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">        return get_range_batch_without_appoptics(column_family, options) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">        report_kvs = extract_trace_details(:get_range_batch, column_family, nil, nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">        AppOpticsAPM::API.trace(:cassandra, report_kvs, :get_range_batch) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">          get_range_batch_without_appoptics(column_family, options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="166">
          <span class="hits">28</span>
          
          <code class="ruby">      def get_indexed_slices_with_appoptics(column_family, index_clause, *columns_and_options)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">        args = [column_family, index_clause] + columns_and_options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">        return send :get_indexed_slices_without_appoptics, *args unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">        report_kvs = extract_trace_details(:get_indexed_slices, column_family, nil, columns_and_options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">        AppOpticsAPM::API.trace(:cassandra, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">          send :get_indexed_slices_without_appoptics, *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="178">
          <span class="hits">28</span>
          
          <code class="ruby">      def create_index_with_appoptics(keyspace, column_family, column_name, validation_class)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">        unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">          return create_index_without_appoptics(keyspace, column_family, column_name, validation_class)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">        report_kvs = extract_trace_details(:create_index, column_family, nil, nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">          report_kvs[:Keyspace] = keyspace.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">          report_kvs[:Column_name] = column_name.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">          report_kvs[:Validation_class] = validation_class.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">        AppOpticsAPM::API.trace(:cassandra, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">          create_index_without_appoptics(keyspace, column_family, column_name, validation_class)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="197">
          <span class="hits">28</span>
          
          <code class="ruby">      def drop_index_with_appoptics(keyspace, column_family, column_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">        return drop_index_without_appoptics(keyspace, column_family, column_name) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">        report_kvs = extract_trace_details(:drop_index, column_family, nil, nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">          report_kvs[:Keyspace] = keyspace.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">          report_kvs[:Column_name] = column_name.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">        AppOpticsAPM::API.trace(:cassandra, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">          drop_index_without_appoptics(keyspace, column_family, column_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="213">
          <span class="hits">28</span>
          
          <code class="ruby">      def add_column_family_with_appoptics(cf_def)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">        return add_column_family_without_appoptics(cf_def) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">        report_kvs = extract_trace_details(:add_column_family, nil, nil, nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">          report_kvs[:Cf] = cf_def[:name] if cf_def.is_a?(Hash) &amp;&amp; cf_def.key?(:name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] #{__method__}:#{File.basename(__FILE__)}:#{__LINE__}: #{e.message}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">        AppOpticsAPM::API.trace(:cassandra, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">          add_column_family_without_appoptics(cf_def)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="228">
          <span class="hits">28</span>
          
          <code class="ruby">      def drop_column_family_with_appoptics(column_family)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">        return drop_column_family_without_appoptics(column_family) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">        report_kvs = extract_trace_details(:drop_column_family, column_family, nil, nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">        AppOpticsAPM::API.trace(:cassandra, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">          drop_column_family_without_appoptics(column_family)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="238">
          <span class="hits">28</span>
          
          <code class="ruby">      def add_keyspace_with_appoptics(ks_def)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">        return add_keyspace_without_appoptics(ks_def) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">        report_kvs = extract_trace_details(:add_keyspace, nil, nil, nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">        report_kvs[:Name] = ks_def.name rescue &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">        AppOpticsAPM::API.trace(:cassandra, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">          add_keyspace_without_appoptics(ks_def)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="249">
          <span class="hits">28</span>
          
          <code class="ruby">      def drop_keyspace_with_appoptics(keyspace)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">        return drop_keyspace_without_appoptics(keyspace) unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">        report_kvs = extract_trace_details(:drop_keyspace, nil, nil, nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">        report_kvs[:Name] = keyspace.to_s rescue &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">        AppOpticsAPM::API.trace(:cassandra, report_kvs) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">          drop_keyspace_without_appoptics(keyspace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby"># There are two main Cassandra clients for Ruby.  This one from Twitter</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby"># and the other from datastax.  This one defined ::Cassandra as a class</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby"># and datastax defines it as a module.  We use this to detect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby"># and differentiate between the client in use.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="268">
          <span class="hits">28</span>
          
          <code class="ruby">if defined?(::Cassandra) &amp;&amp; ::Cassandra.is_a?(Class) &amp;&amp; AppOpticsAPM::Config[:cassandra][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="269">
          <span class="hits">3</span>
          
          <code class="ruby">  AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting cassandra&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="271">
          <span class="hits">3</span>
          
          <code class="ruby">  class ::Cassandra</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="272">
          <span class="hits">3</span>
          
          <code class="ruby">    include AppOpticsAPM::Inst::Cassandra</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">    [:insert, :remove, :count_columns, :get_columns, :multi_get_columns, :get,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">     :multi_get, :get_range_single, :get_range_batch, :get_indexed_slices,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">     :create_index, :drop_index, :add_column_family, :drop_column_family,</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="277">
          <span class="hits">3</span>
          
          <code class="ruby">     :add_keyspace, :drop_keyspace].each do |m|</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="278">
          <span class="hits">48</span>
          
          <code class="ruby">      if method_defined?(m)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="279">
          <span class="hits">48</span>
          
          <code class="ruby">        class_eval &quot;alias #{m}_without_appoptics #{m}&quot;</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="280">
          <span class="hits">48</span>
          
          <code class="ruby">        class_eval &quot;alias #{m} #{m}_with_appoptics&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">      else AppOpticsAPM.logger.warn &quot;[appoptics_apm/loading] Couldn&#39;t properly instrument Cassandra (#{m}).  Partial traces may occur.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">    # Special case handler for question mark methods</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="286">
          <span class="hits">3</span>
          
          <code class="ruby">    if method_defined?(:exists?)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="287">
          <span class="hits">3</span>
          
          <code class="ruby">      alias exists_without_appoptics? exists?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="288">
          <span class="hits">3</span>
          
          <code class="ruby">      alias exists? exists_with_appoptics?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">    else AppOpticsAPM.logger.warn &#39;[appoptics_apm/loading] Couldn\&#39;t properly instrument Cassandra (exists?).  Partial traces may occur.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">  end # class Cassandra</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="4c5ebd7d7e73a1a73322275812bf7237d01e8336">
  <div class="header">
    <h3>lib/appoptics_apm/inst/typhoeus.rb</h3>
    <h4><span class="green">95.16 %</span> covered</h4>
    <div>
      <b>62</b> relevant lines. 
      <span class="green"><b>59</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="5">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    module TyphoeusRequestOps</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="8">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="9">
          <span class="hits">9</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :run, ::Typhoeus::Request::Operations)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="12">
          <span class="hits">28</span>
          
          <code class="ruby">      def run_with_appoptics</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="13">
          <span class="hits">69</span>
          
          <code class="ruby">        blacklisted = AppOpticsAPM::API.blacklisted?(url)</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="14">
          <span class="hits">69</span>
          
          <code class="ruby">        unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="15">
          <span class="hits">18</span>
          
          <code class="ruby">          context = AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="16">
          <span class="hits">18</span>
          
          <code class="ruby">          options[:headers][&#39;X-Trace&#39;] = context if AppOpticsAPM::XTrace.valid?(context) &amp;&amp; !blacklisted</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="17">
          <span class="hits">18</span>
          
          <code class="ruby">          return run_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="20">
          <span class="hits">51</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="21">
          <span class="hits">51</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_entry(:typhoeus)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">          # Prepare X-Trace header handling</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="24">
          <span class="hits">51</span>
          
          <code class="ruby">          context = AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="25">
          <span class="hits">51</span>
          
          <code class="ruby">          options[:headers][&#39;X-Trace&#39;] = context unless blacklisted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="27">
          <span class="hits">51</span>
          
          <code class="ruby">          response = run_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="29">
          <span class="hits">51</span>
          
          <code class="ruby">          if response.code == 0</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="30">
          <span class="hits">15</span>
          
          <code class="ruby">            AppOpticsAPM::API.log(:typhoeus, :error, { :ErrorClass =&gt; response.return_code,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">                                                    :ErrorMsg =&gt; response.return_message })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="34">
          <span class="hits">51</span>
          
          <code class="ruby">          kvs = {}</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="35">
          <span class="hits">51</span>
          
          <code class="ruby">          kvs[:IsService] = 1</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="36">
          <span class="hits">51</span>
          
          <code class="ruby">          kvs[:HTTPStatus] = response.code</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="37">
          <span class="hits">51</span>
          
          <code class="ruby">          kvs[:Backtrace] = AppOpticsAPM::API.backtrace if AppOpticsAPM::Config[:typhoeus][:collect_backtraces]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="39">
          <span class="hits">51</span>
          
          <code class="ruby">          uri = URI(response.effective_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">          # Conditionally log query params</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="42">
          <span class="hits">51</span>
          
          <code class="ruby">          if AppOpticsAPM::Config[:typhoeus][:log_args]</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="43">
          <span class="hits">48</span>
          
          <code class="ruby">            kvs[:RemoteURL] = uri.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="45">
          <span class="hits">3</span>
          
          <code class="ruby">            kvs[:RemoteURL] = uri.to_s.split(&#39;?&#39;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="48">
          <span class="hits">51</span>
          
          <code class="ruby">          kvs[:HTTPMethod] = ::AppOpticsAPM::Util.upcase(options[:method])</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="49">
          <span class="hits">51</span>
          
          <code class="ruby">          kvs[:Blacklisted] = true if blacklisted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">          # Re-attach net::http edge unless it&#39;s blacklisted or if we don&#39;t have a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">          # valid X-Trace header</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="53">
          <span class="hits">51</span>
          
          <code class="ruby">          unless blacklisted</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="54">
          <span class="hits">45</span>
          
          <code class="ruby">            xtrace = response.headers[&#39;X-Trace&#39;]</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="55">
          <span class="hits">45</span>
          
          <code class="ruby">            AppOpticsAPM::XTrace.continue_service_context(context, xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="58">
          <span class="hits">51</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_info(:typhoeus, kvs)</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="59">
          <span class="hits">51</span>
          
          <code class="ruby">          response</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">          AppOpticsAPM::API.log_exception(:typhoeus, e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">          raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        ensure</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="64">
          <span class="hits">51</span>
          
          <code class="ruby">          AppOpticsAPM::API.log_exit(:typhoeus)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="65">
          <span class="hits">34</span>
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="69">
          <span class="hits">28</span>
          
          <code class="ruby">    module TyphoeusHydraRunnable</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="70">
          <span class="hits">28</span>
          
          <code class="ruby">      def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="71">
          <span class="hits">9</span>
          
          <code class="ruby">        ::AppOpticsAPM::Util.method_alias(klass, :run, ::Typhoeus::Hydra)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="74">
          <span class="hits">28</span>
          
          <code class="ruby">      def run_with_appoptics</code>
        </li>
      
        <li class="covered" data-hits="39" data-linenumber="75">
          <span class="hits">39</span>
          
          <code class="ruby">        unless AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="76">
          <span class="hits">18</span>
          
          <code class="ruby">          context = AppOpticsAPM::Context.toString</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="77">
          <span class="hits">18</span>
          
          <code class="ruby">          queued_requests.map do |request|</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="78">
          <span class="hits">36</span>
          
          <code class="ruby">            blacklisted = AppOpticsAPM::API.blacklisted?(request.base_url)</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="79">
          <span class="hits">36</span>
          
          <code class="ruby">            request.options[:headers][&#39;X-Trace&#39;] = context if AppOpticsAPM::XTrace.valid?(context) &amp;&amp; !blacklisted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="81">
          <span class="hits">18</span>
          
          <code class="ruby">          return run_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="84">
          <span class="hits">21</span>
          
          <code class="ruby">        kvs = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="86">
          <span class="hits">21</span>
          
          <code class="ruby">        kvs[:queued_requests] = queued_requests.count</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="87">
          <span class="hits">21</span>
          
          <code class="ruby">        kvs[:max_concurrency] = max_concurrency</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="88">
          <span class="hits">21</span>
          
          <code class="ruby">        kvs[:Async] = 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">        # FIXME: Until we figure out a strategy to deal with libcurl internal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">        # threading and Ethon&#39;s use of easy handles, here we just do a simple</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">        # trace of the hydra run.</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="93">
          <span class="hits">21</span>
          
          <code class="ruby">        AppOpticsAPM::API.trace(:typhoeus_hydra, kvs) do</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="94">
          <span class="hits">21</span>
          
          <code class="ruby">          queued_requests.map do |request|</code>
        </li>
      
        <li class="covered" data-hits="39" data-linenumber="95">
          <span class="hits">39</span>
          
          <code class="ruby">            blacklisted = AppOpticsAPM::API.blacklisted?(request.base_url)</code>
        </li>
      
        <li class="covered" data-hits="39" data-linenumber="96">
          <span class="hits">39</span>
          
          <code class="ruby">            request.options[:headers][&#39;X-Trace&#39;] = AppOpticsAPM::Context.toString unless blacklisted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="99">
          <span class="hits">21</span>
          
          <code class="ruby">          run_without_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="107">
          <span class="hits">28</span>
          
          <code class="ruby">if AppOpticsAPM::Config[:typhoeus][:enabled]</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="108">
          <span class="hits">28</span>
          
          <code class="ruby">  if defined?(::Typhoeus)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="109">
          <span class="hits">9</span>
          
          <code class="ruby">    AppOpticsAPM.logger.info &#39;[appoptics_apm/loading] Instrumenting typhoeus&#39; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="110">
          <span class="hits">9</span>
          
          <code class="ruby">    ::AppOpticsAPM::Util.send_include(::Typhoeus::Request::Operations, ::AppOpticsAPM::Inst::TyphoeusRequestOps)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="111">
          <span class="hits">9</span>
          
          <code class="ruby">    ::AppOpticsAPM::Util.send_include(::Typhoeus::Hydra, ::AppOpticsAPM::Inst::TyphoeusHydraRunnable)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7c3d11112dc2dc81664dd6181e8c93148bd0f948">
  <div class="header">
    <h3>lib/appoptics_apm/instrumentation.rb</h3>
    <h4><span class="red">77.78 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # The Inst module holds all of the instrumentation extensions for various</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # libraries such as Redis, Dalli and Resque.</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="8">
          <span class="hits">28</span>
          
          <code class="ruby">  module Inst</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="9">
          <span class="hits">28</span>
          
          <code class="ruby">    def self.load_instrumentation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      # Load the general instrumentation</code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="11">
          <span class="hits">47</span>
          
          <code class="ruby">      pattern = File.join(File.dirname(__FILE__), &#39;inst&#39;, &#39;*.rb&#39;)</code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="12">
          <span class="hits">47</span>
          
          <code class="ruby">      Dir.glob(pattern) do |f|</code>
        </li>
      
        <li class="covered" data-hits="1081" data-linenumber="13">
          <span class="hits">1081</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="1081" data-linenumber="14">
          <span class="hits">1081</span>
          
          <code class="ruby">          require f</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">          AppOpticsAPM.logger.error &quot;[appoptics_apm/loading] Error loading instrumentation file &#39;#{f}&#39; : #{e}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/loading] #{e.backtrace.first}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="eca1cacbcc2bda178e224137fc588693a02240c5">
  <div class="header">
    <h3>lib/appoptics_apm/legacy_method_profiling.rb</h3>
    <h4><span class="yellow">88.46 %</span> covered</h4>
    <div>
      <b>26</b> relevant lines. 
      <span class="green"><b>23</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"># Provides the methods necessary for method profiling.  Profiling</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"># results are sent to the AppOptics dashboard.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"># Example usage:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"># class MyApp</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#   include AppOpticsAPMMethodProfiling</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#   def process_request()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#     # The hard work</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">#   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">#   # call syntax: profile_method &lt;method&gt;, &lt;profile_name&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">#   profile_method :process_request, &#39;request_processor&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"># end</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="19">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPMMethodProfiling</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="20">
          <span class="hits">31</span>
          
          <code class="ruby">  def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="21">
          <span class="hits">15</span>
          
          <code class="ruby">    klass.extend ClassMethods</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="24">
          <span class="hits">31</span>
          
          <code class="ruby">  module ClassMethods</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="25">
          <span class="hits">31</span>
          
          <code class="ruby">    def profile_method_noop(*args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="29">
          <span class="hits">31</span>
          
          <code class="ruby">    def profile_method_real(method_name, profile_name, store_args = false, store_return = false, *_)</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="30">
          <span class="hits">30</span>
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">        # this only gets file and line where profiling is turned on, presumably</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        # right after the function definition.</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="33">
          <span class="hits">30</span>
          
          <code class="ruby">        file = &#39;&#39;</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="34">
          <span class="hits">30</span>
          
          <code class="ruby">        line = &#39;&#39;</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="35">
          <span class="hits">30</span>
          
          <code class="ruby">        info = instance_method(method_name).source_location</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="36">
          <span class="hits">30</span>
          
          <code class="ruby">        unless info.nil?</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="37">
          <span class="hits">30</span>
          
          <code class="ruby">          file = info[0].to_s</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="38">
          <span class="hits">30</span>
          
          <code class="ruby">          line = info[1].to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        # Safety:  Make sure there are no quotes or double quotes to break the class_eval</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="42">
          <span class="hits">30</span>
          
          <code class="ruby">        file = file.gsub(/[\&#39;\&quot;]/, &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="43">
          <span class="hits">30</span>
          
          <code class="ruby">        line = line.gsub(/[\&#39;\&quot;]/, &#39;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">        # profiling via ruby-prof, is it possible to get return value of profiled code?</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="46">
          <span class="hits">30</span>
          
          <code class="ruby">        code = &quot;def _appoptics_profiled_#{method_name}(*args, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">                  entry_kvs                  = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">                  entry_kvs[&#39;Language&#39;]      = &#39;ruby&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">                  entry_kvs[&#39;ProfileName&#39;]   = &#39;#{AppOpticsAPM::Util.prettify(profile_name)}&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">                  entry_kvs[&#39;FunctionName&#39;]  = &#39;#{AppOpticsAPM::Util.prettify(method_name)}&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">                  entry_kvs[&#39;File&#39;]          = &#39;#{file}&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">                  entry_kvs[&#39;LineNumber&#39;]    = &#39;#{line}&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">                  entry_kvs[&#39;Args&#39;]          = AppOpticsAPM::API.pps(*args) if #{store_args}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">                  entry_kvs.merge!(::AppOpticsAPM::API.get_class_name(self))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">                  AppOpticsAPM::API.log(nil, &#39;profile_entry&#39;, entry_kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">                  ret = _appoptics_orig_#{method_name}(*args, &amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">                  exit_kvs =  {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">                  exit_kvs[&#39;Language&#39;] = &#39;ruby&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">                  exit_kvs[&#39;ProfileName&#39;] = &#39;#{AppOpticsAPM::Util.prettify(profile_name)}&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">                  exit_kvs[&#39;ReturnValue&#39;] = AppOpticsAPM::API.pps(ret) if #{store_return}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">                  AppOpticsAPM::API.log(nil, &#39;profile_exit&#39;, exit_kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">                  ret</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">                end&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;[appoptics_apm/warn] profile_method: #{e.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="72">
          <span class="hits">30</span>
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="73">
          <span class="hits">30</span>
          
          <code class="ruby">        class_eval code, __FILE__, __LINE__</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="74">
          <span class="hits">30</span>
          
          <code class="ruby">        alias_method &quot;_appoptics_orig_#{method_name}&quot;, method_name</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="75">
          <span class="hits">30</span>
          
          <code class="ruby">        alias_method method_name, &quot;_appoptics_profiled_#{method_name}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;[appoptics_apm/warn] Fatal error profiling method (#{method_name}): #{e.inspect}&quot; if AppOpticsAPM::Config[:verbose]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    # This allows this module to be included and called even if the gem is in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">    # no-op mode (no base libraries).</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="83">
          <span class="hits">31</span>
          
          <code class="ruby">    if AppOpticsAPM.loaded</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="84">
          <span class="hits">28</span>
          
          <code class="ruby">      alias :profile_method :profile_method_real</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="86">
          <span class="hits">3</span>
          
          <code class="ruby">      alias :profile_method :profile_method_noop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d68b16994b46638ce99efeaa14a26ce95bded3d0">
  <div class="header">
    <h3>lib/appoptics_apm/loading.rb</h3>
    <h4><span class="red">66.67 %</span> covered</h4>
    <div>
      <b>27</b> relevant lines. 
      <span class="green"><b>18</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="4">
          <span class="hits">31</span>
          
          <code class="ruby">require &#39;digest/sha1&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="6">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="7">
          <span class="hits">31</span>
          
          <code class="ruby">  module Util</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # This module was used solely for the deprecated RUM ID calculation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    # but may be useful in the future.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="12">
          <span class="hits">31</span>
          
          <code class="ruby">    module Base64URL</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="13">
          <span class="hits">31</span>
          
          <code class="ruby">      module_function</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="15">
          <span class="hits">31</span>
          
          <code class="ruby">      def encode(bin)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">        c = [bin].pack(&#39;m0&#39;).gsub(/\=+\Z/, &#39;&#39;).tr(&#39;+/&#39;, &#39;-_&#39;).rstrip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">        m = c.size % 4</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        c += &#39;=&#39; * (4 - m) if m != 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        c</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="22">
          <span class="hits">31</span>
          
          <code class="ruby">      def decode(bin)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">        m = bin.size % 4</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        bin += &#39;=&#39; * (4 - m) if m != 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">        bin.tr(&#39;-_&#39;, &#39;+/&#39;).unpack(&#39;m0&#39;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  # This module houses all of the loading functionality for the appoptics_apm gem.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  # Note that this does not necessarily _have_ to include initialization routines</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  # (although it can).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  # Actual initialization is often separated out as it can be dependent on on the state</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  # of the stack boot process.  e.g. code requiring that initializers, frameworks or</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  # instrumented libraries are already loaded...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="40">
          <span class="hits">31</span>
          
          <code class="ruby">  module Loading</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    # Load the appoptics_apm tracing API</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="44">
          <span class="hits">31</span>
          
          <code class="ruby">    def self.require_api</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="45">
          <span class="hits">31</span>
          
          <code class="ruby">      pattern = File.join(File.dirname(__FILE__), &#39;api&#39;, &#39;*.rb&#39;)</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="46">
          <span class="hits">31</span>
          
          <code class="ruby">      Dir.glob(pattern) do |f|</code>
        </li>
      
        <li class="covered" data-hits="186" data-linenumber="47">
          <span class="hits">186</span>
          
          <code class="ruby">        require f</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="49">
          <span class="hits">31</span>
          
          <code class="ruby">      require &#39;appoptics_apm/api&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="51">
          <span class="hits">31</span>
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="52">
          <span class="hits">31</span>
          
          <code class="ruby">        AppOpticsAPM::API.extend_with_tracing</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      rescue LoadError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        AppOpticsAPM.logger.fatal &quot;[appoptics_apm/error] Couldn&#39;t load api: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="60">
          <span class="hits">31</span>
          
          <code class="ruby">AppOpticsAPM::Loading.require_api</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"># Auto-start the Reporter unless we are running Unicorn on Heroku</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"># In that case, we start the reporters after fork</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="64">
          <span class="hits">31</span>
          
          <code class="ruby">unless AppOpticsAPM.heroku? &amp;&amp; AppOpticsAPM.forking_webserver?</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="65">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Reporter.start if AppOpticsAPM.loaded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="873aa68a709782d905fbfd6a5d7fe281cf00fbd3">
  <div class="header">
    <h3>lib/appoptics_apm/logger.rb</h3>
    <h4><span class="red">70.59 %</span> covered</h4>
    <div>
      <b>17</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="4">
          <span class="hits">31</span>
          
          <code class="ruby">require &#39;logger&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="6">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="7">
          <span class="hits">31</span>
          
          <code class="ruby">  class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="8">
          <span class="hits">31</span>
          
          <code class="ruby">    attr_accessor :logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="11">
          <span class="hits">31</span>
          
          <code class="ruby">  class Logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    # Fatal message</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="13">
          <span class="hits">31</span>
          
          <code class="ruby">    def fatal(string, exception = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      AppOpticsAPM.logger.fatal(string) if AppOpticsAPM.logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    # Error message</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="18">
          <span class="hits">31</span>
          
          <code class="ruby">    def error(msg, exception = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      AppOpticsAPM.logger.error(string) if AppOpticsAPM.logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # Warn message</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="23">
          <span class="hits">31</span>
          
          <code class="ruby">    def warn(msg, exception = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      AppOpticsAPM.logger.warn(string) if AppOpticsAPM.logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    # Info message</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="28">
          <span class="hits">31</span>
          
          <code class="ruby">    def info(msg, exception = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      AppOpticsAPM.logger.info(string) if AppOpticsAPM.logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    # Debug message</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="33">
          <span class="hits">31</span>
          
          <code class="ruby">    def debug(msg, exception = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      AppOpticsAPM.logger.debug(string) if AppOpticsAPM.logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="40">
          <span class="hits">31</span>
          
          <code class="ruby">AppOpticsAPM.logger = Logger.new(STDERR)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"># set log level to INFO to be consistent with oboe, DEBUG would be default</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="42">
          <span class="hits">31</span>
          
          <code class="ruby">AppOpticsAPM.logger.level = Logger::INFO</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="6aead5dc0fc99ae507e71410a1d9359c92e8f708">
  <div class="header">
    <h3>lib/appoptics_apm/method_profiling.rb</h3>
    <h4><span class="yellow">86.96 %</span> covered</h4>
    <div>
      <b>23</b> relevant lines. 
      <span class="green"><b>20</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="2">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="3">
          <span class="hits">31</span>
          
          <code class="ruby">  module MethodProfiling</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="4">
          <span class="hits">31</span>
          
          <code class="ruby">    def profile_wrapper(method, report_kvs, opts, *args, &amp;block)</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="5">
          <span class="hits">62</span>
          
          <code class="ruby">      report_kvs[:Backtrace] = AppOpticsAPM::API.backtrace(2) if opts[:backtrace]</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="6">
          <span class="hits">62</span>
          
          <code class="ruby">      report_kvs[:Arguments] = args if opts[:arguments]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">      # if this is a rails controller we want to set the transaction for the outbound metrics</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="9">
          <span class="hits">62</span>
          
          <code class="ruby">      if defined?(request) &amp;&amp; defined?(request.env)</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="10">
          <span class="hits">26</span>
          
          <code class="ruby">        report_kvs[&#39;Controller&#39;] = self.class.name</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="11">
          <span class="hits">26</span>
          
          <code class="ruby">        report_kvs[&#39;Action&#39;] = self.action_name</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="12">
          <span class="hits">26</span>
          
          <code class="ruby">        request.env[&#39;appoptics_apm.controller&#39;] = report_kvs[&#39;Controller&#39;]</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="13">
          <span class="hits">26</span>
          
          <code class="ruby">        request.env[&#39;appoptics_apm.action&#39;] = report_kvs[&#39;Action&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="16">
          <span class="hits">62</span>
          
          <code class="ruby">      AppOpticsAPM::API.log(nil, :profile_entry, report_kvs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="18">
          <span class="hits">62</span>
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="19">
          <span class="hits">62</span>
          
          <code class="ruby">        rv = self.send(method, *args, &amp;block)</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="20">
          <span class="hits">62</span>
          
          <code class="ruby">        report_kvs[:ReturnValue] = rv if opts[:result]</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="21">
          <span class="hits">62</span>
          
          <code class="ruby">        rv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">        AppOpticsAPM::API.log_exception(nil, e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      ensure</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="26">
          <span class="hits">62</span>
          
          <code class="ruby">        report_kvs.delete(:Backtrace)</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="27">
          <span class="hits">62</span>
          
          <code class="ruby">        report_kvs.delete(:Controller)</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="28">
          <span class="hits">62</span>
          
          <code class="ruby">        report_kvs.delete(:Action)</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="29">
          <span class="hits">62</span>
          
          <code class="ruby">        AppOpticsAPM::API.log(nil, :profile_exit, report_kvs)</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="30">
          <span class="hits">42</span>
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="cb839f8b873fd741e762082dbd877503487f2e88">
  <div class="header">
    <h3>lib/appoptics_apm/noop/context.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">####</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># noop version of AppOpticsAPM::Context</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="6">
          <span class="hits">3</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="7">
          <span class="hits">3</span>
          
          <code class="ruby">  module Context</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    # noop version of toString</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    # toString would return the current context (xtrace) as string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    # the noop version returns an empty string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="15">
          <span class="hits">3</span>
          
          <code class="ruby">    def self.toString</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="16">
          <span class="hits">3</span>
          
          <code class="ruby">      &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="41358d788ba9862014661622ed9d98720f6295b2">
  <div class="header">
    <h3>lib/appoptics_apm/ruby.rb</h3>
    <h4><span class="yellow">90.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="4">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # This module provides a method to manually initialize the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # Ruby instrumentation.  Normally this is done by detecting</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # frameworks at load time and inserting initialization hooks.</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="9">
          <span class="hits">31</span>
          
          <code class="ruby">  module Ruby</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="10">
          <span class="hits">31</span>
          
          <code class="ruby">    class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="11">
          <span class="hits">31</span>
          
          <code class="ruby">      def initialize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">        load</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      # The core method to load Ruby instrumentation.  Call this</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      # from raw Ruby scripts or in Ruby applications where a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      # supported framework isn&#39;t being used.  Supported frameworks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      # will instead be detected at load time and initialization is</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      # automatic.</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="21">
          <span class="hits">31</span>
          
          <code class="ruby">      def load</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">        # In case some apps call this manually, make sure</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        # that the gem is fully loaded and not in no-op</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">        # mode (e.g. on unsupported platforms etc.)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="25">
          <span class="hits">6</span>
          
          <code class="ruby">        if AppOpticsAPM.loaded</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="26">
          <span class="hits">6</span>
          
          <code class="ruby">          AppOpticsAPM::Inst.load_instrumentation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="33">
          <span class="hits">31</span>
          
          <code class="ruby">if AppOpticsAPM.loaded &amp;&amp; !AppOpticsAPM.framework?</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="34">
          <span class="hits">6</span>
          
          <code class="ruby">  ::AppOpticsAPM::Ruby.load</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a9ece4d9b1494600f8bf399c0f7e187952ece8a1">
  <div class="header">
    <h3>lib/appoptics_apm/support.rb</h3>
    <h4><span class="red">6.58 %</span> covered</h4>
    <div>
      <b>76</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>71</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="4">
          <span class="hits">31</span>
          
          <code class="ruby">require &#39;rbconfig&#39;</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="5">
          <span class="hits">31</span>
          
          <code class="ruby">require &#39;logger&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="7">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # This module is used to debug problematic setups and/or environments.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # Depending on the environment, output may be to stdout or the framework</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # log file (e.g. log/production.log)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # yesno</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # Utility method to translate value/nil to &quot;yes&quot;/&quot;no&quot; strings</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="17">
          <span class="hits">31</span>
          
          <code class="ruby">  def self.yesno(x)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    x ? &#39;yes&#39; : &#39;no&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # rubocop:disable Metrics/CyclomaticComplexity, Metrics/PerceivedComplexity, Metrics/AbcSize</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="22">
          <span class="hits">31</span>
          
          <code class="ruby">  def self.support_report</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    @logger_level = AppOpticsAPM.logger.level</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    AppOpticsAPM.logger.level = ::Logger::DEBUG</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;********************************************************&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;* BEGIN AppOpticsAPM Support Report&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;*   Please email the output of this report to support@appoptics.com&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;********************************************************&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;Ruby: #{RUBY_DESCRIPTION}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;$0: #{$0}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;$1: #{$1}&quot; unless $1.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;$2: #{$2}&quot; unless $2.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;$3: #{$3}&quot; unless $3.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;$4: #{$4}&quot; unless $4.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;AppOpticsAPM.loaded == #{AppOpticsAPM.loaded}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    using_jruby = defined?(JRUBY_VERSION)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;Using JRuby?: #{yesno(using_jruby)}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    if using_jruby</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      AppOpticsAPM.logger.warn &quot;Joboe Agent Status: #{Java::ComTracelyticsAgent::Agent.getStatus}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    on_heroku = AppOpticsAPM.heroku?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;On Heroku?: #{yesno(on_heroku)}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    if on_heroku</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      AppOpticsAPM.logger.warn &quot;APPOPTICS_URL: #{ENV[&#39;APPOPTICS_URL&#39;]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;AppOpticsAPM::Ruby defined?: #{yesno(defined?(AppOpticsAPM::Ruby))}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;AppOpticsAPM.reporter: #{AppOpticsAPM.reporter}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;********************************************************&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;* Frameworks&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;********************************************************&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    using_rails = defined?(::Rails)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;Using Rails?: #{yesno(using_rails)}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    if using_rails</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      AppOpticsAPM.logger.warn &quot;AppOpticsAPM::Rails loaded?: #{yesno(defined?(::AppOpticsAPM::Rails))}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">      if defined?(::AppOpticsAPM::Rack)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;AppOpticsAPM::Rack middleware loaded?: #{yesno(::Rails.configuration.middleware.include? AppOpticsAPM::Rack)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    using_sinatra = defined?(::Sinatra)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;Using Sinatra?: #{yesno(using_sinatra)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    using_padrino = defined?(::Padrino)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;Using Padrino?: #{yesno(using_padrino)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    using_grape = defined?(::Grape)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;Using Grape?: #{yesno(using_grape)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;********************************************************&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;* ActiveRecord Adapter&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;********************************************************&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">    if defined?(::ActiveRecord)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">      if defined?(::ActiveRecord::Base.connection.adapter_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;ActiveRecord adapter: #{::ActiveRecord::Base.connection.adapter_name}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      AppOpticsAPM.logger.warn &#39;No ActiveRecord&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    # TODO we don&#39;t have libs in /usr/lib anymore, is this still needed???</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    # AppOpticsAPM.logger.warn &#39;********************************************************&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    # AppOpticsAPM.logger.warn &#39;* AppOpticsAPM Libraries&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    # AppOpticsAPM.logger.warn &#39;********************************************************&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    # files = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    # [&#39;/usr/lib/liboboe*&#39;, &#39;/usr/lib64/liboboe*&#39;].each do |d|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    #   files = Dir.glob(d)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">    #   break if !files.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    # if files.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    #   AppOpticsAPM.logger.warn &#39;Error: No liboboe libs!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    # else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">    #   files.each { |f|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    #     AppOpticsAPM.logger.warn f</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    #   }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;********************************************************&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;* AppOpticsAPM::Config Values&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;********************************************************&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">    AppOpticsAPM::Config.print_config</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;********************************************************&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;* OS, Platform + Env&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;********************************************************&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;host_os: &quot; + RbConfig::CONFIG[&#39;host_os&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;sitearch: &quot; + RbConfig::CONFIG[&#39;sitearch&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;arch: &quot; + RbConfig::CONFIG[&#39;arch&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn RUBY_PLATFORM</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;RACK_ENV: #{ENV[&#39;RACK_ENV&#39;]}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &quot;RAILS_ENV: #{ENV[&#39;RAILS_ENV&#39;]}&quot; if using_rails</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;********************************************************&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;* Raw __Init KVs&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;********************************************************&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">    platform_info = AppOpticsAPM::Util.build_init_report</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">    platform_info.each { |k,v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">      AppOpticsAPM.logger.warn &quot;#{k}: #{v}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;********************************************************&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;* END AppOpticsAPM Support Report&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;*   Support Email: support@appoptics.com&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;*   Github: https://github.com/librato/ruby-appoptics&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">    AppOpticsAPM.logger.warn &#39;********************************************************&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">    AppOpticsAPM.logger.level = @logger_level</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">    nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  # rubocop:enable Metrics/CyclomaticComplexity, Metrics/PerceivedComplexity, Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f9a2e655fd7784d80c554e2add953317603e7c7a">
  <div class="header">
    <h3>lib/appoptics_apm/test.rb</h3>
    <h4><span class="red">58.06 %</span> covered</h4>
    <div>
      <b>31</b> relevant lines. 
      <span class="green"><b>18</b> lines covered</span> and
      <span class="red"><b>13</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="4">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="5">
          <span class="hits">31</span>
          
          <code class="ruby">  module Test</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="6">
          <span class="hits">31</span>
          
          <code class="ruby">    class &lt;&lt; self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">      # load_extras</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      # This method simply loads all the extras needed to run</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      # tests such as models, jobs etc...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="13">
          <span class="hits">31</span>
          
          <code class="ruby">      def load_extras</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">        # If we&#39;re using the libraries gemfile (with sidekiq and resque)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">        if AppOpticsAPM::Test.gemfile?(:libraries)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">          # Load all of the test workers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">          pattern = File.join(File.dirname(__FILE__), &#39;../../test/jobs/**/&#39;, &#39;*.rb&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">          Dir.glob(pattern) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">            AppOpticsAPM.logger.debug &quot;Loading test job file: #{File.basename(f)}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">            require f</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      # gemfile?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      # Method used to determine under which gemfile we&#39;re running.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      # Pass &lt;tt&gt;name&lt;/tt&gt; as the gemfile name only (without the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      # .gemfile extension)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      # returns true or fase depending on result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="34">
          <span class="hits">31</span>
          
          <code class="ruby">      def gemfile?(name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        File.basename(ENV[&#39;BUNDLE_GEMFILE&#39;]) == (name.to_s + &#39;.gemfile&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      # gemfile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      # Used to determine under which gemfile we are running.  This</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      # method will return the name of the active gemfile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="44">
          <span class="hits">31</span>
          
          <code class="ruby">      def gemfile</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        File.basename(ENV[&#39;BUNDLE_GEMFILE&#39;]).split(&#39;.&#39;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      # set_postgresql_env</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      # Used to set the postgresql specific DATABASE_URL env based</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      # on various conditions</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="53">
          <span class="hits">31</span>
          
          <code class="ruby">      def set_postgresql_env</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="54">
          <span class="hits">15</span>
          
          <code class="ruby">        if ENV.key?(&#39;TRAVIS_PSQL_PASS&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">          ENV[&#39;DATABASE_URL&#39;] = &quot;postgresql://postgres:#{ENV[&#39;TRAVIS_PSQL_PASS&#39;]}@127.0.0.1:5432/travis_ci_test&quot;</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="56">
          <span class="hits">15</span>
          
          <code class="ruby">        elsif ENV.key?(&#39;DOCKER_PSQL_PASS&#39;)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="57">
          <span class="hits">15</span>
          
          <code class="ruby">          ENV[&#39;DATABASE_URL&#39;] = &quot;postgresql://docker:#{ENV[&#39;DOCKER_PSQL_PASS&#39;]}@127.0.0.1:5432/travis_ci_test&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">          ENV[&#39;DATABASE_URL&#39;] = &#39;postgresql://postgres@127.0.0.1:5432/travis_ci_test&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      # set_mysql_env</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      # Used to set the mysql specific DATABASE_URL env based</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      # on various conditions</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="68">
          <span class="hits">31</span>
          
          <code class="ruby">      def set_mysql_env</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="69">
          <span class="hits">2</span>
          
          <code class="ruby">        if ENV.key?(&#39;TRAVIS_MYSQL_PASS&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">          ENV[&#39;DATABASE_URL&#39;] = &quot;mysql://root:#{ENV[&#39;TRAVIS_MYSQL_PASS&#39;]}@127.0.0.1:3306/travis_ci_test&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="71">
          <span class="hits">2</span>
          
          <code class="ruby">        elsif ENV.key?(&#39;DOCKER_MYSQL_PASS&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="72">
          <span class="hits">2</span>
          
          <code class="ruby">          ENV[&#39;DATABASE_URL&#39;] = &quot;mysql://root:#{ENV[&#39;DOCKER_MYSQL_PASS&#39;]}@mysql:3306/travis_ci_test&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">          ENV[&#39;DATABASE_URL&#39;] = &#39;mysql://root@127.0.0.1:3306/travis_ci_test&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      # set_mysql2_env</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      # Used to set the mysql specific DATABASE_URL env based</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      # on various conditions</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="83">
          <span class="hits">31</span>
          
          <code class="ruby">      def set_mysql2_env</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="84">
          <span class="hits">12</span>
          
          <code class="ruby">        if ENV.key?(&#39;TRAVIS_MYSQL_PASS&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">          ENV[&#39;DATABASE_URL&#39;] = &quot;mysql2://root:#{ENV[&#39;TRAVIS_MYSQL_PASS&#39;]}@127.0.0.1:3306/travis_ci_test&quot;</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="86">
          <span class="hits">12</span>
          
          <code class="ruby">        elsif ENV.key?(&#39;DOCKER_MYSQL_PASS&#39;)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="87">
          <span class="hits">12</span>
          
          <code class="ruby">          ENV[&#39;DATABASE_URL&#39;] = &quot;mysql2://root:#{ENV[&#39;DOCKER_MYSQL_PASS&#39;]}@mysql:3306/travis_ci_test&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">          ENV[&#39;DATABASE_URL&#39;] = &#39;mysql2://root@127.0.0.1:3306/travis_ci_test&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c9619e17efe90a68ff37714fdab50626e1f1c84b">
  <div class="header">
    <h3>lib/appoptics_apm/thread_local.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>8</b> relevant lines. 
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="4">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # Provides thread local storage for AppOpticsAPM.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # Example usage:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # module AppOpticsAPMBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  #   extend ::AppOpticsAPM::ThreadLocal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  #   thread_local :layer_op</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # end</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="13">
          <span class="hits">31</span>
          
          <code class="ruby">  module ThreadLocal</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="14">
          <span class="hits">31</span>
          
          <code class="ruby">    def thread_local(name)</code>
        </li>
      
        <li class="covered" data-hits="372" data-linenumber="15">
          <span class="hits">372</span>
          
          <code class="ruby">      key = &quot;__#{self}_#{name}__&quot;.intern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="372" data-linenumber="17">
          <span class="hits">372</span>
          
          <code class="ruby">      define_method(name) do</code>
        </li>
      
        <li class="covered" data-hits="7084" data-linenumber="18">
          <span class="hits">7084</span>
          
          <code class="ruby">        Thread.current[key]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="372" data-linenumber="21">
          <span class="hits">372</span>
          
          <code class="ruby">      define_method(name.to_s + &#39;=&#39;) do |value|</code>
        </li>
      
        <li class="covered" data-hits="19880" data-linenumber="22">
          <span class="hits">19880</span>
          
          <code class="ruby">        Thread.current[key] = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c98ed8c31f040cfca52f327d90ca5539a175b585">
  <div class="header">
    <h3>lib/appoptics_apm/util.rb</h3>
    <h4><span class="red">73.85 %</span> covered</h4>
    <div>
      <b>130</b> relevant lines. 
      <span class="green"><b>96</b> lines covered</span> and
      <span class="red"><b>34</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="4">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # Provides utility methods for use while in the business</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # of instrumenting code</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="8">
          <span class="hits">31</span>
          
          <code class="ruby">  module Util</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="9">
          <span class="hits">31</span>
          
          <code class="ruby">    class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="10">
          <span class="hits">31</span>
          
          <code class="ruby">      def contextual_name(cls)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">        # Attempt to infer a contextual name if not indicated</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">        # For example:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">        # ::ActiveRecord::ConnectionAdapters::AbstractMysqlAdapter.to_s.split(/::/).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">        # =&gt; &quot;AbstractMysqlAdapter&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="covered" data-hits="191" data-linenumber="17">
          <span class="hits">191</span>
          
          <code class="ruby">        cls.to_s.split(/::/).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        cls</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      # method_alias</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      # Centralized utility method to alias a method on an arbitrary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      # class or module.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="28">
          <span class="hits">31</span>
          
          <code class="ruby">      def method_alias(cls, method, name = nil)</code>
        </li>
      
        <li class="covered" data-hits="463" data-linenumber="29">
          <span class="hits">463</span>
          
          <code class="ruby">        name ||= contextual_name(cls)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="463" data-linenumber="31">
          <span class="hits">463</span>
          
          <code class="ruby">        if cls.method_defined?(method.to_sym) || cls.private_method_defined?(method.to_sym)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">          # Strip &#39;!&#39; or &#39;?&#39; from method if present</code>
        </li>
      
        <li class="covered" data-hits="463" data-linenumber="34">
          <span class="hits">463</span>
          
          <code class="ruby">          safe_method_name = method.to_s.chop if method.to_s =~ /\?$|\!$/</code>
        </li>
      
        <li class="covered" data-hits="463" data-linenumber="35">
          <span class="hits">463</span>
          
          <code class="ruby">          safe_method_name ||= method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="463" data-linenumber="37">
          <span class="hits">463</span>
          
          <code class="ruby">          without_appoptics = &quot;#{safe_method_name}_without_appoptics&quot;</code>
        </li>
      
        <li class="covered" data-hits="463" data-linenumber="38">
          <span class="hits">463</span>
          
          <code class="ruby">          with_appoptics    = &quot;#{safe_method_name}_with_appoptics&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">          # Only alias if we haven&#39;t done so already</code>
        </li>
      
        <li class="covered" data-hits="152" data-linenumber="41">
          <span class="hits">152</span>
          
          <code class="ruby">          unless cls.method_defined?(without_appoptics.to_sym) ||</code>
        </li>
      
        <li class="covered" data-hits="311" data-linenumber="42">
          <span class="hits">311</span>
          
          <code class="ruby">            cls.private_method_defined?(without_appoptics.to_sym)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="463" data-linenumber="44">
          <span class="hits">463</span>
          
          <code class="ruby">            cls.class_eval do</code>
        </li>
      
        <li class="covered" data-hits="463" data-linenumber="45">
          <span class="hits">463</span>
          
          <code class="ruby">              alias_method without_appoptics, method.to_s</code>
        </li>
      
        <li class="covered" data-hits="463" data-linenumber="46">
          <span class="hits">463</span>
          
          <code class="ruby">              alias_method method.to_s, with_appoptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">          AppOpticsAPM.logger.warn &quot;[appoptics_apm/loading] Couldn&#39;t properly instrument #{name}.#{method}.  Partial traces may occur.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      # class_method_alias</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      # Centralized utility method to alias a class method on an arbitrary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      # class or module</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="60">
          <span class="hits">31</span>
          
          <code class="ruby">      def class_method_alias(cls, method, name = nil)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="61">
          <span class="hits">15</span>
          
          <code class="ruby">        name ||= contextual_name(cls)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="63">
          <span class="hits">15</span>
          
          <code class="ruby">        if cls.singleton_methods.include? method.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">          # Strip &#39;!&#39; or &#39;?&#39; from method if present</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="66">
          <span class="hits">15</span>
          
          <code class="ruby">          safe_method_name = method.to_s.chop if method.to_s =~ /\?$|\!$/</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="67">
          <span class="hits">15</span>
          
          <code class="ruby">          safe_method_name ||= method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="69">
          <span class="hits">15</span>
          
          <code class="ruby">          without_appoptics = &quot;#{safe_method_name}_without_appoptics&quot;</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="70">
          <span class="hits">15</span>
          
          <code class="ruby">          with_appoptics    = &quot;#{safe_method_name}_with_appoptics&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">          # Only alias if we haven&#39;t done so already</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="73">
          <span class="hits">15</span>
          
          <code class="ruby">          unless cls.singleton_methods.include? without_appoptics.to_sym</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="74">
          <span class="hits">15</span>
          
          <code class="ruby">            cls.singleton_class.send(:alias_method, without_appoptics, method.to_s)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="75">
          <span class="hits">15</span>
          
          <code class="ruby">            cls.singleton_class.send(:alias_method, method.to_s, with_appoptics)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">          AppOpticsAPM.logger.warn &quot;[appoptics_apm/loading] Couldn&#39;t properly instrument #{name}.  Partial traces may occur.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      # send_extend</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      # Centralized utility method to send an extend call for an</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      # arbitrary class</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="87">
          <span class="hits">31</span>
          
          <code class="ruby">      def send_extend(target_cls, cls)</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="88">
          <span class="hits">27</span>
          
          <code class="ruby">        target_cls.send(:extend, cls) if defined?(target_cls)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      # send_include</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      # Centralized utility method to send a include call for an</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      # arbitrary class</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="96">
          <span class="hits">31</span>
          
          <code class="ruby">      def send_include(target_cls, cls)</code>
        </li>
      
        <li class="covered" data-hits="229" data-linenumber="97">
          <span class="hits">229</span>
          
          <code class="ruby">        target_cls.send(:include, cls) if defined?(target_cls)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      # static_asset?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">      # Given a path, this method determines whether it is a static asset or not (based</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">      # solely on filename)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="106">
          <span class="hits">31</span>
          
          <code class="ruby">      def static_asset?(path)</code>
        </li>
      
        <li class="covered" data-hits="2370" data-linenumber="107">
          <span class="hits">2370</span>
          
          <code class="ruby">        path =~ Regexp.new(AppOpticsAPM::Config[:dnt_regexp], AppOpticsAPM::Config[:dnt_opts])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;[AppOpticsAPM/debug] Could not apply Regex.new to path. #{e.inspect}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">        false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">      # prettify</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">      # Even to my surprise, &#39;prettify&#39; is a real word:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">      # transitive v. To make pretty or prettier, especially in a superficial or insubstantial way.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      #   from The American Heritage Dictionary of the English Language, 4th Edition</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      # This method makes things &#39;purty&#39; for reporting.</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="121">
          <span class="hits">31</span>
          
          <code class="ruby">      def prettify(x)</code>
        </li>
      
        <li class="covered" data-hits="90" data-linenumber="122">
          <span class="hits">90</span>
          
          <code class="ruby">        if (x.to_s =~ /^#&lt;/) == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">          x.class.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="90" data-linenumber="125">
          <span class="hits">90</span>
          
          <code class="ruby">          x.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">      # upcase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      # Occasionally, we want to send some values in all caps.  This is true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">      # for things like HTTP scheme or method.  This takes anything and does</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">      # it&#39;s best to safely convert it to a string (if needed) and convert it</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      # to all uppercase.</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="136">
          <span class="hits">31</span>
          
          <code class="ruby">      def upcase(o)</code>
        </li>
      
        <li class="covered" data-hits="306" data-linenumber="137">
          <span class="hits">306</span>
          
          <code class="ruby">        if o.is_a?(String) || o.respond_to?(:to_s)</code>
        </li>
      
        <li class="covered" data-hits="306" data-linenumber="138">
          <span class="hits">306</span>
          
          <code class="ruby">          o.to_s.upcase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug &quot;[appoptics_apm/debug] AppOpticsAPM::Util.upcase: could not convert #{o.class}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">          &#39;UNKNOWN&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      # to_query</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">      # Used to convert a hash into a URL # query.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="150">
          <span class="hits">31</span>
          
          <code class="ruby">      def to_query(h)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="151">
          <span class="hits">9</span>
          
          <code class="ruby">        return &#39;&#39; unless h.is_a?(Hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="153">
          <span class="hits">9</span>
          
          <code class="ruby">        result = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="155">
          <span class="hits">27</span>
          
          <code class="ruby">        h.each { |k, v| result.push(k.to_s + &#39;=&#39; + v.to_s) }</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="156">
          <span class="hits">9</span>
          
          <code class="ruby">        result.sort.join(&#39;&amp;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">      # sanitize_sql</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">      # Used to remove query literals from SQL.  Used by all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      # DB adapter instrumentation.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">      # The regular expression passed to String.gsub is configurable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">      # via AppOpticsAPM::Config[:sanitize_sql_regexp] and</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">      # AppOpticsAPM::Config[:sanitize_sql_opts].</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="169">
          <span class="hits">31</span>
          
          <code class="ruby">      def sanitize_sql(sql)</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="170">
          <span class="hits">82</span>
          
          <code class="ruby">        return sql unless AppOpticsAPM::Config[:sanitize_sql]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="79" data-linenumber="172">
          <span class="hits">79</span>
          
          <code class="ruby">        regexp = Regexp.new(AppOpticsAPM::Config[:sanitize_sql_regexp], AppOpticsAPM::Config[:sanitize_sql_opts])</code>
        </li>
      
        <li class="covered" data-hits="79" data-linenumber="173">
          <span class="hits">79</span>
          
          <code class="ruby">        sql.gsub(regexp, &#39;?&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">      # legacy_build_init_report</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      # Internal: Build a hash of KVs that reports on the status of the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">      # running environment.  This is used on stack boot in __Init reporting</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">      # and for AppOpticsAPM.support_report.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">      # This legacy version of build_init_report is used for apps without Bundler.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">      # rubocop:disable Metrics/CyclomaticComplexity, Metrics/PerceivedComplexity, Metrics/AbcSize</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="186">
          <span class="hits">31</span>
          
          <code class="ruby">      def legacy_build_init_report</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="187">
          <span class="hits">3</span>
          
          <code class="ruby">        platform_info = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="189">
          <span class="hits">3</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">          # Report the framework in use</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="191">
          <span class="hits">3</span>
          
          <code class="ruby">          if defined?(::RailsLts::VERSION)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">            platform_info[&#39;Ruby.RailsLts.Version&#39;]  = &quot;RailsLts-#{::RailsLts::VERSION}&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="193">
          <span class="hits">3</span>
          
          <code class="ruby">          elsif defined?(::Rails.version)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">            platform_info[&#39;Ruby.Rails.Version&#39;]     = &quot;Rails-#{::Rails.version}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="196">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Grape.Version&#39;]       = &quot;Grape-#{::Grape::VERSION}&quot; if defined?(::Grape::VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="197">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Cramp.Version&#39;]       = &quot;Cramp-#{::Cramp::VERSION}&quot; if defined?(::Cramp::VERSION)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="199">
          <span class="hits">3</span>
          
          <code class="ruby">          if defined?(::Padrino::VERSION)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">            platform_info[&#39;Ruby.Padrino.Version&#39;]   = &quot;Padrino-#{::Padrino::VERSION}&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="201">
          <span class="hits">3</span>
          
          <code class="ruby">          elsif defined?(::Sinatra::VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="202">
          <span class="hits">3</span>
          
          <code class="ruby">            platform_info[&#39;Ruby.Sinatra.Version&#39;]   = &quot;Sinatra-#{::Sinatra::VERSION}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">          # Report the instrumented libraries</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="206">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Cassandra.Version&#39;]  = &quot;Cassandra-#{::Cassandra.VERSION}&quot;    if defined?(::Cassandra.VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="207">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Curb.Version&#39;]       = &quot;Curb-#{::Curl::VERSION}&quot;             if defined?(::Curl::VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="208">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Dalli.Version&#39;]      = &quot;Dalli-#{::Dalli::VERSION}&quot;           if defined?(::Dalli::VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="209">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Excon.Version&#39;]      = &quot;Excon-#{::Excon::VERSION}&quot;           if defined?(::Excon::VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="210">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Faraday.Version&#39;]    = &quot;Faraday-#{::Faraday::VERSION}&quot;       if defined?(::Faraday::VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="211">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.HTTPClient.Version&#39;] = &quot;HTTPClient-#{::HTTPClient::VERSION}&quot; if defined?(::HTTPClient::VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="212">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Memcached.Version&#39;]  = &quot;Memcached-#{::Memcached::VERSION}&quot;   if defined?(::Memcached::VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="213">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Moped.Version&#39;]      = &quot;Moped-#{::Moped::VERSION}&quot;           if defined?(::Moped::VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="214">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Redis.Version&#39;]      = &quot;Redis-#{::Redis::VERSION}&quot;           if defined?(::Redis::VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="215">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Resque.Version&#39;]     = &quot;Resque-#{::Resque::VERSION}&quot;         if defined?(::Resque::VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="216">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.RestClient.Version&#39;] = &quot;RestClient-#{::RestClient::VERSION}&quot; if defined?(::RestClient::VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="217">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Sidekiq.Version&#39;]    = &quot;Sidekiq-#{::Sidekiq::VERSION}&quot;       if defined?(::Sidekiq::VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="218">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Typhoeus.Version&#39;]   = &quot;Typhoeus-#{::Typhoeus::VERSION}&quot;     if defined?(::Typhoeus::VERSION)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="220">
          <span class="hits">3</span>
          
          <code class="ruby">          if Gem.loaded_specs.key?(&#39;delayed_job&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">            # Oddly, DelayedJob doesn&#39;t have an embedded version number so we get it from the loaded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">            # gem specs.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">            version = Gem.loaded_specs[&#39;delayed_job&#39;].version.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">            platform_info[&#39;Ruby.DelayedJob.Version&#39;]       = &quot;DelayedJob-#{version}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">          # Special case since the Mongo 1.x driver doesn&#39;t embed the version number in the gem directly</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="228">
          <span class="hits">3</span>
          
          <code class="ruby">          if ::Gem.loaded_specs.key?(&#39;mongo&#39;)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="229">
          <span class="hits">3</span>
          
          <code class="ruby">            platform_info[&#39;Ruby.Mongo.Version&#39;]     = &quot;Mongo-#{::Gem.loaded_specs[&#39;mongo&#39;].version}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">          # Report the DB adapter in use</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="233">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Mysql.Version&#39;]   = Mysql::GemVersion::VERSION   if defined?(Mysql::GemVersion::VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="234">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.PG.Version&#39;]      = PG::VERSION                  if defined?(PG::VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="235">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Mysql2.Version&#39;]  = Mysql2::VERSION              if defined?(Mysql2::VERSION)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="236">
          <span class="hits">3</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Sequel.Version&#39;]  = ::Sequel::VERSION            if defined?(::Sequel::VERSION)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">        rescue StandardError, ScriptError =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">          # Also rescue ScriptError (aka SyntaxError) in case one of the expected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">          # version defines don&#39;t exist</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">          platform_info[&#39;Error&#39;] = &quot;Error in legacy_build_init_report: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="243">
          
          
          <code class="ruby">          AppOpticsAPM.logger.warn &quot;[appoptics_apm/warn] Error in legacy_build_init_report: #{e.message}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug e.backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="246">
          <span class="hits">3</span>
          
          <code class="ruby">        platform_info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">      # rubocop:enable Metrics/CyclomaticComplexity, Metrics/PerceivedComplexity, Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">      #  build_init_report</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">      # Internal: Build a hash of KVs that reports on the status of the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">      # running environment.  This is used on stack boot in __Init reporting</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">      # and for AppOpticsAPM.support_report.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">      # rubocop:disable Metrics/CyclomaticComplexity, Metrics/PerceivedComplexity, Metrics/AbcSize</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="258">
          <span class="hits">31</span>
          
          <code class="ruby">      def build_init_report</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="259">
          <span class="hits">24</span>
          
          <code class="ruby">        platform_info = { &#39;__Init&#39; =&gt; 1 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="261">
          <span class="hits">24</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="262">
          <span class="hits">24</span>
          
          <code class="ruby">          platform_info[&#39;Force&#39;]                        = true</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="263">
          <span class="hits">24</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Platform.Version&#39;]        = RUBY_PLATFORM</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="264">
          <span class="hits">24</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Version&#39;]                 = RUBY_VERSION</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="265">
          <span class="hits">24</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.AppOpticsAPM.Version&#39;]       = ::AppOpticsAPM::Version::STRING</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">          # Should this be the oboe version, separate from the Ruby library&#39;s version?</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="267">
          <span class="hits">24</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.Oboe.Version&#39;]            = ::AppOpticsAPM::Version::STRING</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="268">
          <span class="hits">24</span>
          
          <code class="ruby">          platform_info[&#39;RubyHeroku.AppOpticsAPM.Version&#39;] = ::AppOpticsAPMHeroku::Version::STRING if defined?(::AppOpticsAPMHeroku)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="269">
          <span class="hits">24</span>
          
          <code class="ruby">          platform_info[&#39;Ruby.TraceMode.Version&#39;]       = ::AppOpticsAPM::Config[:tracing_mode]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">          # Collect up the loaded gems</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="272">
          <span class="hits">24</span>
          
          <code class="ruby">          if defined?(Gem) &amp;&amp; Gem.respond_to?(:loaded_specs)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="273">
          <span class="hits">24</span>
          
          <code class="ruby">            Gem.loaded_specs.each_pair { |k, v|</code>
        </li>
      
        <li class="covered" data-hits="1925" data-linenumber="274">
          <span class="hits">1925</span>
          
          <code class="ruby">              platform_info[&quot;Ruby.#{k}.Version&quot;] = v.version.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">            platform_info.merge!(legacy_build_init_report)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">          # Report the server in use (if possible)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="281">
          <span class="hits">24</span>
          
          <code class="ruby">          if defined?(::Unicorn::Const::UNICORN_VERSION)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="282">
          
          
          <code class="ruby">            platform_info[&#39;Ruby.AppContainer.Version&#39;] = &quot;Unicorn-#{::Unicorn::Const::UNICORN_VERSION}&quot;</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="283">
          <span class="hits">24</span>
          
          <code class="ruby">          elsif defined?(::Puma::Const::PUMA_VERSION)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="284">
          <span class="hits">24</span>
          
          <code class="ruby">            platform_info[&#39;Ruby.AppContainer.Version&#39;] = &quot;Puma-#{::Puma::Const::PUMA_VERSION} (#{::Puma::Const::CODE_NAME})&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="285">
          
          
          <code class="ruby">          elsif defined?(::PhusionPassenger::PACKAGE_NAME)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="286">
          
          
          <code class="ruby">            platform_info[&#39;Ruby.AppContainer.Version&#39;] = &quot;#{::PhusionPassenger::PACKAGE_NAME}-#{::PhusionPassenger::VERSION_STRING}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="287">
          
          
          <code class="ruby">          elsif defined?(::Thin::VERSION::STRING)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">            platform_info[&#39;Ruby.AppContainer.Version&#39;] = &quot;Thin-#{::Thin::VERSION::STRING} (#{::Thin::VERSION::CODENAME})&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">          elsif defined?(::Mongrel::Const::MONGREL_VERSION)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">            platform_info[&#39;Ruby.AppContainer.Version&#39;] = &quot;Mongrel-#{::Mongrel::Const::MONGREL_VERSION}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">          elsif defined?(::Mongrel2::VERSION)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">            platform_info[&#39;Ruby.AppContainer.Version&#39;] = &quot;Mongrel2-#{::Mongrel2::VERSION}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">          elsif defined?(::Trinidad::VERSION)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">            platform_info[&#39;Ruby.AppContainer.Version&#39;] = &quot;Trinidad-#{::Trinidad::VERSION}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">          elsif defined?(::WEBrick::VERSION)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">            platform_info[&#39;Ruby.AppContainer.Version&#39;] = &quot;WEBrick-#{::WEBrick::VERSION}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">            platform_info[&#39;Ruby.AppContainer.Version&#39;] = File.basename($PROGRAM_NAME)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">        rescue StandardError, ScriptError =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">          # Also rescue ScriptError (aka SyntaxError) in case one of the expected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">          # version defines don&#39;t exist</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">          platform_info[&#39;Error&#39;] = &quot;Error in build_report: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="307">
          
          
          <code class="ruby">          AppOpticsAPM.logger.warn &quot;[appoptics_apm/warn] Error in build_init_report: #{e.message}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">          AppOpticsAPM.logger.debug e.backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="310">
          <span class="hits">24</span>
          
          <code class="ruby">        platform_info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">      # rubocop:enable Metrics/CyclomaticComplexity, Metrics/PerceivedComplexity, Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="0fbacdcc50cc60f29e65d76cd04dd1d447cd8891">
  <div class="header">
    <h3>lib/appoptics_apm/xtrace.rb</h3>
    <h4><span class="red">70.59 %</span> covered</h4>
    <div>
      <b>34</b> relevant lines. 
      <span class="green"><b>24</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="4">
          <span class="hits">31</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # Methods to act on, manipulate or investigate an X-Trace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # value</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="8">
          <span class="hits">31</span>
          
          <code class="ruby">  module XTrace</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="9">
          <span class="hits">31</span>
          
          <code class="ruby">    class &lt;&lt; self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      #  AppOpticsAPM::XTrace.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      #  Perform basic validation on a potential X-Trace ID</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="15">
          <span class="hits">31</span>
          
          <code class="ruby">      def valid?(xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">        # Shouldn&#39;t be nil</code>
        </li>
      
        <li class="covered" data-hits="16098" data-linenumber="17">
          <span class="hits">16098</span>
          
          <code class="ruby">        return false unless xtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        # The X-Trace ID shouldn&#39;t be an initialized empty ID</code>
        </li>
      
        <li class="covered" data-hits="15509" data-linenumber="20">
          <span class="hits">15509</span>
          
          <code class="ruby">        return false if (xtrace =~ /^2b0000000/i) == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">        # Valid X-Trace IDs have a length of 60 bytes and start with &#39;2b&#39;</code>
        </li>
      
        <li class="covered" data-hits="15054" data-linenumber="23">
          <span class="hits">15054</span>
          
          <code class="ruby">        return false unless xtrace.length == 60 &amp;&amp; (xtrace =~ /^2b/i) == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15042" data-linenumber="25">
          <span class="hits">15042</span>
          
          <code class="ruby">        true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug e.message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug e.backtrace</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="32">
          <span class="hits">31</span>
          
          <code class="ruby">      def sampled?(xtrace)</code>
        </li>
      
        <li class="covered" data-hits="216" data-linenumber="33">
          <span class="hits">216</span>
          
          <code class="ruby">        xtrace[59].to_i &amp; 1 == 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="36">
          <span class="hits">31</span>
          
          <code class="ruby">      def set_sampled(xtrace)</code>
        </li>
      
        <li class="covered" data-hits="246" data-linenumber="37">
          <span class="hits">246</span>
          
          <code class="ruby">        xtrace[59] = (xtrace[59].hex | 1).to_s(16).upcase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="40">
          <span class="hits">31</span>
          
          <code class="ruby">      def unset_sampled(xtrace)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="41">
          <span class="hits">6</span>
          
          <code class="ruby">        xtrace[59] = (~(~xtrace[59].hex | 1)).to_s(16).upcase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      # AppOpticsAPM::XTrace.task_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      # Extract and return the task_id portion of an X-Trace ID</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="49">
          <span class="hits">31</span>
          
          <code class="ruby">      def task_id(xtrace)</code>
        </li>
      
        <li class="covered" data-hits="561" data-linenumber="50">
          <span class="hits">561</span>
          
          <code class="ruby">        return nil unless AppOpticsAPM::XTrace.valid?(xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="561" data-linenumber="52">
          <span class="hits">561</span>
          
          <code class="ruby">        xtrace[2..41]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug e.message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug e.backtrace</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        return nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      # AppOpticsAPM::XTrace.edge_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      # Extract and return the edge_id portion of an X-Trace ID</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="64">
          <span class="hits">31</span>
          
          <code class="ruby">      def edge_id(xtrace)</code>
        </li>
      
        <li class="covered" data-hits="12959" data-linenumber="65">
          <span class="hits">12959</span>
          
          <code class="ruby">        return nil unless AppOpticsAPM::XTrace.valid?(xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12959" data-linenumber="67">
          <span class="hits">12959</span>
          
          <code class="ruby">        xtrace[42..57]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug e.message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        AppOpticsAPM.logger.debug e.backtrace</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        return nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      # continue_service_context</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      # In the case of service calls such as external HTTP requests, we</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      # pass along X-Trace headers so that request context can be maintained</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      # across servers and applications.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      # Remote requests can return a X-Trace header in which case we want</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      # to pickup on and continue the context in most cases.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      # @start is the context just before the outgoing request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      # @finish is the context returned to us (as an HTTP response header</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">      # if that be the case)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="89">
          <span class="hits">31</span>
          
          <code class="ruby">      def continue_service_context(start, finish)</code>
        </li>
      
        <li class="covered" data-hits="243" data-linenumber="90">
          <span class="hits">243</span>
          
          <code class="ruby">        if AppOpticsAPM::XTrace.valid?(finish) &amp;&amp; AppOpticsAPM.tracing?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">          # Assure that we received back a valid X-Trace with the same task_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">          # and the sampling bit is set, otherwise it is a response from a non-sampling service</code>
        </li>
      
        <li class="covered" data-hits="216" data-linenumber="94">
          <span class="hits">216</span>
          
          <code class="ruby">          if AppOpticsAPM::XTrace.task_id(start) == AppOpticsAPM::XTrace.task_id(finish) &amp;&amp; AppOpticsAPM::XTrace.sampled?(finish)</code>
        </li>
      
        <li class="covered" data-hits="216" data-linenumber="95">
          <span class="hits">216</span>
          
          <code class="ruby">            AppOpticsAPM::Context.fromString(finish)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">            AppOpticsAPM.logger.debug &quot;[XTrace] Sampling flag unset or mismatched start and finish ids:\n#{start}\n#{finish}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8ab8af3b9db813e143c4c344208432c8ef64009c">
  <div class="header">
    <h3>lib/oboe/backward_compatibility.rb</h3>
    <h4><span class="yellow">85.37 %</span> covered</h4>
    <div>
      <b>41</b> relevant lines. 
      <span class="green"><b>35</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="31" data-linenumber="1">
          <span class="hits">31</span>
          
          <code class="ruby">require &#39;appoptics_apm/thread_local&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="3">
          <span class="hits">31</span>
          
          <code class="ruby">module Oboe</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="4">
          <span class="hits">31</span>
          
          <code class="ruby">  extend AppOpticsAPMBase</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="5">
          <span class="hits">31</span>
          
          <code class="ruby">  if AppOpticsAPM.loaded</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="6">
          <span class="hits">28</span>
          
          <code class="ruby">    include Oboe_metal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # Support for Oboe::API calls</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="12">
          <span class="hits">31</span>
          
          <code class="ruby">  module API</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="13">
          <span class="hits">31</span>
          
          <code class="ruby">    include AppOpticsAPM::API</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="14">
          <span class="hits">31</span>
          
          <code class="ruby">    extend ::AppOpticsAPM::ThreadLocal</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="15">
          <span class="hits">31</span>
          
          <code class="ruby">    thread_local :deprecation_notified</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="17">
          <span class="hits">31</span>
          
          <code class="ruby">    def self.method_missing(sym, *args, &amp;blk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      # Notify of deprecation only once</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="19">
          <span class="hits">30</span>
          
          <code class="ruby">      unless @deprecated_notified</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="20">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;[appoptics_apm/warn] Note that Oboe::API has been renamed to AppOpticsAPM::API. (#{sym}:#{args})&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="21">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM.logger.warn &#39;[appoptics_apm/warn] Oboe::API will be deprecated in a future version.&#39;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="22">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;[appoptics_apm/warn] Caller: #{Kernel.caller[0]}&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="23">
          <span class="hits">3</span>
          
          <code class="ruby">        @deprecated_notified = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="25">
          <span class="hits">30</span>
          
          <code class="ruby">      AppOpticsAPM::API.send(sym, *args, &amp;blk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  # Support for Oboe::Config calls</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="33">
          <span class="hits">31</span>
          
          <code class="ruby">  module Config</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="34">
          <span class="hits">31</span>
          
          <code class="ruby">    extend ::AppOpticsAPM::ThreadLocal</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="35">
          <span class="hits">31</span>
          
          <code class="ruby">    thread_local :deprecation_notified</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="37">
          <span class="hits">31</span>
          
          <code class="ruby">    def self.method_missing(sym, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      # Notify of deprecation only once</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="39">
          <span class="hits">51</span>
          
          <code class="ruby">      unless @deprecated_notified</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="40">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;[appoptics_apm/warn] Note that Oboe::Config has been renamed to AppOpticsAPM::Config. (#{sym}:#{args})&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="41">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM.logger.warn &#39;[appoptics_apm/warn] Oboe::Config will be deprecated in a future version.&#39;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="42">
          <span class="hits">3</span>
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;[appoptics_apm/warn] Caller: #{Kernel.caller[0]}&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="43">
          <span class="hits">3</span>
          
          <code class="ruby">        @deprecated_notified = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="45">
          <span class="hits">51</span>
          
          <code class="ruby">      AppOpticsAPM::Config.send(sym, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  # Support for legacy Oboe::Ruby.load calls</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="52">
          <span class="hits">31</span>
          
          <code class="ruby">  module Ruby</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="53">
          <span class="hits">31</span>
          
          <code class="ruby">    extend ::AppOpticsAPM::ThreadLocal</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="54">
          <span class="hits">31</span>
          
          <code class="ruby">    thread_local :deprecation_notified</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="56">
          <span class="hits">31</span>
          
          <code class="ruby">    def self.method_missing(sym, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      # Notify of deprecation only once</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      unless @deprecated_notified</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;[appoptics_apm/warn] Note that Oboe::Ruby has been renamed to AppOpticsAPM::Ruby. (#{sym}:#{args})&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &#39;[appoptics_apm/warn] Oboe::Ruby will be deprecated in a future version.&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        AppOpticsAPM.logger.warn &quot;[appoptics_apm/warn] Caller: #{Kernel.caller[0]}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        @deprecated_notified = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">      AppOpticsAPM::Ruby.send(sym, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"># Support for OboeMethodProfiling</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="72">
          <span class="hits">31</span>
          
          <code class="ruby">module OboeMethodProfiling</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="73">
          <span class="hits">31</span>
          
          <code class="ruby">  def self.included(klass)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="74">
          <span class="hits">15</span>
          
          <code class="ruby">    klass.extend ClassMethods</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="77">
          <span class="hits">31</span>
          
          <code class="ruby">  module ClassMethods</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="78">
          <span class="hits">31</span>
          
          <code class="ruby">    include AppOpticsAPMMethodProfiling::ClassMethods</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="af6ff44d543c3027efd5a8cdbc66f7d6f9038a56">
  <div class="header">
    <h3>lib/oboe_metal.rb</h3>
    <h4><span class="red">79.49 %</span> covered</h4>
    <div>
      <b>78</b> relevant lines. 
      <span class="green"><b>62</b> lines covered</span> and
      <span class="red"><b>16</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (c) 2016 SolarWinds, LLC.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># All rights reserved.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="4">
          <span class="hits">28</span>
          
          <code class="ruby">require &#39;thread&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"># Disable docs and Camelcase warns since we&#39;re implementing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"># an interface here.  See OboeBase for details.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"># rubocop:disable Style/Documentation, Style/MethodName</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="9">
          <span class="hits">28</span>
          
          <code class="ruby">module AppOpticsAPM</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="10">
          <span class="hits">28</span>
          
          <code class="ruby">  extend AppOpticsAPMBase</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="11">
          <span class="hits">28</span>
          
          <code class="ruby">  include Oboe_metal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="13">
          <span class="hits">28</span>
          
          <code class="ruby">  class Reporter</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="14">
          <span class="hits">28</span>
          
          <code class="ruby">    class &lt;&lt; self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      # start</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      # Start the AppOpticsAPM Reporter</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="20">
          <span class="hits">28</span>
          
          <code class="ruby">      def start</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="21">
          <span class="hits">28</span>
          
          <code class="ruby">        return unless AppOpticsAPM.loaded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="23">
          <span class="hits">28</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="24">
          <span class="hits">28</span>
          
          <code class="ruby">          protocol = ENV.key?(&#39;APPOPTICS_GEM_TEST&#39;) ? &#39;file&#39; :</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">                       ENV[&#39;TRACELYTICS_REPORTER&#39;] || &#39;ssl&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="27">
          <span class="hits">28</span>
          
          <code class="ruby">          case protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">          when &#39;file&#39;</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="29">
          <span class="hits">28</span>
          
          <code class="ruby">            options = &quot;file=#{TRACE_FILE}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">          when &#39;udp&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">            options = &quot;addr=#{AppOpticsAPM::Config[:reporter_host]},port=#{AppOpticsAPM::Config[:reporter_port]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">            if ENV[&#39;APPOPTICS_SERVICE_KEY&#39;].to_s == &#39;&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">              AppOpticsAPM.logger.warn &quot;[appoptics_apm/warn] APPOPTICS_SERVICE_KEY not set. Cannot submit data.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">              AppOpticsAPM.loaded = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">              return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">            # ssl reporter requires the service key passed in as arg &quot;cid&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">            options = &quot;cid=#{ENV[&#39;APPOPTICS_SERVICE_KEY&#39;]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="42">
          <span class="hits">28</span>
          
          <code class="ruby">          AppOpticsAPM.reporter = Oboe_metal::Reporter.new(protocol, options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">          # Only report __Init from here if we are not instrumenting a framework.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">          # Otherwise, frameworks will handle reporting __Init after full initialization</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="46">
          <span class="hits">28</span>
          
          <code class="ruby">          unless defined?(::Rails) || defined?(::Sinatra) || defined?(::Padrino) || defined?(::Grape)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="47">
          <span class="hits">6</span>
          
          <code class="ruby">            AppOpticsAPM::API.report_init</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">          $stderr.puts e.message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">          raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="55">
          <span class="hits">28</span>
          
          <code class="ruby">      alias :restart :start</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      # sendReport</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      # Send the report for the given event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="62">
          <span class="hits">28</span>
          
          <code class="ruby">      def sendReport(evt)</code>
        </li>
      
        <li class="covered" data-hits="15410" data-linenumber="63">
          <span class="hits">15410</span>
          
          <code class="ruby">        AppOpticsAPM.reporter.sendReport(evt)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      # sendStatus</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      # Send the report for the given event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="71">
          <span class="hits">28</span>
          
          <code class="ruby">      def sendStatus(evt, context = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        AppOpticsAPM.reporter.sendStatus(evt, context)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      # clear_all_traces</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      # Truncates the trace output file to zero</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="80">
          <span class="hits">28</span>
          
          <code class="ruby">      def clear_all_traces</code>
        </li>
      
        <li class="covered" data-hits="1817" data-linenumber="81">
          <span class="hits">1817</span>
          
          <code class="ruby">        File.truncate(TRACE_FILE, 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      # get_all_traces</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">      # Retrieves all traces written to the trace file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="89">
          <span class="hits">28</span>
          
          <code class="ruby">      def get_all_traces</code>
        </li>
      
        <li class="covered" data-hits="1420" data-linenumber="90">
          <span class="hits">1420</span>
          
          <code class="ruby">        io = File.open(TRACE_FILE, &#39;r&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1420" data-linenumber="91">
          <span class="hits">1420</span>
          
          <code class="ruby">        contents = io.readlines(nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1420" data-linenumber="93">
          <span class="hits">1420</span>
          
          <code class="ruby">        return contents if contents.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1342" data-linenumber="95">
          <span class="hits">1342</span>
          
          <code class="ruby">        traces = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">        # We use Gem.loaded_spec because older versions of the bson</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        # gem didn&#39;t even have a version embedded in the gem.  If the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">        # gem isn&#39;t in the bundle, it should rightfully error out</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">        # anyways.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="covered" data-hits="1342" data-linenumber="103">
          <span class="hits">1342</span>
          
          <code class="ruby">        if Gem.loaded_specs[&#39;bson&#39;].version.to_s &lt; &#39;4.0&#39;</code>
        </li>
      
        <li class="covered" data-hits="192" data-linenumber="104">
          <span class="hits">192</span>
          
          <code class="ruby">          s = StringIO.new(contents[0])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="192" data-linenumber="106">
          <span class="hits">192</span>
          
          <code class="ruby">          until s.eof?</code>
        </li>
      
        <li class="covered" data-hits="1482" data-linenumber="107">
          <span class="hits">1482</span>
          
          <code class="ruby">            traces &lt;&lt; if ::BSON.respond_to? :read_bson_document</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">                        BSON.read_bson_document(s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">                      else</code>
        </li>
      
        <li class="covered" data-hits="1482" data-linenumber="110">
          <span class="hits">1482</span>
          
          <code class="ruby">                        BSON::Document.from_bson(s)</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="111">
          <span class="hits">1036</span>
          
          <code class="ruby">                      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="1150" data-linenumber="114">
          <span class="hits">1150</span>
          
          <code class="ruby">          bbb = BSON::ByteBuffer.new(contents[0])</code>
        </li>
      
        <li class="covered" data-hits="1150" data-linenumber="115">
          <span class="hits">1150</span>
          
          <code class="ruby">          until bbb.length == 0</code>
        </li>
      
        <li class="covered" data-hits="12721" data-linenumber="116">
          <span class="hits">12721</span>
          
          <code class="ruby">            traces &lt;&lt; Hash.from_bson(bbb)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1342" data-linenumber="120">
          <span class="hits">1342</span>
          
          <code class="ruby">        traces</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="125">
          <span class="hits">28</span>
          
          <code class="ruby">  module EventUtil</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="126">
          <span class="hits">28</span>
          
          <code class="ruby">    def self.metadataString(evt)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">      evt.metadataString</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="131">
          <span class="hits">28</span>
          
          <code class="ruby">  class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="132">
          <span class="hits">28</span>
          
          <code class="ruby">    def sample?(opts = {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">      # Return false if no-op mode</code>
        </li>
      
        <li class="covered" data-hits="2175" data-linenumber="134">
          <span class="hits">2175</span>
          
          <code class="ruby">      return false unless AppOpticsAPM.loaded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      # Assure defaults since SWIG enforces Strings</code>
        </li>
      
        <li class="covered" data-hits="2175" data-linenumber="137">
          <span class="hits">2175</span>
          
          <code class="ruby">      layer   = opts[:layer]      ? opts[:layer].to_s.strip.freeze : APPOPTICS_STR_BLANK</code>
        </li>
      
        <li class="covered" data-hits="2175" data-linenumber="138">
          <span class="hits">2175</span>
          
          <code class="ruby">      xtrace  = opts[:xtrace]     ? opts[:xtrace].to_s.strip       : APPOPTICS_STR_BLANK</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2175" data-linenumber="140">
          <span class="hits">2175</span>
          
          <code class="ruby">      rv = AppOpticsAPM::Context.sampleRequest(layer, xtrace)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2175" data-linenumber="142">
          <span class="hits">2175</span>
          
          <code class="ruby">      if rv == 0</code>
        </li>
      
        <li class="covered" data-hits="212" data-linenumber="143">
          <span class="hits">212</span>
          
          <code class="ruby">        AppOpticsAPM.sample_rate = -1</code>
        </li>
      
        <li class="covered" data-hits="212" data-linenumber="144">
          <span class="hits">212</span>
          
          <code class="ruby">        AppOpticsAPM.sample_source = -1</code>
        </li>
      
        <li class="covered" data-hits="212" data-linenumber="145">
          <span class="hits">212</span>
          
          <code class="ruby">        false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">        # liboboe version &gt; 1.3.1 returning a bit masked integer with SampleRate and</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">        # source embedded</code>
        </li>
      
        <li class="covered" data-hits="1963" data-linenumber="149">
          <span class="hits">1963</span>
          
          <code class="ruby">        AppOpticsAPM.sample_rate = (rv &amp; SAMPLE_RATE_MASK)</code>
        </li>
      
        <li class="covered" data-hits="1963" data-linenumber="150">
          <span class="hits">1963</span>
          
          <code class="ruby">        AppOpticsAPM.sample_source = (rv &amp; SAMPLE_SOURCE_MASK) &gt;&gt; 24</code>
        </li>
      
        <li class="covered" data-hits="1963" data-linenumber="151">
          <span class="hits">1963</span>
          
          <code class="ruby">        true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">      AppOpticsAPM.logger.debug &quot;[oboe/error] sample? error: #{e.inspect}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="158">
          <span class="hits">28</span>
          
          <code class="ruby">    def set_tracing_mode(mode)</code>
        </li>
      
        <li class="covered" data-hits="1264" data-linenumber="159">
          <span class="hits">1264</span>
          
          <code class="ruby">      return unless AppOpticsAPM.loaded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1264" data-linenumber="161">
          <span class="hits">1264</span>
          
          <code class="ruby">      value = mode.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1264" data-linenumber="163">
          <span class="hits">1264</span>
          
          <code class="ruby">      case value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">      when :never</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="165">
          <span class="hits">48</span>
          
          <code class="ruby">        AppOpticsAPM::Context.setTracingMode(OBOE_TRACE_NEVER)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">      when :always</code>
        </li>
      
        <li class="covered" data-hits="1216" data-linenumber="168">
          <span class="hits">1216</span>
          
          <code class="ruby">        AppOpticsAPM::Context.setTracingMode(OBOE_TRACE_ALWAYS)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">        AppOpticsAPM.logger.fatal &quot;[oboe/error] Invalid tracing mode set: #{mode}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">        AppOpticsAPM::Context.setTracingMode(OBOE_TRACE_NEVER)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="176">
          <span class="hits">28</span>
          
          <code class="ruby">    def set_sample_rate(rate)</code>
        </li>
      
        <li class="covered" data-hits="1124" data-linenumber="177">
          <span class="hits">1124</span>
          
          <code class="ruby">      return unless AppOpticsAPM.loaded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      # Update liboboe with the new SampleRate value</code>
        </li>
      
        <li class="covered" data-hits="1124" data-linenumber="180">
          <span class="hits">1124</span>
          
          <code class="ruby">      AppOpticsAPM::Context.setDefaultSampleRate(rate.to_i)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"># rubocop:enable Style/Documentation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="186">
          <span class="hits">28</span>
          
          <code class="ruby">AppOpticsAPM.loaded = true</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="187">
          <span class="hits">28</span>
          
          <code class="ruby">AppOpticsAPM.config_lock = Mutex.new</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a9e958cce9206c0643cacabcdbb39f2f16b115d3">
  <div class="header">
    <h3>lib/rails/generators/appoptics_apm/templates/appoptics_apm_initializer.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>83</b> relevant lines. 
      <span class="green"><b>83</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># AppOpticsAPM Initializer (for the appoptics_apm gem)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># https://www.appoptics.com/</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># More information on instrumenting Ruby applications can be found here:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"># https://docs.appoptics.com/kb/apm_tracing/ruby/</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"># The settings in this template file represent the defaults</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="9">
          <span class="hits">31</span>
          
          <code class="ruby">if defined?(AppOpticsAPM::Config)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # Turn tracing on or off</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # By default tracing is set to &#39;always&#39;, the other option is &#39;never&#39;.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # &#39;always&#39; means that sampling will be done according to the current</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # sampling rate. &#39;never&#39; means that there is no sampling.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="18">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:tracing_mode] = :always</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # Verbose output of instrumentation initialization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="23">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:verbose] = ENV.key?(&#39;APPOPTICS_GEM_VERBOSE&#39;) &amp;&amp; ENV[&#39;APPOPTICS_GEM_VERBOSE&#39;] == &#39;true&#39; ? true : false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # Prepend domain to transaction name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  # If this is set to `true` transaction names will be composed as `my.host.com/controller.action` instead of</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  # `controller.action`. This configuration applies to all transaction names, whether deducted by the instrumentation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  # or implicitly set.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="32">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:transaction_name][:prepend_domain] = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  # Sanitize SQL Statements</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  # The AppOpticsAPM Ruby client has the ability to sanitize query literals</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  # from SQL statements.  By default this is enabled.  Disable to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  # collect and report query literals to AppOpticsAPM.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="41">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:sanitize_sql] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="42">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:sanitize_sql_regexp] = &#39;(\&#39;[\s\S][^\&#39;]*\&#39;|\d*\.\d+|\d+|NULL)&#39;</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="43">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:sanitize_sql_opts]   = Regexp::IGNORECASE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  # Do Not Trace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  # These two values allow you to configure specific URL patterns to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  # never be traced.  By default, this is set to common static file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  # extensions but you may want to customize this list for your needs.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  # dnt_regexp and dnt_opts is passed to Regexp.new to create</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  # a regular expression object.  That is then used to match against</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  # the incoming request path.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  # The path string originates from the rack layer and is retrieved</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  # as follows:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  #   req = ::Rack::Request.new(env)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  #   path = URI.unescape(req.path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  # Usage:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  #   AppOpticsAPM::Config[:dnt_regexp] = &quot;lobster$&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  #   AppOpticsAPM::Config[:dnt_opts]   = Regexp::IGNORECASE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  # This will ignore all requests that end with the string lobster</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  # regardless of case</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  # Requests with positive matches (non nil) will not be traced.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  # See lib/appoptics_apm/util.rb: AppOpticsAPM::Util.static_asset?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="71">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:dnt_regexp] = &#39;\.(jpg|jpeg|gif|png|ico|css|zip|tgz|gz|rar|bz2|pdf|txt|tar|wav|bmp|rtf|js|flv|swf|otf|eot|ttf|woff|woff2|svg|less)(\?.+){0,1}$&#39;</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="72">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:dnt_opts]   = Regexp::IGNORECASE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  # Blacklist urls</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  # This configuration is used by outbound calls. If the call</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  # goes to a blacklisted url then we won&#39;t add any</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  # tracing information to the headers.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  # The list has to an array of strings, even if only one url is blacklisted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">  # Example: AppOpticsAPM::Config[:blacklist] = [&#39;google.com&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="85">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:blacklist] = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  # Rails Exception Logging</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  # In Rails, raised exceptions with rescue handlers via</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  # &lt;tt&gt;rescue_from&lt;/tt&gt; are not reported to the AppOptics</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  # dashboard by default.  Setting this value to true will</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  # report all raised exception regardless.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="96">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:report_rescued_errors] = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">  # Bunny Controller and Action</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  # The bunny (Rabbitmq) instrumentation can optionally report</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">  # Controller and Action values to allow filtering of bunny</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  # message handling in # the UI.  Use of Controller and Action</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">  # for filters is temporary until the UI is updated with</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  # additional filters.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">  # These values identify which properties of</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">  # Bunny::MessageProperties to report as Controller</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  # and Action.  The defaults are to report :app_id (as</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  # Controller) and :type (as Action).  If these values</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  # are not specified in the publish, then nothing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">  # will be reported here.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="115">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:bunnyconsumer][:controller] = :app_id</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="116">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:bunnyconsumer][:action] = :type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">  # Enabling/Disabling Instrumentation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">  # If you&#39;re having trouble with one of the instrumentation libraries, they</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">  # can be individually disabled here by setting the :enabled</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">  # value to false:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="126">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:action_controller][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="127">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:action_controller_api][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="128">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:action_view][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="129">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:active_record][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="130">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:bunnyclient][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="131">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:bunnyconsumer][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="132">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:cassandra][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="133">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:curb][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="134">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:dalli][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="135">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:delayed_jobclient][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="136">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:delayed_jobworker][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="137">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:em_http_request][:enabled] = false</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="138">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:excon][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="139">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:faraday][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="140">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:grape][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="141">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:httpclient][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="142">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:memcached][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="143">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:mongo][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="144">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:moped][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="145">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:nethttp][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="146">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:rack][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="147">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:redis][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="148">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:resqueclient][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="149">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:resqueworker][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="150">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:rest_client][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="151">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:sequel][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="152">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:sidekiqclient][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="153">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:sidekiqworker][:enabled] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="154">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:typhoeus][:enabled] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">  # Argument logging</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">  # for http requests</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">  # Set to true to enable argument logging</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="163">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:bunnyconsumer][:log_args] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="164">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:curb][:log_args] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="165">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:excon][:log_args] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="166">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:httpclient][:log_args] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="167">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:mongo][:log_args] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="168">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:nethttp][:log_args] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="169">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:rack][:log_args] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="170">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:resqueclient][:log_args] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="171">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:resqueworker][:log_args] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="172">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:sidekiqclient][:log_args] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="173">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:sidekiqworker][:log_args] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="174">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:typhoeus][:log_args] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">  # Enabling/Disabling Backtrace Collection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">  # Instrumentation can optionally collect backtraces as they collect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">  # performance metrics.  Note that this has a negative impact on</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">  # performance but can be useful when trying to locate the source of</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">  # a certain call or operation.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="185">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:action_controller][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="186">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:action_controller_api][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="187">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:action_view][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="188">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:active_record][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="189">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:bunnyclient][:collect_backtraces] = false</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="190">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:bunnyconsumer][:collect_backtraces] = false</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="191">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:cassandra][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="192">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:curb][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="193">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:dalli][:collect_backtraces] = false</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="194">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:delayed_jobclient][:collect_backtraces] = false</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="195">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:delayed_jobworker][:collect_backtraces] = false</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="196">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:em_http_request][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="197">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:excon][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="198">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:faraday][:collect_backtraces] = false</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="199">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:grape][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="200">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:httpclient][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="201">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:memcached][:collect_backtraces] = false</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="202">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:mongo][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="203">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:moped][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="204">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:nethttp][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="205">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:rack][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="206">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:redis][:collect_backtraces] = false</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="207">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:resqueclient][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="208">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:resqueworker][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="209">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:rest_client][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="210">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:sequel][:collect_backtraces] = true</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="211">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:sidekiqclient][:collect_backtraces] = false</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="212">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:sidekiqworker][:collect_backtraces] = false</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="213">
          <span class="hits">31</span>
          
          <code class="ruby">  AppOpticsAPM::Config[:typhoeus][:collect_backtraces] = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
      </div>
    </div>
  </body>
</html>
