<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module AppOpticsAPM::API::Tracing - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
  var index_rel_prefix = "../../";
</script>

<script src="../../js/jquery.js"></script>
<script src="../../js/darkfish.js"></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-i-start_trace">#start_trace</a>
    
    <li ><a href="#method-i-start_trace_with_target">#start_trace_with_target</a>
    
    <li ><a href="#method-i-trace">#trace</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-AppOpticsAPM::API::Tracing">
  <h1 id="module-AppOpticsAPM::API::Tracing" class="module">
    module AppOpticsAPM::API::Tracing
  </h1>

  <section class="description">
    
<p>Provides the higher-level tracing interface for the <a
href="../API.html">API</a>.</p>

<p>Traces are best created with a <code>AppOpticsAPM:API.start_trace</code>
block and <code>AppOpticsAPM:API.trace</code> blocks around calls to be
traced. These two methods guarantee proper nesting of tracing and handling
of the tracing context.</p>

<p>Some optional keys that can be used in the <code>opts</code> hash:</p>
<ul><li>
<p><code>:TransactionName</code> - this will show up in the transactions
column in the traces dashboard</p>
</li><li>
<p><code>:Controller</code> - if present will be combined with
<code>Action</code> and show up as transaction in the traces dashboard</p>
</li><li>
<p><code>:Action</code> - if present will be combined with
<code>Controller</code> and show up as transaction in the traces dashboard</p>
</li><li>
<p><code>:HTTP-Host</code> - domain portion of URL</p>
</li><li>
<p><code>:URL</code> - request URI</p>
</li><li>
<p><code>:Method</code></p>
</li></ul>

<p>Invalid keys: <code>:Label</code>, <code>:Layer</code>, <code>:Edge</code>,
<code>:Timestamp</code>, <code>:Timestamp_u</code></p>

  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-start_trace" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_trace</span><span
            class="method-args">(layer, xtrace = nil, opts = {}) { || ... }</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Public: Trace a given block of code which can start a trace depending on
configuration and probability. Detect any exceptions thrown by the block
and report errors.</p>

<p>When <a href="Tracing.html#method-i-start_trace">#start_trace</a> returns
control to the calling context, the oboe context will be cleared.</p>

<p>layer - The layer the block of code belongs to. opts - A hash containing
key/value pairs that will be reported along with the first event of this
layer (optional).</p>

<p>Example</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">handle_request</span>(<span class="ruby-identifier">request</span>, <span class="ruby-identifier">response</span>)
  <span class="ruby-comment"># ... code that modifies request and response ...</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">def</span> <span class="ruby-identifier">handle_request_with_oboe</span>(<span class="ruby-identifier">request</span>, <span class="ruby-identifier">response</span>)
  <span class="ruby-identifier">result</span>, <span class="ruby-identifier">xtrace</span> = <span class="ruby-identifier">start_trace</span>(<span class="ruby-string">&#39;rails&#39;</span>, <span class="ruby-identifier">request</span>[<span class="ruby-string">&#39;X-Trace&#39;</span>]) <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">handle_request</span>(<span class="ruby-identifier">request</span>, <span class="ruby-identifier">response</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
  <span class="ruby-identifier">xtrace</span> = <span class="ruby-identifier">e</span>.<span class="ruby-identifier">xtrace</span>
<span class="ruby-keyword">ensure</span>
  <span class="ruby-identifier">response</span>[<span class="ruby-string">&#39;X-trace&#39;</span>] = <span class="ruby-identifier">xtrace</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Returns a list of length two, the first element of which is the result of
the block, and the second element of which is the oboe context that was set
when the block completed execution.</p>
          
          

          
          <div class="method-source-code" id="start_trace-source">
            <pre><span class="ruby-comment"># File lib/appoptics_apm/api/tracing.rb, line 94</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_trace</span>(<span class="ruby-identifier">layer</span>, <span class="ruby-identifier">xtrace</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">opts</span> = {})
  <span class="ruby-identifier">log_start</span>(<span class="ruby-identifier">layer</span>, <span class="ruby-identifier">xtrace</span>, <span class="ruby-identifier">opts</span>)
  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-keyword">yield</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-identifier">log_exception</span>(<span class="ruby-identifier">layer</span>, <span class="ruby-identifier">e</span>)
    <span class="ruby-identifier">e</span>.<span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-value">:@xtrace</span>, <span class="ruby-identifier">log_end</span>(<span class="ruby-identifier">layer</span>))
    <span class="ruby-identifier">raise</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">xtrace</span> = <span class="ruby-identifier">log_end</span>(<span class="ruby-identifier">layer</span>)

  [<span class="ruby-identifier">result</span>, <span class="ruby-identifier">xtrace</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-start_trace_with_target" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_trace_with_target</span><span
            class="method-args">(layer, xtrace, target, opts = {}) { || ... }</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Public: Trace a given block of code which can start a trace depending on
configuration and probability. Detect any exceptions thrown by the block
and report errors. Assign an X-Trace to the target.</p>

<p>The motivating use case for this is HTTP streaming in rails3. We need
access to the exit event&#39;s trace id so we can set the header before any
work is done, and before any headers are sent back to the client.</p>

<p>layer - The layer the block of code belongs to. xtrace - string - The
X-Trace to continue by the target target - has to respond to []=, The
target object in which to place the trace information opts - A hash
containing key/value pairs that will be reported along</p>

<pre>with the first event of this layer (optional).</pre>

<p>Example:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">handle_request</span>(<span class="ruby-identifier">request</span>, <span class="ruby-identifier">response</span>)
  <span class="ruby-comment"># ... code that does something with request and response ...</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">def</span> <span class="ruby-identifier">handle_request_with_oboe</span>(<span class="ruby-identifier">request</span>, <span class="ruby-identifier">response</span>)
  <span class="ruby-identifier">start_trace_with_target</span>(<span class="ruby-string">&#39;rails&#39;</span>, <span class="ruby-identifier">request</span>[<span class="ruby-string">&#39;X-Trace&#39;</span>], <span class="ruby-identifier">response</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">handle_request</span>(<span class="ruby-identifier">request</span>, <span class="ruby-identifier">response</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Returns the result of the block.</p>
          
          

          
          <div class="method-source-code" id="start_trace_with_target-source">
            <pre><span class="ruby-comment"># File lib/appoptics_apm/api/tracing.rb, line 135</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_trace_with_target</span>(<span class="ruby-identifier">layer</span>, <span class="ruby-identifier">xtrace</span>, <span class="ruby-identifier">target</span>, <span class="ruby-identifier">opts</span> = {})
  <span class="ruby-identifier">log_start</span>(<span class="ruby-identifier">layer</span>, <span class="ruby-identifier">xtrace</span>, <span class="ruby-identifier">opts</span>)
  <span class="ruby-identifier">exit_evt</span> = <span class="ruby-constant">AppOpticsAPM</span><span class="ruby-operator">::</span><span class="ruby-constant">Context</span>.<span class="ruby-identifier">createEvent</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">target</span>[<span class="ruby-string">&#39;X-Trace&#39;</span>] = <span class="ruby-constant">AppOpticsAPM</span><span class="ruby-operator">::</span><span class="ruby-constant">EventUtil</span>.<span class="ruby-identifier">metadataString</span>(<span class="ruby-identifier">exit_evt</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">AppOpticsAPM</span>.<span class="ruby-identifier">tracing?</span>
    <span class="ruby-keyword">yield</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-identifier">log_exception</span>(<span class="ruby-identifier">layer</span>, <span class="ruby-identifier">e</span>)
    <span class="ruby-identifier">raise</span>
  <span class="ruby-keyword">ensure</span>
    <span class="ruby-identifier">exit_evt</span>.<span class="ruby-identifier">addEdge</span>(<span class="ruby-constant">AppOpticsAPM</span><span class="ruby-operator">::</span><span class="ruby-constant">Context</span>.<span class="ruby-identifier">get</span>)
    <span class="ruby-identifier">log</span>(<span class="ruby-identifier">layer</span>, <span class="ruby-value">:exit</span>, {}, <span class="ruby-identifier">exit_evt</span>)
    <span class="ruby-constant">AppOpticsAPM</span><span class="ruby-operator">::</span><span class="ruby-constant">Context</span>.<span class="ruby-identifier">clear</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-trace" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">trace</span><span
            class="method-args">(layer, opts = {}, protect_op = nil) { || ... }</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Public: Trace a given block of code. Detect any exceptions thrown by the
block and report errors.</p>
<ul><li>
<p><code>:layer</code> - The layer the block of code belongs to.</p>
</li><li>
<p><code>:opts</code> - A hash containing key/value pairs that will be
reported along with the first event of this layer (optional).</p>
</li><li>
<p><code>:protect_op</code> - The operation being traced.  Used to avoid
double tracing operations that call each other</p>
</li></ul>

<p>Example</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">computation</span>(<span class="ruby-identifier">n</span>)
  <span class="ruby-identifier">fib</span>(<span class="ruby-identifier">n</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Exception</span>.<span class="ruby-identifier">new</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">def</span> <span class="ruby-identifier">computation_with_oboe</span>(<span class="ruby-identifier">n</span>)
  <span class="ruby-identifier">trace</span>(<span class="ruby-string">&#39;fib&#39;</span>, { :<span class="ruby-identifier">number</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">n</span> }, :<span class="ruby-identifier">fib</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">computation</span>(<span class="ruby-identifier">n</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">result</span> = <span class="ruby-identifier">computation_with_oboe</span>(<span class="ruby-value">1000</span>)
</pre>

<p>Returns the result of the block.</p>
          
          

          
          <div class="method-source-code" id="trace-source">
            <pre><span class="ruby-comment"># File lib/appoptics_apm/api/tracing.rb, line 51</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">trace</span>(<span class="ruby-identifier">layer</span>, <span class="ruby-identifier">opts</span> = {}, <span class="ruby-identifier">protect_op</span> = <span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">log_entry</span>(<span class="ruby-identifier">layer</span>, <span class="ruby-identifier">opts</span>, <span class="ruby-identifier">protect_op</span>)
  <span class="ruby-keyword">begin</span>
    <span class="ruby-keyword">yield</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-identifier">log_exception</span>(<span class="ruby-identifier">layer</span>, <span class="ruby-identifier">e</span>)
    <span class="ruby-identifier">raise</span>
  <span class="ruby-keyword">ensure</span>
    <span class="ruby-identifier">log_exit</span>(<span class="ruby-identifier">layer</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://rdoc.github.io/rdoc">RDoc</a> 5.0.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

